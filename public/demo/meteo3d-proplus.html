<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
<title>TINSFLASH PRO++ ‚Äì Terre IA R√©aliste</title>

<style>
html,body{margin:0;height:100%;overflow:hidden;background:#000;color:#fff;font-family:sans-serif;}
#hud{position:fixed;bottom:10px;left:10px;background:#0008;padding:8px 12px;border-radius:10px;font-size:13px;box-shadow:0 0 8px #0ff;}
#btnLocate{position:fixed;top:10px;left:10px;background:#00aaff;color:#fff;border:none;padding:10px 14px;border-radius:8px;font-weight:600;box-shadow:0 0 8px #09f;}
</style>

<script type="module">
import * as THREE from "/three.module.js";
import { OrbitControls } from "/OrbitControls.js";

let scene,camera,renderer,controls,earth,clouds,stars,light,hud,lat,lon;

init();
animate();

function init(){
  renderer=new THREE.WebGLRenderer({antialias:true});
  renderer.setSize(innerWidth,innerHeight);
  renderer.setPixelRatio(devicePixelRatio);
  document.body.appendChild(renderer.domElement);

  scene=new THREE.Scene();
  camera=new THREE.PerspectiveCamera(60,innerWidth/innerHeight,0.1,100);
  camera.position.set(0,0,3);

  controls=new OrbitControls(camera,renderer.domElement);
  controls.enableDamping=true;

  light=new THREE.DirectionalLight(0xffffff,1.2);
  light.position.set(5,3,5);
  scene.add(light);
  scene.add(new THREE.AmbientLight(0x404040));

  const loader=new THREE.TextureLoader();
  const texEarth=loader.load("https://raw.githubusercontent.com/roblabs/threejs-earth/master/images/earthmap4k.jpg");
  const texBump=loader.load("https://raw.githubusercontent.com/roblabs/threejs-earth/master/images/earthbump4k.jpg");
  const texClouds=loader.load("https://raw.githubusercontent.com/roblabs/threejs-earth/master/images/earthcloudmap.jpg");

  const matEarth=new THREE.MeshPhongMaterial({
    map:texEarth,bumpMap:texBump,bumpScale:0.05,specular:new THREE.Color("#333"),shininess:8
  });
  earth=new THREE.Mesh(new THREE.SphereGeometry(1,128,128),matEarth);
  scene.add(earth);

  clouds=new THREE.Mesh(new THREE.SphereGeometry(1.01,64,64),
    new THREE.MeshLambertMaterial({map:texClouds,transparent:true,opacity:0.4}));
  scene.add(clouds);

  const starGeo=new THREE.BufferGeometry();
  const p=[];for(let i=0;i<1500;i++){const r=5+Math.random()*15,t=Math.random()*6.28,p2=Math.acos(2*Math.random()-1);
    p.push(r*Math.sin(p2)*Math.cos(t),r*Math.sin(p2)*Math.sin(t),r*Math.cos(p2));}
  starGeo.setAttribute("position",new THREE.Float32BufferAttribute(p,3));
  stars=new THREE.Points(starGeo,new THREE.PointsMaterial({color:0xffffff,size:0.02}));
  scene.add(stars);

  hud=document.createElement("div");hud.id="hud";hud.textContent="üì° Appuie sur Localiser";document.body.appendChild(hud);
  const btn=document.createElement("button");btn.id="btnLocate";btn.textContent="Localiser";btn.onclick=askLocation;document.body.appendChild(btn);

  window.addEventListener("resize",()=>{camera.aspect=innerWidth/innerHeight;camera.updateProjectionMatrix();renderer.setSize(innerWidth,innerHeight);});
}

async function askLocation(){
  hud.textContent="Recherche position‚Ä¶";
  if(!navigator.geolocation){hud.textContent="‚ö†Ô∏è Pas de GPS";return;}
  navigator.geolocation.getCurrentPosition(async(pos)=>{
    lat=pos.coords.latitude;lon=pos.coords.longitude;
    hud.textContent=`Position ${lat.toFixed(2)},${lon.toFixed(2)} ‚Äì chargement relief & m√©t√©o`;
    await applyRelief();
    await updateWeather();
  },()=>hud.textContent="‚ö†Ô∏è GPS refus√©");
}

async function applyRelief(){
  try{
    const r=await fetch(`/api/altitude?lat=${lat}&lon=${lon}`);
    const d=await r.json();
    const alt=d.altitude||0;
    const pos=earth.geometry.attributes.position;
    for(let i=0;i<pos.count;i++){
      const v=new THREE.Vector3().fromBufferAttribute(pos,i);
      v.multiplyScalar(1+alt/40000); // l√©ger gonflement
      pos.setXYZ(i,v.x,v.y,v.z);
    }
    pos.needsUpdate=true;
  }catch(e){console.warn("relief:",e);}
}

async function updateWeather(){
  try{
    const r=await fetch(`/api/weather-map?lat=${lat}&lon=${lon}`);
    const d=await r.json();
    const cloud=d.cloud||0;const rain=d.rain||0;
    clouds.material.opacity=0.2+cloud/100;
    clouds.material.color.setHSL(0.6,0.2,1-rain/50);
    hud.textContent=`‚òÅÔ∏è ${cloud}% nuages | üåßÔ∏è ${rain} mm/h`;
  }catch(e){hud.textContent="‚ö†Ô∏è Erreur m√©t√©o";}
}

function animate(){
  requestAnimationFrame(animate);
  earth.rotation.y+=0.0008;
  clouds.rotation.y+=0.001;
  controls.update();
  renderer.render(scene,camera);
}
</script>
</head>
<body></body>
</html>
