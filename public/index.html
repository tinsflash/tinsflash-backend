<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="robots" content="index,follow">
  <title>üå¶Ô∏è TINSFLASH ‚Äì Pr√©visions & Alertes m√©t√©o IA</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <!-- Google Ads (script uniquement) -->
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6828365665232268" crossorigin="anonymous"></script>

  <style>
    body { margin:0; font-family:"Segoe UI",sans-serif; background:#eef2f7; color:#222; }
    header video { width:100%; height:auto; max-height:400px; object-fit:cover; display:block; }

    main { padding:14px; display:flex; flex-direction:column; gap:20px; max-width:950px; margin:auto; }

    .section { background:#fff; border-radius:10px; padding:14px; box-shadow:0 2px 8px rgba(0,0,0,0.1); }
    h2 { color:#1565c0; font-size:1.1rem; margin-bottom:8px; }

    #mapForecast,#mapAlerts { width:100%; height:320px; border-radius:10px; }
    #radar { width:100%; height:360px; border:0; border-radius:10px; }

    /* Chat flottant */
    #chatBtn {
      position:fixed; bottom:18px; right:18px;
      width:60px; height:60px;
      background:url('/avatars/jean-default.png') center/cover no-repeat;
      border-radius:50%; box-shadow:0 0 10px rgba(0,0,0,0.3);
      cursor:pointer; z-index:1000; animation:pulse 2.5s infinite;
    }
    @keyframes pulse { 0%{box-shadow:0 0 6px #4fc3f7;} 50%{box-shadow:0 0 14px #4fc3f7;} 100%{box-shadow:0 0 6px #4fc3f7;} }
    #chatBox {
      position:fixed; bottom:90px; right:18px;
      width:300px; height:360px; display:none; flex-direction:column;
      background:white; border-radius:12px; box-shadow:0 4px 14px rgba(0,0,0,0.3); z-index:1001;
    }
    #chatHeader { background:#1565c0; color:white; padding:8px; border-radius:12px 12px 0 0; font-weight:bold; text-align:center; }
    #chatMessages { flex:1; padding:10px; overflow-y:auto; font-size:0.9rem; }
    #chatInput { display:flex; border-top:1px solid #ccc; }
    #chatInput input { flex:1; border:none; padding:8px; }
    #chatInput button { background:#1565c0; border:none; color:white; padding:8px 12px; }

    footer { text-align:center; font-size:0.85rem; color:#555; padding:20px 10px; background:#f5f5f5; border-top:1px solid #ddd; }

    /* Fan Club */
    #fanClub { display:flex; flex-direction:column; gap:8px; }
    input[type="email"] { padding:8px; border:1px solid #ccc; border-radius:6px; }
    button { background:#1565c0; color:white; border:none; padding:8px 14px; border-radius:6px; font-weight:bold; cursor:pointer; }
    button:hover { background:#0d47a1; }

    .upgrade {
      position:fixed; bottom:18px; left:18px;
      background:#ffd600; color:#222;
      padding:10px 14px; border-radius:10px;
      font-weight:bold; box-shadow:0 0 10px rgba(0,0,0,0.2);
      animation:blink 2s infinite;
    }
    @keyframes blink { 0%,100%{opacity:1;} 50%{opacity:0.5;} }

    @media(max-width:700px){
      #mapForecast,#mapAlerts,#radar{height:260px;}
      #chatBox{width:90%; right:5%;}
    }
  </style>
</head>
<body>
  <header>
    <video autoplay muted loop playsinline>
      <source src="intro-jean.mp4" type="video/mp4">
    </video>
  </header>

  <main>
    <section class="section">
      <h2>üåç Bienvenue sur TINSFLASH</h2>
      <p>
        TINSFLASH est un moteur m√©t√©orologique de nouvelle g√©n√©ration, combinant mod√®les scientifiques, intelligence artificielle et
        analyse g√©ographique de haute pr√©cision. Nos pr√©visions sont actualis√©es en temps r√©el et optimis√©es par zone, avec des alertes
        locales, nationales et mondiales anticip√©es avant les autres.  
        <br><br>
        Notre IA ¬´ Jean ¬ª t‚Äôaccompagne au quotidien pour te donner une m√©t√©o plus intelligente, plus juste et toujours √† jour.
      </p>
    </section>

    <section class="section">
      <h2>üìç Localisation</h2>
      <p>Autorise la g√©olocalisation ou indique ton adresse pour obtenir tes pr√©visions locales.</p>
      <input type="text" id="manualAddress" placeholder="Ex: Paris, France" />
      <button onclick="detectLocation()">Activer la g√©olocalisation</button>
    </section>

    <section class="section">
      <h2>üåû Pr√©visions du jour & 7 jours</h2>
      <div id="forecastText">Chargement des pr√©visions...</div>
      <div id="mapForecast"></div>
    </section>

    <section class="section">
      <h2>üö® Alertes locales / mondiales</h2>
      <div id="mapAlerts"></div>
      <ul id="alertsList"></ul>
    </section>

    <section class="section">
      <h2>üõ∞Ô∏è Radar en direct</h2>
      <iframe id="radar" src="https://embed.windy.com/embed2.html?lat=50&lon=4&detailLat=50&detailLon=4&width=650&height=450&zoom=5&level=surface&overlay=rain&menu=&message=true&type=map&location=coordinates&detail=true&metricWind=default&metricTemp=default&radarRange=-1" allowfullscreen></iframe>
    </section>

    <section class="section">
      <h2>üíå TINS'Fan Club & avantages</h2>
      <form id="fanClub">
        <input type="email" id="email" placeholder="Ton email pour rejoindre le Fan Club" required />
        <label><input type="checkbox" id="consent" required> J'accepte la politique RGPD (inscription gratuite, infos m√©t√©o locales)</label>
        <button type="button" onclick="registerFan()">Je rejoins üéâ</button>
      </form>
      <div id="fanMsg"></div>
    </section>
  </main>

  <div class="upgrade" onclick="window.location.href='https://buy.stripe.com/cNiaEZgK5bpffuRex3gfu00'">‚≠ê Passez Premium ou Pro pour + de fonctions exclusives</div>

  <div id="chatBtn" onclick="toggleChat()" title="Parler √† Jean IA"></div>
  <div id="chatBox">
    <div id="chatHeader">üí¨ Jean ‚Äì Assistant m√©t√©o IA</div>
    <div id="chatMessages"></div>
    <div id="chatInput">
      <input type="text" id="msgInput" placeholder="Demande √† Jean..." />
      <button onclick="sendMsg()">‚û§</button>
    </div>
  </div>

  <footer>
    <p>¬© 2025 <strong>TINSFLASH</strong> ‚Äì Tous droits r√©serv√©s.<br>
    Pour partenariat, presse ou acquisition de notre moteur m√©t√©o :  
    <a href="mailto:skysnapia@gmail.com">skysnapia@gmail.com</a> ‚Äì  
    WhatsApp : <a href="https://wa.me/32473264477">0032 473 26 44 77</a>
    </p>
  </footer>

  <script>
    // === GEOLOCALISATION ===
    async function detectLocation(){
      if(navigator.geolocation){
        navigator.geolocation.getCurrentPosition(pos=>{
          loadForecast(pos.coords.latitude,pos.coords.longitude);
        },err=>alert("Erreur g√©oloc: "+err.message));
      }else alert("G√©olocalisation non support√©e");
    }

    // === CARTES ===
    const mapF=L.map("mapForecast").setView([20,0],2);
    const mapA=L.map("mapAlerts").setView([20,0],2);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:"¬© OpenStreetMap"}).addTo(mapF);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:"¬© OpenStreetMap"}).addTo(mapA);

    async function loadForecast(lat=50,lon=4){
      document.getElementById("forecastText").innerText="Chargement...";
      try{
        const res=await fetch("/api/status");
        const data=await res.json();
        document.getElementById("forecastText").innerText="Pr√©visions g√©n√©r√©es par notre IA pour ta zone.";
        data.alerts?.forEach(a=>{
          if(a.lat&&a.lon)L.circle([a.lat,a.lon],{radius:80000,color:"#2196f3",fillOpacity:0.4})
            .addTo(mapF).bindPopup(`<b>${a.country||"?"}</b><br>${a.title||"Pr√©vision locale"}`);
        });
      }catch(e){
        document.getElementById("forecastText").innerText="‚ö†Ô∏è Erreur de chargement.";
      }
    }
    loadForecast();

    async function loadAlerts(){
      try{
        const res=await fetch("/api/alerts");
        const alerts=await res.json();
        const ul=document.getElementById("alertsList"); ul.innerHTML="";
        mapA.eachLayer(l=>l instanceof L.Circle && l.remove());
        alerts.forEach(a=>{
          if(a.lat&&a.lon)L.circle([a.lat,a.lon],{radius:120000,color:"red",fillOpacity:0.5})
            .addTo(mapA).bindPopup(`<b>${a.country}</b><br>${a.title||"Alerte"}`);
          const li=document.createElement("li"); li.textContent=`${a.country||"?"}: ${a.title||"Alerte m√©t√©o"}`;
          ul.appendChild(li);
        });
      }catch(e){console.warn("alerts:",e.message);}
    }
    loadAlerts();
    setInterval(loadAlerts,90000);

    // === CHAT IA ===
    function toggleChat(){
      const c=document.getElementById("chatBox");
      c.style.display=c.style.display==="flex"?"none":"flex";
    }
    async function sendMsg(){
      const input=document.getElementById("msgInput");
      const text=input.value.trim();
      if(!text)return;
      const chat=document.getElementById("chatMessages");
      chat.innerHTML+=`<div><b>Moi:</b> ${text}</div>`;
      input.value="";
      try{
        const res=await fetch("/api/jean",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({message:text})});
        const data=await res.json();
        chat.innerHTML+=`<div><b>Jean:</b> ${data.reply}</div>`;
        chat.scrollTop=chat.scrollHeight;
      }catch(e){chat.innerHTML+=`<div>‚ö†Ô∏è ${e.message}</div>`;}
    }

    // === FAN CLUB ===
    async function registerFan(){
      const email=document.getElementById("email").value.trim();
      const consent=document.getElementById("consent").checked;
      if(!email||!consent)return alert("Merci de renseigner ton email et d'accepter le RGPD");
      const res=await fetch("/api/register-fan",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email})});
      const data=await res.json();
      document.getElementById("fanMsg").innerText=data.success?"Bienvenue üéâ":"Erreur : "+(data.message||data.error);
    }
  </script>
</body>
</html>
