<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TINSFLASH ‚Ä¢ Pr√©visions & Alertes</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <style>
    body{margin:0;font-family:"Segoe UI",sans-serif;background:#0f172a;color:#f5faff;}
    header{text-align:center;padding:15px;background:linear-gradient(90deg,#08101f,#15294d);
      color:#4fc3f7;font-size:1.6em;font-weight:bold;text-shadow:0 0 12px #4fc3f7;}
    .subheader{text-align:center;background:#0d1528;color:#7dd3fc;padding:6px;font-size:0.9em;}
    video{width:100%;max-height:180px;object-fit:cover;display:block;}
    main{max-width:1200px;margin:auto;padding:20px;}
    h2{color:#4fc3f7;border-left:4px solid #4fc3f7;padding-left:10px;margin-top:35px;}
    p.intro{color:#e0e8f9;line-height:1.7;font-size:1.08em;text-align:justify;}
    .intro-block{display:flex;align-items:flex-start;gap:18px;margin-top:20px;}
    .intro-block img{border-radius:12px;width:140px;height:auto;box-shadow:0 0 18px rgba(0,0,0,0.4);}
    .forecast-grid{display:flex;flex-wrap:wrap;gap:10px;margin-top:10px;}
    .forecast-card{background:#131a2b;border-radius:10px;padding:10px;min-width:110px;text-align:center;box-shadow:0 0 10px rgba(0,0,0,0.3);}
    .forecast-card img{width:50px;height:50px;}
    .map-container{height:360px;margin:25px 0;border-radius:10px;overflow:hidden;box-shadow:0 0 12px rgba(0,0,0,0.4);}
    footer{text-align:center;background:#111827;color:#ccc;padding:15px;font-size:0.9em;}
    footer a{color:#4fc3f7;text-decoration:none;}
    footer a:hover{text-decoration:underline;}
    .banner{background:#16233a;color:#4fc3f7;padding:12px;text-align:center;font-weight:bold;margin-top:20px;border-radius:8px;}
    .notif-btn{background:#4fc3f7;color:#000;padding:6px 10px;border:none;border-radius:6px;cursor:pointer;font-weight:bold;margin-top:8px;}
    input[type=text]{width:100%;padding:8px;margin-top:8px;border-radius:6px;border:none;background:#1b2339;color:#eee;}
    .alert-section .alert-box{background:#1b2439;border-left:4px solid #4fc3f7;padding:8px;margin-bottom:8px;border-radius:8px;}
    .alert-section .alert-box strong{color:#4fc3f7;}
    .meteo-jour{background:#15294d;padding:12px;border-radius:10px;margin-top:20px;color:#dce7f9;box-shadow:0 0 10px rgba(0,0,0,0.4);}
    .ask-jean{text-align:center;margin:20px 0;}
    .ask-jean a{color:#4fc3f7;font-weight:bold;cursor:pointer;text-decoration:none;}
    .ask-jean a:hover{text-decoration:underline;}

    /* CHAT J.E.A.N */
    .btn-ai{position:fixed;bottom:25px;right:25px;background:#4fc3f7;color:#000;font-weight:bold;
      border:none;border-radius:50%;width:52px;height:52px;cursor:pointer;box-shadow:0 0 15px rgba(79,195,247,0.6);
      font-size:18px;transition:transform .3s ease;z-index:999;}
    .btn-ai:hover{transform:scale(1.1);}
    .chat-box{position:fixed;bottom:90px;right:20px;background:#1b2439;border:2px solid #4fc3f7;border-radius:12px;
      width:320px;height:400px;display:none;flex-direction:column;box-shadow:0 0 15px rgba(0,0,0,0.5);z-index:999;}
    .chat-header{background:#4fc3f7;color:#000;text-align:center;padding:6px;font-weight:bold;}
    .chat-messages{flex:1;padding:8px;overflow-y:auto;font-size:14px;background:#0e1423;}
    .chat-input{display:flex;border-top:1px solid #333;}
    .chat-input input{flex:1;padding:8px;border:none;background:#1b2339;color:#eee;}
    .chat-input button{background:#4fc3f7;border:none;color:#000;padding:8px 12px;font-weight:bold;cursor:pointer;}
  </style>
</head>

<body>
  <header>TINSFLASH ‚Ä¢ Pr√©visions & Alertes</header>
  <div class="subheader">üõ∞ Donn√©es satellites ‚Ä¢ Mod√®les IA multi-sources ‚Ä¢ Sp√©cificit√©s locales (relief, altitude, oc√©ans)</div>

  <video autoplay muted loop playsinline id="introVideo">
    <source src="intro-jean.mp4" type="video/mp4" />
  </video>

  <main>
    <div class="intro-block">
      <img src="avatars/jean-default.png" alt="avatar" />
      <div>
        <h2>Pr√©sentation du syst√®me J.E.A.N.</h2>
        <p class="intro">
          Le <strong>Syst√®me J.E.A.N.</strong> croise en temps r√©el les donn√©es satellites,
          mod√®les num√©riques et intelligences artificielles multi-sources. Il analyse le relief,
          l‚Äôhumidit√©, la temp√©rature du sol et les microclimats pour fournir des pr√©visions
          <strong>fiables, locales, nationales et mondiales</strong>, tout en anticipant, souvent avant
          les autres, les anomalies m√©t√©orologiques susceptibles d‚Äô√©voluer en alertes.
        </p>
      </div>
    </div>

    <h2>üìç Votre position</h2>
    <div id="position-status">D√©tection de votre position en cours...</div>
    <input type="text" id="manualAddress" placeholder="Ou entrez votre adresse compl√®te (rue, ville, pays)" />
    <button class="notif-btn" onclick="askNotifications()">üîî Activer les notifications m√©t√©o</button>

    <h2>Pr√©vision locale du jour</h2>
    <div id="forecast-today" class="forecast-grid">Chargement...</div>

    <h2>Pr√©visions locales (7 jours)</h2>
    <div id="forecast-local" class="forecast-grid">Chargement...</div>

    <h2>Pr√©visions nationales (7 jours)</h2>
    <div id="forecast-national" class="forecast-grid">Chargement...</div>

    <!-- üß† Synth√®se automatique -->
    <div id="meteoJour" class="meteo-jour">Analyse du jour en cours...</div>

    <!-- üí¨ Lien vers J.E.A.N -->
    <div class="ask-jean">
      <a id="askJeanLink">üí¨ Posez vos questions m√©t√©orologiques √† J.E.A.N.</a>
    </div>

    <h2>Carte mondiale des alertes</h2>
    <div id="map-alerts" class="map-container"></div>

    <h2>Alertes locales</h2>
    <div id="alerts-local" class="alert-section">Chargement...</div>

    <h2>Alertes nationales</h2>
    <div id="alerts-national" class="alert-section">Chargement...</div>

    <h2>Alertes mondiales ‚Äì Primeurs TINSFLASH</h2>
    <div id="alerts-world" class="alert-section">Chargement...</div>

    <h2>Radar mondial Windy</h2>
    <iframe width="100%" height="450" src="https://embed.windy.com/embed2.html?lat=48.0&lon=3.0&zoom=3&level=surface&overlay=rain&menu=true" frameborder="0"></iframe>

    <div class="banner">
      üîß Pour vos diagnostics et d√©tections de fuites :
      <a href="https://www.uman-detect.com" target="_blank">Uman-Detect.com</a>
    </div>
  </main>

  <footer>
    ¬© 2025 TINSFLASH ‚Äì Tous droits r√©serv√©s<br/>
    üìß <a href="mailto:skysnapia@gmail.com">skysnapia@gmail.com</a> |
    üí¨ <a href="https://wa.me/32473264477" target="_blank">WhatsApp +32 473 26 44 77</a><br/>
    Une demande de partenariat ou un √©ventuel rachat de notre syst√®me ? Contactez-nous.
  </footer>

  <!-- üí¨ Chat m√©t√©o J.E.A.N -->
  <button class="btn-ai" id="btnAI">ü§ñ</button>
  <div class="chat-box" id="chatJean">
    <div class="chat-header">Assistant M√©t√©o J.E.A.N.</div>
    <div class="chat-messages" id="chatMessages"></div>
    <div class="chat-input">
      <input type="text" id="chatInput" placeholder="Posez votre question m√©t√©o..." />
      <button onclick="sendChat()">Envoyer</button>
    </div>
  </div>

  <script>
    const API_BASE = "/api";

    // üîî Notifications
    function askNotifications(){
      if(Notification.permission==="granted"){alert("Notifications d√©j√† activ√©es.");return;}
      Notification.requestPermission().then(p=>{
        if(p==="granted")new Notification("TINSFLASH : notifications m√©t√©o activ√©es !");
      });
    }

    // ‚öôÔ∏è Pr√©visions
    function renderForecastCards(container, data){
      container.innerHTML="";
      if(!data||!data.length){container.textContent="Aucune donn√©e disponible.";return;}
      data.forEach(d=>{
        const div=document.createElement("div");
        div.className="forecast-card";
        div.innerHTML=`
          <img src="assets/icons/${d.icon||'sun'}.png" alt="">
          <div><b>${d.day||''}</b></div>
          <div>${d.temp_min}¬∞ / ${d.temp_max}¬∞</div>
          <small>${d.condition||''}</small>`;
        container.appendChild(div);
      });
    }

    // üß† G√©n√©ration automatique du texte m√©t√©o du jour
    function renderMeteoJour(f){
      const el=document.getElementById("meteoJour");
      if(!f){el.textContent="Pr√©visions en cours...";return;}
      let msg=`Aujourd‚Äôhui, le temps est domin√© par ${f.condition?.toLowerCase()||"des conditions variables"} avec une temp√©rature comprise entre ${f.temp_min}¬∞C et ${f.temp_max}¬∞C. `;
      msg+=`Le vent souffle √† environ ${f.wind?.toFixed(0)||0} km/h et la fiabilit√© du mod√®le est estim√©e √† ${(f.reliability*100||80).toFixed(0)} %.`;
      el.textContent=msg;
    }

    // üìç G√©olocalisation / adresse
    function initPosition(){
      const ps=document.getElementById("position-status");
      if(navigator.geolocation){
        navigator.geolocation.getCurrentPosition(p=>{
          ps.textContent=`‚úÖ Position d√©tect√©e : ${p.coords.latitude.toFixed(2)}, ${p.coords.longitude.toFixed(2)}`;
          loadForecast(p.coords.latitude,p.coords.longitude);
        },()=>ps.textContent="‚ö†Ô∏è G√©olocalisation refus√©e.");
      }
      document.getElementById("manualAddress").addEventListener("change",async e=>{
        const addr=e.target.value;
        if(!addr)return;
        const geo=await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(addr)}`);
        const g=await geo.json();
        if(g[0]){const {lat,lon}=g[0];ps.textContent=`üìç ${addr}`;loadForecast(lat,lon);}
        else ps.textContent="Adresse non trouv√©e.";
      });
    }

    // üå§Ô∏è Chargement des pr√©visions
    async function loadForecast(lat,lon){
      try{
        const r=await fetch(`${API_BASE}/forecast?lat=${lat}&lon=${lon}`);
        const data=await r.json();
        renderForecastCards(document.getElementById("forecast-today"), [data.forecast]);
        renderForecastCards(document.getElementById("forecast-local"), data.nextDays||[]);
        renderForecastCards(document.getElementById("forecast-national"), data.national||[]);
        renderMeteoJour(data.forecast);
      }catch(e){console.error(e);}
    }

    // üí¨ Chat m√©t√©o
    const chatBox=document.getElementById("chatJean");
    document.getElementById("btnAI").onclick=()=>chatBox.style.display=chatBox.style.display==="flex"?"none":"flex";
    document.getElementById("askJeanLink").onclick=()=>{chatBox.style.display="flex";};

    async function sendChat(){
      const msg=document.getElementById("chatInput").value.trim();
      if(!msg)return;
      const m=document.getElementById("chatMessages");
      m.innerHTML+=`<div style='color:#4fc3f7;'>Vous : ${msg}</div>`;
      document.getElementById("chatInput").value="";
      try{
        const r=await fetch(`${API_BASE}/cohere`,{
          method:"POST",
          headers:{"Content-Type":"application/json"},
          body:JSON.stringify({question:`[METEO ONLY] ${msg}`})
        });
        const d=await r.json();
        if(d.reply?.toLowerCase().includes("je ne peux pas")||!d.reply){
          m.innerHTML+=`<div>J.E.A.N : Je r√©ponds uniquement aux questions li√©es √† la m√©t√©o et aux alertes TINSFLASH.</div>`;
        }else{
          m.innerHTML+=`<div>J.E.A.N : ${d.reply}</div>`;
        }
      }catch(e){
        m.innerHTML+=`<div>‚ùå ${e.message}</div>`;
      }
      m.scrollTop=m.scrollHeight;
    }

    // üó∫Ô∏è Carte alertes
    function initMapAlerts(){
      const map=L.map("map-alerts").setView([20,0],2);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);
      fetch(`${API_BASE}/alerts`).then(r=>r.json()).then(list=>{
        list.forEach(a=>{
          if(a.lat&&a.lon)L.marker([a.lat,a.lon])
            .addTo(map)
            .bindPopup(`<b>${a.title}</b><br>${a.zone}<br>${a.description||''}`);
        });
      });
    }

    document.addEventListener("DOMContentLoaded",()=>{
      initPosition();
      initMapAlerts();
    });
  </script>
</body>
</html>
