<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>TINSFLASH ‚Äì Pr√©visions et Alertes M√©t√©o</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="robots" content="index,follow">
  <style>
    body{margin:0;font-family:Arial,sans-serif;background:#0d1117;color:#eee;line-height:1.6;}
    header{position:relative;height:40vh;overflow:hidden;}
    header video{width:100%;height:100%;object-fit:cover;}
    header .overlay{position:absolute;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.4);display:flex;align-items:center;justify-content:center;}
    header h1{font-size:2rem;color:#00d8ff;text-align:center;}
    main{padding:20px;}
    h2{color:#00d8ff;margin-top:20px;}
    .forecast,.alerts{background:#161b22;padding:15px;border-radius:8px;margin:15px 0;}
    .forecast-table{width:100%;border-collapse:collapse;margin-top:10px;}
    .forecast-table th,.forecast-table td{border:1px solid #333;padding:8px;text-align:center;}
    .forecast-table th{background:#222;color:#00d8ff;}
    iframe{width:100%;height:400px;border:none;border-radius:8px;}
    footer{text-align:center;font-size:.8rem;color:#888;padding:15px;background:#111;}
    .ads{margin:20px 0;text-align:center;}
    .input-box{text-align:center;margin:15px 0;}
    input,button{padding:8px 12px;border-radius:6px;border:none;margin:5px;}
    button{background:#00d8ff;color:#000;cursor:pointer;}
    button:hover{background:#00aacc;}
    .bulletin{background:#202530;padding:15px;border-radius:8px;margin-top:10px;font-style:italic;}
    .alert-card{background:#222;padding:12px;margin:10px 0;border-radius:6px;}
  </style>
</head>
<body>

<header>
  <video autoplay muted loop id="introVideo">
    <source src="intro-jean.mp4" type="video/mp4">
  </video>
  <div class="overlay"><h1>üåç TINSFLASH ‚Äì Les pr√©visions et alertes m√©t√©o les plus pr√©cises du monde</h1></div>
</header>

<main>
  <section>
    <p>
      Notre moteur <b>nucl√©aire m√©t√©o</b> croise les mod√®les mondiaux, le relief, le climat et les anomalies saisonni√®res.  
      R√©sultat : <b>les pr√©visions locales et nationales les plus fiables au monde</b>, avec des alertes <b>avant tout le monde</b>.  
    </p>
  </section>

  <div class="input-box">
    <input type="text" id="cityInput" placeholder="Ville (ex: Paris)">
    <input type="text" id="countryInput" placeholder="Pays (ex: FR)">
    <button onclick="manualForecast()">üîç Voir la m√©t√©o</button>
  </div>

  <section class="forecast">
    <h2>üìä Pr√©visions locales</h2>
    <table class="forecast-table" id="forecastTable"></table>
    <div class="bulletin" id="forecastBulletin">Chargement du bulletin m√©t√©o...</div>
  </section>

  <section class="alerts">
    <h2>üö® Alertes m√©t√©o</h2>
    <div id="alerts">Chargement...</div>
    <button onclick="loadWorldAlerts()">üåç Voir alertes mondiales</button>
  </section>

  <h2>üõ∞Ô∏è Radar</h2>
  <iframe src="https://embed.windy.com/embed2.html?lat=50&lon=4&zoom=5&level=surface&overlay=rain&menu=&message=true&marker=true&calendar=now&pressure=&type=map&location=coordinates&detail=true&detailLat=50&detailLon=4&metricWind=default&metricTemp=default&radarRange=-1"></iframe>
</main>

<footer>
  ¬© 2025 TINSFLASH ‚Äì System J.E.A.N by Pydaris <br>
  üìß skysnapia@gmail.com | üì± WhatsApp +32 473 26 44 77
</footer>

<!-- Avatar J.E.A.N -->
<script src="https://unpkg.com/lottie-web@latest/build/player/lottie.min.js"></script>
<div id="avatar-jean" style="position: fixed; bottom: 20px; right: 20px; width: 120px; height: 120px; cursor: pointer; z-index: 9999;">
  <lottie-player 
    src="https://assets10.lottiefiles.com/packages/lf20_j1adxtyb.json"
    background="transparent"
    speed="1"
    loop
    autoplay>
  </lottie-player>
</div>

<script>
document.getElementById("avatar-jean").addEventListener("click", async () => {
  const q = prompt("Posez une question m√©t√©o √† J.E.A.N :");
  if(!q) return;
  const res = await fetch("/api/jean", {
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({message:q})
  });
  const data = await res.json();
  alert("J.E.A.N : " + (data.reply || "Pas de r√©ponse"));
});

// === Param√®tres URL
const params = new URLSearchParams(window.location.search);
let city = params.get("city") || "Bruxelles";
let country = params.get("country") || "BE";

// G√©ocodage simplifi√©
let lat=50.8503, lon=4.3517;
function geo(city,country){
  if(city.toLowerCase()==="paris"){return [48.8566,2.3522];}
  if(city.toLowerCase()==="new york"){return [40.7128,-74.0060];}
  return [50.8503,4.3517]; // d√©faut Bruxelles
}
[lat,lon]=geo(city,country);

// Changement manuel
function manualForecast(){
  const c=document.getElementById("cityInput").value;
  const p=document.getElementById("countryInput").value;
  if(c&&p){window.location.search=`?city=${c}&country=${p}`;}
}

// Charger les pr√©visions
async function loadForecast(){
  try{
    const res = await fetch("/api/superforecast",{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({lat,lon,country,region:city})
    });
    const data = await res.json();

    const table=document.getElementById("forecastTable");
    table.innerHTML="";

    let bulletin="Pr√©visions indisponibles.";
    if(data && data.forecast){
      // On tente d‚Äôanalyser JSON IA
      let f=data.forecast;
      if(typeof f==="string"){
        try{ f=JSON.parse(f); }catch(e){}
      }
      if(f.resume || f.message_utilisateur){
        bulletin=f.message_utilisateur || f.resume;
      }
      if(f.points_forts){
        table.innerHTML="<tr><th>Points forts</th></tr>";
        f.points_forts.forEach(pt=>{
          const row=document.createElement("tr");
          row.innerHTML=`<td>${pt}</td>`;
          table.appendChild(row);
        });
      }
    }
    document.getElementById("forecastBulletin").textContent=bulletin;

    if("Notification" in window && Notification.permission==="granted"){
      new Notification("Pr√©vision TINSFLASH", { body: bulletin });
    }
  }catch(e){
    document.getElementById("forecastBulletin").textContent="Erreur forecast: "+e.message;
  }
}

// Charger alertes
async function loadAlerts(){
  try{
    const res = await fetch("/api/alerts");
    const data = await res.json();
    if(!Array.isArray(data) || data.length===0){
      document.getElementById("alerts").innerHTML="‚úÖ Aucune alerte active.";
      return;
    }
    renderAlerts(data);
  }catch(e){
    document.getElementById("alerts").textContent="Erreur alertes: "+e.message;
  }
}

// Charger alertes mondiales
async function loadWorldAlerts(){
  try{
    const res = await fetch("/api/alerts");
    const data = await res.json();
    const world = data.filter(a=>a.continent && !a.region); // continentales
    if(!world || world.length===0){
      document.getElementById("alerts").innerHTML="‚úÖ Aucune alerte mondiale.";
      return;
    }
    renderAlerts(world);
  }catch(e){
    document.getElementById("alerts").textContent="Erreur alertes mondiales: "+e.message;
  }
}

// Rendu alertes
function renderAlerts(list){
  let html="";
  list.forEach(a=>{
    const d=a.data||{};
    const fiab=d.fiabilite||0;
    const color=fiab>90?"#0f0":fiab>70?"#ffa500":"#f00";
    html+=`
      <div class="alert-card">
        <b>${a.country||""} ${a.region? "‚Äì "+a.region:""} (${a.continent||""})</b><br>
        Type : ${d.type||"?"} ‚Äì Intensit√© : ${d.intensite||"?"}<br>
        Fiabilit√© : <span style="color:${color};">${fiab}%</span><br>
        ‚è±Ô∏è ${a.timestamp}<br>
        ‚ö†Ô∏è Cons√©quences : ${d.consequences||"?"}<br>
        ‚úÖ Recommandations : ${d.recommandations||"?"}
      </div>
    `;
  });
  document.getElementById("alerts").innerHTML=html;
}

// Notifications navigateur
if("Notification" in window && Notification.permission!=="granted"){
  Notification.requestPermission();
}

loadForecast();
loadAlerts();
</script>
</body>
</html>
