<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TINSFLASH ‚Ä¢ Pr√©visions & Alertes</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <style>
    /* (üé® ton style original conserv√© int√©gralement) */
    body{margin:0;font-family:"Segoe UI",sans-serif;background:#0f172a;color:#f5faff;}
    header{text-align:center;padding:15px;background:linear-gradient(90deg,#08101f,#15294d);color:#4fc3f7;font-size:1.6em;font-weight:bold;text-shadow:0 0 12px #4fc3f7;}
    .subheader{text-align:center;background:#0d1528;color:#7dd3fc;padding:6px;font-size:0.9em;}
    .video-container{position:relative;overflow:hidden;}
    video{width:100%;max-height:180px;object-fit:cover;object-position:bottom;display:block;filter:brightness(0.95);}
    .video-overlay{position:absolute;bottom:0;width:100%;height:60px;background:linear-gradient(to bottom,rgba(15,23,42,0) 0%,#0f172a 100%);}
    .sound-btn{position:absolute;right:15px;bottom:15px;background:rgba(0,0,0,0.5);border:none;border-radius:50%;color:#4fc3f7;font-size:18px;padding:6px;cursor:pointer;}
    main{max-width:1200px;margin:auto;padding:20px;}
    h2{color:#4fc3f7;border-left:4px solid #4fc3f7;padding-left:10px;margin-top:35px;}
    .forecast-grid{display:flex;flex-wrap:wrap;gap:10px;margin-top:10px;}
    .forecast-card{background:#131a2b;border-radius:10px;padding:10px;min-width:110px;text-align:center;box-shadow:0 0 10px rgba(0,0,0,0.3);}
    .forecast-card img{width:50px;height:50px;}
    .map-container{height:360px;margin:25px 0;border-radius:10px;overflow:hidden;box-shadow:0 0 12px rgba(0,0,0,0.4);}
    footer{text-align:center;background:#111827;color:#ccc;padding:15px;font-size:0.9em;}
    .btn-ai{position:fixed;bottom:25px;right:25px;background:#4fc3f7;color:#000;font-weight:bold;border:none;border-radius:50%;width:52px;height:52px;cursor:pointer;box-shadow:0 0 15px rgba(79,195,247,0.6);font-size:18px;transition:transform .3s ease;z-index:999;}
    .chat-box{position:fixed;bottom:90px;right:20px;background:#1b2439;border:2px solid #4fc3f7;border-radius:12px;width:320px;height:400px;display:none;flex-direction:column;box-shadow:0 0 15px rgba(0,0,0,0.5);z-index:999;}
    .chat-header{background:#4fc3f7;color:#000;text-align:center;padding:6px;font-weight:bold;}
    .chat-messages{flex:1;padding:8px;overflow-y:auto;font-size:14px;background:#0e1423;}
    .chat-input{display:flex;border-top:1px solid #333;}
    .chat-input input{flex:1;padding:8px;border:none;background:#1b2339;color:#eee;}
    .chat-input button{background:#4fc3f7;border:none;color:#000;padding:8px 12px;font-weight:bold;cursor:pointer;}
  </style>
</head>
<body>

<header>TINSFLASH ‚Ä¢ Pr√©visions & Alertes</header>
<div class="subheader">üõ∞ Donn√©es satellites ‚Ä¢ Mod√®les IA multi-sources ‚Ä¢ Sp√©cificit√©s locales (relief, altitude, oc√©ans)</div>

<div class="video-container">
  <video autoplay muted loop playsinline id="introVideo">
    <source src="intro-jean.mp4" type="video/mp4" />
  </video>
  <div class="video-overlay"></div>
  <button class="sound-btn" id="soundToggle">üîá</button>
</div>

<main>
  <!-- sections pr√©visions / cartes / alertes -->
  <h2>üìç Votre position</h2>
  <div id="position-status">D√©tection de votre position...</div>
  <input type="text" id="manualAddress" placeholder="Ou entrez votre adresse..." />
  
  <h2>Pr√©visions locales</h2>
  <div id="forecast-local" class="forecast-grid">Chargement...</div>

  <h2>Carte mondiale des alertes</h2>
  <div id="map-alerts" class="map-container"></div>
</main>

<footer>¬© 2025 TINSFLASH ‚Äì Tous droits r√©serv√©s</footer>

<!-- üí¨ Chat m√©t√©o -->
<button class="btn-ai" id="btnAI">ü§ñ</button>
<div class="chat-box" id="chatJean">
  <div class="chat-header">Assistant M√©t√©o J.E.A.N.</div>
  <div class="chat-messages" id="chatMessages"></div>
  <div class="chat-input">
    <input type="text" id="chatInput" placeholder="Posez votre question m√©t√©o..." />
    <button onclick="sendChat()">Envoyer</button>
  </div>
</div>

<script>
const API="/api";
const chatBox=document.getElementById("chatJean");
const btnAI=document.getElementById("btnAI");
btnAI.onclick=()=>chatBox.style.display=chatBox.style.display==="flex"?"none":"flex";

/* üéöÔ∏è contr√¥le son vid√©o */
const v=document.getElementById("introVideo"),btn=document.getElementById("soundToggle");
btn.onclick=()=>{v.muted=!v.muted;btn.textContent=v.muted?"üîá":"üîä";};

/* üìç position utilisateur */
function initPosition(){
  const ps=document.getElementById("position-status");
  if(navigator.geolocation){
    navigator.geolocation.getCurrentPosition(p=>{
      ps.textContent=`‚úÖ Position d√©tect√©e : ${p.coords.latitude.toFixed(2)}, ${p.coords.longitude.toFixed(2)}`;
      loadForecast(p.coords.latitude,p.coords.longitude);
    },()=>ps.textContent="‚ö†Ô∏è G√©olocalisation refus√©e.");
  }
}
async function loadForecast(lat,lon){
  try{
    const r=await fetch(`${API}/forecast?lat=${lat}&lon=${lon}`);
    const j=await r.json();
    renderForecast(j.nextDays||[]);
  }catch(e){console.error(e);}
}
function renderForecast(arr){
  const el=document.getElementById("forecast-local");
  el.innerHTML="";
  arr.forEach(f=>{
    const d=document.createElement("div");
    d.className="forecast-card";
    d.innerHTML=`<img src="assets/icons/${f.icon||'sun'}.png"><div><b>${f.day}</b></div><div>${f.temp_min}¬∞ / ${f.temp_max}¬∞</div>`;
    el.appendChild(d);
  });
}

/* üåç carte alertes */
function initMap(){
  const map=L.map("map-alerts").setView([20,0],2);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);
  fetch(`${API}/alerts`).then(r=>r.json()).then(list=>{
    list.forEach(a=>{
      if(a.lat&&a.lon)L.marker([a.lat,a.lon]).addTo(map).bindPopup(`<b>${a.title}</b><br>${a.zone}<br>${a.description||''}`);
    });
  });
}

/* üí¨ chat m√©t√©o ‚Äì GPT-4o-mini limit√© √† 2 questions/24h */
let chatCount=+localStorage.getItem("chatCount")||0;
let lastReset=+localStorage.getItem("chatReset")||Date.now();
if(Date.now()-lastReset>86400000){chatCount=0;localStorage.setItem("chatReset",Date.now());}
async function sendChat(){
  if(chatCount>=2){alert("‚ùå Vous avez atteint la limite de 2 questions pour aujourd‚Äôhui.");return;}
  const msg=document.getElementById("chatInput").value.trim();
  if(!msg)return;
  const m=document.getElementById("chatMessages");
  m.innerHTML+=`<div style='color:#4fc3f7;'>Vous : ${msg}</div>`;
  document.getElementById("chatInput").value="";
  try{
    const res=await fetch("/api/ai-admin",{method:"POST",headers:{"Content-Type":"application/json"},
      body:JSON.stringify({message:`[METEO ONLY] ${msg}`,mode:"meteo"})});
    const j=await res.json();
    if(!j.reply||j.reply.toLowerCase().includes("non meteo"))
      m.innerHTML+=`<div>J.E.A.N : Je r√©ponds uniquement aux questions m√©t√©o et alertes.</div>`;
    else m.innerHTML+=`<div>J.E.A.N : ${j.reply}</div>`;
    chatCount++;localStorage.setItem("chatCount",chatCount);
  }catch(e){m.innerHTML+=`<div>‚ùå ${e.message}</div>`;}
  m.scrollTop=m.scrollHeight;
}

document.addEventListener("DOMContentLoaded",()=>{initPosition();initMap();});
</script>
</body>
</html>
