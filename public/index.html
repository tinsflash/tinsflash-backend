<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="robots" content="index,follow">
  <title>üå¶Ô∏è TINSFLASH ‚Äì Pr√©visions & Alertes m√©t√©o IA</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <!-- Google Ads -->
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6828365665232268" crossorigin="anonymous"></script>

  <style>
    body { margin:0; font-family:"Segoe UI",sans-serif; background:#eef2f7; color:#222; }
    header video {
      width:100%; height:260px; object-fit:cover; display:block;
      border-bottom:3px solid #1976d2;
    }
    main { padding:14px; max-width:950px; margin:auto; display:flex; flex-direction:column; gap:22px; }
    .section { background:#fff; border-radius:10px; padding:16px; box-shadow:0 2px 8px rgba(0,0,0,0.1); }
    h2 { color:#1565c0; font-size:1.1rem; margin-bottom:8px; border-bottom:1px solid #bbdefb; padding-bottom:4px; }
    .forecast-icons { display:flex; gap:12px; flex-wrap:wrap; justify-content:center; margin-top:10px; }
    .forecast-day { background:#e3f2fd; border-radius:8px; padding:10px; width:100px; text-align:center; }
    .forecast-day img { width:48px; height:48px; }
    #mapForecast,#mapAlerts { width:100%; height:320px; border-radius:10px; margin-top:8px; }
    #radar { width:100%; height:360px; border:0; border-radius:10px; }

    /* Fan Club */
    #fanClub { display:flex; flex-direction:column; gap:8px; }
    input[type="email"] { padding:8px; border:1px solid #ccc; border-radius:6px; }
    button { background:#1565c0; color:white; border:none; padding:8px 14px; border-radius:6px; font-weight:bold; cursor:pointer; }
    button:hover { background:#0d47a1; }

    /* Chat flottant Jean */
    #chatBtn {
      position:fixed; bottom:18px; right:18px;
      width:72px; height:72px;
      background:url('/avatars/jean-default.png') center/cover no-repeat;
      border-radius:50%;
      box-shadow:0 0 12px rgba(0,0,0,0.4);
      cursor:pointer; z-index:1000;
      animation:pulse 2.5s infinite;
      border:3px solid #4fc3f7;
    }
    @keyframes pulse {
      0%{box-shadow:0 0 6px #4fc3f7;}
      50%{box-shadow:0 0 16px #4fc3f7;}
      100%{box-shadow:0 0 6px #4fc3f7;}
    }
    #chatBox {
      position:fixed; bottom:100px; right:18px;
      width:320px; height:400px; display:none; flex-direction:column;
      background:white; border-radius:14px;
      box-shadow:0 4px 14px rgba(0,0,0,0.35);
      z-index:1001;
    }
    #chatHeader {
      background:#1565c0; color:white;
      padding:10px; border-radius:14px 14px 0 0;
      font-weight:bold; text-align:center;
    }
    #chatMessages { flex:1; padding:10px; overflow-y:auto; font-size:0.9rem; }
    .msgUser { text-align:right; background:#e3f2fd; margin:6px; padding:6px 8px; border-radius:10px; display:inline-block; }
    .msgBot { text-align:left; background:#f5f5f5; margin:6px; padding:6px 8px; border-radius:10px; display:inline-block; }
    #chatInput { display:flex; border-top:1px solid #ccc; }
    #chatInput input { flex:1; border:none; padding:8px; }
    #chatInput button { background:#1565c0; border:none; color:white; padding:8px 12px; }

    footer { text-align:center; font-size:0.85rem; color:#555; padding:20px 10px; background:#f5f5f5; border-top:1px solid #ddd; }

    @media(max-width:700px){
      #mapForecast,#mapAlerts,#radar{height:260px;}
      #chatBox{width:90%; right:5%;}
    }
  </style>
</head>
<body>
  <header>
    <video autoplay muted loop playsinline>
      <source src="intro-jean.mp4" type="video/mp4">
    </video>
  </header>

  <main>
    <section class="section">
      <h2>üåç Bienvenue sur TINSFLASH</h2>
      <p>
        TINSFLASH combine l‚Äôintelligence artificielle, les mod√®les m√©t√©orologiques les plus r√©cents et les donn√©es locales
        pour produire des pr√©visions ultra-pr√©cises, adapt√©es √† ta position et actualis√©es plusieurs fois par jour.
      </p>
    </section>

    <section class="section">
      <h2>üìç Pr√©visions locales du jour</h2>
      <div id="localForecast">Chargement...</div>
      <div class="forecast-icons" id="iconsToday"></div>
    </section>

    <section class="section">
      <h2>üå¶Ô∏è Pr√©visions nationales & 7 jours</h2>
      <div id="nationalForecast">Chargement...</div>
      <div class="forecast-icons" id="iconsWeek"></div>
    </section>

    <section class="section">
      <h2>üö® Alertes locales & nationales</h2>
      <div id="alertsList"></div>
    </section>

    <section class="section">
      <h2>üó∫Ô∏è Pr√©visions sur carte</h2>
      <div id="mapForecast"></div>
    </section>

    <section class="section">
      <h2>üåç Carte des alertes</h2>
      <div id="mapAlerts"></div>
    </section>

    <section class="section">
      <h2>üõ∞Ô∏è Radar en direct</h2>
      <iframe id="radar" src="https://embed.windy.com/embed2.html?lat=50&lon=4&zoom=5&level=surface&overlay=rain&menu=&message=true&type=map&location=coordinates&detail=true&metricWind=default&metricTemp=default" allowfullscreen></iframe>
    </section>

    <section class="section">
      <h2>üíå TINS'Fan Club & avantages</h2>
      <form id="fanClub">
        <input type="email" id="email" placeholder="Ton email pour rejoindre le Fan Club" required />
        <label><input type="checkbox" id="consent" required> J'accepte la politique RGPD (inscription gratuite, infos m√©t√©o locales)</label>
        <button type="button" onclick="registerFan()">Je rejoins üéâ</button>
      </form>
      <div id="fanMsg"></div>
    </section>
  </main>

  <!-- Jean IA -->
  <div id="chatBtn" onclick="toggleChat()" title="Parler √† Jean IA"></div>
  <div id="chatBox">
    <div id="chatHeader">üí¨ Jean ‚Äì Assistant m√©t√©o IA</div>
    <div id="chatMessages"></div>
    <div id="chatInput">
      <input type="text" id="msgInput" placeholder="Demande √† Jean..." />
      <button onclick="sendMsg()">‚û§</button>
    </div>
  </div>

  <footer>
    <p>¬© 2025 <strong>TINSFLASH</strong> ‚Äì Tous droits r√©serv√©s.<br>
    Pour partenariat, presse ou acquisition de notre moteur m√©t√©o :  
    <a href="mailto:skysnapia@gmail.com">skysnapia@gmail.com</a> ‚Äì  
    WhatsApp : <a href="https://wa.me/32473264477">0032 473 26 44 77</a>
    </p>
  </footer>

  <script>
    const mapF=L.map("mapForecast").setView([20,0],2);
    const mapA=L.map("mapAlerts").setView([20,0],2);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:"¬© OpenStreetMap"}).addTo(mapF);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:"¬© OpenStreetMap"}).addTo(mapA);

    async function loadData(){
      try{
        const st=await fetch("/api/status").then(r=>r.json());
        document.getElementById("localForecast").innerText="Pr√©vision locale disponible.";
        document.getElementById("nationalForecast").innerText="Pr√©vision nationale g√©n√©r√©e ("+(st.finalReport?.accuracy||"95% de fiabilit√©")+")";

        // Ic√¥nes
        ["‚òÄÔ∏è","üå¶Ô∏è","üåßÔ∏è","‚õÖ"].forEach(i=>{
          const d=document.createElement("div");
          d.className="forecast-day";
          d.innerHTML=`<div style='font-size:30px'>${i}</div><div>Jour</div>`;
          iconsToday.appendChild(d);
        });
        for(let i=1;i<=7;i++){
          const d=document.createElement("div");
          d.className="forecast-day";
          d.innerHTML=`<img src="/icons/${i}.png" alt="J${i}"><div>J+${i}</div>`;
          iconsWeek.appendChild(d);
        }

        const al=await fetch("/api/alerts").then(r=>r.json());
        const list=document.getElementById("alertsList"); list.innerHTML="";
        al.forEach(a=>{
          const li=document.createElement("div");
          li.innerHTML=`<b>${a.country||"?"}</b>: ${a.title||"Alerte m√©t√©o"}`;
          list.appendChild(li);
          if(a.lat&&a.lon)L.circle([a.lat,a.lon],{radius:120000,color:"red",fillOpacity:0.5}).addTo(mapA);
        });
      }catch(e){console.warn(e);}
    }
    loadData();

    // === CHAT JEAN (Cohere) ===
    function toggleChat(){
      const c=document.getElementById("chatBox");
      c.style.display=c.style.display==="flex"?"none":"flex";
    }
    async function sendMsg(){
      const input=document.getElementById("msgInput");
      const text=input.value.trim();
      if(!text)return;
      const chat=document.getElementById("chatMessages");
      chat.innerHTML+=`<div class='msgUser'>${text}</div>`;
      input.value="";
      const res=await fetch("/api/jean",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({message:text})});
      const data=await res.json();
      chat.innerHTML+=`<div class='msgBot'><b>Jean:</b> ${data.reply}</div>`;
      chat.scrollTop=chat.scrollHeight;
    }

    // === FAN CLUB ===
    async function registerFan(){
      const email=document.getElementById("email").value.trim();
      const consent=document.getElementById("consent").checked;
      if(!email||!consent)return alert("Merci de renseigner ton email et d'accepter le RGPD");
      const res=await fetch("/api/register-fan",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email})});
      const data=await res.json();
      document.getElementById("fanMsg").innerText=data.success?"Bienvenue üéâ":"Erreur : "+(data.message||data.error);
    }
  </script>
</body>
</html>
