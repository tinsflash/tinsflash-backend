<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TINSFLASH ‚Äì Pr√©visions m√©t√©o et alertes avec IA</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; background: #f3f6fa; color: #111827; }
    header { position: relative; width: 100%; height: 220px; overflow: hidden; }
    header video { width: 100%; height: 100%; object-fit: cover; }
    header .overlay { position: absolute; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.35); display: flex; align-items: center; justify-content: center;
      color: white; font-size: 26px; font-weight: bold; text-align: center; padding: 10px; }
    main { padding: 20px; max-width: 900px; margin: auto; }
    h2 { color: #1e40af; margin-top: 20px; }
    .forecast { display: grid; grid-template-columns: repeat(auto-fill,minmax(120px,1fr));
      gap: 12px; margin-top: 15px; }
    .day { background: white; border-radius: 10px; padding: 10px; text-align: center;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
    iframe { width: 100%; height: 400px; border: none; border-radius: 10px; margin-top: 15px; }
    /* Widget J.E.A.N. */
    #jean-bubble { position: fixed; bottom: 20px; right: 20px;
      background: linear-gradient(135deg,#2563eb,#1e3a8a); color: white;
      border-radius: 50px; padding: 12px 20px; cursor: pointer; font-weight: bold;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index: 9999; }
    #jean-window { display: none; position: fixed; bottom: 80px; right: 20px; width: 320px;
      height: 420px; background: white; border-radius: 12px; box-shadow: 0 8px 20px rgba(0,0,0,0.25);
      z-index: 9999; display: flex; flex-direction: column; overflow: hidden; }
    @media(max-width:600px){ #jean-window { width: 100%; height: 100%; bottom: 0; right: 0; border-radius: 0; } }
    #jean-header { background: #2563eb; color: white; padding: 10px; font-weight: bold; text-align: center; }
    #jean-chat { flex: 1; padding: 10px; overflow-y: auto; font-size: 14px; display: flex; flex-direction: column; }
    .msg { margin: 6px 0; padding: 8px 12px; border-radius: 12px; max-width: 85%; line-height: 1.4; }
    .user { background: #e0f2fe; align-self: flex-end; } .jean { background: #f3f4f6; align-self: flex-start; }
    #jean-input { display: flex; padding: 10px; border-top: 1px solid #eee; gap: 5px; }
    #jean-input input { flex: 1; border: 1px solid #ccc; border-radius: 8px; padding: 8px; }
    #jean-input button { border: none; border-radius: 8px; padding: 8px 10px; cursor: pointer; font-size: 14px; font-weight: bold; }
    #jean-input .send { background: #2563eb; color: white; } #jean-input .mic { background: #059669; color: white; }
  </style>
</head>
<body>
  <!-- Bandeau pub -->
  <div style="background:#ddd;text-align:center;padding:8px;">[Google Ads Banner]</div>

  <header>
    <video autoplay muted loop>
      <source src="intro.mp4" type="video/mp4" />
    </video>
    <div class="overlay">üåç Les pr√©visions et alertes m√©t√©o les plus pr√©cises du monde, renforc√©es par l‚ÄôIA</div>
  </header>

  <main>
    <h2>üìç Localisation</h2>
    <div style="display:flex;gap:10px;flex-wrap:wrap;">
      <input id="address" type="text" placeholder="Entrez votre ville ou adresse"
             style="flex:2;padding:10px;border-radius:8px;border:1px solid #ccc;">
      <select id="country" style="flex:1;padding:10px;border-radius:8px;border:1px solid #ccc;">
        <option value="BE">Belgique</option><option value="FR">France</option>
        <option value="US">√âtats-Unis</option><option value="UK">Royaume-Uni</option>
        <option value="DE">Allemagne</option><option value="IT">Italie</option>
      </select>
      <button onclick="loadForecast()" style="padding:10px 15px;border:none;border-radius:8px;
              background:#2563eb;color:white;font-weight:bold;">OK</button>
    </div>
    <button onclick="geolocate()" style="margin-top:10px;padding:8px 12px;border:none;
            border-radius:8px;background:#059669;color:white;font-weight:bold;">
      üì° Utiliser ma position
    </button>

    <h2>üå§Ô∏è Pr√©visions locales</h2>
    <div id="local-forecast" class="forecast"></div>

    <h2>üèõÔ∏è Pr√©visions nationales</h2>
    <div id="national-forecast" class="forecast"></div>

    <h2>üö® Alertes m√©t√©o</h2>
    <div id="alerts"></div>

    <h2>üåç Radar m√©t√©o (Windy)</h2>
    <iframe id="radar" src="https://embed.windy.com/embed2.html?lat=50&lon=4&detailLat=50&detailLon=4&width=650&height=400&zoom=5&level=surface&overlay=rain&product=ecmwf&menu=&message=true&marker=true&calendar=&pressure=&type=map&location=coordinates&detail=true&metricWind=default&metricTemp=default&radarRange=-1"></iframe>
  </main>

  <div style="background:#ddd;text-align:center;padding:8px;">[Google Ads Footer]</div>

  <!-- Widget J.E.A.N. -->
  <div id="jean-bubble">ü§ñ IA J.E.A.N.</div>
  <div id="jean-window">
    <div id="jean-header">Assistant m√©t√©o J.E.A.N.</div>
    <div id="jean-chat"></div>
    <div id="jean-input">
      <input id="jean-question" type="text" placeholder="Posez une question..." />
      <button class="send" onclick="askJean()">‚û§</button>
      <button class="mic" onclick="startVoice()">üé§</button>
    </div>
  </div>

  <script>
    async function loadForecast(lat=50.5, lon=4.5){
      const country=document.getElementById("country").value;
      const localDiv=document.getElementById("local-forecast");
      const nationalDiv=document.getElementById("national-forecast");
      const alertsDiv=document.getElementById("alerts");
      localDiv.innerHTML="‚è≥ Chargement...";
      nationalDiv.innerHTML="‚è≥ Chargement...";
      alertsDiv.innerHTML="‚è≥ Chargement...";

      try{
        const loc=await fetch(`/api/forecast/local?lat=${lat}&lon=${lon}&country=${country}`).then(r=>r.json());
        localDiv.innerHTML=loc.forecast||"Pas de donn√©es";

        const nat=await fetch(`/api/forecast/national?country=${country}`).then(r=>r.json());
        nationalDiv.innerHTML=JSON.stringify(nat.forecasts,null,2);

        const al=await fetch("/api/alerts/active").then(r=>r.json());
        alertsDiv.innerHTML=JSON.stringify(al,null,2);

        // Mise √† jour radar Windy
        document.getElementById("radar").src =
          `https://embed.windy.com/embed2.html?lat=${lat}&lon=${lon}&detailLat=${lat}&detailLon=${lon}&width=650&height=400&zoom=6&level=surface&overlay=rain&product=ecmwf&marker=true&detail=true`;
      }catch(e){
        localDiv.innerHTML=nationalDiv.innerHTML=alertsDiv.innerHTML="‚ùå Erreur: "+e.message;
      }
    }

    function geolocate(){
      if(navigator.geolocation){
        navigator.geolocation.getCurrentPosition(
          pos=>{loadForecast(pos.coords.latitude,pos.coords.longitude);},
          err=>{alert("Impossible d‚Äôobtenir la g√©olocalisation.");}
        );
      }else{
        alert("La g√©olocalisation n‚Äôest pas support√©e par ce navigateur.");
      }
    }

    // === J.E.A.N. ===
    const bubble=document.getElementById("jean-bubble");
    const windowJean=document.getElementById("jean-window");
    const chatBox=document.getElementById("jean-chat");
    bubble.onclick=()=>{windowJean.style.display=windowJean.style.display==="none"?"flex":"none";};
    async function askJean(){
      const input=document.getElementById("jean-question");
      const question=input.value.trim(); if(!question) return; input.value="";
      addMessage(question,"user"); addMessage("‚è≥ J.E.A.N. r√©fl√©chit...","jean");
      try{
        const res=await fetch("/api/cohere",{method:"POST",headers:{"Content-Type":"application/json"},
          body:JSON.stringify({question,category:"grand public"})});
        const data=await res.json();
        const answer=data.answer||"‚ùå Pas de r√©ponse de J.E.A.N.";
        updateLastMessage("üë®‚Äçüî¨ "+answer); speakAnswer(answer);
      }catch(e){updateLastMessage("‚ùå Erreur : "+e.message);}
    }
    function addMessage(text,type){const msg=document.createElement("div"); msg.className="msg "+type;
      msg.innerText=text; chatBox.appendChild(msg); chatBox.scrollTop=chatBox.scrollHeight;}
    function updateLastMessage(text){const msgs=chatBox.getElementsByClassName("msg");
      if(msgs.length>0){msgs[msgs.length-1].innerText=text;}}
    function startVoice(){const Rec=window.SpeechRecognition||window.webkitSpeechRecognition;
      if(!Rec){alert("Pas de reconnaissance vocale support√©e.");return;}
      const recognition=new Rec(); recognition.lang="fr-FR"; recognition.start();
      recognition.onresult=(e)=>{document.getElementById("jean-question").value=e.results[0][0].transcript; askJean();};}
    function speakAnswer(text){if(!text) return; const utter=new SpeechSynthesisUtterance(text); utter.lang="fr-FR";
      const voices=speechSynthesis.getVoices(); const male=voices.find(v=>v.lang.startsWith("fr")&&/homme|male|Paul|Thomas|Herv√©|Lo√Øc/i.test(v.name));
      if(male) utter.voice=male; utter.rate=0.9; utter.pitch=0.8; speechSynthesis.cancel(); speechSynthesis.speak(utter);}
    speechSynthesis.onvoiceschanged=()=>{};
  </script>
</body>
</html>
