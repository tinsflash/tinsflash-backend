<!-- PATH: public/admin-alerts.html -->
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="robots" content="noindex,nofollow" />
  <title>🌋 Alertes Mondiales – TINSFLASH Everest v1.1</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    body{background:#060c14;color:#eaf2ff;font-family:"Segoe UI",sans-serif;margin:0;overflow-x:hidden}
    header{background:#08121d;padding:12px 20px;font-size:20px;font-weight:bold;color:#6bf3ff;display:flex;justify-content:space-between;align-items:center}
    header button{background:#142739;color:#6bf3ff;border:1px solid #6bf3ff;border-radius:6px;padding:6px 12px;cursor:pointer}
    .sidebar{position:fixed;top:0;left:0;height:100%;width:200px;background:#08121d;overflow-y:auto;transition:all .3s;padding-top:60px}
    .sidebar a{display:block;color:#9ad6ff;padding:10px 15px;text-decoration:none;font-size:14px}
    .sidebar a:hover{background:#102030;color:#fff}
    .toggle-btn{position:fixed;top:15px;left:15px;background:#08121d;border:1px solid #6bf3ff;border-radius:4px;padding:4px 8px;color:#6bf3ff;cursor:pointer;font-size:16px;z-index:9999}
    .filters{display:flex;justify-content:space-around;padding:10px;background:#091626;margin-left:200px;transition:margin-left .3s}
    .collapsed .filters{margin-left:0}
    button{background:#132334;color:white;border:1px solid #6bf3ff;padding:6px 12px;border-radius:6px;cursor:pointer}
    #map{height:420px;margin:10px 10px 20px 210px;border-radius:10px;overflow:hidden;transition:margin-left .3s}
    .collapsed #map{margin-left:10px}
    table{width:96%;margin:20px auto 80px;border-collapse:collapse;background:#101a25;color:#cce6ff;font-size:14px}
    th,td{border-bottom:1px solid #223;padding:6px 8px;text-align:left}
    th{background:#152236;color:#6bf3ff;font-weight:600}
    .status-auto_published{color:#00ffb7}.status-validated{color:#ffe66b}.status-under_watch{color:#ff7f50}
    .log-box{background:#0d1827;color:#9ad6ff;padding:8px;height:160px;overflow-y:auto;margin:8px 10px 10px 210px;border-radius:8px;font-size:13px;transition:margin-left .3s}
    .collapsed .log-box{margin-left:10px}
    footer{position:fixed;bottom:0;left:0;right:0;background:#08121d;text-align:center;padding:6px;font-size:12px;color:#6bf3ff}
    @media(max-width:768px){
      .sidebar{width:0;padding-top:0}
      #map,.log-box{margin-left:10px}
      .filters{flex-direction:column;gap:5px;margin-left:0}
    }
  </style>
</head>
<body>
  <div class="toggle-btn" onclick="toggleSidebar()">☰</div>

  <div class="sidebar" id="sidebar">
    <a href="/admin-pp.html">🛰️ Console moteur</a>
    <a href="/admin-alerts.html">🌋 Alertes</a>
    <a href="/admin-chat.html">💬 Chat IA</a>
    <a href="/admin-radar.html">🌦️ Radar & News</a>
    <a href="/admin-users.html">👥 Utilisateurs</a>
    <a href="/admin-index.html">🏠 Index</a>
  </div>

  <header>
    🌋 Console des Alertes Mondiales – Everest v1.1
    <button onclick="loadAlerts()">🔄 Rafraîchir</button>
  </header>

  <div class="filters">
    <button onclick="loadAlerts('all')">🌐 Toutes</button>
    <button onclick="loadAlerts('auto_published')">🚀 Auto-publiées (≥90%)</button>
    <button onclick="loadAlerts('validated')">🟡 À valider (70–89%)</button>
    <button onclick="loadAlerts('under_watch')">🟠 En surveillance (&lt;70%)</button>
  </div>

  <div id="map"></div>

  <h3 style="padding-left:20px;color:#6bf3ff;">📡 Derniers logs d’alertes (temps réel)</h3>
  <div id="logBox" class="log-box"></div>

  <table id="alertsTable">
    <thead>
      <tr>
        <th>Pays / Région</th>
        <th>Type</th>
        <th>Certitude %</th>
        <th>Détectée le</th>
        <th>Dernière vérif.</th>
        <th>Statut</th>
        <th>Sources</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <footer>© TINSFLASH – Everest Protocol v1.1 | Toutes données réelles</footer>

  <script>
    const body=document.body;
    function toggleSidebar(){body.classList.toggle("collapsed");}

    let map=L.map("map").setView([20,0],2);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:"© OpenStreetMap"}).addTo(map);
    let markers=[];

    async function loadAlerts(filter="all"){
      try{
        const res=await fetch("/api/alerts");
        const alerts=await res.json();
        const tbody=document.querySelector("#alertsTable tbody");
        tbody.innerHTML="";
        markers.forEach(m=>map.removeLayer(m));markers=[];

        for(const a of alerts){
          const certainty=a.certainty||a.data?.confidence||0;
          const status=certainty>=90?"auto_published":certainty>=70?"validated":"under_watch";
          if(filter!=="all"&&status!==filter)continue;

          const color=certainty>=90?"lime":certainty>=70?"gold":"orange";
          const lat=a.geo?.lat||a.lat||a.data?.geo?.lat||0;
          const lon=a.geo?.lon||a.lon||a.data?.geo?.lon||0;
          const marker=L.circleMarker([lat,lon],{color,radius:6,fillOpacity:.8})
            .addTo(map)
            .bindPopup(`<b>${a.zone||a.country||"?"}</b><br>${a.title||a.data?.type||"?"}<br><b>${certainty}%</b>`);
          markers.push(marker);

          const tr=document.createElement("tr");
          tr.innerHTML=`
            <td>${a.zone||a.country||"-"} / ${a.region||"-"}</td>
            <td>${a.title||a.data?.type||"?"}</td>
            <td>${certainty}</td>
            <td>${a.firstDetection?new Date(a.firstDetection).toLocaleString():"-"}</td>
            <td>${a.lastCheck?new Date(a.lastCheck).toLocaleString():"-"}</td>
            <td class="status-${status}">${status.replace("_"," ")}</td>
            <td>${(a.sources||[]).join(", ")||"-"}</td>
            <td>
              <button onclick="publishAlert('${a._id}')">Publier</button>
              <button onclick="holdAlert('${a._id}')">Attente</button>
              <button onclick="deleteAlert('${a._id}')">Suppr.</button>
            </td>`;
          tbody.appendChild(tr);
        }
      }catch(err){console.error("Erreur chargement alertes :",err);}
    }

    async function publishAlert(id){
      const res=await fetch(`/api/alerts/export/${id}`,{method:"POST"});
      if(res.ok)loadAlerts();
    }
    async function holdAlert(id){
      await fetch(`/api/alerts/status/${id}`,{
        method:"PUT",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({action:"under_watch"})
      });
      loadAlerts();
    }
    async function deleteAlert(id){
      await fetch(`/api/alerts/${id}`,{method:"DELETE"});
      loadAlerts();
    }

    // 🔥 Flux temps réel
    const logBox=document.getElementById("logBox");
    const evtSrc=new EventSource("/api/logs/stream");
    evtSrc.onmessage=(ev)=>{
      try{
        const data=JSON.parse(ev.data);
        if(data.message?.includes("🚨")||data.message?.includes("Alerte")){
          const p=document.createElement("div");
          p.textContent=data.message;
          logBox.appendChild(p);
          logBox.scrollTop=logBox.scrollHeight;
        }
      }catch{}
    };

    loadAlerts();
    setInterval(()=>loadAlerts(),120000); // auto refresh 2 min
  </script>
</body>
</html>
