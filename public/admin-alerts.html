<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="robots" content="noindex,nofollow" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>üö® TINSFLASH PRO+++ ‚Äì Alertes</title>
  <style>
    body{margin:0;background:#0a111d;color:#e6f6ff;font-family:Inter,system-ui}
    header{padding:14px;text-align:center;background:#08121d;color:#6bf3ff;font-weight:700;font-size:1.1rem}
    nav{display:flex;justify-content:center;gap:12px;padding:10px;background:#0d1624}
    nav a{color:#6bf3ff;text-decoration:none;font-weight:600}
    nav a:hover{text-decoration:underline}
    main{max-width:1100px;margin:0 auto;padding:12px}
    h2{color:#6bf3ff;border-bottom:1px solid #203040;padding-bottom:4px}
    iframe{width:100%;height:480px;border:0;border-radius:10px;margin-bottom:14px}
    details{background:#0d1624;margin:6px 0;border-radius:8px;padding:8px}
    summary{cursor:pointer;font-weight:600;color:#6bf3ff}
    .alert-item{margin:6px 0;padding:6px;border-radius:6px}
    .primeur{background:#3b006b;color:#fff}
    .a90{background:#003b1d;color:#76ff7a}
    .a70{background:#4f2a00;color:#ffc978}
    .aSub70{background:#3b0000;color:#ff6b6b}
    .logs{background:#0d1624;padding:8px;border-radius:10px;height:220px;overflow:auto;font-family:monospace;font-size:0.9rem}
    /* Chat */
    #chatBox{margin-top:16px;background:#0e1725;border-radius:10px;padding:8px;height:400px;display:flex;flex-direction:column}
    #chatMessages{flex:1;overflow:auto;padding:6px}
    #chatControls{display:flex;gap:4px}
    #chatControls input{flex:1;padding:8px;border:none;background:#07121a;color:#e6f6ff;border-radius:6px}
    #chatControls button{background:#4fc3f7;border:none;color:#001;font-weight:700;padding:8px 10px;border-radius:6px}
    .msg-bot{background:#123045;padding:6px;border-radius:8px;margin:5px 0}
    .msg-user{background:#4fc3f7;color:#001;padding:6px;border-radius:8px;margin:5px 0;text-align:right}
  </style>
</head>
<body>

<script>
const pin=sessionStorage.getItem("tinsflashPIN");
if(!pin){const p=prompt("Code d‚Äôacc√®s admin ?");if(p!=="202679"){alert("Acc√®s refus√©");location.href="/";}else sessionStorage.setItem("tinsflashPIN","ok");}
</script>

<header>üö® TINSFLASH PRO+++ ‚Äì Gestion des Alertes IA J.E.A.N</header>
<nav>
  <a href="/admin-pp.html">Console</a>
  <a href="/admin-alerts.html">Alertes</a>
  <a href="/admin-chat.html">Chat</a>
  <a href="/admin-radar.html">Radar</a>
  <a href="/index.html">Index public</a>
</nav>

<main>
  <h2>üåç Carte des alertes connect√©e</h2>
  <iframe src="/admin-radar.html#alerts" id="alertsMap"></iframe>

  <h2>üåê Alertes Primeur (publi√©es avant autres services)</h2>
  <div id="primeurList"></div>

  <h2>‚úÖ Alertes auto-publi√©es > 90 %</h2>
  <div id="autoList"></div>

  <h2>‚ö†Ô∏è Alertes 70 ‚Äì 89 % (analyse humaine requise)</h2>
  <div id="analyseList"></div>

  <h2>üîç Alertes < 70 % (surveillance IA continue)</h2>
  <div id="subList"></div>

  <h2>üß† Chat IA M√©t√©o (GPT-4o-mini)</h2>
  <div id="chatBox">
    <div id="chatMessages">
      <div class="msg-bot">ü§ñ J.E.A.N : Connect√© au moteur ‚Äì mode m√©t√©o administrateur</div>
    </div>
    <div id="chatControls">
      <input id="chatInput" placeholder="Pose ta question m√©t√©o..." onkeypress="if(event.key==='Enter')sendChat()">
      <button onclick="sendChat()">‚Üí</button>
    </div>
  </div>

  <h2>üìú Logs</h2>
  <div class="logs" id="logs"></div>
</main>

<script>
const API="/api";

/* Chargement des alertes */
async function loadAlerts(){
  try{
    const r=await fetch(`${API}/logs-live`);
    const j=await r.json();
    const logs=document.getElementById("logs");
    logs.innerText=j.logs.map(x=>x.message).join("\n");

    // Simulation / connexion r√©elle : r√©cup√©rer alertes via runWorldAlerts() ou Mongo
    const alerts=j.checkup?.alerts||[];
    const primeur=alerts.filter(a=>a.primeur);
    const auto=alerts.filter(a=>a.fiabilite>=90);
    const analyse=alerts.filter(a=>a.fiabilite>=70 && a.fiabilite<90);
    const sub=alerts.filter(a=>a.fiabilite<70);

    fillList("primeurList",primeur,"primeur");
    fillList("autoList",auto,"a90");
    fillList("analyseList",analyse,"a70");
    fillList("subList",sub,"aSub70");
  }catch(e){
    document.getElementById("logs").innerText="Erreur chargement alertes : "+e.message;
  }
}

function fillList(id,arr,cls){
  const el=document.getElementById(id);
  if(!arr?.length){el.innerHTML="<i>Aucune donn√©e pour le moment</i>";return;}
  el.innerHTML=arr.map(a=>`
    <details class="alert-item ${cls}">
      <summary>${a.zone||"Zone inconnue"} ‚Äì Fiabilit√© : ${a.fiabilite||"?"}%</summary>
      <div><b>Description :</b> ${a.description||"‚Äì"}</div>
      <div><b>Type :</b> ${a.type||"‚Äì"}</div>
      <div><b>D√©but :</b> ${a.debut||"‚Äì"}<br><b>Fin :</b> ${a.fin||"‚Äì"}</div>
      <div><b>Actions :</b> 
        <button onclick="validerAlerte('${a.id}')">Valider</button> 
        <button onclick="surveillerAlerte('${a.id}')">Surveillance</button>
      </div>
    </details>`).join("");
}

function validerAlerte(id){alert("Validation envoy√©e pour "+id);}
function surveillerAlerte(id){alert("Alerte mise en surveillance "+id);}

/* Chat */
async function sendChat(){
  const txt=document.getElementById("chatInput").value.trim();
  if(!txt)return;
  const msgs=document.getElementById("chatMessages");
  msgs.innerHTML+=`<div class='msg-user'>${txt}</div>`;
  document.getElementById("chatInput").value="";
  try{
    const res=await fetch("/api/ai-admin",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({message:txt,mode:"meteo"})});
    const j=await res.json();
    msgs.innerHTML+=`<div class='msg-bot'>${j.reply||j}</div>`;
    msgs.scrollTop=msgs.scrollHeight;
  }catch(e){msgs.innerHTML+=`<div class='msg-bot'>‚ùå Erreur : ${e.message}</div>`;}
}

loadAlerts();
setInterval(loadAlerts,120000);
</script>
</body>
</html>
