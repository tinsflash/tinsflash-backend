<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="robots" content="noindex,nofollow" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>🌋 Alertes Mondiales – TINSFLASH</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    body{margin:0;background:#060c14;color:#eaf2ff;font-family:Inter,system-ui}
    header{display:flex;align-items:center;justify-content:space-between;padding:12px 18px;background:#08121d;color:#6bf3ff;font-weight:700}
    .sidebar{position:fixed;left:0;top:0;height:100%;width:200px;background:#08121d;padding-top:70px}
    .sidebar a{display:block;padding:10px 14px;color:#9ad6ff;text-decoration:none}
    .main{margin-left:210px;padding:12px}
    #map{height:420px;border-radius:8px}
    table{width:100%;border-collapse:collapse;margin-top:12px;background:#0f1a24}
    th,td{padding:8px;border-bottom:1px solid #08202a}
    th{background:#0b1722;color:#6bf3ff}
    .log-box{background:#07151d;padding:8px;border-radius:8px;height:160px;overflow:auto}
    @media(max-width:800px){.sidebar{display:none}.main{margin-left:12px}}
  </style>
</head>
<body>
<script>
  const pin = sessionStorage.getItem("tinsflashPIN");
  if(!pin){ const p=prompt("Code d’accès admin ?"); if(p!=="202679"){ alert("Accès refusé"); location.href="/"; } else sessionStorage.setItem("tinsflashPIN","ok"); }
</script>

<header>
  <div style="font-size:18px">🌋 Console Alertes – TINSFLASH</div>
  <div><button onclick="loadAlerts()">🔄 Rafraîchir</button></div>
</header>

<div class="sidebar">
  <a href="/admin-pp.html">🛰️ Console</a>
  <a href="/admin-alerts.html">🌋 Alertes</a>
  <a href="/admin-chat.html">💬 Chat</a>
  <a href="/admin-radar.html">🌦️ Radar</a>
  <a href="/admin-users.html">👥 Utilisateurs</a>
  <a href="/admin-index.html">🏠 Index</a>
</div>

<div class="main">
  <div style="display:flex;gap:8px;flex-wrap:wrap">
    <button onclick="loadAlerts('all')">Toutes</button>
    <button onclick="loadAlerts('auto_published')">Auto-publiées ≥90%</button>
    <button onclick="loadAlerts('validated')">70–89%</button>
    <button onclick="loadAlerts('under_watch')"><70%</button>
  </div>

  <div id="map"></div>

  <h3 style="margin-top:12px">📡 Logs d'alerte (temps réel)</h3>
  <div id="logBox" class="log-box"></div>

  <table id="alertsTable">
    <thead>
      <tr><th>Pays / Région</th><th>Type</th><th>Certitude</th><th>Détectée</th><th>Dernière vérif.</th><th>Statut</th><th>Sources</th><th>Actions</th></tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
  const map = L.map("map").setView([20,0],2);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);
  let markers = [];

  async function loadAlerts(filter="all"){
    try{
      const res = await fetch("/api/alerts");
      const alerts = await res.json();
      const tbody = document.querySelector("#alertsTable tbody");
      tbody.innerHTML = "";
      markers.forEach(m=>map.removeLayer(m)); markers=[];

      for(const a of alerts){
        const certainty = a.certainty || a.data?.confidence || 0;
        const status = certainty >= 90 ? "auto_published" : certainty >= 70 ? "validated" : "under_watch";
        if(filter !== "all" && status !== filter) continue;
        const color = certainty >= 90 ? "lime" : certainty >= 70 ? "gold" : "orange";
        const lat = a.geo?.lat || a.lat || a.data?.geo?.lat || 0;
        const lon = a.geo?.lon || a.lon || a.data?.geo?.lon || 0;
        const mk = L.circleMarker([lat,lon],{color,radius:6,fillOpacity:0.9}).addTo(map).bindPopup(`<b>${a.zone||a.country||"?"}</b><br>${a.title || a.data?.type || ""}<br>${certainty}%`);
        markers.push(mk);

        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${a.zone||a.country||"-"} / ${a.region||"-"}</td>
                        <td>${a.title||a.data?.type||"?"}</td>
                        <td>${certainty}</td>
                        <td>${a.firstDetection ? new Date(a.firstDetection).toLocaleString() : "-"}</td>
                        <td>${a.lastCheck ? new Date(a.lastCheck).toLocaleString() : "-"}</td>
                        <td>${status.replace("_"," ")}</td>
                        <td>${(a.sources||[]).join(", ")||"-"}</td>
                        <td>
                          <button onclick="publishAlert('${a._id}')">Publier</button>
                          <button onclick="holdAlert('${a._1d}')">Attente</button>
                          <button onclick="deleteAlert('${a._id}')">Suppr</button>
                        </td>`;
        tbody.appendChild(tr);
      }
    } catch(err){ console.error(err); }
  }

  async function publishAlert(id){
    await fetch(`/api/alerts/export/${id}`,{method:"POST"});
    loadAlerts();
  }
  async function holdAlert(id){
    await fetch(`/api/alerts/status/${id}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"under_watch"})});
    loadAlerts();
  }
  async function deleteAlert(id){
    await fetch(`/api/alerts/${id}`,{method:"DELETE"});
    loadAlerts();
  }

  // logs SSE
  const logBox = document.getElementById("logBox");
  const es = new EventSource("/api/logs/stream");
  es.onmessage = ev => {
    try{
      const d = JSON.parse(ev.data);
      if(!d) return;
      if(d.message && (d.message.includes("🚨") || d.message.toLowerCase().includes("alerte"))){
        const p = document.createElement("div");
        p.textContent = d.message;
        logBox.appendChild(p);
        logBox.scrollTop = logBox.scrollHeight;
      }
    }catch(e){}
  };

  loadAlerts();
  setInterval(()=>loadAlerts(), 120000);
</script>
</body>
</html>
