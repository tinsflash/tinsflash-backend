<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="robots" content="noindex,nofollow">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TINSFLASH â€“ Console Alertes IA</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <style>
    body{background:#000818;color:#d4e7ff;font-family:Orbitron,sans-serif;margin:0}
    header{background:linear-gradient(90deg,#00224e,#004ba8);padding:1rem;text-align:center;font-size:1.5rem;color:#fff}
    #mapAlerts{height:50vh;margin:1rem;border:2px solid #00eaff;border-radius:10px}
    section{margin:1rem;padding:1rem;background:#00142b;border-radius:10px}
    h2{color:#00eaff;margin-bottom:0.5rem}
    table{width:100%;border-collapse:collapse;font-size:0.9rem}
    th,td{border:1px solid #004ba8;padding:0.4rem;text-align:left}
    tr:hover{background:#002850}
    button{background:#00eaff;color:#001f3f;border:none;border-radius:5px;padding:0.3rem 0.7rem;margin:0.1rem;cursor:pointer}
  </style>
</head>
<body>
<header>ðŸš¨ Console Alertes IA J.E.A.N.</header>
<div id="mapAlerts"></div>

<section>
  <h2>ðŸ”· Alertes Primeur (Ã©mises avant les autres)</h2>
  <table id="primeurTable"><thead><tr><th>Type</th><th>Pays</th><th>FiabilitÃ©</th><th>Actions</th></tr></thead><tbody></tbody></table>
</section>

<section>
  <h2>ðŸŸ© Alertes auto-publiÃ©es â‰¥90%</h2>
  <table id="confirmTable"><thead><tr><th>Type</th><th>Pays</th><th>FiabilitÃ©</th><th>Actions</th></tr></thead><tbody></tbody></table>
</section>

<section>
  <h2>ðŸŸ¨ Alertes Ã  valider (70â€“89%)</h2>
  <table id="validerTable"><thead><tr><th>Type</th><th>Pays</th><th>FiabilitÃ©</th><th>Actions</th></tr></thead><tbody></tbody></table>
</section>

<section>
  <h2>ðŸŸ¥ Alertes sous surveillance (<70%)</h2>
  <table id="surveillerTable"><thead><tr><th>Type</th><th>Pays</th><th>FiabilitÃ©</th></tr></thead><tbody></tbody></table>
</section>

<section>
  <h2>ðŸ“¤ Formulaire Transmission NASA / Institutions</h2>
  <form onsubmit="sendToNasa(event)">
    <label>Organisation :</label><input id="org" style="width:100%" required><br>
    <label>Message :</label><textarea id="msg" rows="3" style="width:100%" required></textarea><br>
    <button type="submit">Envoyer</button>
  </form>
</section>

<script>
  const map=L.map("mapAlerts").setView([20,0],2);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:"TINSFLASH"}).addTo(map);
  const colors={primeur:"#0066ff",confirm:"#00ff7f",valider:"#ffcc00",surveiller:"#ff0033"};

  async function loadAlerts(){
    const res=await axios.get("/api/alerts");
    const primeur=res.data.filter(a=>a.isPrimeur);
    const confirm=res.data.filter(a=>!a.isPrimeur && a.reliability>=0.9);
    const valider=res.data.filter(a=>!a.isPrimeur && a.reliability>=0.7 && a.reliability<0.9);
    const surveiller=res.data.filter(a=>a.reliability<0.7);

    drawTable("primeurTable",primeur,colors.primeur);
    drawTable("confirmTable",confirm,colors.confirm);
    drawTable("validerTable",valider,colors.valider);
    drawTable("surveillerTable",surveiller,colors.surveiller);

    map.eachLayer(l=>{if(l instanceof L.CircleMarker)map.removeLayer(l)});
    res.data.forEach(a=>{
      let color=a.isPrimeur?colors.primeur:(a.reliability>=0.9?colors.confirm:(a.reliability>=0.7?colors.valider:colors.surveiller));
      L.circleMarker([a.lat,a.lon],{radius:8,color,fillOpacity:0.8})
        .bindPopup(`<b>${a.type}</b><br>${Math.round(a.reliability*100)}%<br>${a.country}`)
        .addTo(map);
    });
  }

  function drawTable(id,data,color){
    const tb=document.querySelector(`#${id} tbody`);
    tb.innerHTML="";
    data.forEach(a=>{
      const tr=document.createElement("tr");
      tr.innerHTML=`
        <td style="color:${color}">${a.type}</td>
        <td>${a.country}</td>
        <td>${Math.round(a.reliability*100)}%</td>
        <td>${id!=="surveillerTable"?`
          <button onclick="exportAlert('${a._id}')">Exporter</button>
          <button onclick="validateAlert('${a._id}')">Valider</button>
          <button onclick="holdAlert('${a._id}')">En attente</button>`:""}</td>`;
      tb.appendChild(tr);
    });
  }

  function exportAlert(id){axios.post("/api/alert/export",{id});alert("Export envoyÃ© Ã  l'expert.");}
  function validateAlert(id){axios.post("/api/alert/validate",{id});alert("Alerte validÃ©e.");}
  function holdAlert(id){axios.post("/api/alert/hold",{id});alert("Alerte mise en attente.");}
  function sendToNasa(e){e.preventDefault();axios.post("/api/nasa",{org:org.value,msg:msg.value});alert("Message transmis.");}

  loadAlerts();
</script>
</body>
</html>
