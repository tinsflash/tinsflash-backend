<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="robots" content="noindex,nofollow"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>🌋 Alertes – TINSFLASH</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<style>
body{margin:0;background:#060c14;color:#eaf2ff;font-family:Inter,system-ui}
header{display:flex;align-items:center;justify-content:space-between;padding:12px 18px;background:#08121d;color:#6bf3ff;font-weight:700}
.sidebar{position:fixed;left:0;top:0;height:100%;width:200px;background:#08121d;padding-top:70px}
.sidebar a{display:block;padding:10px 14px;color:#9ad6ff;text-decoration:none}
.main{margin-left:210px;padding:12px}
#map{height:420px;border-radius:8px}
table{width:100%;border-collapse:collapse;margin-top:12px;background:#0f1a24}
th,td{padding:8px;border-bottom:1px solid #08202a}
th{background:#0b1722;color:#6bf3ff}
.log-box{background:#07151d;padding:8px;border-radius:8px;height:160px;overflow:auto}
button{background:#4fc3f7;color:#001;border:none;padding:6px 10px;border-radius:6px;cursor:pointer}
@media(max-width:800px){.sidebar{display:none}.main{margin-left:12px}}
</style>
</head>
<body>
<script>
const pin=sessionStorage.getItem("tinsflashPIN");
if(!pin){const p=prompt("Code ?");if(p!=="202679"){alert("⛔");location.href="/";}else sessionStorage.setItem("tinsflashPIN","ok");}
</script>

<header>
  <div>🌋 Console Alertes – TINSFLASH</div>
  <div><button onclick="loadAlerts()">🔄 Rafraîchir</button></div>
</header>

<div class="sidebar">
  <a href="/admin-pp.html">🛰️ Console</a>
  <a href="/admin-alerts.html">🌋 Alertes</a>
  <a href="/admin-chat.html">💬 Chat</a>
  <a href="/admin-radar.html">🌦️ Radar</a>
  <a href="/admin-users.html">👥 Utilisateurs</a>
  <a href="/admin-index.html">🏠 Index</a>
</div>

<div class="main">
  <div style="display:flex;gap:8px;flex-wrap:wrap">
    <button onclick="loadAlerts('all')">Toutes</button>
    <button onclick="loadAlerts('auto_published')">Auto ≥90%</button>
    <button onclick="loadAlerts('validated')">70–89%</button>
    <button onclick="loadAlerts('under_watch')"><70%</button>
  </div>

  <div id="map"></div>

  <h3>📡 Logs d’alerte</h3>
  <div id="logBox" class="log-box"></div>

  <table id="alertsTable">
    <thead><tr>
      <th>Pays / Région</th><th>Type</th><th>Certitude</th>
      <th>Détectée</th><th>Dernière vérif.</th>
      <th>Statut</th><th>Sources</th><th>Actions</th>
    </tr></thead>
    <tbody></tbody>
  </table>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
const map=L.map("map").setView([20,0],2);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);
let markers=[];

async function loadAlerts(filter="all"){
  try{
    const res=await fetch("/api/alerts");
    const alerts=await res.json();
    const tb=document.querySelector("#alertsTable tbody");
    tb.innerHTML=""; markers.forEach(m=>map.removeLayer(m)); markers=[];
    for(const a of alerts){
      const c=a.certainty||0;
      const st=c>=90?"auto_published":c>=70?"validated":"under_watch";
      if(filter!=="all"&&st!==filter)continue;
      const col=c>=90?"lime":c>=70?"gold":"orange";
      const lat=a.geo?.lat||0,lon=a.geo?.lon||0;
      const mk=L.circleMarker([lat,lon],{color:col,radius:6,fillOpacity:0.9})
        .addTo(map).bindPopup(`<b>${a.zone}</b><br>${a.title}<br>${c}%`);
      markers.push(mk);
      tb.innerHTML+=`<tr>
        <td>${a.zone||"-"}</td><td>${a.title||"-"}</td>
        <td>${c}</td><td>${a.firstDetection?new Date(a.firstDetection).toLocaleString():"-"}</td>
        <td>${a.lastCheck?new Date(a.lastCheck).toLocaleString():"-"}</td>
        <td>${st}</td><td>${(a.sources||[]).join(", ")||"-"}</td>
        <td>
          <button onclick="publishAlert('${a._id}')">Publier</button>
          <button onclick="holdAlert('${a._id}')">Attente</button>
          <button onclick="deleteAlert('${a._id}')">Suppr</button>
        </td></tr>`;
    }
  }catch(e){console.error(e);}
}
async function publishAlert(id){await fetch(`/api/alerts/export/${id}`,{method:"POST"});loadAlerts();}
async function holdAlert(id){await fetch(`/api/alerts/status/${id}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"under_watch"})});loadAlerts();}
async function deleteAlert(id){await fetch(`/api/alerts/${id}`,{method:"DELETE"});loadAlerts();}

const logBox=document.getElementById("logBox");
const es=new EventSource("/api/logs/stream");
es.onmessage=e=>{
  try{
    const d=JSON.parse(e.data);
    if(d.message&&/alerte|🚨/i.test(d.message)){
      const p=document.createElement("div");
      p.textContent=d.message;
      logBox.appendChild(p); logBox.scrollTop=logBox.scrollHeight;
    }
  }catch{}
};
loadAlerts(); setInterval(loadAlerts,120000);
</script>
</body>
</html>
