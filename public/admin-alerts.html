<!-- PATH: public/admin-alerts.html -->
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="robots" content="noindex,nofollow" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ğŸš¨ TINSFLASH â€“ Global Alerts Console</title>
  <link href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" rel="stylesheet" />
  <style>
    body{font-family:Inter,system-ui,Arial;background:#0b0f19;color:#eee;margin:0}
    header{background:#111831;padding:15px;text-align:center;color:#4fc3f7;font-size:22px;font-weight:bold}
    nav{background:#1a2238;padding:10px;display:flex;justify-content:center;gap:15px;flex-wrap:wrap}
    nav a{color:#ccc;text-decoration:none;font-weight:600}nav a:hover{color:#4fc3f7}
    main{padding:15px}
    h2{color:#4fc3f7;border-bottom:1px solid #333;padding-bottom:6px;margin-top:25px}
    table{width:100%;border-collapse:collapse;margin-top:10px;font-size:14px}
    th,td{border:1px solid #333;padding:6px;text-align:center}
    th{background:#1a2238;color:#4fc3f7}
    .ok{color:#66bb6a}.warn{color:#ffca28}.bad{color:#ef5350}
    button{background:#4fc3f7;color:#000;border:none;border-radius:6px;padding:5px 10px;cursor:pointer;font-weight:bold}
    button:hover{background:#0288d1}
    .btn-danger{background:#ef5350;color:#fff}
    #map{height:480px;border-radius:8px;margin:20px 0}
    .premium{background:#112;padding:10px;border-radius:8px;margin-bottom:10px}
    .premium h3{margin-top:0;color:#ffd54f}
    @media(max-width:768px){#map{height:320px}}
  </style>
</head>
<body>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
// === SÃ©curitÃ© admin ===
const storedPin = sessionStorage.getItem("tinsflashPIN");
if(!storedPin){
  const pin = prompt("Code dâ€™accÃ¨s admin ?");
  if(pin!=="202679"){ alert("â›” AccÃ¨s refusÃ©"); location.href="/"; }
  else { sessionStorage.setItem("tinsflashPIN","ok"); }
}

let map;

// === Initialisation carte ===
function initMap(){
  map=L.map("map").setView([20,0],2);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:"Â© OpenStreetMap"}).addTo(map);
}

// === Chargement alertes ===
async function loadAlerts(){
  const res = await fetch("/api/alerts");
  const alerts = await res.json();

  // Tri par certitude dÃ©croissante
  alerts.sort((a,b)=>b.certainty - a.certainty);

  const tableBody=document.getElementById("alertsBody");
  tableBody.innerHTML="";
  const premiumDiv=document.getElementById("premiumZone");
  premiumDiv.innerHTML="";

  // nettoyage carte
  map.eachLayer(l=>{if(l instanceof L.CircleMarker) map.removeLayer(l);});

  const now=new Date();
  const topPremium=alerts.filter(a=>a.certainty>=90);

  // Section Premium
  if(topPremium.length>0){
    let html="<h3>ğŸŒ Premium World Alerts</h3>";
    for(const a of topPremium.slice(0,10)){
      html+=`<div>âš¡ <b>${a.title}</b> (${a.region}) â€“ ${a.certainty}% â€“ ${a.severity.toUpperCase()}</div>`;
    }
    premiumDiv.innerHTML=html;
  }

  for(const a of alerts){
    const col=a.severity==="extreme"?"#ff0000":a.severity==="high"?"#ff9800":a.severity==="medium"?"#ffca28":"#4caf50";
    const m=L.circleMarker([a.lat,a.lon],{radius:7,color:col,fillOpacity:0.8})
      .addTo(map)
      .bindPopup(`<b>${a.title}</b><br>${a.region}<br>${a.certainty}% â€“ ${a.severity}`);

    const det=new Date(a.detectionAt).toLocaleString();
    const last=new Date(a.lastCheckedAt).toLocaleString();
    const row=document.createElement("tr");
    const cls=a.certainty>=90?"ok":a.certainty>=70?"warn":"bad";

    row.innerHTML=`
      <td>${a.title}</td>
      <td>${a.region}</td>
      <td class="${cls}">${a.certainty}%</td>
      <td>${a.severity}</td>
      <td>${det}</td>
      <td>${last}</td>
      <td>${a.status}</td>
      <td>
        <button onclick="exportAlert('${a._id}')">ğŸš€ Publier</button>
        <button class="btn-danger" onclick="removeAlert('${a._id}')">ğŸ—‘ï¸ Supprimer</button>
      </td>
    `;
    tableBody.appendChild(row);
  }
}

// === Actions ===
async function exportAlert(id){
  const res=await fetch(`/api/alerts/export/${id}`,{method:"POST"});
  const data=await res.json();
  if(data.success) alert(`âœ… ExportÃ©e vers ${data.targets.join(", ")}`);
  else alert("âŒ Ã‰chec export");
  loadAlerts();
}

async function removeAlert(id){
  if(!confirm("Supprimer cette alerte ?"))return;
  await fetch(`/api/alerts/${id}`,{method:"DELETE"});
  loadAlerts();
}

// === Auto-refresh ===
setInterval(loadAlerts,15000);
window.onload=()=>{initMap();loadAlerts();}
</script>

<header>ğŸš¨ TINSFLASH â€“ Global Alerts Console</header>
<nav>
  <a href="/admin-pp.html">Console moteur</a>
  <a href="/admin-alerts.html">Alertes</a>
  <a href="/admin-chat.html">Chat</a>
  <a href="/admin-index.html">Index</a>
  <a href="/admin-radar.html">Radar & News</a>
  <a href="/admin-users.html">Utilisateurs</a>
</nav>

<main>
  <div class="premium" id="premiumZone"></div>
  <h2>ğŸŒ Carte mondiale des alertes</h2>
  <div id="map"></div>

  <h2>ğŸ“‹ Liste complÃ¨te des alertes</h2>
  <table>
    <thead><tr><th>Titre</th><th>RÃ©gion</th><th>Certitude</th><th>GravitÃ©</th><th>DÃ©tection</th><th>DerniÃ¨re vÃ©rif</th><th>Statut</th><th>Actions</th></tr></thead>
    <tbody id="alertsBody"><tr><td colspan="8">Chargementâ€¦</td></tr></tbody>
  </table>
</main>
</body>
</html>
