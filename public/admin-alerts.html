<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>üåã Alertes Mondiales ‚Äì TINSFLASH Everest v1.1</title>
  <meta name="robots" content="noindex,nofollow" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    body {
      background: #060c14;
      color: #eaf2ff;
      font-family: "Segoe UI", sans-serif;
      margin: 0;
      overflow-x: hidden;
    }
    header {
      background: #08121d;
      padding: 12px 20px;
      font-size: 20px;
      font-weight: bold;
      color: #6bf3ff;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    header button {
      background: #142739;
      color: #6bf3ff;
      border: 1px solid #6bf3ff;
      border-radius: 6px;
      padding: 6px 12px;
      cursor: pointer;
    }
    .filters {
      display: flex;
      justify-content: space-around;
      padding: 10px;
      background: #091626;
    }
    button {
      background: #132334;
      color: white;
      border: 1px solid #6bf3ff;
      padding: 6px 12px;
      border-radius: 6px;
      cursor: pointer;
    }
    #map {
      height: 420px;
      margin: 10px;
      border-radius: 10px;
      overflow: hidden;
    }
    table {
      width: 96%;
      margin: 10px auto 60px;
      border-collapse: collapse;
      background: #101a25;
      color: #cce6ff;
      font-size: 14px;
    }
    th, td {
      border-bottom: 1px solid #223;
      padding: 6px 8px;
      text-align: left;
    }
    th {
      background: #152236;
      color: #6bf3ff;
      font-weight: 600;
    }
    .status-auto_published { color: #00ffb7; }
    .status-validated { color: #ffe66b; }
    .status-under_watch { color: #ff7f50; }
    .log-box {
      background: #0d1827;
      color: #9ad6ff;
      padding: 8px;
      height: 160px;
      overflow-y: auto;
      margin: 8px 10px;
      border-radius: 8px;
      font-size: 13px;
    }
    footer {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: #08121d;
      text-align: center;
      padding: 6px;
      font-size: 12px;
      color: #6bf3ff;
    }
  </style>
</head>
<body>
  <header>
    üåã Console des Alertes Mondiales ‚Äì Everest v1.1
    <button onclick="loadAlerts()">üîÑ Rafra√Æchir</button>
  </header>

  <div class="filters">
    <button onclick="loadAlerts('all')">üåê Toutes</button>
    <button onclick="loadAlerts('auto_published')">üöÄ Auto-publi√©es (‚â• 90 %)</button>
    <button onclick="loadAlerts('validated')">üü° √Ä valider (70 ‚Äì 89 %)</button>
    <button onclick="loadAlerts('under_watch')">üü† En surveillance (&lt; 70 %)</button>
  </div>

  <div id="map"></div>

  <h3 style="padding-left:12px;color:#6bf3ff;">üì° Derniers logs d‚Äôalertes (temps r√©el)</h3>
  <div id="logBox" class="log-box"></div>

  <table id="alertsTable">
    <thead>
      <tr>
        <th>Pays / R√©gion</th>
        <th>Type</th>
        <th>Certitude %</th>
        <th>D√©tect√©e le</th>
        <th>Derni√®re v√©rif.</th>
        <th>Statut</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <footer>¬© TINSFLASH ‚Äì Everest Protocol v1.1 | Toutes donn√©es r√©elles</footer>

  <script>
    let map = L.map("map").setView([20, 0], 2);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: "¬© OpenStreetMap",
    }).addTo(map);
    let markers = [];

    async function loadAlerts(filter = "all") {
      try {
        const res = await fetch("/api/alerts");
        const alerts = await res.json();
        const tbody = document.querySelector("#alertsTable tbody");
        tbody.innerHTML = "";
        markers.forEach((m) => map.removeLayer(m));
        markers = [];

        for (const a of alerts) {
          const certainty = a.data?.confidence || 0;
          const status = 
            certainty >= 90 ? "auto_published" :
            certainty >= 70 ? "validated" : "under_watch";

          if (filter !== "all" && status !== filter) continue;

          const color =
            certainty >= 90 ? "lime" : certainty >= 70 ? "gold" : "orange";
          const lat = a.lat || a.data?.geo?.lat || 0;
          const lon = a.lon || a.data?.geo?.lon || 0;
          const marker = L.circleMarker([lat, lon], {
            color,
            radius: 6,
            fillOpacity: 0.8,
          })
            .addTo(map)
            .bindPopup(`<b>${a.country || "?"}</b><br>${a.region || ""}<br>${a.data?.type || ""}<br><b>${certainty}%</b>`);
          markers.push(marker);

          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${a.country || "-"} / ${a.region || "-"}</td>
            <td>${a.data?.type || "?"}</td>
            <td>${certainty}</td>
            <td>${a.data?.firstDetection ? new Date(a.data.firstDetection).toLocaleString() : "-"}</td>
            <td>${a.timestamp ? new Date(a.timestamp).toLocaleString() : "-"}</td>
            <td class="status-${status}">${status.replace("_"," ")}</td>
            <td>
              <button onclick="publishAlert('${a._id}')">Publier</button>
              <button onclick="holdAlert('${a._id}')">Attente</button>
              <button onclick="deleteAlert('${a._id}')">Suppr.</button>
            </td>`;
          tbody.appendChild(tr);
        }
      } catch (err) {
        console.error("Erreur chargement alertes:", err);
      }
    }

    async function publishAlert(id) {
      const res = await fetch(`/api/alerts/export/${id}`, { method: "POST" });
      if (res.ok) loadAlerts();
    }
    async function holdAlert(id) {
      await fetch(`/api/alerts/${id}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ action: "under_watch" }),
      });
      loadAlerts();
    }
    async function deleteAlert(id) {
      await fetch(`/api/alerts/${id}`, { method: "DELETE" });
      loadAlerts();
    }

    // üî• Flux temps r√©el (logs)
    const logBox = document.getElementById("logBox");
    const evtSrc = new EventSource("/api/logs/stream");
    evtSrc.onmessage = (ev) => {
      try {
        const data = JSON.parse(ev.data);
        if (data.message?.includes("üö®")) {
          const p = document.createElement("div");
          p.textContent = data.message;
          logBox.appendChild(p);
          logBox.scrollTop = logBox.scrollHeight;
        }
      } catch {}
    };

    loadAlerts();
  </script>
</body>
</html>
