<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="robots" content="noindex,nofollow">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Console Admin ‚Äì Alertes</title>
  <style>
    body { font-family: Arial, sans-serif; background:#111; color:#eee; margin:0; }
    header { background:#222; padding:10px; text-align:center; }
    nav a { color:#0af; margin:0 10px; text-decoration:none; }
    h2 { margin-top:20px; }
    .alert-block { padding:15px; margin:10px; border-radius:8px; }
    .published { background:#163; }
    .tovalidate { background:#663; }
    .surveillance { background:#335; }
    pre { white-space:pre-wrap; background:#000; padding:10px; border-radius:6px; }
    button { margin:5px; padding:5px 10px; border:none; border-radius:4px; cursor:pointer; }
    button.validate { background:#2a2; color:white; }
    button.reject { background:#a22; color:white; }
    button.pending { background:#cc0; color:black; }
    .badge { padding:2px 6px; border-radius:4px; font-size:0.8em; margin-left:6px; }
    .exclusive { background:#a22; color:#fff; }
    .confirmed { background:#2a2; color:#fff; }
    #summary { background:#222; padding:10px; margin:10px; border-radius:8px; }
  </style>
  <script>
    const pwd = prompt("Mot de passe ?");
    if (pwd !== "202679") {
      document.write("‚õî Acc√®s refus√©");
      throw new Error("Acc√®s refus√©");
    }

    async function fetchSummary() {
      const res = await fetch("/api/alerts/summary");
      if (!res.ok) return {};
      return await res.json();
    }

    async function fetchAlerts() {
      const [alertsRes, summary] = await Promise.all([
        fetch("/api/alerts").then(r => r.json()),
        fetchSummary()
      ]);

      const publishedDiv = document.getElementById("published");
      const toValidateDiv = document.getElementById("tovalidate");
      const surveillanceDiv = document.getElementById("surveillance");

      publishedDiv.innerHTML = "";
      toValidateDiv.innerHTML = "";
      surveillanceDiv.innerHTML = "";

      // üîé R√©sum√© global
      if (summary && summary.total != null) {
        document.getElementById("summary").innerHTML = `
          <strong>Total alertes :</strong> ${summary.total}<br>
          üü¢ Publi√©es : ${summary.byStatus.published} | 
          üü° √Ä valider : ${summary.byStatus.toValidate} | 
          üîµ Surveillance : ${summary.byStatus["under-surveillance"]} | 
          ‚ö™ Archiv√©es : ${summary.byStatus.archived}<br>
          üî¥ Exclusives : ${summary.exclusives} | 
          üü¢ Confirm√©es ailleurs : ${summary.confirmedElsewhere}
        `;
      }

      alertsRes.forEach(alert => {
        const fiab = alert?.data?.confidence || 0;
        const status = alert?.data?.status || "under-surveillance";
        let block;
        if (status === "published") block = publishedDiv;
        else if (status === "toValidate") block = toValidateDiv;
        else block = surveillanceDiv;

        // Badge exclusivit√©
        let badge = "";
        const ex = alert?.data?.external?.exclusivity;
        if (ex === "exclusive") badge = `<span class="badge exclusive">TINSFLASH Exclusif</span>`;
        if (ex === "confirmed-elsewhere") badge = `<span class="badge confirmed">Confirm√© ailleurs</span>`;

        const el = document.createElement("div");
        el.className = `alert-block ${status}`;
        el.innerHTML = `
          <strong>${alert.country} ${alert.region || ""}</strong> ‚Äì ${alert.continent} ${badge}<br>
          <em>Confiance : ${fiab}%</em><br>
          <pre>${JSON.stringify(alert.data, null, 2)}</pre>
          ${status === "toValidate" ? `
            <button class="validate" onclick="updateStatus('${alert.id}','published')">Valider</button>
            <button class="reject" onclick="updateStatus('${alert.id}','under-surveillance')">Rejeter</button>
            <button class="pending" onclick="updateStatus('${alert.id}','pending')">En attente</button>
          ` : ""}
        `;
        block.appendChild(el);
      });
    }

    async function updateStatus(id, action) {
      await fetch(`/api/alerts/${id}/${action}`, { method:"POST" });
      fetchAlerts();
    }

    setInterval(fetchAlerts, 5000);
    window.onload = fetchAlerts;
  </script>
</head>
<body>
  <header>
    <h1>üö® Console Admin ‚Äì Alertes</h1>
    <nav>
      <a href="/admin">Console</a>
      <a href="/admin-alerts">Alertes</a>
      <a href="/admin-chat">Chat</a>
      <a href="/admin-index">Vue Index</a>
      <a href="/admin-radar">Radar & News</a>
      <a href="/admin-users">Utilisateurs</a>
    </nav>
  </header>

  <div id="summary"></div>

  <h2>‚úÖ Auto-publi√©es (&gt;90%)</h2>
  <div id="published"></div>

  <h2>‚è≥ √Ä valider (70‚Äì90%)</h2>
  <div id="tovalidate"></div>

  <h2>üîµ Sous surveillance (&lt;70%)</h2>
  <div id="surveillance"></div>
</body>
</html>
