<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="robots" content="noindex,nofollow">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Console Admin ‚Äì Alertes</title>
  <style>
    body { font-family: Arial, sans-serif; background:#111; color:#eee; margin:0; }
    header { background:#222; padding:10px; text-align:center; }
    nav a { color:#0af; margin:0 10px; text-decoration:none; }
    h2 { margin-top:20px; }
    .alert-block { padding:15px; margin:10px; border-radius:8px; }
    .published { background:#163; }
    .tovalidate { background:#663; }
    .ignored { background:#633; }
    pre { white-space:pre-wrap; background:#000; padding:10px; border-radius:6px; }
    button { margin:5px; padding:5px 10px; border:none; border-radius:4px; cursor:pointer; }
    button.validate { background:#2a2; color:white; }
    button.reject { background:#a22; color:white; }
    button.pending { background:#cc0; color:black; }
  </style>
  <script>
    const pwd = prompt("Mot de passe ?");
    if (pwd !== "202679") {
      document.write("‚õî Acc√®s refus√©");
      throw new Error("Acc√®s refus√©");
    }

    async function fetchAlerts() {
      const res = await fetch("/api/alerts");
      const data = await res.json();
      if (!Array.isArray(data)) return;

      const publishedDiv = document.getElementById("published");
      const toValidateDiv = document.getElementById("tovalidate");
      const ignoredDiv = document.getElementById("ignored");

      publishedDiv.innerHTML = "";
      toValidateDiv.innerHTML = "";
      ignoredDiv.innerHTML = "";

      data.forEach(alert => {
        const fiab = alert?.data?.fiabilite || 0;
        let block;
        if (fiab >= 90) block = publishedDiv;
        else if (fiab >= 70) block = toValidateDiv;
        else block = ignoredDiv;

        const el = document.createElement("div");
        el.className = "alert-block";
        el.innerHTML = `
          <strong>${alert.country} ${alert.region || ""}</strong> ‚Äì ${alert.continent}<br>
          <em>Confiance : ${fiab}%</em><br>
          <pre>${JSON.stringify(alert.data, null, 2)}</pre>
          ${fiab >= 70 && fiab < 90 ? `
            <button class="validate" onclick="updateStatus('${alert.id}','published')">Valider</button>
            <button class="reject" onclick="updateStatus('${alert.id}','ignored')">Rejeter</button>
            <button class="pending" onclick="updateStatus('${alert.id}','pending')">En attente</button>
          ` : ""}
        `;
        block.appendChild(el);
      });
    }

    async function updateStatus(id, action) {
      await fetch(`/api/alerts/${id}/${action}`, { method:"POST" });
      fetchAlerts();
    }

    setInterval(fetchAlerts, 5000);
    window.onload = fetchAlerts;
  </script>
</head>
<body>
  <header>
    <h1>üö® Console Admin ‚Äì Alertes</h1>
    <nav>
      <a href="/admin">Console</a>
      <a href="/admin-alerts">Alertes</a>
      <a href="/admin-chat">Chat</a>
      <a href="/admin-index">Vue Index</a>
      <a href="/admin-radar">Radar & News</a>
      <a href="/admin-users">Utilisateurs</a>
    </nav>
  </header>

  <h2>‚úÖ Auto-publi√©es (&gt;90%)</h2>
  <div id="published"></div>

  <h2>‚è≥ √Ä valider (70‚Äì90%)</h2>
  <div id="tovalidate"></div>

  <h2>‚ùå Ignor√©es (&lt;70%)</h2>
  <div id="ignored"></div>
</body>
</html>
