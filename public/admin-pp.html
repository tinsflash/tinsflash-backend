<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Cockpit Administrateur — Centrale Nucléaire Météo</title>
  <style>
    body { background:#111; color:#eee; font-family: monospace; margin:0; padding:0; }
    nav { background:#222; padding:10px; }
    nav a { color:#ccc; margin-right:15px; text-decoration:none; }
    nav a:hover { color:#fff; }
    h2 { margin-top:20px; color:#0f0; }
    .checklist { background:#000; padding:10px; border:1px solid #333; }
    .logbox { background:#000; color:#0f0; padding:10px; height:200px; overflow-y:auto; border:1px solid #333; }
    .badge { padding:2px 6px; border-radius:4px; font-weight:bold; }
    .pending { background:#555; color:#fff; }
    .running { background:orange; color:#000; }
    .ok { background:green; color:#fff; }
    .fail { background:red; color:#fff; }
    .country-block { border:1px solid #333; margin:8px 0; padding:6px; background:#181818; }
    .region { margin-left:20px; }
    pre { background:#111; padding:6px; border:1px solid #333; overflow-x:auto; }
  </style>
</head>
<body>

  <!-- Navigation -->
  <nav>
    <a href="/admin">Cockpit</a>
    <a href="/admin-alerts">Alertes</a>
    <a href="/admin-chat">Chat IA</a>
    <a href="/admin-radar">Radar</a>
    <a href="/admin-index">Prévisualisation Index</a>
    <a href="/admin-infos">Infos Météo Mondiales</a>
    <a href="/admin-users">Utilisateurs</a>
  </nav>

  <div style="padding:20px;">
    <h1>⚡ Cockpit Administrateur</h1>

    <!-- Bouton RUN -->
    <button onclick="launchRun()" style="padding:10px; background:red; color:#fff; font-size:16px;">
      🚀 Lancer Run Global
    </button>

    <!-- Checklist moteur -->
    <h2>✅ Checklist moteur</h2>
    <div id="checkup" class="checklist">Chargement...</div>

    <!-- Logs moteur -->
    <h2>📜 Logs moteur (live)</h2>
    <div id="logs" class="logbox"></div>

    <!-- État complet moteur -->
    <h2>🛰️ État du moteur (live)</h2>
    <button onclick="exportJSON()">📂 Export JSON</button>
    <button onclick="copyJSON()">📋 Copier JSON</button>
    <div id="engineState"></div>
  </div>

<script>
// === Checklist moteur ===
async function fetchCheckup() {
  const res = await fetch("/api/checkup");
  const data = await res.json();
  let html = "<table>";
  for (const [step, status] of Object.entries(data)) {
    let cls = "pending", label = "⚪";
    if (status === "RUNNING") { cls = "running"; label = "🟠"; }
    if (status === "OK") { cls = "ok"; label = "🟢"; }
    if (status === "FAIL") { cls = "fail"; label = "🔴"; }
    html += `<tr><td>${label}</td><td>${step}</td><td><span class="badge ${cls}">${status}</span></td></tr>`;
  }
  html += "</table>";
  document.getElementById("checkup").innerHTML = html;
}

// === Logs moteur (SSE) ===
const logBox = document.getElementById("logs");
const evtSource = new EventSource("/api/logs/stream");
evtSource.onmessage = function(e) {
  const logs = JSON.parse(e.data);
  logBox.innerHTML = logs.map(l => l).join("<br>");
  logBox.scrollTop = logBox.scrollHeight;
};

// === État moteur détaillé ===
async function fetchEngineState() {
  const res = await fetch("/api/engine-state");
  const data = await res.json();
  const container = document.getElementById("engineState");
  container.innerHTML = "";

  // Boucle pays
  for (const [country, content] of Object.entries(data.zonesCovered || {})) {
    const block = document.createElement("div");
    block.className = "country-block";
    block.innerHTML = `<b>🌍 ${country}</b>`;

    // Boucle régions
    if (content.regions) {
      content.regions.forEach(r => {
        const regionDiv = document.createElement("div");
        regionDiv.className = "region";
        regionDiv.innerHTML = `📍 <b>${r.region}</b> (${r.lat},${r.lon})<br>
          <pre>${JSON.stringify(r.forecast || r.error || {}, null, 2)}</pre>`;
        block.appendChild(regionDiv);
      });
    }
    container.appendChild(block);
  }
}

function exportJSON() {
  fetch("/api/engine-state").then(r => r.json()).then(data => {
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "engineState.json";
    a.click();
    URL.revokeObjectURL(url);
  });
}

function copyJSON() {
  fetch("/api/engine-state").then(r => r.json()).then(data => {
    navigator.clipboard.writeText(JSON.stringify(data, null, 2));
    alert("JSON copié dans le presse-papier !");
  });
}

async function launchRun() {
  const res = await fetch("/api/run-global", { method:"POST" });
  const data = await res.json();
  alert("Run global lancé !");
  console.log(data);
}

// Refresh auto
setInterval(fetchCheckup, 2000);
setInterval(fetchEngineState, 4000);
fetchCheckup();
fetchEngineState();
</script>

</body>
</html>
