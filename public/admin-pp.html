<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="robots" content="noindex,nofollow">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‚ö° Console Admin ‚Äî Centrale M√©t√©o Mondiale</title>
  <style>
    body { font-family: Arial, sans-serif; background:#0d1117; color:#e6edf3; margin:0; }
    header { background:#111; padding:12px; text-align:center; font-size:22px; font-weight:bold; color:#0af; }
    nav { background:#1c1f26; padding:10px; text-align:center; }
    nav a { color:#0af; margin:0 12px; text-decoration:none; }
    h2, h3 { margin:15px 0 10px; color:#0af; }
    .grid { display:grid; grid-template-columns: repeat(auto-fill,minmax(200px,1fr)); gap:10px; margin:10px 0; }
    .zone { background:#161b22; border-radius:6px; padding:10px; }
    button { margin:6px 0; padding:8px 12px; border:none; border-radius:6px; cursor:pointer; background:#0af; color:#000; font-weight:bold; }
    .status-ball { width:14px; height:14px; border-radius:50%; display:inline-block; margin-right:6px; }
    .status-ball.pending { background:#cc0; }
    .status-ball.ok { background:#2a2; }
    .status-ball.fail { background:#a22; }
    #logs { background:#000; color:#eee; font-family:monospace; padding:10px; height:250px; overflow-y:auto; border-radius:8px; margin-top:10px; white-space:pre-wrap; }
    .info { color:#0af; }
    .warn { color:#cc0; }
    .error { color:#f55; }
    #chatButton { position:fixed; bottom:20px; right:20px; width:60px; height:60px; border-radius:50%; background:#0af; color:#fff; font-size:22px; font-weight:bold; border:none; cursor:pointer; }
    #chatBubble { position:fixed; bottom:90px; right:20px; width:320px; height:420px; background:#161b22; border:2px solid #0af; border-radius:10px; display:none; flex-direction:column; }
    #chatBubble header { padding:8px; font-weight:bold; text-align:center; color:#0af; }
    #chatLog { flex:1; overflow-y:auto; padding:8px; background:#0d1117; border-radius:6px; }
    #chatInput { display:flex; }
    #chatInput input { flex:1; padding:6px; border:none; border-radius:6px; }
    #chatInput button { padding:6px 10px; background:#0af; border:none; border-radius:6px; cursor:pointer; }
    #runStatus { display:none; position:fixed; top:0; left:0; width:100%; padding:12px; text-align:center; font-weight:bold; font-size:18px; background:#111; color:#fff; z-index:9999; }
    .country-row { display:flex; align-items:center; justify-content:space-between; background:#161b22; padding:6px 10px; margin:4px 0; border-radius:6px; }
    .country-name { font-weight:bold; }
    #map { height:500px; width:100%; margin:20px auto; border-radius:8px; overflow:hidden; }
  </style>

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
</head>
<body>
<script>
  const pass = prompt("Code d'acc√®s ?");
  if (pass !== "202679") {
    document.body.innerHTML = "<h1 style='color:red;text-align:center;'>‚õî Acc√®s refus√©</h1>";
    throw new Error("Acc√®s refus√©");
  }
</script>

<header>‚ö° Centrale M√©t√©o Mondiale ‚Äî Console Admin</header>
<nav>
  <a href="/admin">Console</a>
  <a href="/admin-alerts">Alertes</a>
  <a href="/admin-chat">Chat IA</a>
  <a href="/admin-index">Vue Index</a>
  <a href="/admin-radar">Radar & News</a>
  <a href="/admin-users">Utilisateurs</a>
</nav>

<div id="runStatus"></div>

<main style="padding:20px;">
  <h2>üõ∞Ô∏è Cockpit Global</h2>
  <button onclick="runGlobal()">üöÄ Lancer RUN GLOBAL (pr√©visions + alertes + fusion)</button>

  <h2>üåç Carte de couverture</h2>
  <div id="map"></div>

  <h2>üìú Logs moteur (live)</h2>
  <div id="logs">Connexion en cours‚Ä¶</div>

  <h2>üõ∞Ô∏è Pompage des mod√®les</h2>
  <div id="models-status" class="grid"></div>

  <h2>‚ö° √âtapes du moteur</h2>
  <div id="engine-steps" class="grid"></div>

  <h2>üåç Supervision par pays</h2>
  <div id="zones-status" style="display:grid; grid-template-columns:1fr 1fr; gap:20px;">
    <div>
      <h3>üìä Pr√©visions</h3>
      <div id="forecast-countries"></div>
    </div>
    <div>
      <h3>üö® Alertes</h3>
      <div id="alert-countries"></div>
    </div>
  </div>
</main>

<!-- Chat bulle -->
<button id="chatButton" onclick="toggleChat()">üí¨</button>
<div id="chatBubble">
  <header>ü§ñ Chat IA Moteur</header>
  <div id="chatLog"></div>
  <div id="chatInput">
    <input type="text" id="chatMsg" placeholder="Demander au moteur..." onkeypress="if(event.key==='Enter') sendChat()">
    <button onclick="sendChat()">Envoyer</button>
  </div>
</div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
  // Bandeau visuel
  function showRunStatus(msg, color){
    const bar=document.getElementById("runStatus");
    bar.style.display="block"; bar.style.background=color; bar.innerText=msg;
    setTimeout(()=>{ bar.style.display="none"; },8000);
  }

  // === RUN GLOBAL ===
  async function runGlobal(){
    showRunStatus("‚ñ∂Ô∏è RUN GLOBAL lanc√©...","#cc0");
    await fetch("/api/run-orchestrator",{method:"POST"});
  }

  // Logs live
  const logDiv=document.getElementById("logs");
  const evt=new EventSource("/api/logs/stream");
  evt.onmessage=(e)=>{
    const log=JSON.parse(e.data);
    let cls="info"; if(log.message.includes("ERROR")) cls="error"; if(log.message.includes("WARN")) cls="warn";
    logDiv.innerHTML+=`<div class="${cls}">[${new Date(log.ts).toLocaleTimeString()}] ${log.message}</div>`;
    logDiv.scrollTop=logDiv.scrollHeight;
  };

  // Models & Steps
  const models = ["ECMWF","GFS","ICON","Meteomatics","Copernicus ERA5","NOAA","NASA POWER","OpenWeather"];
  function buildModels(){
    const m=document.getElementById("models-status"); m.innerHTML="";
    models.forEach(md=>{
      m.innerHTML+=`<div id="model-${md}" class="zone"><span class="status-ball pending"></span>${md}</div>`;
    });
  }
  buildModels();

  const steps = ["Pompage des mod√®les","Analyse relief & climat","Pr√©visions zones couvertes","Alertes zones couvertes","Alertes continentales","Fusion IA","D√©ploiement final"];
  function buildEngineSteps(){
    const s=document.getElementById("engine-steps"); s.innerHTML="";
    steps.forEach(st=>{
      const safeId=st.replace(/\s+/g,"-");
      s.innerHTML+=`<div id="step-${safeId}" class="zone"><span class="status-ball pending"></span> ${st}</div>`;
    });
  }
  buildEngineSteps();

  // === Leaflet Map ===
  const map = L.map("map").setView([20,0], 2);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 6, minZoom: 2, attribution: "¬© OpenStreetMap"
  }).addTo(map);

  let geoLayer;
  async function loadWorld(){
    const res = await fetch("https://raw.githubusercontent.com/datasets/geo-countries/master/data/countries.geojson");
    const world = await res.json();
    geoLayer = L.geoJSON(world, {
      style: { color:"#222", weight:1, fillColor:"#444", fillOpacity:0.7 },
      onEachFeature: (feature, layer) => {
        layer.bindTooltip(feature.properties.ADMIN);
        layer.on("click", () => showCountryDetails(feature.properties.ISO_A2));
      }
    }).addTo(map);
  }
  loadWorld();

  async function refreshMap(){
    try {
      const res = await fetch("/api/engine-state");
      const data = await res.json();
      geoLayer.eachLayer(layer => {
        const iso = layer.feature.properties.ISO_A2;
        let color = "#444"; // d√©faut
        if (data?.alertsLocal?.some(a => (a.countryCode||a.country)===iso)) color="#a22";
        else if (data?.forecasts?.[iso]) color="#2a2";
        layer.setStyle({ fillColor: color });
      });
    } catch(e){ console.warn("Erreur refreshMap:", e.message); }
  }
  setInterval(refreshMap,10000);

  function showCountryDetails(iso){
    alert("üìç D√©tails pour " + iso + " (pr√©visions/alertes √† r√©cup√©rer c√¥t√© API)");
  }

  // Chat IA
  function toggleChat(){ const c=document.getElementById("chatBubble"); c.style.display=c.style.display==="flex"?"none":"flex"; }
  async function sendChat(){
    const input=document.getElementById("chatMsg"); const msg=input.value.trim(); if(!msg) return;
    const log=document.getElementById("chatLog"); log.innerHTML+=`<div><b>Moi:</b> ${msg}</div>`; input.value="";
    const res=await fetch("/api/chat/engine",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({message:msg})});
    const data=await res.json(); log.innerHTML+=`<div style="color:#0af;"><b>Moteur:</b> ${data.reply}</div>`; log.scrollTop=log.scrollHeight;
  }
</script>
</body>
</html>
