<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<meta name="robots" content="noindex,nofollow"/>
<title>🚀 TINSFLASH PRO+++ • Cockpit Administrateur</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<style>
body{margin:0;background:#0a1222;color:#e6f6ff;font-family:"Segoe UI",sans-serif;}
header{background:#061020;text-align:center;padding:12px;color:#4fc3f7;font-size:1.4em;
text-shadow:0 0 8px #4fc3f7;}
.container{max-width:1400px;margin:auto;padding:15px;}
h2{color:#4fc3f7;border-left:4px solid #4fc3f7;padding-left:10px;}
button{background:#13233d;color:#4fc3f7;border:1px solid #4fc3f7;
padding:10px;margin:4px;border-radius:8px;font-weight:bold;cursor:pointer;}
button:hover{background:#4fc3f7;color:#000;}
.btn-active{background:#22c55e;color:#000!important;animation:blink 1s infinite alternate;}
@keyframes blink{from{opacity:1;}to{opacity:.5;}}
.status-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:8px;}
.light{width:14px;height:14px;border-radius:50%;display:inline-block;margin-right:6px;}
.ok{background:#00ff88;} .warn{background:#ffaa00;} .err{background:#ff4444;} .idle{background:#666;}
.map{height:280px;margin-top:10px;border-radius:10px;overflow:hidden;}
.logs{background:#0e1729;border-radius:10px;padding:10px;height:300px;overflow-y:auto;
font-family:monospace;font-size:13px;}
</style>
</head>
<body>

<script>
if(!sessionStorage.getItem("tinsflashPIN")){
 const p=prompt("Code d’accès admin ?");
 if(p!=="202679"){alert("Accès refusé");location.href="/";} 
 else sessionStorage.setItem("tinsflashPIN","ok");
}
</script>

<header>🛰️ CONSOLE IA J.E.A.N – SUPERVISION TINSFLASH PRO+++</header>

<div class="container">

<h2>⚙️ Extraction – Zones couvertes</h2>
<div class="status-grid">
  <button onclick="run('europe')">🇪🇺 Europe</button>
  <button onclick="run('usa')">🇺🇸 USA / 🇨🇦 Canada</button>
  <button onclick="run('afrique')">🌍 Afrique</button>
  <button onclick="run('asie')">🌏 Asie</button>
  <button onclick="run('oceanie')">🌊 Océanie</button>
  <button onclick="run('ameriquesud')">🌎 Amérique Sud</button>
  <button onclick="run('belgique')"><img src="belgique.png" height="18"/> Belgique</button>
  <button onclick="run('bouke')"><img src="bouke.png" height="18"/> Bouké (Namur)</button>
</div>

<h2>🧠 IA & Alertes</h2>
<div class="status-grid">
  <button onclick="runAI()">🤖 Analyse IA J.E.A.N.</button>
  <button onclick="runAlerts()">🚨 Fusion alertes</button>
</div>

<h2>📊 État du moteur</h2>
<div id="status">
  <div><span class="light idle" id="lightEngine"></span>Moteur</div>
  <div><span class="light idle" id="lightIA"></span>IA J.E.A.N.</div>
  <div><span class="light idle" id="lightAlerts"></span>Alertes</div>
  <div><span class="light idle" id="lightDB"></span>MongoDB</div>
</div>

<h2>🌍 Cartes</h2>
<div id="mapForecast" class="map"></div>
<div id="mapAlerts" class="map"></div>

<h2>📜 Logs en direct</h2>
<div id="logs" class="logs">Connexion en cours...</div>

</div>

<script>
const logs=document.getElementById("logs");
function addLog(msg){logs.textContent+="\n"+msg;logs.scrollTop=logs.scrollHeight;}

async function run(zone){
 const btns=document.querySelectorAll("button");
 btns.forEach(b=>b.classList.remove("btn-active"));
 event.target.classList.add("btn-active");
 addLog(`▶️ Lancement run-${zone}...`);
 try{
  const res=await fetch(`/api/run-${zone}`,{method:"POST"});
  const j=await res.json();
  if(j.success)addLog(`✅ Run ${zone} terminé (${new Date().toLocaleTimeString()})`);
  else addLog(`⚠️ Erreur ${zone}: ${j.error}`);
 }catch(e){addLog(`❌ Crash ${zone}: ${e.message}`);}
 event.target.classList.remove("btn-active");
}

async function runAI(){await fetch("/api/runAI",{method:"POST"});addLog("🧠 IA J.E.A.N. activée.");}
async function runAlerts(){await fetch("/api/runWorldAlerts",{method:"POST"});addLog("🚨 Fusion alertes déclenchée.");}

// 🛰️ Logs temps réel (SSE)
const evt=new EventSource("/api/logs");
evt.onmessage=e=>{
 const log=JSON.parse(e.data);
 addLog(`${new Date(log.time).toLocaleTimeString()} — ${log.message}`);
};

// 🧩 Mise à jour état moteur
async function updateStatus(){
 try{
   const r=await fetch("/api/status");const s=await r.json();
   setLight("lightEngine",s.status==="RUN_OK"?"ok":"warn");
   setLight("lightIA",s.checkup?.iaActive?"ok":"idle");
   setLight("lightAlerts",s.checkup?.alerts?"ok":"warn");
   setLight("lightDB",s.db==="connected"?"ok":"err");
 }catch{setLight("lightEngine","err");}
}
function setLight(id,state){
 const el=document.getElementById(id);
 el.className=`light ${state}`;
}
setInterval(updateStatus,15000);updateStatus();

// 🌍 Cartes Leaflet
const map1=L.map("mapForecast").setView([50,4],3);
const map2=L.map("mapAlerts").setView([20,0],2);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map1);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map2);

// Charger points de prévision et alertes
async function loadForecasts(){
 const r=await fetch("/api/forecast?lat=50&lon=4"); 
 const d=await r.json();
 L.marker([d.lat||50,d.lon||4]).addTo(map1).bindPopup(`Temp: ${d.temp||"?"}°C`);
}
async function loadAlerts(){
 const r=await fetch("/api/alerts");
 const a=await r.json();
 a.forEach(x=>{if(x.lat&&x.lon)L.circle([x.lat,x.lon],{radius:80000,color:"red"}).addTo(map2)
   .bindPopup(x.title||"Alerte");});
}
loadForecasts();loadAlerts();
</script>

</body>
</html>
