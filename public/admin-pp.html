<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>🛰️ Console Pro+ – TINSFLASH</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="style.css">
  <style>
    body { background: #0c1a2b; color: #eee; font-family: Arial, sans-serif; }
    h1 { text-align: center; color: #00eaff; }
    .btn { padding: 12px 20px; border: none; border-radius: 6px; cursor: pointer; }
    .btn-run { background: #00eaff; color: #0c1a2b; font-weight: bold; }
    .progress { width: 100%; background: #333; border-radius: 8px; margin: 15px 0; height: 22px; }
    .progress-bar { height: 22px; background: #00eaff; width: 0%; border-radius: 8px; transition: width 0.4s; }
    .card { background: #132a44; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
    pre { background: #1e2f47; padding: 10px; border-radius: 6px; overflow-x: auto; }
  </style>
  <script>
    async function runForecast() {
      const btn = document.getElementById("btn-run");
      const progress = document.getElementById("progress-bar");
      const output = document.getElementById("result");
      btn.disabled = true;
      output.innerText = "⏳ Lancement du supercalculateur météo...";
      progress.style.width = "10%";

      try {
        const res = await fetch("/api/supercalc/run", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ time: new Date().toISOString(), country: "BE" })
        });

        progress.style.width = "70%";
        const data = await res.json();

        progress.style.width = "100%";

        output.innerHTML = `
          <h3>✅ Résultat du run</h3>
          <p><b>Status :</b> ${data.status}</p>
          <p><b>Anomalie :</b> ${data.forecast.anomaly || "Normale"}</p>
          <p><b>Température :</b> ${data.forecast.temperature_min}°C – ${data.forecast.temperature_max}°C</p>
          <p><b>Vent :</b> ${data.forecast.wind} km/h</p>
          <p><b>Précipitations :</b> ${data.forecast.precipitation} mm</p>
          <p><b>Fiabilité :</b> ${data.forecast.reliability}%</p>
          <h4>🌍 Pondérations appliquées :</h4>
          <pre>${JSON.stringify(data.weights, null, 2)}</pre>
          <h4>📡 Sources utilisées :</h4>
          <pre>${JSON.stringify(data.sources, null, 2)}</pre>
          <h4>⚠️ Erreurs éventuelles :</h4>
          <pre>${JSON.stringify(data.errors, null, 2)}</pre>
        `;
      } catch (err) {
        output.innerText = "❌ Erreur lors du run: " + err.message;
      }

      btn.disabled = false;
    }

    async function loadLogs() {
      const logsEl = document.getElementById("logs");
      logsEl.innerText = "⏳ Chargement logs...";
      try {
        const res = await fetch("/api/supercalc/logs");
        const data = await res.json();
        logsEl.innerHTML = data.map(l =>
          `<div class="card">
            <b>Run :</b> ${l.time}<br>
            <b>Status :</b> ${l.status}<br>
            <pre>${JSON.stringify(l.forecast, null, 2)}</pre>
          </div>`
        ).join("");
      } catch (err) {
        logsEl.innerText = "❌ Erreur chargement logs: " + err.message;
      }
    }

    document.addEventListener("DOMContentLoaded", loadLogs);
  </script>
</head>
<body>
  <h1>🛰️ Console Pro+ – Supercalculateur</h1>

  <div class="card">
    <button id="btn-run" class="btn btn-run" onclick="runForecast()">🚀 Lancer un run météo</button>
    <div class="progress"><div id="progress-bar" class="progress-bar"></div></div>
    <div id="result">Résultat en attente...</div>
  </div>

  <div class="card">
    <h2>🗄 Derniers runs sauvegardés</h2>
    <div id="logs">⏳ En attente...</div>
  </div>
</body>
</html>
