<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Console TINSFLASH</title>
  <style>
    body { font-family: Arial, sans-serif; background:#111; color:#eee; margin:0; }
    h1 { padding:10px; background:#222; }
    h2 { margin-top:20px; }
    .tabs { display:flex; background:#222; }
    .tab { padding:10px 20px; cursor:pointer; }
    .tab.active { background:#444; }
    .content { display:none; padding:20px; }
    .content.active { display:block; }
    table { width:100%; border-collapse:collapse; margin-top:10px; }
    th, td { border:1px solid #444; padding:6px; text-align:left; }
    th { background:#333; }
    iframe { width:100%; height:600px; border:none; margin-top:10px; }
    button { margin:5px; padding:8px 12px; cursor:pointer; }
    select, input { margin:5px; padding:6px; }
    #diag-result { background:#222; padding:10px; margin-top:10px; border:1px solid #555; white-space:pre-wrap; }
  </style>
</head>
<body>
  <h1>‚ö° Centrale Nucl√©aire M√©t√©o ‚Äî Console Admin</h1>

  <div class="tabs">
    <div class="tab active" data-tab="alerts">üö® Alertes</div>
    <div class="tab" data-tab="local">üìç Pr√©visions locales (copie index)</div>
    <div class="tab" data-tab="news">üì∞ Actualit√©s</div>
    <div class="tab" data-tab="radar">üì° Radar</div>
    <div class="tab" data-tab="diag">üîç Diagnostic moteur</div>
  </div>

  <!-- Onglet Alertes -->
  <div id="alerts" class="content active">
    <h2>Publi√©es (>90%)</h2>
    <table id="alerts-90"><tr><th>Pays</th><th>Type</th><th>Message</th><th>Fiabilit√©</th></tr></table>

    <h2>√Ä valider (70-90%)</h2>
    <table id="alerts-70"><tr><th>Pays</th><th>Type</th><th>Message</th><th>Fiabilit√©</th><th>Actions</th></tr></table>

    <h2>Envoy√©es expert</h2>
    <table id="alerts-expert"><tr><th>Pays</th><th>Type</th><th>Message</th><th>Fiabilit√©</th></tr></table>

    <h2>En attente</h2>
    <table id="alerts-wait"><tr><th>Pays</th><th>Type</th><th>Message</th><th>Fiabilit√©</th></tr></table>

    <h2>Ignor√©es (<70%)</h2>
    <table id="alerts-low"><tr><th>Pays</th><th>Type</th><th>Message</th><th>Fiabilit√©</th></tr></table>
  </div>

  <!-- Onglet Pr√©visions locales -->
  <div id="local" class="content">
    <h2>Pr√©vision locale (copie exacte de la page index utilisateur)</h2>
    <input type="text" id="city" placeholder="Ville">
    <select id="country">
      <option value="FR">France</option>
      <option value="BE">Belgique</option>
      <option value="DE">Allemagne</option>
      <option value="US">USA</option>
      <option value="GB">UK</option>
      <option value="ES">Espagne</option>
      <option value="IT">Italie</option>
    </select>
    <button onclick="loadForecast()">Voir comme utilisateur</button>
    <iframe id="forecast-frame"></iframe>
  </div>

  <!-- Onglet Actualit√©s -->
  <div id="news" class="content">
    <h2>Actualit√©s m√©t√©o & climat</h2>
    <div id="news-list"></div>
  </div>

  <!-- Onglet Radar -->
  <div id="radar" class="content">
    <h2>Radar m√©t√©o global (interne)</h2>
    <iframe id="radar-frame" src="/api/radar/europe"></iframe>

    <h2>Radar interactif (Windy-like)</h2>
    <label>Type de carte : </label>
    <select id="overlay-select" onchange="updateWindyOverlay()">
      <option value="rain">üåßÔ∏è Pluie</option>
      <option value="snow">‚ùÑÔ∏è Neige</option>
      <option value="wind">üí® Vent</option>
      <option value="temp">üå°Ô∏è Temp√©rature</option>
      <option value="pressure">üîµ Pression</option>
    </select>
    <iframe 
      id="windy-frame"
      src="https://embed.windy.com/embed2.html?lat=50&lon=5&zoom=4&level=surface&overlay=rain&product=ecmwf"
      width="100%" 
      height="600" 
      frameborder="0">
    </iframe>
  </div>

  <!-- Onglet Diagnostic -->
  <div id="diag" class="content">
    <h2>Diagnostic moteur m√©t√©o</h2>
    <button onclick="runDiagnostic()">Lancer diagnostic complet</button>
    <div id="diag-result">‚öôÔ∏è En attente de diagnostic...</div>
  </div>

  <script>
    // Tabs
    document.querySelectorAll(".tab").forEach(tab=>{
      tab.addEventListener("click", ()=>{
        document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
        document.querySelectorAll(".content").forEach(c=>c.classList.remove("active"));
        tab.classList.add("active");
        document.getElementById(tab.dataset.tab).classList.add("active");
      });
    });

    // Charger alertes
    async function loadAlerts() {
      const res = await fetch("/api/alerts");
      const data = await res.json();
      const alerts = data.covered || [];

      alerts.forEach((a, idx)=>{
        let row = `<tr>
          <td>${a.country||"-"}</td>
          <td>${a.type||"-"}</td>
          <td>${a.message||"-"}</td>
          <td>${a.reliability||"?"}%</td>`;

        if(a.reliability>=90){
          row += "</tr>";
          document.getElementById("alerts-90").innerHTML+=row;
        } 
        else if(a.reliability>=70 && !a.tag){
          row += `<td>
            <button onclick="handleAlertAction(${idx}, 'validate')">‚úÖ Valider</button>
            <button onclick="handleAlertAction(${idx}, 'expert')">üì§ Expert</button>
            <button onclick="handleAlertAction(${idx}, 'wait')">‚è≥ Attente</button>
          </td></tr>`;
          document.getElementById("alerts-70").innerHTML+=row;
        }
        else if(a.tag==="expert"){
          row += "</tr>";
          document.getElementById("alerts-expert").innerHTML+=row;
        }
        else if(a.tag==="wait"){
          row += "</tr>";
          document.getElementById("alerts-wait").innerHTML+=row;
        }
        else {
          row += "</tr>";
          document.getElementById("alerts-low").innerHTML+=row;
        }
      });
    }

    // Actions sur alertes
    async function handleAlertAction(index, action){
      const res = await fetch("/api/alerts/action", {
        method: "POST",
        headers: { "Content-Type":"application/json" },
        body: JSON.stringify({ index, action })
      });
      const result = await res.json();
      alert("Action: " + result.status);
      location.reload();
    }

    // Pr√©visions locales = copie index
    function loadForecast(){
      const city = document.getElementById("city").value;
      const country = document.getElementById("country").value;
      if(city && country){
        document.getElementById("forecast-frame").src = `/index.html?city=${encodeURIComponent(city)}&country=${country}`;
      }
    }

    // Actualit√©s
    async function loadNews() {
      const res = await fetch("/api/news");
      const news = await res.json();
      let html="";
      news.forEach(n=>{
        html += `<p><b>${n.title}</b><br>${n.summary||""}<br><a href="${n.link}" target="_blank">Lire plus</a></p>`;
      });
      document.getElementById("news-list").innerHTML=html;
    }

    // Radar interactif Windy
    function updateWindyOverlay(){
      const overlay = document.getElementById("overlay-select").value;
      const windy = document.getElementById("windy-frame");
      windy.src = `https://embed.windy.com/embed2.html?lat=50&lon=5&zoom=4&level=surface&overlay=${overlay}&product=ecmwf`;
    }

    // Diagnostic IA
    async function runDiagnostic(){
      document.getElementById("diag-result").innerText = "‚è≥ Diagnostic en cours...";
      try {
        const res = await fetch("/api/chat", {
          method: "POST",
          headers: { "Content-Type":"application/json" },
          body: JSON.stringify({ 
            message: "V√©rifie que le moteur a bien analys√© toutes les donn√©es (mod√®les, satellites, climat, relief), g√©n√©r√© les pr√©visions zones couvertes et non couvertes, et produit toutes les alertes comme pr√©vu.",
            country: "" 
          })
        });
        const data = await res.json();
        document.getElementById("diag-result").innerText = data.reply.reply || JSON.stringify(data);
      } catch (err) {
        document.getElementById("diag-result").innerText = "‚ùå Erreur diagnostic: " + err.message;
      }
    }

    // Initial load
    loadAlerts();
    loadNews();
  </script>
</body>
</html>
