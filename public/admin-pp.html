<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Centrale Nucl√©aire M√©t√©o - Admin</title>
  <style>
    body { font-family: Arial, sans-serif; background: #111; color: #eee; padding: 20px; }
    h2 { color: #0ff; }
    h3 { margin-top: 30px; }
    h4 { margin: 10px 0; }
    div, table { margin: 5px 0; }
    table { border-collapse: collapse; width: 100%; margin-top: 10px; }
    th, td { border: 1px solid #444; padding: 8px; text-align: left; }
    th { background: #222; }
    tr:nth-child(even) { background: #1a1a1a; }
    .btn { background: #0ff; color: #000; border: none; padding: 5px 10px; cursor: pointer; }
    .btn:hover { background: #0cc; }
    .danger { background: #f33; color: #fff; }
    .danger:hover { background: #c00; }
  </style>
</head>
<body>
  <h2>‚ö° Centrale Nucl√©aire M√©t√©o - Admin Console</h2>

  <!-- Pr√©visions nationales -->
  <section id="national">
    <h3>üáßüá™üá´üá∑üá±üá∫ Pr√©visions nationales</h3>
    <div id="BE-forecast">‚è≥ Chargement Belgique...</div>
    <div id="FR-forecast">‚è≥ Chargement France...</div>
    <div id="LUX-forecast">‚è≥ Chargement Luxembourg...</div>
  </section>

  <!-- Alertes m√©t√©o -->
  <section id="alerts">
    <h3>‚ö†Ô∏è Alertes m√©t√©o</h3>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Niveau</th>
          <th>Certitude</th>
          <th>Description</th>
          <th>Zone</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="alerts-table">
        <tr><td colspan="6">‚è≥ Chargement...</td></tr>
      </tbody>
    </table>
    <h4>‚ûï Nouvelle alerte</h4>
    <form id="alert-form">
      <input type="text" id="alert-type" placeholder="Type (pluie, vent...)" required />
      <input type="text" id="alert-level" placeholder="Niveau (jaune, orange, rouge)" required />
      <input type="number" id="alert-certainty" placeholder="Certitude (%)" required />
      <input type="text" id="alert-description" placeholder="Description" />
      <input type="text" id="alert-location" placeholder="Localisation" />
      <button type="submit" class="btn">Cr√©er</button>
    </form>
  </section>

  <script>
  // Charger les pr√©visions nationales
  async function loadForecast(country) {
    try {
      const res = await fetch(`/api/admin/forecasts/latest/${country}`);
      if (!res.ok) {
        document.getElementById(`${country}-forecast`).innerText = "‚ùå Pas de pr√©vision dispo";
        return;
      }
      const data = await res.json();
      let html = `<h4>${country}</h4>`;
      if (data.zones?.length > 0) {
        data.zones.forEach(z => {
          html += `<div><b>${z.name}</b> : ${z.text} (${z.min}¬∞C / ${z.max}¬∞C, ${z.icon})</div>`;
        });
      } else {
        html += `<div>${data.text} (${data.icon})</div>`;
      }
      document.getElementById(`${country}-forecast`).innerHTML = html;
    } catch (err) {
      console.error("Erreur chargement forecast", err);
      document.getElementById(`${country}-forecast`).innerText = "‚ö†Ô∏è Erreur chargement";
    }
  }

  // Charger les alertes
  async function loadAlerts() {
    try {
      const res = await fetch("/api/admin/alerts");
      const alerts = await res.json();
      const tbody = document.getElementById("alerts-table");
      tbody.innerHTML = "";
      if (alerts.length === 0) {
        tbody.innerHTML = "<tr><td colspan='6'>Aucune alerte</td></tr>";
        return;
      }
      alerts.forEach(a => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${a.type}</td>
          <td>${a.level}</td>
          <td>${a.certainty}%</td>
          <td>${a.description || ""}</td>
          <td>${a.location || ""}</td>
          <td>
            <button class="btn danger" onclick="deleteAlert('${a._id}')">üóëÔ∏è</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    } catch (err) {
      console.error("Erreur chargement alertes", err);
    }
  }

  // Supprimer une alerte
  async function deleteAlert(id) {
    if (!confirm("Supprimer cette alerte ?")) return;
    try {
      await fetch(`/api/admin/alerts/${id}`, { method: "DELETE" });
      loadAlerts();
    } catch (err) {
      console.error("Erreur suppression alerte", err);
    }
  }

  // Ajouter une nouvelle alerte
  document.getElementById("alert-form").addEventListener("submit", async (e) => {
    e.preventDefault();
    try {
      const newAlert = {
        type: document.getElementById("alert-type").value,
        level: document.getElementById("alert-level").value,
        certainty: parseInt(document.getElementById("alert-certainty").value),
        description: document.getElementById("alert-description").value,
        location: document.getElementById("alert-location").value
      };
      await fetch("/api/admin/alerts", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(newAlert)
      });
      document.getElementById("alert-form").reset();
      loadAlerts();
    } catch (err) {
      console.error("Erreur cr√©ation alerte", err);
    }
  });

  // Charger au d√©marrage
  window.onload = () => {
    ["BE","FR","LUX"].forEach(c => loadForecast(c));
    loadAlerts();
  };
  </script>
</body>
</html>
