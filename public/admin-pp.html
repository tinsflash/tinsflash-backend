<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>⚡ Centrale Nucléaire Météo – Console Admin</title>
  <style>
    body { font-family: Arial, sans-serif; background: #0b0f17; color: #e0e0e0; }
    header { background: #111; padding: 15px; text-align: center; font-size: 1.4em; }
    .btn-run { background: #28a745; border: none; padding: 15px 30px; font-size: 1.2em; cursor: pointer; border-radius: 8px; }
    .logs { background: #1c1f26; padding: 10px; height: 250px; overflow-y: scroll; font-size: 0.9em; }
    .status { display: flex; gap: 10px; margin: 15px 0; }
    .status-item { padding: 10px; border-radius: 6px; flex: 1; text-align: center; }
    .ok { background: #155724; color: #d4edda; }
    .fail { background: #721c24; color: #f8d7da; }
    .running { background: #856404; color: #fff3cd; }
  </style>
</head>
<body>
  <header>⚡ Console Admin – Centrale Nucléaire Météo</header>

  <section>
    <button class="btn-run" onclick="runGlobal()">🚀 Lancer RUN Global</button>
  </section>

  <section class="status" id="checklist">
    <div class="status-item running" id="sources">📡 Sources</div>
    <div class="status-item running" id="hires">🌍 HRRR/AROME</div>
    <div class="status-item running" id="alerts">⚡ Alertes</div>
    <div class="status-item running" id="db">💾 Sauvegarde</div>
  </section>

  <section>
    <h3>📋 Logs en direct</h3>
    <div class="logs" id="logs"></div>
  </section>

  <section>
    <h3>🚨 Dernières Alertes</h3>
    <ul id="alerts-list"></ul>
  </section>

  <section>
    <h3>👥 Utilisateurs par zones</h3>
    <div id="users"></div>
  </section>

  <script>
    async function runGlobal() {
      await fetch('/api/run-global', { method: 'POST' });
    }

    // 📡 Logs en direct via SSE
    const logBox = document.getElementById("logs");
    const evtSource = new EventSource("/api/logs/stream");
    evtSource.onmessage = function(e) {
      const logs = JSON.parse(e.data);
      logBox.innerHTML = logs.map(l => `<div>[${l.timestamp}] ${l.message}</div>`).join("");
      logBox.scrollTop = logBox.scrollHeight;
    };

    // ✅ Moteur état + checklist
    async function refreshEngine() {
      const res = await fetch("/api/engine-state");
      const state = await res.json();

      document.getElementById("sources").className = "status-item " + (state.sourcesOk ? "ok" : "fail");
      document.getElementById("hires").className = "status-item " + (state.hiresOk ? "ok" : "fail");
      document.getElementById("alerts").className = "status-item " + (state.alertsOk ? "ok" : "fail");
      document.getElementById("db").className = "status-item " + (state.dbOk ? "ok" : "fail");

      // 🚨 Alertes avec note HRRR/AROME/standard
      const alertsRes = await fetch("/api/alerts");
      const alertsData = await alertsRes.json();
      document.getElementById("alerts-list").innerHTML =
        alertsData.alerts.map(a => `<li>${a.country} ${a.region || ""} → ${a.data?.type || "?"} | Note: ${a.note || "Standard"}</li>`).join("");
    }

    setInterval(refreshEngine, 5000);
  </script>
</body>
</html>
