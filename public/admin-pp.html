<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="robots" content="noindex,nofollow">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‚ö° Console Admin ‚Äì Centrale Nucl√©aire M√©t√©o</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial, sans-serif; background:#111; color:#eee; margin:0; }
    header { background:#222; padding:12px; text-align:center; }
    nav a { color:#0af; margin:0 10px; text-decoration:none; }
    h2,h3 { margin-top:20px; }

    #alertsSummary { background:#222; padding:12px; margin:12px; border-radius:8px; font-size:0.95em; }
    .stat { margin:5px 0; }
    .badge { padding:3px 8px; border-radius:6px; margin-left:6px; }
    .exclusive { background:#a22; color:#fff; }
    .confirmed { background:#2a2; color:#fff; }
    .blinker { animation: blink 1s infinite; }
    @keyframes blink { 50% { opacity:0; } }

    .button { margin:5px; padding:10px 14px; border:none; border-radius:6px; cursor:pointer; font-weight:bold; min-width:220px; }
    .idle { background:#cc0; color:#000; }    /* orange par d√©faut */
    .running { background:#09f; color:#fff; } /* bleu en cours */
    .ok { background:#2a2; color:#fff; }      /* vert OK */
    .fail { background:#a22; color:#fff; }    /* rouge FAIL */

    #logs { display:block; background:#000; color:#0f0; padding:10px; border-radius:6px; margin:10px; max-height:250px; overflow:auto; font-family:monospace; font-size:0.85em; }

    .columns { display:flex; gap:20px; margin:20px; flex-wrap:wrap; }
    .zone { flex:1; background:#222; padding:10px; border-radius:8px; }
    .zone h3 { margin:0 0 8px 0; }
    .row { display:flex; justify-content:space-between; margin:4px 0; }
    .ball { width:14px; height:14px; border-radius:50%; display:inline-block; margin-left:6px; }
    .ball.orange { background:#cc0; }
    .ball.green { background:#2a2; }
    .ball.red { background:#a22; }
    .ball.purple { background:#639; }

    #chatButton {
      position: fixed; bottom:20px; right:20px;
      width:60px; height:60px; border-radius:50%;
      background:#0af; color:#fff; font-size:24px; font-weight:bold;
      border:none; cursor:pointer; z-index:9999;
    }
    #chatBubble {
      position: fixed; bottom:90px; right:20px;
      background:#222; border:2px solid #0af; border-radius:12px;
      padding:10px; width:300px; height:400px;
      display:none; flex-direction:column; z-index:9999;
    }
    #chatBubble header { font-weight:bold; text-align:center; margin-bottom:6px; }
    #chatLog { flex:1; overflow-y:auto; background:#000; padding:6px; border-radius:6px; }
    #chatInput { margin-top:6px; display:flex; }
    #chatInput input { flex:1; padding:4px; }
    #chatInput button { padding:4px 8px; }
  </style>
</head>
<body>
<script>
  const pwd = prompt("Mot de passe ?");
  if (pwd !== "202679") {
    document.write("<h1 style='color:red;text-align:center;'>‚õî Acc√®s refus√©</h1>");
    throw new Error("Acc√®s refus√©");
  }
</script>

<header>
  <h1>‚ö° Centrale nucl√©aire m√©t√©o ‚Äì Console Admin</h1>
  <nav>
    <a href="/admin">Console</a>
    <a href="/admin-alerts">Alertes</a>
    <a href="/admin-chat">Chat</a>
    <a href="/admin-index">Vue Index</a>
    <a href="/admin-radar">Radar & News</a>
    <a href="/admin-users">Utilisateurs</a>
  </nav>
</header>

<div id="alertsSummary">Chargement du r√©sum√©‚Ä¶</div>
<canvas id="alertsChart"></canvas>

<div class="columns">
  <div class="zone">
    <h3>üåç Pr√©visions Europe</h3>
    <div id="europeForecast"></div>
  </div>
  <div class="zone">
    <h3>üá∫üá∏ Pr√©visions USA</h3>
    <div id="usaForecast"></div>
  </div>
</div>
<div class="columns">
  <div class="zone">
    <h3>üö® Alertes Europe</h3>
    <div id="europeAlerts"></div>
  </div>
  <div class="zone">
    <h3>üö® Alertes USA</h3>
    <div id="usaAlerts"></div>
  </div>
</div>

<section id="engineControls">
  <h2>üõ† Contr√¥le moteur</h2>
  <button id="btnEurope" class="button idle" onclick="runProcess('/api/run-europe','btnEurope')">Run Pr√©visions Europe</button>
  <button id="btnUSA" class="button idle" onclick="runProcess('/api/run-usa','btnUSA')">Run Pr√©visions USA</button>
  <button id="btnAlertsEurope" class="button idle" onclick="runProcess('/api/run-alerts','btnAlertsEurope')">Run Alertes Europe</button>
  <button id="btnAlertsContinental" class="button idle" onclick="runProcess('/api/run-alerts-continental','btnAlertsContinental')">Run Alertes Continentales</button>
  <button id="btnAlertsWorld" class="button idle" onclick="runProcess('/api/run-alerts-world','btnAlertsWorld')">Run Alertes Mondiales</button>
  <button id="btnOrchestrator" class="button idle" onclick="runProcess('/api/run-orchestrator','btnOrchestrator')">Run Orchestrateur IA</button>
</section>

<h2>üìú Logs en direct</h2>
<pre id="logs">Connexion logs en direct‚Ä¶</pre>

<button id="chatButton" onclick="toggleChat()">üí¨</button>
<div id="chatBubble">
  <header>ü§ñ ChatGPT5 ‚Äì Moteur</header>
  <div id="chatLog"></div>
  <div id="chatInput">
    <input type="text" id="chatMsg" placeholder="Demander au moteur..." onkeypress="if(event.key==='Enter') sendChat()">
    <button onclick="sendChat()">Envoyer</button>
  </div>
</div>

<script>
  let chart;
  let lastExclusiveCount = 0;

  // === R√©sum√© alertes
  async function fetchAlertsSummary() {
    const res = await fetch("/api/alerts/summary");
    if (!res.ok) return;
    const s = await res.json();
    const exclusiveCount = s.exclusives || 0;

    let exclusiveBadge = `<span class="badge exclusive">${exclusiveCount}</span>`;
    if (exclusiveCount > lastExclusiveCount) {
      exclusiveBadge = `<span class="badge exclusive blinker">${exclusiveCount}</span>`;
    }
    lastExclusiveCount = exclusiveCount;

    document.getElementById("alertsSummary").innerHTML = `
      <div class="stat">üìä <strong>Total alertes actives :</strong> ${s.total || 0}</div>
      <div class="stat">üîµ Sous surveillance : ${s.byStatus?.["under-surveillance"] || 0}</div>
      <div class="stat">üî¥ Exclusives : ${exclusiveBadge}
          üü¢ Confirm√©es ailleurs : <span class="badge confirmed">${s.confirmedElsewhere || 0}</span></div>
    `;
    updateChart(s);
  }

  function updateChart(s) {
    const ctx = document.getElementById("alertsChart").getContext("2d");
    const data = {
      labels: ["Publi√©es", "√Ä valider", "Surveillance", "Ignor√©es", "Exclusives", "Confirm√©es"],
      datasets: [{
        data: [
          s.byStatus?.["published"] || 0,
          s.byStatus?.["toValidate"] || 0,
          s.byStatus?.["under-surveillance"] || 0,
          s.byStatus?.["ignored"] || 0,
          s.exclusives || 0,
          s.confirmedElsewhere || 0
        ],
        backgroundColor: ["#2a2", "#cc0", "#335", "#633", "#a22", "#0af"]
      }]
    };
    if (chart) { chart.data = data; chart.update(); }
    else {
      chart = new Chart(ctx, {
        type: "doughnut",
        data,
        options: { plugins:{ legend:{ labels:{ color:"#eee" } } } }
      });
    }
  }

  // === Zones pr√©visions / alertes
  async function fetchCountries() {
    const res = await fetch("/api/checkup");
    const state = await res.json();
    fillZone("europeForecast", Object.keys(state.zonesCoveredEurope || {}), state.checkupForecast);
    fillZone("usaForecast", Object.keys(state.zonesCoveredUSA || {}), state.checkupForecast);
    fillZone("europeAlerts", Object.keys(state.zonesCoveredEurope || {}), state.checkupAlerts);
    fillZone("usaAlerts", Object.keys(state.zonesCoveredUSA || {}), state.checkupAlerts);
  }
  function fillZone(id, list, checkup) {
    const div = document.getElementById(id);
    div.innerHTML = "";
    list.forEach(c => {
      const st = checkup?.[c] || "PENDING";
      let ballClass = "orange";
      if (st === "OK") ballClass = "green";
      else if (st === "FAIL") ballClass = "red";
      else if (st === "PARTIAL") ballClass = "purple";
      div.innerHTML += `<div class="row"><span>${c}</span><span class="ball ${ballClass}"></span></div>`;
    });
  }

  // === Logs SSE
  let eventSource = new EventSource("/api/logs/stream");
  eventSource.onmessage = (e) => {
    if (!e.data) return;
    try {
      const obj = JSON.parse(e.data);
      addLog(`[${obj.ts ? new Date(obj.ts).toLocaleTimeString() : new Date().toLocaleTimeString()}] ${obj.message}`);
    } catch { addLog(e.data); }
  };
  function addLog(msg) {
    const logs = document.getElementById("logs");
    logs.innerText += msg + "\n";
    logs.scrollTop = logs.scrollHeight;
  }

  // === Boutons Run
  async function runProcess(url, btnId) {
    const btn = document.getElementById(btnId);
    btn.className = "button running"; btn.innerText = "‚è≥ En cours...";
    try {
      const res = await fetch(url, { method:"POST" });
      const data = await res.json();
      if (res.ok && data.success) {
        btn.className = "button ok"; btn.innerText = "‚úÖ Termin√©";
      } else {
        btn.className = "button fail"; btn.innerText = "‚ùå Erreur";
      }
    } catch (e) {
      btn.className = "button fail"; btn.innerText = "‚ùå Erreur";
    }
    setTimeout(() => { btn.className = "button idle"; btn.innerText = btn.getAttribute("data-label") || btn.innerText; }, 5000);
  }

  // === Chat
  function toggleChat() {
    const chat = document.getElementById("chatBubble");
    chat.style.display = chat.style.display === "none" ? "flex" : "none";
  }
  async function sendChat() {
    const input = document.getElementById("chatMsg");
    const msg = input.value.trim(); if (!msg) return;
    const logEl = document.getElementById("chatLog");
    logEl.innerHTML += `<div><b>Moi:</b> ${msg}</div>`; input.value = "";
    const res = await fetch("/api/chat/engine", {
      method:"POST", headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ message: msg })
    });
    const data = await res.json();
    logEl.innerHTML += `<div><b>GPT:</b> ${data.reply}</div>`;
    logEl.scrollTop = logEl.scrollHeight;
  }

  // Init
  setInterval(fetchAlertsSummary, 7000);
  setInterval(fetchCountries, 10000);
  window.onload = () => { fetchAlertsSummary(); fetchCountries(); };
</script>
</body>
</html>
