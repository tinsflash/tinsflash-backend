<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="robots" content="noindex,nofollow">
  <title>🚨 Console Admin – TINSFLASH</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { margin:0; font-family:Arial, sans-serif; background:#0d1117; color:#e6edf3; }
    header { background:#111; padding:12px; text-align:center; font-size:22px; font-weight:bold; color:#0af; }
    nav { background:#1c1f26; padding:10px; text-align:center; }
    nav a { color:#0af; margin:0 12px; text-decoration:none; }
    h2 { margin:15px 0 10px; color:#0af; }
    button { margin:6px 0; padding:8px 12px; border:none; border-radius:6px; cursor:pointer; background:#0af; color:#000; font-weight:bold; }
    #status-message { margin-top:8px; font-weight:bold; }
    #logs { background:#000; color:#eee; font-family:monospace; padding:10px; height:250px; overflow-y:auto; border-radius:8px; margin-top:10px; white-space:pre-wrap; }
    .phase-list { list-style:none; padding:0; margin:0; }
    .phase-list li { padding:4px 0; }
    .ok { color:lime; }
    .fail { color:red; }
    .pending { color:orange; }
    #map { height:400px; border-radius:8px; margin-top:10px; }
  </style>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
</head>
<body>
<script>
  const pass = prompt("Code d'accès ?");
  if (pass !== "202679") {
    document.body.innerHTML = "<h1 style='color:red;text-align:center;'>⛔ Accès refusé</h1>";
    throw new Error("Accès refusé");
  }
</script>

<header>🚨 Console Admin – TINSFLASH</header>
<nav>
  <a href="/admin">Console</a>
  <a href="/admin-alerts">Alertes</a>
  <a href="/admin-chat">Chat IA</a>
  <a href="/admin-index">Vue Index</a>
  <a href="/admin-radar">Radar & News</a>
  <a href="/admin-users">Utilisateurs</a>
</nav>

<main style="padding:20px;">
  <h2>⚡ Orchestration</h2>
  <button onclick="runGlobal()">▶️ Run Global (Orchestre)</button>
  <div id="status-message">⏳ En attente lancement...</div>

  <h2>🌍 Carte des prévisions & alertes</h2>
  <div id="map"></div>

  <h2>⚡ Phases du moteur</h2>
  <ul class="phase-list">
    <li id="phase-models" class="pending">🛰️ Modèles</li>
    <li id="phase-localForecasts" class="pending">📊 Prévisions locales/nationales</li>
    <li id="phase-forecastsContinental" class="pending">🌐 Prévisions continentales</li>
    <li id="phase-aiAlerts" class="pending">🚨 Alertes locales/nationales</li>
    <li id="phase-alertsContinental" class="pending">🌍 Alertes continentales</li>
    <li id="phase-alertsWorld" class="pending">🌎 Alertes mondiales</li>
    <li id="phase-fusionIA" class="pending">🤖 Fusion IA globale</li>
  </ul>

  <h2>📜 Logs moteur (live)</h2>
  <div id="logs">Connexion en cours…</div>
</main>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
  // =============================
  // 🚀 Lancement Run Global
  // =============================
  async function runGlobal(){
    const statusDiv=document.getElementById("status-message");
    statusDiv.innerText="🚀 Run Global lancé...";
    statusDiv.style.color="orange";
    try{
      const res=await fetch("/api/run-global",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({zone:"All"})});
      const data=await res.json();
      if(data.success){
        statusDiv.innerText="✅ Run Global en cours (orchestration active)";
        statusDiv.style.color="lime";
      } else {
        statusDiv.innerText="❌ Erreur lancement run global";
        statusDiv.style.color="red";
      }
    }catch(e){
      statusDiv.innerText="❌ Erreur serveur: "+e.message;
      statusDiv.style.color="red";
    }
  }

  // =============================
  // 📡 Logs moteur live (SSE)
  // =============================
  const logDiv=document.getElementById("logs");
  const evt=new EventSource("/api/logs/stream");
  evt.onmessage=(e)=>{
    const log=JSON.parse(e.data);
    logDiv.innerHTML+=`<div>[${new Date(log.ts).toLocaleTimeString()}] ${log.message}</div>`;
    logDiv.scrollTop=logDiv.scrollHeight;
  };
  evt.onerror=()=>{ logDiv.innerHTML+="<div style='color:red'>⚠️ Perte connexion logs</div>"; };

  // =============================
  // ⚡ Phases moteur (checkup)
  // =============================
  async function refreshPhases(){
    try{
      const res=await fetch("/api/checkup");
      const data=await res.json();
      for(const key in data){
        const el=document.getElementById("phase-"+key);
        if(el){
          el.className=data[key]==="OK"?"ok":data[key]==="FAIL"?"fail":"pending";
        }
      }
    }catch(e){ console.warn("Erreur phases:",e.message); }
  }
  setInterval(refreshPhases,5000);

  // =============================
  // 🗺️ Carte Leaflet
  // =============================
  const map=L.map("map").setView([20,0],2);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:6}).addTo(map);

  let countryLayers={};
  async function refreshMap(){
    try{
      const res=await fetch("/api/alerts");
      const alerts=await res.json();
      alerts.forEach(a=>{
        if(a.lat && a.lon){
          const color=a.data?.status==="published"?"red":a.data?.status==="toValidate"?"orange":"blue";
          if(countryLayers[a.country]) map.removeLayer(countryLayers[a.country]);
          countryLayers[a.country]=L.circleMarker([a.lat,a.lon],{radius:6,color:color,fillColor:color,fillOpacity:0.8}).bindPopup(`${a.country} ${a.region||""}<br>${a.data?.status} (${a.data?.confidence||0}%)`).addTo(map);
        }
      });
    }catch(e){ console.warn("Erreur map:",e.message); }
  }
  setInterval(refreshMap,10000);
</script>
</body>
</html>
