<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>âš¡ Centrale NuclÃ©aire MÃ©tÃ©o â€“ Console Admin</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <header>
    <h1>âš¡ Centrale NuclÃ©aire MÃ©tÃ©o â€“ Console Admin</h1>
  </header>

  <!-- SuperForecast -->
  <section>
    <h3>ğŸš€ SuperForecast</h3>
    <button onclick="runSuperForecast()">Lancer Run</button>
    <p id="sf-status">â³ En attenteâ€¦</p>
  </section>

  <!-- PrÃ©visions -->
  <section>
    <h3>ğŸ“¡ PrÃ©visions nationales (BE / FR multi-zones / USA)</h3>
    <div id="forecast-list">â³ Chargementâ€¦</div>
    <button onclick="publishToIndex()">Publier vers index</button>
  </section>

  <!-- Alertes -->
  <section>
    <h3>âš ï¸ Alertes</h3>
    <div id="alerts">Aucune alerte</div>
  </section>

  <!-- Chat J.E.A.N. -->
  <section>
    <h3>ğŸ¤– Chat J.E.A.N.</h3>
    <input type="text" id="chat-input" placeholder="Pose ta question..." />
    <button id="chat-send">Envoyer</button>
    <p id="chat-response">â³ En attente...</p>
  </section>

  <!-- Debug IA -->
  <section id="debug-ia" style="display:none;">
    <h3>ğŸ› ï¸ Debug Cohere</h3>
    <pre id="debug-content" style="background:#111; color:#0f0; padding:10px; border-radius:8px; max-height:200px; overflow:auto;"></pre>
  </section>
  <button id="toggle-debug">Afficher debug IA</button>

  <!-- Logs -->
  <section>
    <h3>ğŸ“œ Logs</h3>
    <div id="logs">â³ Chargementâ€¦</div>
  </section>

  <script>
    async function runSuperForecast() {
      document.getElementById("sf-status").textContent = "â³ Run en coursâ€¦";
      const res = await fetch("/api/superforecast/run", { method: "POST" });
      const data = await res.json();
      document.getElementById("sf-status").textContent = "âœ… Run terminÃ©";
      loadLogs();
    }

    async function publishToIndex() {
      alert("ğŸ“¤ PrÃ©visions publiÃ©es vers lâ€™index (front).");
    }

    async function loadForecasts() {
      const res = await fetch("/api/forecasts");
      const data = await res.json();
      const container = document.getElementById("forecast-list");
      if (!data || data.length === 0) {
        container.textContent = "âš ï¸ Aucune prÃ©vision disponible.";
        return;
      }
      container.innerHTML = data.map(f =>
        `<div><strong>${f.zone || "N/A"}</strong> â€“ ${f.minTemp ?? "?"}Â° / ${f.maxTemp ?? "?"}Â° â€“ ğŸŒ§ï¸ ${f.precip ?? "?"}% â€“ ğŸ’¨ ${f.wind ?? "?"} km/h</div>`
      ).join("");
    }

    async function loadAlerts() {
      const res = await fetch("/api/alerts");
      const data = await res.json();
      const container = document.getElementById("alerts");
      if (!data || data.length === 0) {
        container.textContent = "âš ï¸ Aucune alerte.";
        return;
      }
      container.innerHTML = data.map(a =>
        `<div>ğŸš¨ ${a.type} â€“ ${a.zone} (${a.level})</div>`
      ).join("");
    }

    async function loadLogs() {
      const res = await fetch("/api/logs");
      const data = await res.json();
      const container = document.getElementById("logs");
      if (!data || data.length === 0) {
        container.textContent = "âš ï¸ Aucun log.";
        return;
      }
      container.innerHTML = data.map(l =>
        `<div>[${l.date || "?"}] ${l.message}</div>`
      ).join("");
    }

    // Chat JEAN
    const chatInput = document.getElementById("chat-input");
    const chatSend = document.getElementById("chat-send");
    const chatResponse = document.getElementById("chat-response");
    const debugSection = document.getElementById("debug-ia");
    const debugContent = document.getElementById("debug-content");
    const toggleDebug = document.getElementById("toggle-debug");

    toggleDebug.addEventListener("click", () => {
      debugSection.style.display = debugSection.style.display === "none" ? "block" : "none";
    });

    chatSend.addEventListener("click", async () => {
      const message = chatInput.value.trim();
      if (!message) {
        chatResponse.textContent = "âš ï¸ Entrez une question.";
        return;
      }

      chatResponse.textContent = "â³ J.E.A.N. rÃ©flÃ©chit...";

      try {
        const res = await fetch("/api/chat", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ message }),
        });

        const data = await res.json();
        chatResponse.textContent = data.reply || "âš ï¸ RÃ©ponse indisponible";

        if (data.debug) {
          debugContent.textContent = JSON.stringify(data.debug, null, 2);
        }
      } catch (err) {
        chatResponse.textContent = "âš ï¸ Erreur rÃ©seau.";
      }
    });

    // Auto-load
    loadForecasts();
    loadAlerts();
    loadLogs();
  </script>
</body>
</html>
