<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üõ∞Ô∏è Console IA J.E.A.N ‚Äì TINSFLASH (Cockpit)</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <style>
    body{margin:0;background:#0b1220;color:#e0e6f0;font-family:"Segoe UI",sans-serif;}
    header{background:#111b2e;padding:15px;text-align:center;color:#4fc3f7;font-weight:bold;font-size:1.4em;text-shadow:0 0 10px #4fc3f7;}
    nav{display:flex;justify-content:center;flex-wrap:wrap;gap:10px;background:#141e33;padding:8px;}
    nav a{color:#a9b7d0;text-decoration:none;padding:8px 14px;border-radius:8px;transition:0.3s;background:#1a2744;}
    nav a:hover,nav a.active{background:#4fc3f7;color:#000;}
    main{max-width:1200px;margin:auto;padding:20px;}
    h2{color:#4fc3f7;margin-top:25px;}
    .section{background:#101a30;border-radius:12px;padding:18px;margin-bottom:25px;box-shadow:0 0 10px rgba(0,0,0,0.4);}
    .btn{background:#1a2744;color:#4fc3f7;border:1px solid #4fc3f7;padding:8px 14px;border-radius:6px;cursor:pointer;font-weight:bold;margin:4px;transition:0.3s;}
    .btn:hover{background:#4fc3f7;color:#000;}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:20px;}
    #map-forecast,#map-alerts{height:320px;border-radius:10px;overflow:hidden;}
    #logStream{background:#000;color:#4fc3f7;font-family:monospace;padding:10px;border-radius:6px;height:200px;overflow-y:auto;}
    small{color:#7a8cab;}
  </style>
</head>

<body>
  <header>üõ∞Ô∏è Console IA J.E.A.N ‚Äì TINSFLASH (Cockpit)</header>

  <nav>
    <a href="admin-alerts.html">Alertes</a>
    <a href="admin-chat.html">Chat</a>
    <a href="admin-radar.html">Radar</a>
    <a href="admin-users.html">Utilisateurs</a>
    <a href="index.html">Index</a>
  </nav>

  <main>
    <div class="section">
      <h2>üß† Commandes moteur</h2>
      <button class="btn" data-action="extract" onclick="runExtraction()">‚ö° Extraction</button>
      <button class="btn" data-action="ai" onclick="runIAJEAN()">üß† Analyse IA J.E.A.N.</button>
      <button class="btn" data-action="refresh" onclick="refreshStatus()">üîÑ Rafra√Æchir</button>
      <button class="btn" data-action="integrate" onclick="integrateAlerts()">‚ö° Int√©grer alertes IA ‚Üí moteur</button>
    </div>

    <div class="section">
      <h2>‚öôÔ∏è √âtat du moteur</h2>
      <div id="engineStatus">Chargement...</div>
    </div>

    <div class="section grid">
      <div>
        <h2>üåç Carte pr√©visions</h2>
        <div id="map-forecast"></div>
      </div>
      <div>
        <h2>üåã Carte alertes</h2>
        <div id="map-alerts"></div>
      </div>
    </div>

    <div class="section">
      <h2>üìú Logs moteur</h2>
      <div id="logStream">Connexion...</div>
    </div>
  </main>

  <script>
    const API="/api";
    const logDiv=document.getElementById("logStream");

    // === Flux SSE temps r√©el ===
    function startLogStream(){
      const evtSource=new EventSource(`${API}/logs/stream`);
      evtSource.onmessage=(e)=>{
        try{
          const d=JSON.parse(e.data);
          const t=new Date(d.timestamp).toLocaleTimeString();
          logDiv.innerHTML+=`<div>[${t}] [${d.level.toUpperCase()}][${d.module}] ${d.message}</div>`;
          logDiv.scrollTop=logDiv.scrollHeight;
        }catch{}
      };
      evtSource.onerror=()=>logDiv.innerHTML+="<div>‚ö†Ô∏è Connexion SSE perdue...</div>";
    }

    // === √âtat du moteur ===
    async function refreshStatus(){
      const e=document.getElementById("engineStatus");
      e.innerHTML="Mise √† jour...";
      try{
        const r=await fetch(`${API}/status`);
        const d=await r.json();
        e.innerHTML=`<b>Statut:</b> ${d.status}<br>
          <b>Dernier run:</b> ${new Date(d.lastRun).toLocaleString()}<br>
          <b>Alertes actives:</b> ${d.alerts?.length||0}<br>
          <b>Zones couvertes:</b> ${d.coveredZones?.length||0}`;
      }catch(err){e.innerHTML="‚ùå Erreur statut: "+err.message;}
    }

    // === Extraction compl√®te ===
    async function runExtraction(){
      showPopup("‚öôÔ∏è Extraction des mod√®les en cours...","Fusion GFS / ECMWF / ICON / NASA");
      try{
        const r=await fetch(`${API}/run-global`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({zone:"All"})});
        const d=await r.json();
        closePopup();
        if(!d.success)throw new Error(d.error||"Erreur inconnue");
        alert("‚úÖ Extraction compl√®te r√©ussie !");
        refreshStatus();
      }catch(e){closePopup();alert("‚ùå Extraction √©chou√©e: "+e.message);}
    }

    // === IA J.E.A.N. avec popup anim√© ===
    async function runIAJEAN(){
      const btn=document.querySelector("button[data-action='ai']");
      btn.disabled=true;btn.style.opacity="0.6";
      showPopup("üß† Analyse IA J.E.A.N. en cours...","Fusion IA / mod√®les / relief / climat");
      try{
        const r=await fetch(`${API}/ai-analyse`,{method:"POST"});
        const d=await r.json();
        closePopup();btn.disabled=false;btn.style.opacity="1";
        if(!d.success)throw new Error(d.error||"Erreur inconnue");
        alert("‚úÖ Analyse IA J.E.A.N. termin√©e avec succ√®s !");
        refreshStatus();
      }catch(e){
        closePopup();btn.disabled=false;btn.style.opacity="1";
        alert("‚ùå Erreur IA J.E.A.N : "+e.message);
      }
    }

    // === Int√©gration alertes ===
    async function integrateAlerts(){
      showPopup("‚ö° Int√©gration des alertes IA...","Mise √† jour du moteur en cours");
      try{
        const r=await fetch(`${API}/alerts`);
        const d=await r.json();
        closePopup();
        if(!Array.isArray(d))throw new Error("Aucune alerte disponible");
        alert(`‚úÖ ${d.length} alertes pr√™tes √† √™tre int√©gr√©es !`);
      }catch(e){closePopup();alert("‚ùå Erreur int√©gration: "+e.message);}
    }

    // === Carte Leaflet ===
    function initMaps(){
      const mapF=L.map("map-forecast").setView([30,10],2);
      const mapA=L.map("map-alerts").setView([30,10],2);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(mapF);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(mapA);
    }

    // === Popups anim√©s ===
    function showPopup(title,subtitle=""){
      const overlay=document.createElement("div");
      overlay.id="popupOverlay";
      overlay.style.cssText=`
        position:fixed;inset:0;background:rgba(0,0,0,0.85);
        display:flex;flex-direction:column;align-items:center;justify-content:center;
        color:#4fc3f7;font-family:'Segoe UI',sans-serif;z-index:9999;text-align:center;
      `;
      overlay.innerHTML=`
        <div style="border:4px solid #4fc3f7;border-top-color:transparent;border-radius:50%;
          width:80px;height:80px;animation:spin 1.2s linear infinite;margin-bottom:20px"></div>
        <p style="font-size:1.2em;font-weight:bold">${title}</p>
        <small>${subtitle}</small>
        <style>@keyframes spin{to{transform:rotate(360deg)}}</style>
      `;
      document.body.appendChild(overlay);
    }
    function closePopup(){const p=document.getElementById("popupOverlay");if(p)p.remove();}

    // === Init ===
    document.addEventListener("DOMContentLoaded",()=>{
      initMaps();
      refreshStatus();
      startLogStream();
    });
  </script>
</body>
</html>
