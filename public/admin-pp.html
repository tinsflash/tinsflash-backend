<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>TINSFLASH – Console Administrateur</title>
  <style>
    body { margin:0; font-family:Arial; background:#111; color:#eee; }
    header { background:#222; padding:10px; font-size:18px; }
    nav { display:flex; gap:10px; margin-bottom:10px; }
    nav button { padding:8px 12px; cursor:pointer; border:none; border-radius:4px; }
    section { padding:10px; }
    .ok { color:lime; }
    .ko { color:red; }
    .inconnu { color:orange; }
    .card { background:#1a1a1a; padding:10px; border-radius:6px; margin-bottom:10px; }
    pre { background:#000; padding:10px; border-radius:4px; overflow-x:auto; }
  </style>
</head>
<body>
  <header>
    ⚡ TINSFLASH – Console Administrateur
    <span id="lastState" style="font-size:14px;color:gray;margin-left:10px;"></span>
  </header>

  <nav>
    <button onclick="showTab('dashboard')">Dashboard</button>
    <button onclick="showTab('alerts')">Alertes</button>
    <button onclick="showTab('users')">Vue utilisateur</button>
    <button onclick="showTab('chat')">Chat IA (moteur)</button>
    <button onclick="showTab('tools')">Outils & Radar</button>
  </nav>

  <!-- Dashboard -->
  <section id="dashboard" class="tab">
    <div class="card">
      <h3>🚀 Lancer le moteur</h3>
      <button onclick="runGlobal()">RUN GLOBAL (zones couvertes)</button>
      <button onclick="runContinental()">RUN CONTINENTAL (non couvertes)</button>
      <button onclick="loadEngineState()">Actualiser état</button>
      <pre id="runResult">Résultat du run affiché ici…</pre>
    </div>

    <div class="card">
      <h3>🧠 Checkup 13 points</h3>
      <ul id="checkupList"></ul>
    </div>

    <div class="card">
      <h3>📜 Logs (moteur & admin)</h3>
      <button onclick="loadLogs()">Charger logs</button>
      <pre id="logs">Aucun log.</pre>
    </div>

    <div class="card">
      <h3>🧩 État & Utilisateurs</h3>
      <pre id="stateUsers">Chargement…</pre>
    </div>
  </section>

  <!-- Alertes -->
  <section id="alerts" class="tab" style="display:none;">
    <div class="card">
      <h3>⚠️ Gestion des alertes</h3>
      <button onclick="loadAlerts()">Actualiser les alertes</button>
      <pre id="alertsList">Chargement…</pre>
    </div>
  </section>

  <!-- Utilisateurs -->
  <section id="users" class="tab" style="display:none;">
    <div class="card">
      <h3>👥 Vue utilisateur</h3>
      <p>Simulation de la page index (à implémenter plus tard)</p>
    </div>
  </section>

  <!-- Chat -->
  <section id="chat" class="tab" style="display:none;">
    <div class="card">
      <h3>💬 Chat IA (moteur)</h3>
      <input id="chatInput" placeholder="Posez une question…" style="width:80%;" />
      <button onclick="askChat()">Envoyer</button>
      <pre id="chatReply">Réponse IA…</pre>
    </div>
  </section>

  <!-- Outils -->
  <section id="tools" class="tab" style="display:none;">
    <div class="card">
      <h3>🛰 Outils & Radar</h3>
      <p>Radar global en cours d’intégration…</p>
    </div>
  </section>

  <script>
    async function runGlobal() {
      const res = await fetch("/api/run-global", { method: "POST" });
      document.getElementById("runResult").textContent = JSON.stringify(await res.json(), null, 2);
      loadEngineState();
    }
    async function runContinental() {
      const res = await fetch("/api/run-continental", { method: "POST" });
      document.getElementById("runResult").textContent = JSON.stringify(await res.json(), null, 2);
      loadEngineState();
    }
    async function loadEngineState() {
      const res = await fetch("/api/engine-state");
      const data = await res.json();
      document.getElementById("lastState").textContent = data.runTime ? "Dernier état: " + data.runTime : "Aucun run encore";
      renderCheckup(data);
      document.getElementById("stateUsers").textContent = JSON.stringify({ moteur:"actif", ia:data.ia, users:data.users }, null, 2);
    }
    async function loadLogs() {
      const res = await fetch("/api/logs");
      document.getElementById("logs").textContent = JSON.stringify(await res.json(), null, 2);
    }
    async function loadAlerts() {
      const res = await fetch("/api/alerts");
      document.getElementById("alertsList").textContent = JSON.stringify(await res.json(), null, 2);
    }
    async function askChat() {
      const msg = document.getElementById("chatInput").value;
      const res = await fetch("/api/chat", {
        method:"POST", headers:{ "Content-Type":"application/json" },
        body:JSON.stringify({ message: msg })
      });
      document.getElementById("chatReply").textContent = JSON.stringify(await res.json(), null, 2);
    }
    function renderCheckup(state) {
      const points = [
        { id:"models.ok", label:"1. Modèles OK", value:state.models.ok.length>0 },
        { id:"models.ko", label:"2. Modèles non OK", value:state.models.ko.length>0 ? false : null },
        { id:"sources.ok", label:"3. Sources OK", value:state.sources.ok.length>0 },
        { id:"sources.ko", label:"4. Sources non OK", value:state.sources.ko.length>0 ? false : null },
        { id:"ia.forecasts", label:"5. Analyse IA prévisions", value:state.ia.forecasts },
        { id:"ia.alerts", label:"6. Analyse IA alertes", value:state.ia.alerts },
        { id:"forecasts.local", label:"7. Prévisions locales (zones couvertes)", value:state.forecasts.local },
        { id:"forecasts.national", label:"8. Prévisions nationales (zones couvertes)", value:state.forecasts.national },
        { id:"alerts.local", label:"9. Alertes locales (zones couvertes)", value:state.alerts.local },
        { id:"alerts.national", label:"10. Alertes nationales (zones couvertes)", value:state.alerts.national },
        { id:"alerts.continental", label:"11. Alertes continentales (zones non couvertes)", value:state.alerts.continental },
        { id:"alerts.world", label:"12. Assemblage alertes mondiales", value:state.alerts.world },
        { id:"forecasts.openData", label:"13. Open-data prévisions (zones non couvertes)", value:state.forecasts.openData },
      ];
      const ul = document.getElementById("checkupList");
      ul.innerHTML = "";
      points.forEach(p=>{
        let cls = "inconnu", txt = "inconnu";
        if (p.value === true) { cls="ok"; txt="OK"; }
        if (p.value === false) { cls="ko"; txt="KO"; }
        const li=document.createElement("li");
        li.innerHTML = `<span class="${cls}">${p.label}: ${txt}</span>`;
        ul.appendChild(li);
      });
    }
    function showTab(tab) {
      document.querySelectorAll(".tab").forEach(el=>el.style.display="none");
      document.getElementById(tab).style.display="block";
    }
    loadEngineState();
  </script>
</body>
</html>
