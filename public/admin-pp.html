<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>TINSFLASH – Console Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body { font-family: Arial, sans-serif; margin:0; padding:0; background:#111; color:#eee; }
    header { background:#222; padding:10px; text-align:center; }
    nav { background:#333; padding:10px; display:flex; gap:15px; justify-content:center; }
    nav a { color:#eee; text-decoration:none; padding:5px 10px; border-radius:5px; }
    nav a:hover { background:#555; }
    section { padding:20px; display:none; }
    section.active { display:block; }
    h2,h3 { color:#0ff; }
    button { padding:6px 12px; margin:5px 0; }
    pre { background:#222; padding:10px; white-space:pre-wrap; max-height:250px; overflow-y:auto; }
    table { width:100%; border-collapse:collapse; margin:10px 0; }
    th, td { border:1px solid #555; padding:6px; text-align:left; }
    iframe { width:100%; height:600px; border:none; background:#fff; }
    textarea { width:100%; height:120px; }
  </style>
</head>
<body>
<header>
  <h1>🌍 Centrale Nucléaire Météo – Console Admin</h1>
</header>

<nav>
  <a href="#" onclick="showTab('dashboard')">Dashboard</a>
  <a href="#" onclick="showTab('alertes')">Alertes</a>
  <a href="#" onclick="showTab('vueuser')">Vue Utilisateur</a>
  <a href="#" onclick="showTab('chat')">Chat IA</a>
  <a href="#" onclick="showTab('radar')">Radar</a>
</nav>

<!-- === Dashboard === -->
<section id="dashboard" class="active">
  <h2>⚡ Dashboard</h2>
  <button onclick="runGlobal()">🚀 Lancer RUN GLOBAL</button>
  <h3>Résultat du run</h3>
  <pre id="checkup-result">En attente...</pre>

  <h3>📡 Sources météo</h3>
  <table id="sources-table">
    <thead>
      <tr><th>Modèle</th><th>Cycle</th><th>Horodatage</th><th>Statut</th></tr>
    </thead>
    <tbody></tbody>
  </table>

  <h3>📝 Logs récents</h3>
  <pre id="logs">En attente...</pre>

  <h3>❌ Erreurs</h3>
  <pre id="errors">En attente...</pre>
</section>

<!-- === Alertes === -->
<section id="alertes">
  <h2>🚨 Alertes</h2>
  <h3>✅ Auto-validées (>90%)</h3>
  <table id="alerts-auto"><thead><tr><th>Pays/Zone</th><th>Détail</th><th>Fiabilité</th></tr></thead><tbody></tbody></table>
  
  <h3>🟠 À examiner (70–90%)</h3>
  <table id="alerts-review"><thead><tr><th>Pays/Zone</th><th>Détail</th><th>Fiabilité</th></tr></thead><tbody></tbody></table>
</section>

<!-- === Vue Utilisateur === -->
<section id="vueuser">
  <h2>👤 Vue Utilisateur</h2>
  <label>Ville: <input type="text" id="city" /></label>
  <label>Pays:
    <select id="country">
      <option value="be">Belgique</option>
      <option value="fr">France</option>
      <option value="us">USA</option>
      <option value="gb">UK</option>
      <option value="de">Allemagne</option>
    </select>
  </label>
  <button onclick="loadUserView()">Voir la vue</button>
  <iframe id="user-view" src=""></iframe>
</section>

<!-- === Chat IA === -->
<section id="chat">
  <h2>🤖 Chat IA (moteur & prévisions)</h2>
  <textarea id="chat-input" placeholder="Posez une question..."></textarea><br>
  <button onclick="askAI()">Envoyer</button>
  <pre id="chat-output">En attente...</pre>
</section>

<!-- === Radar === -->
<section id="radar">
  <h2>🌐 Radar Global</h2>
  <iframe src="/api/radar/global"></iframe>
</section>

<script>
function showTab(id) {
  document.querySelectorAll("section").forEach(s => s.classList.remove("active"));
  document.getElementById(id).classList.add("active");
}

// === RUN GLOBAL ===
async function runGlobal() {
  const res = await fetch("/api/run-global", { method: "POST" });
  const data = await res.json();
  if (!data.success) {
    document.getElementById("checkup-result").textContent = "❌ " + data.error;
    return;
  }
  const result = data.result;
  document.getElementById("checkup-result").textContent = JSON.stringify(result, null, 2);

  // Sources
  const tbody = document.querySelector("#sources-table tbody");
  tbody.innerHTML = "";
  if (result.sources && result.sources.length) {
    result.sources.forEach(src => {
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${src.name}</td><td>${src.cycleId||"-"}</td><td>${src.timestamp||"-"}</td><td>${src.status==="ok"?"✅ OK":"❌ KO"}</td>`;
      tbody.appendChild(tr);
    });
  }

  loadLogs();
}

// === Logs & Erreurs ===
async function loadLogs() {
  const res = await fetch("/api/logs");
  const logs = await res.json();
  document.getElementById("logs").textContent = JSON.stringify(logs, null, 2);
  const stateRes = await fetch("/api/engine-state");
  const state = await stateRes.json();
  document.getElementById("errors").textContent = JSON.stringify(state.errors || [], null, 2);
}

// === Vue Utilisateur ===
function loadUserView() {
  const city = document.getElementById("city").value;
  const country = document.getElementById("country").value;
  document.getElementById("user-view").src = `/index.html?city=${encodeURIComponent(city)}&country=${country}`;
}

// === Chat IA ===
async function askAI() {
  const input = document.getElementById("chat-input").value;
  const res = await fetch("/api/chat", {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({ message: input })
  });
  const data = await res.json();
  document.getElementById("chat-output").textContent = data.reply || JSON.stringify(data, null, 2);
}
</script>
</body>
</html>
