<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>üîí Admin Console ‚Äì TINSFLASH</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="style.css">
  <style>
    body { background: #0c1a2b; color: #eee; }
    .card { background: #1e2f47; color: #fff; margin-bottom: 20px; padding: 15px; border-radius: 8px; }
    button { margin-top: 10px; padding: 8px 12px; border: none; border-radius: 6px; cursor: pointer; }
    .btn-validate { background: #00eaff; color: #000; }
    .btn-run { background: #4caf50; color: #fff; font-weight: bold; }
  </style>
  <script defer>
    async function checkPassword() {
      const pwd = prompt("Entrez le mot de passe admin :");
      if (pwd !== "202679") {
        document.body.innerHTML = "<h1>‚õî Acc√®s refus√©</h1>";
        throw new Error("Acc√®s refus√©");
      }
      loadAlerts();
    }

    // Charger alertes
    async function loadAlerts() {
      const el = document.getElementById("alerts-container");
      el.innerText = "‚è≥ Chargement...";
      try {
        const res = await fetch("/api/alerts");
        const data = await res.json();
        if (!data || data.length === 0) {
          el.innerText = "‚úÖ Aucune alerte en attente";
          return;
        }

        el.innerHTML = data.map(a => `
          <div class="card">
            <h3>‚ö†Ô∏è ${a.message.split("\n")[0]}</h3>
            <p><b>Fiabilit√©:</b> ${a.reliability}%</p>
            <p><b>Description:</b> ${a.forecast.description || "N/A"}</p>
            <p><b>Vent:</b> ${a.forecast.wind} km/h | üåßÔ∏è ${a.forecast.precipitation} mm</p>
            <p><b>Radar:</b> ${a.radarImage ? `<a href="${a.radarImage}" target="_blank">Voir radar</a>` : "N/A"}</p>
            <p><b>Status:</b> ${a.validated ? "‚úÖ Valid√©e" : (a.validationRequired ? "üü† En attente" : "‚è≥ G√©n√©r√©e")}</p>
            ${!a.validated && a.validationRequired ? 
              `<button class="btn-validate" onclick="validateAlert('${a._id}')">Valider</button>` 
              : ""}
          </div>
        `).join("");
      } catch (err) {
        el.innerText = "‚ùå Erreur chargement alertes";
      }
    }

    // Valider alerte
    async function validateAlert(alertId) {
      try {
        const res = await fetch("/api/alerts/validate", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ alertId })
        });
        const data = await res.json();
        alert(data.message || "Alerte valid√©e");
        loadAlerts();
      } catch {
        alert("‚ùå Erreur validation alerte");
      }
    }

    // G√©n√©rer pr√©visions
    async function runForecast() {
      const el = document.getElementById("run-result");
      el.innerText = "‚è≥ Lancement du supercalculateur m√©t√©o...";
      try {
        const res = await fetch("/api/supercalc/run", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            time: new Date().toISOString(),
            country: "BE",
            lat: 50.8503,
            lon: 4.3517
          })
        });
        const data = await res.json();
        el.innerText = `‚úÖ Pr√©visions g√©n√©r√©es (${data.status})`;
      } catch (err) {
        el.innerText = "‚ùå Erreur g√©n√©ration pr√©visions";
      }
    }

    document.addEventListener("DOMContentLoaded", checkPassword);
  </script>
</head>
<body>
  <main class="container">
    <h1>üîí Console Admin ‚Äì Gestion des alertes & runs</h1>

    <!-- Bouton lancement manuel -->
    <section class="card">
      <h2>‚ö° Supercalculateur m√©t√©o</h2>
      <button class="btn-run" onclick="runForecast()">‚ñ∂Ô∏è G√©n√©rer les pr√©visions</button>
      <p id="run-result"></p>
      <p><small>‚è∞ Runs recommand√©s : 07h10, 12h10, 19h10 (heure belge)</small></p>
    </section>

    <!-- Alertes -->
    <section>
      <h2>‚ö†Ô∏è Alertes m√©t√©o</h2>
      <div id="alerts-container">‚è≥ Chargement...</div>
    </section>
  </main>
</body>
</html>
