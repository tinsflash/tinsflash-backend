<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="robots" content="noindex,nofollow">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‚ö° Console Admin ‚Äî Centrale M√©t√©o Mondiale</title>
  <style>
    body { font-family: Arial, sans-serif; background:#0d1117; color:#e6edf3; margin:0; }
    header { background:#111; padding:12px; text-align:center; font-size:22px; font-weight:bold; color:#0af; }
    nav { background:#1c1f26; padding:10px; text-align:center; }
    nav a { color:#0af; margin:0 12px; text-decoration:none; }
    h2, h3 { margin:15px 0 10px; color:#0af; }
    .grid { display:grid; grid-template-columns: repeat(auto-fill,minmax(200px,1fr)); gap:10px; margin:10px 0; }
    .zone { background:#161b22; border-radius:6px; padding:10px; }
    button { margin:6px 0; padding:8px 12px; border:none; border-radius:6px; cursor:pointer; background:#0af; color:#000; font-weight:bold; }
    .status-ball { width:14px; height:14px; border-radius:50%; display:inline-block; margin-right:6px; }
    .status-ball.pending { background:#cc0; }
    .status-ball.published { background:#2a2; }
    .status-ball.tovalidate { background:#e69500; }
    .status-ball.under-surveillance { background:#08f; }
    .status-ball.low-confidence { background:#a22; }
    .status-ball.archived { background:#555; }
    #logs { background:#000; color:#eee; font-family:monospace; padding:10px; height:250px; overflow-y:auto; border-radius:8px; margin-top:10px; white-space:pre-wrap; }
    #runStatus { display:none; position:fixed; top:0; left:0; width:100%; padding:12px; text-align:center; font-weight:bold; font-size:18px; background:#111; color:#fff; z-index:9999; }
    .country-row { display:flex; align-items:center; justify-content:space-between; background:#161b22; padding:6px 10px; margin:4px 0; border-radius:6px; }
    .country-name { font-weight:bold; }
  </style>
</head>
<body>
<script>
  const pass = prompt("Code d'acc√®s ?");
  if (pass !== "202679") {
    document.body.innerHTML = "<h1 style='color:red;text-align:center;'>‚õî Acc√®s refus√©</h1>";
    throw new Error("Acc√®s refus√©");
  }
</script>

<header>‚ö° Centrale M√©t√©o Mondiale ‚Äî Console Admin</header>
<nav>
  <a href="/admin">Console</a>
  <a href="/admin-alerts">Alertes</a>
  <a href="/admin-chat">Chat IA</a>
  <a href="/admin-index">Vue Index</a>
  <a href="/admin-radar">Radar & News</a>
  <a href="/admin-users">Utilisateurs</a>
</nav>

<div id="runStatus"></div>

<main style="padding:20px;">
  <h2>üõ∞Ô∏è Cockpit Global</h2>
  <button onclick="runGlobalForecasts()">‚ñ∂Ô∏è Pr√©visions zones couvertes</button>
  <button onclick="runGlobalAlerts()">‚ñ∂Ô∏è Alertes zones couvertes</button>
  <button onclick="runContinentalAlerts()">‚ñ∂Ô∏è Alertes continentales</button>
  <button onclick="runFusion()">‚ñ∂Ô∏è Fusion & Orchestration IA</button>

  <h2>üìú Logs moteur (live)</h2>
  <div id="logs">Connexion en cours‚Ä¶</div>

  <h2>üõ∞Ô∏è Pompage des mod√®les</h2>
  <div id="models-status" class="grid"></div>

  <h2>‚ö° √âtapes du moteur</h2>
  <div id="engine-steps" class="grid"></div>

  <h2>üåç Supervision des pays (Pr√©visions & Alertes)</h2>
  <div id="zones-status"></div>
</main>

<script>
  // Bandeau visuel
  function showRunStatus(msg,color){
    const bar=document.getElementById("runStatus");
    bar.style.display="block"; bar.style.background=color; bar.innerText=msg;
    setTimeout(()=>{ bar.style.display="none"; },5000);
  }

  // Models
  const models=["ECMWF","GFS","ICON","Meteomatics","Copernicus ERA5","NOAA","NASA POWER","OpenWeather"];
  function buildModels(){
    const m=document.getElementById("models-status"); m.innerHTML="";
    models.forEach(md=>{
      m.innerHTML+=`<div id="model-${md}" class="zone"><span class="status-ball pending"></span> ${md}</div>`;
    });
  }
  buildModels();

  // Steps
  const steps=["Pompage des mod√®les","Analyse relief & climat","Pr√©visions zones couvertes","Alertes zones couvertes","Alertes continentales","Fusion IA alertes & pr√©visions","D√©ploiement final"];
  function buildEngineSteps(){
    const s=document.getElementById("engine-steps"); s.innerHTML="";
    steps.forEach(st=>{
      const safeId=st.replace(/\s+/g,"-");
      s.innerHTML+=`<div id="step-${safeId}" class="zone"><span class="status-ball pending"></span> ${st}</div>`;
    });
  }
  buildEngineSteps();

  // Supervision par pays ‚Üí bas√© sur /api/alerts/summary
  async function refreshZones(){
    const res=await fetch("/api/alerts/summary");
    if(!res.ok) return;
    const summary=await res.json();
    const div=document.getElementById("zones-status");
    div.innerHTML=`
      <p>Total: ${summary.total} alertes</p>
      üü¢ Publi√©es: ${summary.byStatus.published} | 
      üü° √Ä valider: ${summary.byStatus.toValidate} | 
      üîµ Surveillance: ${summary.byStatus["under-surveillance"]} | 
      üî¥ Faible cr√©dibilit√©: ${summary.byStatus["low-confidence"]} | 
      ‚ö™ Archiv√©es: ${summary.byStatus.archived}<br>
      Exclusives: ${summary.exclusives} | Confirm√©es ailleurs: ${summary.confirmedElsewhere}
    `;
  }
  setInterval(refreshZones,8000);

  // Logs SSE
  const logDiv=document.getElementById("logs");
  const evt=new EventSource("/api/logs/stream");
  evt.onmessage=(e)=>{
    const log=JSON.parse(e.data);
    logDiv.innerHTML+=`<div>[${new Date(log.ts).toLocaleTimeString()}] ${log.message}</div>`;
    logDiv.scrollTop=logDiv.scrollHeight;
  };

  // Runs
  async function runGlobalForecasts(){ showRunStatus("‚ñ∂Ô∏è Pr√©visions...","#cc0"); await fetch("/api/run-global",{method:"POST"}); }
  async function runGlobalAlerts(){ showRunStatus("‚ñ∂Ô∏è Alertes...","#cc0"); await fetch("/api/run-alerts",{method:"POST"}); }
  async function runContinentalAlerts(){ showRunStatus("‚ñ∂Ô∏è Continental...","#cc0"); await fetch("/api/run-alerts-continental",{method:"POST"}); }
  async function runFusion(){ showRunStatus("‚ñ∂Ô∏è Fusion...","#cc0"); await fetch("/api/run-orchestrator",{method:"POST"}); }
</script>
</body>
</html>
