<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="robots" content="noindex,nofollow" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>üõ∞Ô∏è TINSFLASH ‚Ä¢ Console Moteur IA J.E.A.N.</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <style>
    body {margin:0;background:#0b1220;color:#e6f6ff;font-family:"Segoe UI",sans-serif;}
    header {background:#08121d;color:#4fc3f7;text-align:center;padding:10px;font-size:1.4em;
      text-shadow:0 0 10px #4fc3f7;}
    nav {display:flex;justify-content:center;gap:12px;padding:10px;background:#0d1624;}
    nav a {color:#7dd3fc;text-decoration:none;font-weight:bold;}
    nav a:hover {color:#fff;text-shadow:0 0 10px #4fc3f7;}
    .container {max-width:1250px;margin:auto;padding:15px;}
    h2 {color:#4fc3f7;margin-top:25px;border-left:4px solid #4fc3f7;padding-left:8px;}
    button {background:#4fc3f7;color:#001;border:none;padding:10px 16px;margin:4px;border-radius:8px;
      font-weight:bold;cursor:pointer;}
    button:hover {background:#7dd3fc;}
    .panel {background:#0e1721;border-radius:10px;padding:15px;margin-top:15px;}
    .status-grid {display:flex;flex-wrap:wrap;gap:10px;margin-top:10px;}
    .status-box {flex:1 1 180px;background:#101c2b;padding:10px;border-radius:8px;text-align:center;}
    .status-light {width:14px;height:14px;border-radius:50%;display:inline-block;margin-right:6px;}
    .green{background:#00ff88;} .red{background:#ff4444;} .orange{background:#ffaa00;} .blue{background:#4fc3f7;}
    .map-duo {display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:15px;}
    .map {height:340px;border-radius:10px;overflow:hidden;}
    .alert-counters {display:flex;justify-content:space-around;margin-top:15px;flex-wrap:wrap;}
    .counter {background:#13233d;padding:10px 16px;border-radius:10px;text-align:center;min-width:150px;
      box-shadow:0 0 10px rgba(0,0,0,0.3);}
    .counter h3{margin:0;color:#4fc3f7;}
    #logs {background:#0e1721;padding:10px;border-radius:10px;height:200px;overflow-y:auto;
      font-family:monospace;font-size:13px;margin-top:10px;}
    /* üí¨ Chat */
    .btn-ai{position:fixed;bottom:25px;right:25px;background:#4fc3f7;color:#000;font-weight:bold;
      border:none;border-radius:50%;width:52px;height:52px;cursor:pointer;
      box-shadow:0 0 15px rgba(79,195,247,0.6);font-size:18px;transition:transform .3s ease;z-index:999;}
    .btn-ai:hover{transform:scale(1.1);}
    .chat-box{position:fixed;bottom:90px;right:20px;background:#1b2439;border:2px solid #4fc3f7;border-radius:12px;
      width:320px;height:400px;display:none;flex-direction:column;box-shadow:0 0 15px rgba(0,0,0,0.5);z-index:999;}
    .chat-header{background:#4fc3f7;color:#000;text-align:center;padding:6px;font-weight:bold;}
    .chat-messages{flex:1;padding:8px;overflow-y:auto;font-size:14px;background:#0e1423;}
    .chat-input{display:flex;border-top:1px solid #333;}
    .chat-input input{flex:1;padding:8px;border:none;background:#1b2339;color:#eee;}
    .chat-input button{background:#4fc3f7;border:none;color:#000;padding:8px 12px;font-weight:bold;cursor:pointer;}
  </style>
</head>

<body>
<script>
  // üîí S√©curit√© PIN
  const pin = sessionStorage.getItem("tinsflashPIN");
  if(!pin){
    const p = prompt("Code d‚Äôacc√®s admin ?");
    if(p!=="202679"){ alert("Acc√®s refus√©."); location.href="/"; }
    else sessionStorage.setItem("tinsflashPIN","ok");
  }
</script>

<header>üõ∞Ô∏è Console IA J.E.A.N ‚Äì TINSFLASH PRO+++</header>

<nav>
  <a href="/admin-pp.html">Dashboard</a>
  <a href="/admin-alerts.html">Alertes</a>
  <a href="/admin-chat.html">Chat IA</a>
  <a href="/admin-radar.html">Radar</a>
  <a href="/admin-index.html">Index Admin</a>
  <a href="/admin-local.html">Local</a>
  <a href="/admin-news.html">News</a>
  <a href="/admin-users.html">Users</a>
</nav>

<div class="container">
  <h2>‚öôÔ∏è Pilotage du moteur</h2>
  <div class="panel">
    <button onclick="runZone('All')">‚ö° Extraction Europe‚ÄìUSA‚ÄìCanada</button>
    <button onclick="runZone('World')">üåç Extraction Reste du Monde</button>
    <button onclick="runIA()">üß† Analyse IA J.E.A.N.</button>
    <button onclick="fusionAlerts()">üì¢ Fusion des alertes IA</button>
  </div>

  <h2>üß© √âtat moteur et sources</h2>
  <div class="status-grid" id="statusGrid">
    <div class="status-box"><div><span class="status-light" id="motorLight"></span>Moteur</div><div id="motorStatus">‚Äì</div></div>
    <div class="status-box"><div><span class="status-light" id="modelsLight"></span>Mod√®les</div><div>‚Äì</div></div>
    <div class="status-box"><div><span class="status-light" id="iaLight"></span>IA</div><div>‚Äì</div></div>
    <div class="status-box"><div><span class="status-light" id="mongoLight"></span>MongoDB</div><div>‚Äì</div></div>
  </div>

  <div class="map-duo">
    <div id="mapForecast" class="map"></div>
    <div id="mapAlerts" class="map"></div>
  </div>

  <div class="alert-counters">
    <div class="counter"><h3 id="count90">0</h3><div>üü¢ Alertes > 90 %</div></div>
    <div class="counter"><h3 id="count7089">0</h3><div>üü† 70‚Äì89 %</div></div>
    <div class="counter"><h3 id="count70">0</h3><div>üî¥ < 70 %</div></div>
    <div class="counter"><h3 id="countPrimeurs">0</h3><div>üîµ Primeurs IA</div></div>
  </div>

  <h2>üìú Logs moteur</h2>
  <div id="logs">Chargement des logs...</div>
</div>

<!-- üí¨ Chat IA -->
<button class="btn-ai" id="btnAI">ü§ñ</button>
<div class="chat-box" id="chatJean">
  <div class="chat-header">Assistant technique J.E.A.N. (GPT-4o-mini)</div>
  <div class="chat-messages" id="chatMessages"></div>
  <div class="chat-input">
    <input type="text" id="chatInput" placeholder="Pose ta question technique..." />
    <button onclick="sendChat()">Envoyer</button>
  </div>
</div>

<script>
const API = "/api";

// ======== Boutons ========
async function runZone(zone){
  addLog(`üöÄ Lancement extraction ${zone}...`);
  const res = await fetch(`${API}/run-global`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({zone})});
  const j = await res.json();
  addLog(j.success?`‚úÖ Extraction ${zone} termin√©e.`:`‚ùå ${j.error}`);
}
async function runIA(){
  addLog("üß† Lancement analyse IA...");
  const res = await fetch(`${API}/ai-analyse`,{method:"POST"});
  const j = await res.json();
  addLog(j.success?"‚úÖ IA termin√©e.":"‚ùå "+j.error);
}
async function fusionAlerts(){
  addLog("üåç Fusion mondiale en cours...");
  const res = await fetch(`${API}/runWorldAlerts`,{method:"POST"});
  const j = await res.json();
  addLog(j.success?"‚úÖ Fusion termin√©e.":"‚ùå "+j.error);
}

// ======== Statut ========
async function refreshStatus(){
  try{
    const r=await fetch(`${API}/status`);
    const s=await r.json();
    document.getElementById("motorLight").className="status-light "+(s.status==="running"?"green":"red");
    document.getElementById("motorStatus").textContent=s.status;
    document.getElementById("mongoLight").className="status-light "+(s.errors?.length? "orange":"green");
  }catch(e){addLog("‚ö†Ô∏è Erreur status "+e.message);}
}
setInterval(refreshStatus,10000);
refreshStatus();

// ======== Logs SSE ========
async function loadLogs(){
  const r=await fetch(`${API}/logs-live`);
  const j=await r.json();
  const logsEl=document.getElementById("logs");
  logsEl.innerHTML="";
  j.logs.forEach(l=>logsEl.innerHTML+=`<div>[${l.timestamp}] ${l.message}</div>`);
}
setInterval(loadLogs,8000);
loadLogs();
function addLog(msg){
  const el=document.getElementById("logs");
  el.innerHTML+=`<div>${new Date().toLocaleTimeString()} ${msg}</div>`;
  el.scrollTop=el.scrollHeight;
}

// ======== Cartes ========
const mapF=L.map("mapForecast").setView([20,0],2);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(mapF);
const mapA=L.map("mapAlerts").setView([20,0],2);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(mapA);
async function loadAlerts(){
  try{
    const r=await fetch(`${API}/alerts`);
    const list=await r.json();
    let c90=0,c7089=0,c70=0,cP=0;
    list.forEach(a=>{
      if(!a.lat||!a.lon)return;
      let color="red";
      if(a.reliability>=0.9){color="green";c90++;}
      else if(a.reliability>=0.7){color="orange";c7089++;}
      else{color="red";c70++;}
      if(a.isPrimeur){color="blue";cP++;}
      L.circleMarker([a.lat,a.lon],{radius:6,color}).addTo(mapA).bindPopup(`<b>${a.title}</b><br>${a.zone}`);
    });
    document.getElementById("count90").textContent=c90;
    document.getElementById("count7089").textContent=c7089;
    document.getElementById("count70").textContent=c70;
    document.getElementById("countPrimeurs").textContent=cP;
  }catch(e){addLog("‚ö†Ô∏è Erreur loadAlerts "+e.message);}
}
loadAlerts();

// ======== Chat IA technique ========
const chatBox=document.getElementById("chatJean");
document.getElementById("btnAI").onclick=()=>chatBox.style.display=chatBox.style.display==="flex"?"none":"flex";
async function sendChat(){
  const msg=document.getElementById("chatInput").value.trim();
  if(!msg)return;
  const m=document.getElementById("chatMessages");
  m.innerHTML+=`<div style='color:#4fc3f7;'>Vous : ${msg}</div>`;
  document.getElementById("chatInput").value="";
  const r=await fetch(`${API}/chat-tech`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({message:msg})});
  const d=await r.json();
  m.innerHTML+=`<div>J.E.A.N : ${d.reply}</div>`;
  m.scrollTop=m.scrollHeight;
}
</script>
</body>
</html>
