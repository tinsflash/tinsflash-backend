<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>üõ∞Ô∏è Console Admin TINSFLASH</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="robots" content="noindex, nofollow" />
  <link rel="stylesheet" href="style.css" />
  <style>
    body { background:#0a0f1c; color:#00ffea; font-family:"Orbitron", Arial, sans-serif; margin:0; }
    header { text-align:center; padding:20px; border-bottom:2px solid #00ffea; }
    h1 { margin:0; color:#00ffea; text-shadow:0 0 10px #00fbe7; }
    .container { padding:20px; max-width:1200px; margin:auto; display:grid; gap:20px; }
    .card { background:#111830; border:1px solid #00ffea; border-radius:12px; padding:20px; box-shadow:0 0 15px rgba(0,255,234,0.3); }
    h2 { color:#00fbe7; margin-top:0; text-shadow:0 0 8px #00d9ff; }
    .btn { background:#00ffea; color:#000; border:none; padding:10px 15px; margin:5px; border-radius:8px; font-weight:bold; cursor:pointer; }
    .btn:hover { background:#00d9ff; }
    #logs { background:#000; color:#0f0; font-family:monospace; padding:10px; min-height:160px; overflow-y:auto; border-radius:6px; }
    textarea,input,select { width:100%; padding:8px; margin:5px 0; border-radius:6px; border:none; background:#0c1a2b; color:#fff; }
    .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .pill { display:inline-block; padding:4px 10px; border-radius:999px; background:#072033; color:#88ffd7; border:1px solid #00ffea; font-size:12px; margin:3px 6px 0 0; }
    .ok { color:#27d17f } .ko { color:#ff5c5c }
    .mono { font-family:monospace; white-space:pre-wrap; word-break:break-word; }
    #radar { height:360px; border-radius:8px; overflow:hidden; }
    .small { font-size:12px; opacity:.8 }
  </style>
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const pass = prompt("Mot de passe Admin ?");
      if (pass !== "202679") {
        alert("‚õî Acc√®s refus√©");
        window.location.href = "index.html";
      }
    });
  </script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
</head>
<body>
  <header>
    <h1>üõ∞Ô∏è Console Administrateur ‚Äì Mode NASA</h1>
  </header>

  <div class="container">

    <!-- Zone courante -->
    <div class="card">
      <h2>üåê Zone de travail</h2>
      <div class="row">
        <label for="zone">Pays / Zone :</label>
        <select id="zone">
          <option value="BE" selected>Belgique (BE)</option>
          <option value="FR">France (FR)</option>
          <option value="US">USA (US)</option>
          <option value="GB">Angleterre / UK (GB)</option>
          <option value="UA">Ukraine (UA)</option>
          <option value="NO">Norv√®ge (NO)</option>
        </select>
        <button class="btn" onclick="persistZone()">üíæ M√©moriser</button>
        <span class="small">Astuce : la zone choisie est utilis√©e pour tous les appels API.</span>
      </div>
    </div>

    <!-- Supercalculateur -->
    <div class="card">
      <h2>‚ö° Supercalculateur M√©t√©o</h2>
      <button class="btn" onclick="runManualRun()">üöÄ Lancer un Run (manual)</button>
      <span class="small">Planning actuel: 07:10 / 12:10 / 19:10 (BE)</span>
      <div id="run-status" class="mono">‚è≥ En attente...</div>
    </div>

    <!-- Monitoring & Logs -->
    <div class="card">
      <h2>üì° Monitoring & Logs</h2>
      <div class="row">
        <button class="btn" onclick="loadCheckup()">üîÑ Rafra√Æchir √©tat</button>
        <span id="light-check" class="pill">Checkup...</span>
      </div>
      <div id="checkup" class="mono">‚è≥ Attente checkup...</div>
      <hr />
      <div class="row">
        <button class="btn" onclick="loadLogs()">üìñ Charger logs</button>
        <span class="small">NB: backend actuel n‚Äôexpose pas GET /api/logs (lecture). Voir aide-m√©moire.</span>
      </div>
      <div id="logs" class="mono">‚ÑπÔ∏è En l‚Äôabsence de GET /api/logs, je n‚Äôai pas de source √† afficher.</div>
    </div>

    <!-- Alertes -->
    <div class="card">
      <h2>‚ö†Ô∏è Alertes m√©t√©o</h2>
      <div class="row">
        <button class="btn" onclick="loadAlerts()">‚ö†Ô∏è Charger alertes (zone)</button>
      </div>
      <div id="alerts" class="mono">‚è≥ Attente alertes...</div>
    </div>

    <!-- Pr√©visions nationales -->
    <div class="card">
      <h2>üåç Pr√©visions nationales (zone)</h2>
      <div class="row">
        <button class="btn" onclick="loadNational()">üá∫üá≥ Charger pr√©visions nationales</button>
      </div>
      <div id="nat" class="mono">‚è≥ En attente‚Ä¶</div>
    </div>

    <!-- Utilisateurs -->
    <div class="card">
      <h2>üìä Utilisateurs (zones couvertes / non couvertes)</h2>
      <button class="btn" onclick="loadUsers()">üîÑ Rafra√Æchir</button>
      <div id="users" class="mono">Endpoint non disponible pour le moment</div>
    </div>

    <!-- Chat IA -->
    <div class="card">
      <h2>ü§ñ IA J.E.A.N (moteur & expert m√©t√©o/climat)</h2>
      <textarea id="q" placeholder="Posez une question..."></textarea>
      <button class="btn" onclick="sendChat()">Envoyer</button>
      <div id="ai" class="mono">‚è≥ Attente...</div>
    </div>

    <!-- Radar -->
    <div class="card">
      <h2>üõ∞Ô∏è Radar ‚Äì Vue admin</h2>
      <div id="radar"></div>
      <div class="small">Donn√©es r√©elles RainViewer (radar mondial), fond OpenStreetMap. 100% live.</div>
    </div>

    <!-- News -->
    <div class="card">
      <h2>üì∞ Actualit√©s m√©t√©o (monde)</h2>
      <button class="btn" onclick="loadNews()">üîÑ Rafra√Æchir</button>
      <div id="news" class="mono">Endpoint non disponible pour le moment</div>
    </div>

  </div>

  <script>
    const API_BASE = `${location.origin}/api`;

    // === Zone persist√©e ===
    function getZone() {
      const sel = document.getElementById('zone');
      return sel.value || 'BE';
    }
    function persistZone() {
      localStorage.setItem('admin.zone', getZone());
      alert('‚úÖ Zone m√©moris√©e: ' + getZone());
    }
    (function restoreZone(){
      const z = localStorage.getItem('admin.zone');
      if (z) {
        const sel = document.getElementById('zone');
        if ([...sel.options].some(o => o.value === z)) sel.value = z;
      }
    })();

    // === Superforecast (run manuel) ===
    async function runManualRun() {
      const zone = getZone();
      const el = document.getElementById('run-status');
      el.textContent = '‚è≥ Lancement‚Ä¶';
      try {
        const r = await fetch(`${API_BASE}/superforecast?zone=${encodeURIComponent(zone)}`);
        const data = await r.json();
        if (!r.ok) throw new Error(data?.error || 'Erreur Run');
        el.textContent = '‚úÖ Run OK ‚Äì ' + JSON.stringify(data).slice(0, 500);
      } catch (e) {
        el.innerHTML = `<span class="ko">‚ùå Erreur Run</span>\n${(e.message||e)}`;
      }
    }

    // === Checkup (√©tat global) ===
    async function loadCheckup() {
      const el = document.getElementById('checkup');
      const light = document.getElementById('light-check');
      el.textContent = '‚è≥ R√©cup√©ration‚Ä¶';
      light.textContent = 'Checkup‚Ä¶';
      try {
        const r = await fetch(`${API_BASE}/checkup`);
        const data = await r.json();
        if (!r.ok) throw new Error(data?.error || 'Erreur checkup');
        light.textContent = 'Checkup OK';
        light.className = 'pill ok';
        el.textContent = JSON.stringify(data, null, 2);
      } catch (e) {
        light.textContent = 'Checkup KO';
        light.className = 'pill ko';
        el.innerHTML = `<span class="ko">‚ùå Erreur r√©cup√©ration checkup</span>\n${(e.message||e)}`;
      }
    }

    // === Logs (lecture : pas d‚Äôendpoint dispo c√¥t√© serveur) ===
    async function loadLogs() {
      const el = document.getElementById('logs');
      el.innerHTML = '‚ÑπÔ∏è Le backend n‚Äôexpose pas GET /api/logs (lecture).<br/>'
        + 'üëâ Deux options rapides :<br/>'
        + '1) ajouter GET /api/admin/logs (qui appelle logsService.getLogs),<br/>'
        + '2) ou afficher ici les derniers runs du checkup.';
    }

    // === Alertes ===
    async function loadAlerts() {
      const zone = getZone();
      const el = document.getElementById('alerts');
      el.textContent = '‚è≥ Chargement‚Ä¶';
      try {
        const r = await fetch(`${API_BASE}/alerts/${encodeURIComponent(zone)}`);
        const data = await r.json();
        if (!r.ok) throw new Error(data?.error || 'Erreur alertes');
        el.textContent = JSON.stringify(data, null, 2);
      } catch (e) {
        el.innerHTML = `<span class="ko">‚ùå Erreur alertes</span>\n${(e.message||e)}`;
      }
    }

    // === Pr√©visions nationales ===
    async function loadNational() {
      const zone = getZone();
      const el = document.getElementById('nat');
      el.textContent = '‚è≥ Chargement‚Ä¶';
      try {
        const r = await fetch(`${API_BASE}/forecast/${encodeURIComponent(zone)}`);
        const data = await r.json();
        if (!r.ok) throw new Error(data?.error || 'Erreur pr√©visions');
        el.textContent = JSON.stringify(data, null, 2);
      } catch (e) {
        el.innerHTML = `<span class="ko">‚ùå Erreur ${zone}</span>\n${(e.message||e)}`;
      }
    }

    // === Utilisateurs (placeholder tant que route non dispo) ===
    async function loadUsers() {
      document.getElementById('users').textContent =
        'Endpoint non disponible pour le moment (pr√©voir /api/users/stats).';
    }

    // === Chat IA ===
    async function sendChat() {
      const zone = getZone();
      const q = document.getElementById('q').value || 'Le temps en Belgique?';
      const el = document.getElementById('ai');
      el.textContent = '‚è≥ Attente‚Ä¶';
      try {
        const r = await fetch(`${API_BASE}/chat?zone=${encodeURIComponent(zone)}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message: q })
        });
        const data = await r.json();
        if (!r.ok) throw new Error(data?.error || 'Erreur IA');
        el.textContent = data?.reply || JSON.stringify(data, null, 2);
      } catch (e) {
        el.innerHTML = `<span class="ko">‚ùå Erreur IA</span>\n${(e.message||e)}`;
      }
    }

    // === Radar (100% r√©el via RainViewer) ===
    let map;
    function initRadar() {
      map = L.map('radar').setView([50.85, 4.35], 6);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 12,
        attribution: '&copy; OpenStreetMap',
      }).addTo(map);
      // Radar RainViewer (donn√©es live publiques)
      const radar = L.tileLayer(
        'https://tilecache.rainviewer.com/v2/radar/{z}/{x}/{y}/1/256/{color}/2/0_0.png',
        { opacity: 0.7, pane: 'overlayPane' }
      );
      radar.addTo(map);
    }

    // === News (placeholder tant que route non dispo) ===
    async function loadNews() {
      document.getElementById('news').textContent =
        'Endpoint non disponible pour le moment (pr√©voir /api/news).';
    }

    // boot
    initRadar();
    loadCheckup();
  </script>
</body>
</html>
