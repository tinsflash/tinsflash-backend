<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TINSFLASH ‚Ä¢ Console Admin</title>
  <style>
    :root{
      --bg:#0b0f14; --panel:#111827; --muted:#1f2937; --text:#e5e7eb; --sub:#9ca3af; --ok:#10b981; --ko:#ef4444; --unk:#f59e0b; --line:#2b3442; --accent:#38bdf8;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial,'Noto Sans',sans-serif;background:var(--bg);color:var(--text)}
    header{position:sticky;top:0;z-index:50;background:linear-gradient(180deg,#0b0f14,rgba(11,15,20,.85));border-bottom:1px solid var(--line)}
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    .brand{display:flex;align-items:center;gap:12px}
    .brand h1{margin:0;font-size:18px;font-weight:700;letter-spacing:.5px}
    .tag{font-size:12px;color:#9ca3af;background:#0f172a;padding:2px 8px;border-radius:999px;border:1px solid #1f2937}
    nav{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    nav a{display:inline-flex;align-items:center;gap:8px;padding:10px 12px;border-radius:10px;text-decoration:none;color:var(--text);background:var(--muted);border:1px solid var(--line);font-size:14px}
    nav a.active{outline:2px solid var(--accent);background:#0f172a}
    main{padding:16px}
    .grid{display:grid;gap:12px}
    @media(min-width:900px){.grid.cols-2{grid-template-columns:1fr 1fr}.grid.cols-3{grid-template-columns:repeat(3,1fr)}}
    .card{background:var(--panel);border:1px solid var(--line);border-radius:14px;padding:14px}
    .card h3{margin:0 0 10px 0;font-size:16px}
    .buttons{display:flex;gap:8px;flex-wrap:wrap}
    button,.btn{cursor:pointer;background:#0ea5e9;border:1px solid #1f2937;color:white;padding:10px 12px;border-radius:10px;font-weight:600}
    button.ghost{background:transparent;color:var(--text);border:1px solid var(--line)}
    .small{font-size:12px;color:var(--sub)}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,'Liberation Mono','Courier New',monospace}
    .log{display:flex;gap:8px;align-items:flex-start;padding:8px;border-bottom:1px dashed var(--line)}
    .log .t{min-width:160px;color:var(--sub);font-size:12px}
    .chip{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;border:1px solid var(--line);background:#0f172a;font-size:12px}
    .ok{color:#10b981;border-color:#065f46;background:rgba(16,185,129,.08)}
    .ko{color:#ef4444;border-color:#7f1d1d;background:rgba(239,68,68,.08)}
    .unk{color:#f59e0b;border-color:#78350f;background:rgba(245,158,11,.08)}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .field{display:flex;flex-direction:column;gap:6px}
    input,select,textarea{background:#0f172a;border:1px solid var(--line);color:var(--text);border-radius:10px;padding:10px}
    textarea{min-height:120px;resize:vertical}
    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid var(--line);padding:8px;text-align:left;font-size:14px}
    .muted{color:var(--sub)}
    iframe{width:100%;min-height:65vh;border:1px solid var(--line);border-radius:12px;background:#0b0f14}
    .hidden{display:none}
    .hl{color:#93c5fd}
  </style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="brand">
      <h1>‚ö° TINSFLASH ‚Ä¢ Console Administrateur</h1>
      <span class="tag">Centrale Nucl√©aire M√©t√©o</span>
      <span id="lastSync" class="small"></span>
    </div>
    <nav id="tabs">
      <a data-page="dashboard" class="active">Dashboard</a>
      <a data-page="alerts">Alertes</a>
      <a data-page="user-view">Vue utilisateur</a>
      <a data-page="chat">Chat IA (moteur)</a>
      <a data-page="tools">Outils & Radar</a>
      <a data-page="news">Actualit√©s</a>
    </nav>
  </div>
</header>

<main class="wrap">
  <!-- DASHBOARD -->
  <section id="page-dashboard">
    <div class="grid cols-2">
      <div class="card">
        <h3>üöÄ Lancer le moteur</h3>
        <div class="buttons">
          <button id="btnRunGlobal">RUN GLOBAL (zones couvertes)</button>
          <button id="btnRunContinental" class="ghost">RUN CONTINENTAL (non couvertes)</button>
          <button id="btnVerify" class="ghost">V√©rifier (IA)</button>
          <button id="btnRefresh" class="ghost">Actualiser √©tat</button>
        </div>
        <p class="small">R√®gle d‚Äôor : 100 % r√©el, jamais de mock. Les runs n‚Äô√©crasent rien tant que la publication auto n‚Äôest pas d√©clench√©e.</p>
        <div id="runResult" class="small mono muted"></div>
      </div>

      <div class="card">
        <h3>üß† Checkup moteur ‚Äì 13 points</h3>
        <div id="checkup" class="grid"></div>
        <div class="small muted" id="engineMeta"></div>
      </div>
    </div>

    <div class="grid cols-2" style="margin-top:12px">
      <div class="card">
        <h3>üìú Logs (moteur & admin)</h3>
        <div class="row">
          <button id="btnLoadLogs" class="ghost">Charger logs</button>
          <span class="small muted">Derniers 200 √©l√©ments ‚Ä¢ couleur = s√©v√©rit√©</span>
        </div>
        <div id="logs" style="margin-top:10px"></div>
      </div>

      <div class="card">
        <h3>üß© √âtat & Utilisateurs</h3>
        <div class="row">
          <span id="engineStatus" class="chip unk">Moteur: inconnu</span>
          <span id="iaStatus" class="chip unk">IA: inconnu</span>
          <span id="radarStatus" class="chip unk">Radar: inconnu</span>
          <span id="forecastsStatus" class="chip unk">Pr√©visions: inconnu</span>
          <span id="alertsStatus" class="chip unk">Alertes: inconnu</span>
        </div>
        <div id="usersBox" style="margin-top:12px">
          <h4 style="margin:6px 0 8px 0;font-size:14px">üë• Utilisateurs par zone</h4>
          <div class="small muted">Si l‚ÄôAPI /api/users n‚Äôest pas disponible dans ce d√©ploiement, le bloc reste vide.</div>
          <div id="users"></div>
        </div>
      </div>
    </div>
  </section>

  <!-- ALERTS -->
  <section id="page-alerts" class="hidden">
    <div class="card">
      <h3>‚ö†Ô∏è Gestion des alertes (automatiques & √† valider)</h3>
      <div class="buttons">
        <button id="btnLoadAlerts" class="ghost">Actualiser les alertes</button>
      </div>
      <div class="grid cols-3" style="margin-top:10px">
        <div>
          <h4>> 90 % ‚Äî publi√©es automatiquement</h4>
          <div id="alertsAuto"></div>
        </div>
        <div>
          <h4>70‚Äì90 % ‚Äî √† valider / expert / attente</h4>
          <div id="alertsReview"></div>
        </div>
        <div>
          <h4>< 70 % ‚Äî ignor√©es / m√©moire</h4>
          <div id="alertsLow"></div>
        </div>
      </div>

      <div style="margin-top:14px">
        <h4>üî≠ Comparaison avec autres sources</h4>
        <div class="grid cols-2">
          <div class="card">
            <h3 class="small">A / Nous sommes les <span class="hl">SEULS</span> (premiers)</h3>
            <div id="cmpFirst"></div>
          </div>
          <div class="card">
            <h3 class="small">B / Aussi vus ailleurs (sources)</h3>
            <div id="cmpOthers"></div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- USER VIEW -->
  <section id="page-user-view" class="hidden">
    <div class="card">
      <h3>üåç Vue utilisateur (index r√©el)</h3>
      <div class="grid cols-3">
        <div class="field">
          <label>Pays</label>
          <select id="uvCountry">
            <option value="">‚Äî</option>
            <option>Belgium</option><option>France</option><option>Germany</option><option>Netherlands</option>
            <option>Spain</option><option>Italy</option><option>Portugal</option><option>Poland</option>
            <option>Austria</option><option>Sweden</option><option>Finland</option><option>Denmark</option>
            <option>Norway</option><option>United Kingdom</option><option>Ukraine</option><option>USA</option>
            <option>Romania</option><option>Czechia</option><option>Slovakia</option><option>Slovenia</option>
            <option>Bulgaria</option><option>Greece</option><option>Ireland</option><option>Hungary</option>
            <option>Luxembourg</option><option>Malta</option><option>Cyprus</option><option>Estonia</option>
            <option>Latvia</option><option>Lithuania</option><option>Croatia</option>
          </select>
        </div>
        <div class="field">
          <label>Ville</label>
          <input id="uvCity" placeholder="ex: Bruxelles" />
        </div>
        <div class="field">
          <label>&nbsp;</label>
          <div class="row">
            <button id="btnUserView">Charger</button>
            <button id="btnUserViewClear" class="ghost">Effacer</button>
          </div>
        </div>
      </div>
      <div class="small muted" style="margin-top:8px">
        Astuce: si l‚Äôindex supporte <span class="mono">?lat=&amp;lon=&amp;country=</span>, on force la g√©oloc. Sinon, l‚Äôindex utilisera sa logique interne.
      </div>
      <div id="userViewSummary" class="card" style="margin-top:10px"></div>
      <iframe id="userViewFrame" src="index.html" loading="lazy"></iframe>
    </div>
  </section>

  <!-- CHAT -->
  <section id="page-chat" class="hidden">
    <div class="card">
      <h3>üí¨ Chat IA (moteur & pr√©visions)</h3>
      <div class="grid cols-2">
        <div class="field">
          <label>Message √† GPT-5 (centrale)</label>
          <textarea id="chatMsg" placeholder="Ex: Diagnostic complet du dernier run + sources utilis√©es + pr√©visions France/Belgique + alertes g√©n√©r√©es..."></textarea>
          <div class="row">
            <button id="btnAsk">Envoyer</button>
            <button id="btnAskAudit" class="ghost">Audit moteur (auto)</button>
          </div>
        </div>
        <div class="field">
          <label>R√©ponse</label>
          <textarea id="chatReply" readonly></textarea>
        </div>
      </div>
    </div>
  </section>

  <!-- TOOLS -->
  <section id="page-tools" class="hidden">
    <div class="grid cols-2">
      <div class="card">
        <h3>üõ† Outils admin</h3>
        <div class="buttons">
          <button id="btnQuickHealth" class="ghost">Health check rapide</button>
          <button id="btnReloadState" class="ghost">Recharger √©tat</button>
        </div>
        <pre id="toolsOut" class="mono small muted" style="white-space:pre-wrap"></pre>
      </div>

      <div class="card">
        <h3>üåß Radar global</h3>
        <div class="row">
          <button id="btnLoadRadar" class="ghost">Charger radar</button>
          <span class="small muted">Source: /api/radar/global (fallback Windy si indisponible)</span>
        </div>
        <div id="radarBox" style="margin-top:10px">
          <iframe id="windy" class="hidden" src="https://embed.windy.com/embed2.html?lat=20&lon=0&detail=true&pressure=true&type=radar&zoom=3" loading="lazy"></iframe>
          <div id="leafletBox" class="hidden" style="height:65vh;border:1px solid var(--line);border-radius:12px"></div>
        </div>
      </div>
    </div>
  </section>

  <!-- NEWS -->
  <section id="page-news" class="hidden">
    <div class="card">
      <h3>üì∞ Actualit√©s m√©t√©o & climat</h3>
      <div class="row">
        <button id="btnLoadNews" class="ghost">Charger actualit√©s</button>
        <span class="small muted">/api/news (si dispo dans ce build)</span>
      </div>
      <div id="newsList" style="margin-top:10px"></div>
    </div>
  </section>
</main>

<!-- Leaflet (radar fallback si /api/radar/global renvoie des tuiles) -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

<script>
/* ==== Helpers ==== */
const $ = sel => document.querySelector(sel);
const $$ = sel => [...document.querySelectorAll(sel)];
const store = {
  set(k,v){ localStorage.setItem(k, JSON.stringify(v)); },
  get(k,d=null){ try{ return JSON.parse(localStorage.getItem(k)) ?? d }catch{return d} },
  del(k){ localStorage.removeItem(k) }
};
function fmtTS(ts){ try{ return new Date(ts).toLocaleString() } catch{ return ts } }
function htmlEscape(s){ return (s??"").toString().replace(/[&<>"']/g,m=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[m])) }
async function jsonOrError(res){
  const txt = await res.text();
  try{ return JSON.parse(txt) }catch(e){
    throw new Error(`R√©ponse non JSON (${res.status}) ‚Üí ${txt.slice(0,200)}‚Ä¶`);
  }
}
function chip(status){
  if(status===true) return '<span class="chip ok">OK</span>';
  if(status===false) return '<span class="chip ko">KO</span>';
  return '<span class="chip unk">inconnu</span>';
}

/* ==== Navigation (sections = pages internes, m√©moire via hash & localStorage) ==== */
const pages = ["dashboard","alerts","user-view","chat","tools","news"];
function show(page){
  pages.forEach(p=>{
    const sec = document.getElementById("page-"+p);
    const tab = [...document.querySelectorAll('nav a')].find(a=>a.dataset.page===p);
    if(p===page){ sec.classList.remove("hidden"); tab.classList.add("active"); }
    else{ sec.classList.add("hidden"); tab.classList.remove("active"); }
  });
  location.hash = "#"+page;
  store.set("admin.currentPage", page);
}
window.addEventListener("hashchange", ()=> {
  const p = location.hash.replace("#","");
  if(pages.includes(p)) show(p);
});
document.getElementById("tabs").addEventListener("click", (e)=>{
  const a = e.target.closest("a[data-page]");
  if(a){ e.preventDefault(); show(a.dataset.page); }
});
show(store.get("admin.currentPage","dashboard"));

/* ==== Dashboard: RUNs, √©tat moteur, logs, checkup ==== */
async function loadEngineState(){
  const res = await fetch("/api/engine-state");
  const data = await jsonOrError(res);
  // endpoints vari√©s: soit {success:true,state:{...}} soit l'objet brut
  const state = data.state || data;
  store.set("engine.state", state);
  $("#lastSync").textContent = "Dernier √©tat: "+(state.runTime ? fmtTS(state.runTime) : "‚Äî");
  renderEngineBadges(state);
  renderCheckup(state);
}
function renderEngineBadges(state){
  const set = (el, val) => el.outerHTML = el.outerHTML.replace(/class="([^"]*)"/, (m,cls)=> `class="${cls.replace(/\s(ok|ko|unk)\b/g,'')} ${val}"`);
  $("#engineStatus").textContent = "Moteur: "+(state.runTime? "actif":"inconnu");
  set($("#engineStatus"), state.runTime? "ok":"unk");
  $("#iaStatus").textContent = "IA: "+(state.ia===true? "ok": state.ia===false? "ko":"inconnue");
  set($("#iaStatus"), state.ia===true? "ok": state.ia===false? "ko":"unk");
  $("#radarStatus").textContent = "Radar: "+(state.radar===true? "ok": state.radar===false? "ko":"inconnu");
  set($("#radarStatus"), state.radar===true? "ok": state.radar===false? "ko":"unk");
  $("#forecastsStatus").textContent = "Pr√©visions: "+(state.forecasts===true? "ok": state.forecasts===false? "ko":"inconnu");
  set($("#forecastsStatus"), state.forecasts===true? "ok": state.forecasts===false? "ko":"unk");
  $("#alertsStatus").textContent = "Alertes: "+(state.alerts===true? "ok": state.alerts===false? "ko":"inconnu");
  set($("#alertsStatus"), state.alerts===true? "ok": state.alerts===false? "ko":"unk");
  $("#engineMeta").textContent = "Zones couvertes: "+Object.keys(state.zonesCovered||{}).length+" ‚Ä¢ Alertes enregistr√©es: "+(state.alertsList?.length||0);
}
function boolFrom(obj, path){
  try{
    const val = path.split(".").reduce((a,k)=>a?.[k], obj);
    if(val===undefined || val===null) return null;
    if(typeof val==="string") return val.toLowerCase()==="ok" ? true : val.toLowerCase()==="ko" ? false : null;
    if(typeof val==="boolean") return val;
    if(typeof val==="number") return val>0;
    if(typeof val==="object") return Object.keys(val).length>0;
    return null;
  }catch{return null}
}
function renderCheckup(state){
  // Heuristiques robustes avec r√©tro-compat : on d√©duit OK/KO selon pr√©sence/valeurs
  const sources = state.sources||{};
  const zones = state.zonesCovered||{};
  const alertsList = state.alertsList||[];
  const hasModelsOK = ["gfs","ecmwf","icon","meteomatics","nasaSat","copernicus"].some(k => (sources?.[k]||"").toString().toLowerCase()==="ok");
  const someModelKO = ["gfs","ecmwf","icon","meteomatics","nasaSat","copernicus"].some(k => (sources?.[k]||"").toString().toLowerCase()==="ko");

  const items = [
    {label:"1. Mod√®les OK", v: hasModelsOK},
    {label:"2. Mod√®les non OK", v: someModelKO},
    {label:"3. Sources OK", v: Object.keys(sources).length>0},
    {label:"4. Sources non OK", v: Object.keys(sources).length===0? true:false},
    {label:"5. Analyse IA pr√©visions", v: state.forecasts??null},
    {label:"6. Analyse IA alertes", v: state.alerts??null},
    {label:"7. Pr√©visions locales (zones couvertes)", v: Object.keys(zones).length>0},
    {label:"8. Pr√©visions nationales (zones couvertes)", v: Object.keys(zones).length>0},
    {label:"9. Alertes locales (zones couvertes)", v: alertsList.some(a=>a.scope==="covered")},
    {label:"10. Alertes nationales (zones couvertes)", v: alertsList.some(a=>a.scope==="covered" && a.level)},
    {label:"11. Alertes continentales (non couvertes)", v: alertsList.some(a=>a.scope==="global")},
    {label:"12. Assemblage alertes mondiales", v: alertsList.length>0},
    {label:"13. Open-data pr√©visions (non couvertes)", v: (sources?.openweather||"").toString().toLowerCase()==="ok" }
  ];
  const box = $("#checkup");
  box.innerHTML = items.map(it=>`<div class="row">${chip(it.v===true?true:it.v===false?false:null)} <span>${htmlEscape(it.label)}</span></div>`).join("");
}
async function runGlobal(){
  $("#runResult").textContent = "RUN GLOBAL en cours‚Ä¶";
  const res = await fetch("/api/run-global",{method:"POST"});
  const data = await jsonOrError(res);
  $("#runResult").textContent = JSON.stringify(data, null, 2);
  await loadEngineState();
}
async function runContinental(){
  $("#runResult").textContent = "RUN CONTINENTAL en cours‚Ä¶";
  const res = await fetch("/api/run-continental",{method:"POST"});
  const data = await jsonOrError(res);
  $("#runResult").textContent = JSON.stringify(data, null, 2);
  await loadEngineState();
}
async function loadLogs(){
  const res = await fetch("/api/logs");
  const data = await jsonOrError(res);
  const logs = Array.isArray(data)? data : (data.logs||data);
  store.set("engine.logs", logs);
  const box = $("#logs");
  box.innerHTML = logs.map(l=>{
    const isErr = /error|erreur|‚ùå/i.test(l.message||"");
    return `<div class="log">
      <div class="t">${htmlEscape(fmtTS(l.timestamp||""))}</div>
      <div class="${isErr?'ko':''}">${htmlEscape(l.message||"")}</div>
    </div>`;
  }).join("") || '<div class="small muted">Aucun log.</div>';
}
$("#btnRunGlobal").onclick = runGlobal;
$("#btnRunContinental").onclick = runContinental;
$("#btnRefresh").onclick = loadEngineState;
$("#btnLoadLogs").onclick = loadLogs;

/* ==== Chat IA moteur ==== */
async function askChat(msg){
  const res = await fetch("/api/chat",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({message:msg||""})});
  const data = await jsonOrError(res);
  const reply = data.reply?.reply || data.reply || data.response || data;
  $("#chatReply").value = typeof reply==="string" ? reply : JSON.stringify(reply,null,2);
}
$("#btnAsk").onclick = ()=> askChat($("#chatMsg").value.trim());
$("#btnAskAudit").onclick = ()=>{
  const s = store.get("engine.state", {});
  const question = `Audit int√©gral moteur:
- runTime: ${s.runTime}
- sources: ${JSON.stringify(s.sources||{})}
- zones: ${Object.keys(s.zonesCovered||{}).length}
- alertes: ${(s.alertsList||[]).length}
V√©rifie que les mod√®les et sources sont bien attest√©s, que l‚ÄôIA a produit pr√©visions+alertes, et dis si tout est publiable.`;
  $("#chatMsg").value = question;
  askChat(question);
};

/* ==== Alertes (buckets + actions) ==== */
function renderAlertItem(a){
  const meta = [
    a.country? `Pays: ${a.country}`:"",
    a.continent? `Continent: ${a.continent}`:"",
    a.level? `Niveau: ${a.level}`:"",
    (a.confidence!=null)? `Fiabilit√©: ${a.confidence}%`:"",
    a.firstDetectedByUs===true? "Premiers: oui": (a.firstDetectedByUs===false? "Premiers: non":"")
  ].filter(Boolean).join(" ‚Ä¢ ");
  const id = a._id || a.id || "";
  return `<div class="card" style="margin-bottom:8px">
    <div class="row"><strong>${htmlEscape(a.title||"Alerte")}</strong> <span class="small muted">${htmlEscape(meta)}</span></div>
    <div class="small muted mono" style="margin-top:6px">${htmlEscape(JSON.stringify(a.details||{},null,2))}</div>
    ${id? `<div class="row" style="margin-top:8px">
      <button data-act="validate" data-id="${id}" class="ghost">Valider</button>
      <button data-act="expert" data-id="${id}" class="ghost">Envoyer expert</button>
      <button data-act="wait" data-id="${id}" class="ghost">Mettre en attente</button>
      <button data-act="ignore" data-id="${id}" class="ghost">Ignorer</button>
    </div>` : ""}
  </div>`;
}
function bucketize(list){
  const auto=[], review=[], low=[];
  for(const a of list){
    const c = Number(a.confidence ?? -1);
    if(c>=90) auto.push(a);
    else if(c>=70) review.push(a);
    else low.push(a);
  }
  return {auto,review,low};
}
async function loadAlerts(){
  const res = await fetch("/api/alerts");
  const data = await jsonOrError(res);
  // tol√©rer diff√©rents formats de service
  const alerts = data.alerts?.covered || data.covered || data.alerts || [];
  const globals = data.alerts?.global || data.global || [];
  const merged = Array.isArray(alerts) ? alerts.slice() : [];
  if(Array.isArray(globals)) merged.push(...globals);
  const {auto,review,low} = bucketize(merged);

  $("#alertsAuto").innerHTML = auto.map(renderAlertItem).join("") || '<div class="small muted">Aucune alerte auto pour l‚Äôinstant.</div>';
  $("#alertsReview").innerHTML = review.map(renderAlertItem).join("") || '<div class="small muted">Aucune alerte √† examiner.</div>';
  $("#alertsLow").innerHTML = low.map(renderAlertItem).join("") || '<div class="small muted">Aucune alerte <70 %.</div>';

  // Comparaison ‚Äì placeholders robustes si non fournis
  $("#cmpFirst").innerHTML = auto.filter(a=>a.firstDetectedByUs===true).map(renderAlertItem).join("") || '<div class="small muted">Aucune d√©tect√©e uniquement par nous pour l‚Äôinstant.</div>';
  $("#cmpOthers").innerHTML = auto.filter(a=>a.firstDetectedByUs===false).map(renderAlertItem).join("") || '<div class="small muted">Aucune aussi vue ailleurs list√©e.</div>';
}
$("#btnLoadAlerts").onclick = loadAlerts;

document.addEventListener("click", async (e)=>{
  const btn = e.target.closest('button[data-act][data-id]');
  if(!btn) return;
  const id = btn.dataset.id, act = btn.dataset.act;
  try{
    const res = await fetch(`/api/alerts/${encodeURIComponent(id)}/${encodeURIComponent(act)}`,{method:"POST"});
    const data = await jsonOrError(res);
    await loadAlerts();
    alert("OK");
  }catch(err){ alert("Erreur action alerte: "+err.message) }
});

/* ==== Vue utilisateur ==== */
async function geocode(city, country){
  if(!city || !country) return null;
  const url = `https://nominatim.openstreetmap.org/search?format=jsonv2&limit=1&country=${encodeURIComponent(country)}&q=${encodeURIComponent(city)}`;
  const res = await fetch(url);
  const j = await res.json().catch(()=>[]);
  if(!Array.isArray(j) || !j.length) return null;
  return {lat:parseFloat(j[0].lat), lon:parseFloat(j[0].lon), display:j[0].display_name};
}
$("#btnUserView").onclick = async ()=>{
  const country = $("#uvCountry").value.trim();
  const city = $("#uvCity").value.trim();
  const sum = $("#userViewSummary");
  sum.innerHTML = '<span class="small muted">R√©solution‚Ä¶</span>';
  let lat=null, lon=null, display=null;
  const g = await geocode(city, country);
  if(g){ lat=g.lat; lon=g.lon; display=g.display; }
  sum.innerHTML = `<div class="small">Pays: <b>${htmlEscape(country||"‚Äî")}</b> ‚Ä¢ Ville: <b>${htmlEscape(city||"‚Äî")}</b> ${display? `‚Ä¢ ${htmlEscape(display)}`:""}</div>` +
                  (lat? `<div class="small mono muted">lat=${lat} lon=${lon}</div>`:"");
  // tenter de forcer l‚Äôindex avec param√®tres, sinon simple index
  const params = (lat && lon && country)? `?lat=${lat}&lon=${lon}&country=${encodeURIComponent(country)}` : "";
  $("#userViewFrame").src = "index.html"+params;
  store.set("uv.last",{country,city,lat,lon});
};
$("#btnUserViewClear").onclick = ()=>{
  $("#uvCountry").value = ""; $("#uvCity").value="";
  $("#userViewSummary").innerHTML="";
  $("#userViewFrame").src = "index.html";
  store.del("uv.last");
};
// restaurer derni√®re vue
const lastUV = store.get("uv.last", null);
if(lastUV){ $("#uvCountry").value=lastUV.country||""; $("#uvCity").value=lastUV.city||""; }

/* ==== Outils & Radar ==== */
let leafletMap=null, leafletLayer=null;
async function loadRadar(){
  try{
    const res = await fetch("/api/radar/global");
    const data = await jsonOrError(res);
    const radar = data.radar || data;
    if(radar && radar.tileUrl){
      $("#windy").classList.add("hidden");
      $("#leafletBox").classList.remove("hidden");
      if(!leafletMap){
        leafletMap = L.map('leafletBox',{zoomControl:true}).setView([20,0],3);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'¬© OpenStreetMap'}).addTo(leafletMap);
      }
      if(leafletLayer){ leafletMap.removeLayer(leafletLayer); leafletLayer=null; }
      leafletLayer = L.tileLayer(radar.tileUrl, {opacity:0.7});
      leafletLayer.addTo(leafletMap);
    }else{
      // fallback Windy
      $("#leafletBox").classList.add("hidden");
      $("#windy").classList.remove("hidden");
    }
  }catch{
    $("#leafletBox").classList.add("hidden");
    $("#windy").classList.remove("hidden");
  }
}
$("#btnLoadRadar").onclick = loadRadar;

$("#btnQuickHealth").onclick = ()=>{
  const s = store.get("engine.state", {});
  const logs = store.get("engine.logs", []);
  const out = {
    runTime: s.runTime||null,
    sources: s.sources||{},
    zones: Object.keys(s.zonesCovered||{}).length,
    alerts: (s.alertsList||[]).length,
    lastLog: logs[0]?.message||null
  };
  $("#toolsOut").textContent = JSON.stringify(out,null,2);
};
$("#btnReloadState").onclick = loadEngineState;

/* ==== News ==== */
async function loadNews(){
  try{
    const res = await fetch("/api/news");
    const data = await jsonOrError(res);
    const list = Array.isArray(data)? data : (data.articles||data.items||[]);
    $("#newsList").innerHTML = list.map(a=>`
      <div class="card" style="margin-bottom:8px">
        <div><strong>${htmlEscape(a.title||"")}</strong></div>
        <div class="small muted">${htmlEscape(a.source?.name||a.source||"")}</div>
        <div class="small">${htmlEscape(a.description||"")}</div>
        ${a.url? `<div class="small"><a class="btn" href="${htmlEscape(a.url)}" target="_blank" rel="noopener">Ouvrir</a></div>`:""}
      </div>
    `).join("") || '<div class="small muted">Aucune actualit√©.</div>';
  }catch(err){
    $("#newsList").innerHTML = `<div class="small ko">Erreur news: ${htmlEscape(err.message)}</div>`;
  }
}
$("#btnLoadNews").onclick = loadNews;

/* ==== Boot (ne pas lancer de RUN automatiquement) ==== */
(async function boot(){
  // restaurer √©tat sans d√©clencher de run
  try{ await loadEngineState(); }catch(e){ /* silencieux */ }
  try{
    const logs = store.get("engine.logs", null);
    if(logs){ $("#logs").innerHTML = logs.map(l=>`<div class="log"><div class="t">${htmlEscape(fmtTS(l.timestamp||""))}</div><div>${htmlEscape(l.message||"")}</div></div>`).join(""); }
  }catch{}
})();
</script>
</body>
</html>
