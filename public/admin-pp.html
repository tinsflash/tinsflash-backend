<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="robots" content="noindex,nofollow">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Console Admin ‚Äì Centrale m√©t√©o nucl√©aire</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial, sans-serif; background:#111; color:#eee; margin:0; }
    header { background:#222; padding:10px; text-align:center; }
    nav a { color:#0af; margin:0 10px; text-decoration:none; }
    h2 { margin-top:20px; }
    #alertsSummary { background:#222; padding:12px; margin:12px; border-radius:8px; font-size:0.9em; }
    .stat { margin:5px 0; }
    .badge { padding:3px 8px; border-radius:6px; margin-left:6px; }
    .exclusive { background:#a22; color:#fff; }
    .confirmed { background:#2a2; color:#fff; }
    .surveillance { background:#335; color:#fff; }
    .blinker { animation: blink 1s infinite; }
    @keyframes blink { 50% { opacity:0; } }
    .button { margin:5px; padding:8px 12px; border:none; border-radius:6px; cursor:pointer; font-weight:bold; }
    .orange { background:#cc0; color:#000; }
    .green { background:#2a2; color:#fff; }
    .red { background:#a22; color:#fff; }
    .purple { background:#639; color:#fff; }
    #logs { display:none; background:#000; padding:10px; border-radius:6px; margin:10px; max-height:250px; overflow:auto; }

    /* Colonnes pr√©visions / alertes */
    .columns { display:flex; gap:20px; margin:20px; }
    .col { flex:1; background:#222; padding:10px; border-radius:8px; }
    .col h3 { text-align:center; }
    .row { display:flex; justify-content:space-between; margin:4px 0; }
    .ball { width:14px; height:14px; border-radius:50%; display:inline-block; margin-left:6px; }
    .ball.orange { background:#cc0; }
    .ball.green { background:#2a2; }
    .ball.red { background:#a22; }
    .ball.purple { background:#639; }

    /* Chat bulle */
    #chatButton {
      position: fixed; bottom:20px; right:20px;
      width:60px; height:60px; border-radius:50%;
      background:#0af; color:#fff; font-size:24px; font-weight:bold;
      border:none; cursor:pointer; z-index:9999;
    }
    #chatBubble {
      position: fixed; bottom:90px; right:20px;
      background:#222; border:2px solid #0af; border-radius:12px;
      padding:10px; width:300px; height:400px;
      display:none; flex-direction:column; z-index:9999;
    }
    #chatBubble header { font-weight:bold; text-align:center; margin-bottom:6px; }
    #chatLog { flex:1; overflow-y:auto; background:#000; padding:6px; border-radius:6px; }
    #chatInput { margin-top:6px; display:flex; }
    #chatInput input { flex:1; padding:4px; }
    #chatInput button { padding:4px 8px; }
  </style>
  <script>
    const pwd = prompt("Mot de passe ?");
    if (pwd !== "202679") {
      document.write("‚õî Acc√®s refus√©");
      throw new Error("Acc√®s refus√©");
    }

    let lastExclusiveCount = 0;
    let chart;

    async function fetchAlertsSummary() {
      try {
        const res = await fetch("/api/alerts/summary");
        if (!res.ok) return;
        const s = await res.json();
        const exclusiveCount = s.exclusives || 0;

        let exclusiveBadge = `<span class="badge exclusive">${exclusiveCount}</span>`;
        if (exclusiveCount > lastExclusiveCount) {
          exclusiveBadge = `<span class="badge exclusive blinker">${exclusiveCount}</span>`;
        }
        lastExclusiveCount = exclusiveCount;

        document.getElementById("alertsSummary").innerHTML = `
          <div class="stat">üìä <strong>Total alertes actives :</strong> ${s.total || 0}</div>
          <div class="stat">üîµ Sous surveillance : ${s.byStatus?.["under-surveillance"] || 0}</div>
          <div class="stat">üî¥ Exclusives : ${exclusiveBadge}
              üü¢ Confirm√©es ailleurs : <span class="badge confirmed">${s.confirmedElsewhere || 0}</span></div>
        `;

        updateChart(s);
      } catch (e) { console.error("Erreur r√©sum√© alertes:", e); }
    }

    function updateChart(s) {
      const ctx = document.getElementById("alertsChart").getContext("2d");
      const data = {
        labels: ["Publi√©es", "√Ä valider", "Sous surveillance", "Ignor√©es", "Exclusives", "Confirm√©es"],
        datasets: [{
          data: [
            s.byStatus?.["published"] || 0,
            s.byStatus?.["toValidate"] || 0,
            s.byStatus?.["under-surveillance"] || 0,
            s.byStatus?.["ignored"] || 0,
            s.exclusives || 0,
            s.confirmedElsewhere || 0
          ],
          backgroundColor: ["#2a2", "#cc0", "#335", "#633", "#a22", "#0af"]
        }]
      };
      if (chart) { chart.data = data; chart.update(); }
      else { chart = new Chart(ctx, { type:"doughnut", data, options:{ plugins:{ legend:{ labels:{ color:"#eee" } } } } }); }
    }

    async function fetchCountries() {
      try {
        const res = await fetch("/api/checkup");
        const state = await res.json();
        const europe = state.zonesCoveredEurope?.countries || [];
        const usa = state.zonesCoveredUSA?.states || [];

        fillCol("forecastList", europe, state.checkup);
        fillCol("alertList", usa, state.checkup);
      } catch (e) { console.error("Erreur pays:", e); }
    }

    function fillCol(id, list, checkup) {
      const div = document.getElementById(id);
      div.innerHTML = "";
      list.forEach(c => {
        const st = checkup?.[c] || "PENDING";
        const ballClass = st==="OK"?"green":st==="FAIL"?"red":st==="PARTIAL"?"purple":"orange";
        div.innerHTML += `<div class="row"><span>${c}</span><span class="ball ${ballClass}"></span></div>`;
      });
    }

    async function runProcess(endpoint, btnId) {
      const btn = document.getElementById(btnId);
      btn.className = "button orange";
      try {
        const res = await fetch(endpoint, { method:"POST" });
        const data = await res.json();
        btn.className = data.success ? "button green" : "button red";
      } catch { btn.className = "button red"; }
    }

    function toggleLogs() {
      const logs = document.getElementById("logs");
      logs.style.display = logs.style.display === "none" ? "block" : "none";
      if (logs.style.display === "block") loadLogs();
    }
    async function loadLogs() {
      const res = await fetch("/api/logs?cycle=current");
      const data = await res.json();
      document.getElementById("logs").innerText = data.map(l=>l.message).join("\n");
    }

    function toggleChat() {
      const chat = document.getElementById("chatBubble");
      chat.style.display = chat.style.display==="none"?"flex":"none";
    }

    async function sendChat() {
      const input = document.getElementById("chatMsg");
      const msg = input.value.trim();
      if (!msg) return;
      const log = document.getElementById("chatLog");
      log.innerHTML += `<div><b>Moi:</b> ${msg}</div>`;
      input.value = "";
      const res = await fetch("/api/chat/engine", {
        method:"POST", headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ message: msg })
      });
      const data = await res.json();
      log.innerHTML += `<div><b>GPT:</b> ${data.reply}</div>`;
      log.scrollTop = log.scrollHeight;
    }

    setInterval(fetchAlertsSummary, 7000);
    setInterval(fetchCountries, 10000);
    window.onload = () => { fetchAlertsSummary(); fetchCountries(); };
  </script>
</head>
<body>
  <header>
    <h1>‚ö° Centrale nucl√©aire m√©t√©o ‚Äì Console Admin</h1>
    <nav>
      <a href="/admin">Console</a>
      <a href="/admin-alerts">Alertes</a>
      <a href="/admin-chat">Chat</a>
      <a href="/admin-index">Vue Index</a>
      <a href="/admin-radar">Radar & News</a>
      <a href="/admin-users">Utilisateurs</a>
    </nav>
  </header>

  <!-- üö® R√©sum√© global alertes -->
  <div id="alertsSummary">Chargement du r√©sum√© des alertes‚Ä¶</div>
  <canvas id="alertsChart"></canvas>

  <!-- Colonnes Pr√©visions & Alertes -->
  <div class="columns">
    <div class="col">
      <h3>üåç Pr√©visions par pays</h3>
      <div id="forecastList"></div>
    </div>
    <div class="col">
      <h3>üö® Alertes par pays</h3>
      <div id="alertList"></div>
    </div>
  </div>

  <!-- üõ† Contr√¥le moteur -->
  <section id="engineControls">
    <h2>üõ† Contr√¥le moteur</h2>
    <button id="btnEurope" class="button" onclick="runProcess('/api/run-europe','btnEurope')">Run Pr√©visions Europe</button>
    <button id="btnUSA" class="button" onclick="runProcess('/api/run-usa','btnUSA')">Run Pr√©visions USA</button>
    <button id="btnAlertsEurope" class="button" onclick="runProcess('/api/run-alerts','btnAlertsEurope')">Run Alertes Europe</button>
    <button id="btnAlertsContinental" class="button" onclick="runProcess('/api/run-alerts-continental','btnAlertsContinental')">Run Alertes Continentales</button>
    <button id="btnAlertsWorld" class="button" onclick="runProcess('/api/run-alerts-world','btnAlertsWorld')">Run Alertes Mondiales</button>
    <button id="btnOrchestrator" class="button" onclick="runProcess('/api/run-orchestrator','btnOrchestrator')">Run Orchestrateur IA</button>
    <button onclick="toggleLogs()">üìú Voir logs</button>
    <div id="logs"></div>
  </section>

  <!-- üí¨ Chat IA moteur (r√©ductible) -->
  <button id="chatButton" onclick="toggleChat()">üí¨</button>
  <div id="chatBubble">
    <header>ü§ñ ChatGPT5 ‚Äì Moteur</header>
    <div id="chatLog"></div>
    <div id="chatInput">
      <input type="text" id="chatMsg" placeholder="Demander au moteur..." onkeypress="if(event.key==='Enter') sendChat()">
      <button onclick="sendChat()">Envoyer</button>
    </div>
  </div>
</body>
</html>
