<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>TinsFlash â€“ Admin Pro+</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <header class="banner">
    <h1>âš™ï¸ Cockpit Admin Pro+</h1>
  </header>

  <main>
    <!-- Supercalculateur -->
    <section class="card wide">
      <h2>ğŸš€ Supercalculateur mÃ©tÃ©o</h2>
      <button id="run-btn">â–¶ï¸ Lancer un run</button>
      <div id="run-status">â³ En attente...</div>
      <div id="run-progress" style="width:100%; background:#eee; border-radius:8px; margin-top:10px;">
        <div id="progress-bar" style="width:0%; height:20px; background:#007bff; border-radius:8px;"></div>
      </div>
    </section>

    <!-- Derniers runs -->
    <section class="card wide">
      <h2>ğŸ“Š Derniers runs enregistrÃ©s</h2>
      <div id="last-runs">â³ Chargement...</div>
    </section>

    <!-- Logs admin -->
    <section class="card wide">
      <h2>ğŸ“‹ Logs administrateur</h2>
      <div id="admin-logs">â³ Chargement...</div>
    </section>
  </main>

  <footer>
    Â© 2025 TinsFlash â€“ Centrale nuclÃ©aire mÃ©tÃ©o
  </footer>

  <script>
    // Lancer un run supercalc
    document.getElementById("run-btn").addEventListener("click", async () => {
      const status = document.getElementById("run-status");
      const bar = document.getElementById("progress-bar");

      status.innerText = "â³ Run en cours...";
      bar.style.width = "0%";

      try {
        const res = await fetch("/api/supercalc/run", { method: "POST" });
        const data = await res.json();

        if (data.success) {
          status.innerText = "âœ… Run terminÃ© avec succÃ¨s";
          bar.style.width = "100%";
          loadRuns();
        } else {
          status.innerText = "âŒ Erreur run : " + data.error;
          bar.style.width = "0%";
        }
      } catch (err) {
        status.innerText = "âŒ Erreur supercalc";
        bar.style.width = "0%";
      }
    });

    // Charger derniers runs
    async function loadRuns() {
      const c = document.getElementById("last-runs");
      c.innerHTML = "â³ Chargement...";
      try {
        const res = await fetch("/api/supercalc/logs");
        const data = await res.json();
        if (!data.length) {
          c.innerHTML = "âš ï¸ Aucun run enregistrÃ©";
          return;
        }
        c.innerHTML = data
          .map(run =>
            `<div>[${new Date(run.timestamp).toLocaleString("fr-FR")}] ğŸŒ (${run.location.lat}, ${run.location.lon}) - Sources: ${run.sources.length}, Anomalie: ${run.anomaly || "Aucune"}</div>`
          )
          .join("");
      } catch (err) {
        c.innerHTML = "âŒ Erreur chargement runs";
      }
    }

    // Charger logs admin
    async function loadAdminLogs() {
      const c = document.getElementById("admin-logs");
      c.innerHTML = "â³ Chargement...";
      try {
        const res = await fetch("/api/admin/logs");
        const data = await res.json();
        if (!data.length) {
          c.innerHTML = "âœ… Aucun log enregistrÃ©";
          return;
        }
        c.innerHTML = data
          .map(
            log =>
              `<div>[${new Date(log.timestamp).toLocaleString("fr-FR")}] ${log.message}</div>`
          )
          .join("");
      } catch (err) {
        c.innerHTML = "âŒ Erreur chargement logs admin";
      }
    }

    // RafraÃ®chissement pÃ©riodique
    setInterval(loadRuns, 15000);       // Runs toutes les 15 sec
    setInterval(loadAdminLogs, 10000);  // Logs toutes les 10 sec

    // Premier chargement
    window.addEventListener("DOMContentLoaded", () => {
      loadRuns();
      loadAdminLogs();
    });
  </script>
</body>
</html>
