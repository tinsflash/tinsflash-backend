<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Console Admin â€“ Centrale NuclÃ©aire MÃ©tÃ©o ğŸŒâš¡</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      font-family: "Segoe UI", Arial, sans-serif;
      background-color: #0a0f1c;
      color: #f0f0f0;
      margin: 0;
      padding: 20px;
    }
    h1, h2 {
      text-align: center;
      color: #00d9ff;
    }
    .status-bar {
      background: #111a2d;
      padding: 12px;
      margin-bottom: 20px;
      text-align: center;
      border: 2px solid #00d9ff;
      border-radius: 8px;
      font-size: 1.1em;
    }
    .container { display: grid; gap: 20px; }
    .card {
      background: #111a2d;
      padding: 15px;
      border-radius: 10px;
      border: 1px solid #00d9ff;
      box-shadow: 0 0 10px rgba(0,217,255,0.3);
    }
    textarea, input, button {
      width: 100%;
      padding: 10px;
      border-radius: 6px;
      border: none;
      margin-top: 8px;
    }
    button {
      background: #00d9ff;
      color: #0a0f1c;
      font-weight: bold;
      cursor: pointer;
    }
    button:hover { background: #00aacc; }
    #logs {
      background: #000;
      color: #0f0;
      font-family: monospace;
      white-space: pre-wrap;
      word-wrap: break-word;
      overflow-y: auto;
      max-height: 250px;
    }
    .alert-valid { color: #0f0; }
    .alert-pending { color: #ff0; }
    .alert-critical { color: #f00; }
    .small-text { font-size: 0.85em; color: #aaa; }
    .tools-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 10px;
    }
    iframe {
      width: 100%;
      border: none;
      height: 250px;
      border-radius: 6px;
    }
  </style>
</head>
<body>
  <h1>ğŸ› ï¸ Centrale NuclÃ©aire MÃ©tÃ©o â€“ Console Admin</h1>
  <div class="status-bar">
    <strong>IA Active :</strong> ğŸ¤– Cohere (command-r-plus) â€“  
    <strong>Zones couvertes :</strong> ğŸ‡ªğŸ‡º Europe Ã©largie + ğŸ‡ºğŸ‡¸ USA  
    <strong>Mode :</strong> 100% rÃ©el, zÃ©ro dÃ©mo ğŸš€
  </div>

  <div class="container">
    <!-- SuperForecast -->
    <div class="card">
      <h2>âš¡ Lancer un Run SuperForecast</h2>
      <label>Latitude: <input id="lat" value="50.5"></label>
      <label>Longitude: <input id="lon" value="4.7"></label>
      <button onclick="runForecast()">ğŸš€ Lancer</button>
      <button onclick="refreshIndex()">ğŸ”„ RafraÃ®chir Index</button>
    </div>

    <!-- Logs -->
    <div class="card">
      <h2>ğŸ“œ Logs en temps rÃ©el</h2>
      <div id="logs">En attente de logs...</div>
    </div>

    <!-- PrÃ©visions nationales -->
    <div class="card">
      <h2>ğŸŒ PrÃ©visions Nationales</h2>
      <ul id="nationalForecasts">
        <li>BE: <span id="forecastBE">â€“</span></li>
        <li>FR: <span id="forecastFR">â€“</span></li>
        <li>LUX: <span id="forecastLUX">â€“</span></li>
      </ul>
      <div class="small-text">âœ”ï¸ RafraÃ®chies automatiquement aprÃ¨s chaque Run</div>
    </div>

    <!-- Alertes -->
    <div class="card">
      <h2>âš ï¸ Alertes</h2>
      <h3>ğŸ”´ Automatiques (>90%)</h3>
      <ul id="alertsAuto"><li>Aucune alerte</li></ul>
      <h3>ğŸŸ¡ Ã€ valider (70â€“90%)</h3>
      <ul id="alertsPending"><li>Aucune alerte</li></ul>
    </div>

    <!-- Chat -->
    <div class="card">
      <h2>ğŸ’¬ Chat avec J.E.A.N.</h2>
      <textarea id="chatInput" placeholder="Pose une question Ã  J.E.A.N."></textarea>
      <button onclick="askJean()">Envoyer</button>
      <div id="chatResponse" class="small-text">RÃ©ponses de J.E.A.N. sâ€™afficheront ici.</div>
    </div>

    <!-- Surveillance moteur -->
    <div class="card">
      <h2>ğŸ–¥ï¸ Surveillance du Moteur</h2>
      <div id="engineStatus">Chargement...</div>
    </div>

    <!-- Surveillance externe -->
    <div class="card">
      <h2>ğŸŒ Outils de Surveillance Externe</h2>
      <div class="tools-grid">
        <iframe src="https://www.rainviewer.com/map.html"></iframe>
        <iframe src="https://www.nasa.gov/specials/radar/"></iframe>
        <iframe src="https://www.wetterzentrale.de/"></iframe>
        <iframe src="https://climate.copernicus.eu/"></iframe>
      </div>
    </div>

    <!-- News scientifiques -->
    <div class="card">
      <h2>ğŸ“° Flux News Scientifiques & MÃ©tÃ©o</h2>
      <iframe id="newsFrame" src="https://news.google.com/rss/search?q=climat+OR+meteo&hl=fr&gl=FR&ceid=FR:fr"></iframe>
      <button onclick="translateNews()">ğŸŒ Traduire en FR</button>
      <div id="translatedNews" class="small-text"></div>
    </div>

    <!-- Stats -->
    <div class="card">
      <h2>ğŸ“Š Stats & Utilisateurs</h2>
      <div id="stats">Chargement...</div>
    </div>
  </div>

  <script>
    async function runForecast() {
      const lat = document.getElementById("lat").value;
      const lon = document.getElementById("lon").value;
      const res = await fetch("/api/supercalc/run", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ lat, lon }),
      });
      const data = await res.json();
      updateLogs(data.logs);
      updateNational(data.nationalForecasts || {});
    }

    function updateLogs(logs) {
      document.getElementById("logs").textContent = logs.join("\n");
    }

    function updateNational(forecasts) {
      document.getElementById("forecastBE").textContent = forecasts.BE || "â€“";
      document.getElementById("forecastFR").textContent = forecasts.FR || "â€“";
      document.getElementById("forecastLUX").textContent = forecasts.LUX || "â€“";
    }

    async function askJean() {
      const message = document.getElementById("chatInput").value;
      const res = await fetch("/api/chat", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ message }),
      });
      const data = await res.json();
      document.getElementById("chatResponse").textContent =
        "ğŸ§‘â€ğŸ”§ J.E.A.N: " + (data.text || "RÃ©ponse vide");
    }

    async function loadStats() {
      const res = await fetch("/api/admin/stats");
      const data = await res.json();
      document.getElementById("stats").innerHTML =
        `PrÃ©visions: ${data.forecasts} | Alertes: ${data.alerts} | Uptime: ${Math.round(data.uptime/60)} min`;
    }

    async function loadAlerts() {
      const res = await fetch("/api/alerts");
      const alerts = await res.json();
      document.getElementById("alertsAuto").innerHTML = alerts
        .filter(a => a.reliability > 90)
        .map(a => `<li class="alert-critical">${a.title}</li>`)
        .join("") || "<li>Aucune alerte</li>";
      document.getElementById("alertsPending").innerHTML = alerts
        .filter(a => a.reliability >= 70 && a.reliability <= 90)
        .map(a => `<li class="alert-pending">${a.title} <button onclick='validateAlert("${a._id}")'>Valider</button> <button>Rejeter</button></li>`)
        .join("") || "<li>Aucune alerte</li>";
    }

    async function loadEngine() {
      const res = await fetch("/api/admin/engine");
      const data = await res.json();
      document.getElementById("engineStatus").innerHTML =
        `CPU: ${data.cpu}% | RAM: ${data.ram}% | DB: ${data.db} | Uptime: ${Math.round(data.uptime/60)} min`;
    }

    async function refreshIndex() {
      await fetch("/api/admin/refresh-index", { method: "POST" });
      alert("ğŸ”„ Index public rafraÃ®chi !");
    }

    async function translateNews() {
      try {
        let frame = document.getElementById("newsFrame");
        let doc = frame.contentDocument || frame.contentWindow.document;
        let text = doc.body.innerText.substring(0, 3000); // limite
        const res = await fetch(
          `https://translate.googleapis.com/translate_a/single?client=gtx&sl=auto&tl=fr&dt=t&q=${encodeURIComponent(text)}`
        );
        const data = await res.json();
        const translated = data[0].map(item => item[0]).join(" ");
        document.getElementById("translatedNews").textContent = translated;
      } catch (err) {
        document.getElementById("translatedNews").textContent = "âŒ Erreur traduction: " + err.message;
      }
    }

    loadStats();
    loadAlerts();
    loadEngine();
    setInterval(loadStats, 60000);
    setInterval(loadAlerts, 60000);
    setInterval(loadEngine, 60000);
  </script>
</body>
</html>
