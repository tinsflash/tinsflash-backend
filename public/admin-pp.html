<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>‚ö° Centrale Nucl√©aire M√©t√©o ‚Äì Admin</title>
  <style>
    body { background:#0a0f1c; color:#fff; font-family:Arial, sans-serif; margin:0; }
    header { padding:20px; background:#11172b; text-align:center; font-size:22px; font-weight:bold; }
    .controls { display:flex; flex-wrap:wrap; justify-content:center; gap:16px; padding:15px; background:#141c33; }
    .run-btn { padding:10px 15px; border-radius:6px; border:none; cursor:pointer; font-weight:bold; color:#fff; background:#444; }
    .run-btn.orange { background:orange; }
    .run-btn.green { background:#2ecc71; }
    .run-btn.red { background:#e74c3c; }
    .run-btn.purple { background:#9b59b6; }
    .progress { width:160px; height:8px; background:#222; border-radius:4px; margin:5px auto; overflow:hidden; }
    .progress-bar { height:8px; width:0%; background:#2ecc71; transition:width 0.3s; }

    .columns { display:flex; justify-content:space-around; padding:20px; }
    .col { flex:1; padding:10px; }
    h2 { font-size:18px; margin-bottom:10px; }
    .country { display:flex; align-items:center; margin:5px 0; }
    .bubble { width:14px; height:14px; border-radius:50%; margin-right:8px; background:orange; }
    .bubble.green { background:#2ecc71; }
    .bubble.red { background:#e74c3c; }
    .bubble.purple { background:#9b59b6; }

    .logs { padding:20px; background:#11172b; }
    .logs-header { display:flex; justify-content:space-between; align-items:center; cursor:pointer; font-weight:bold; }
    .logs-content { max-height:300px; overflow-y:auto; display:none; background:#0d1324; padding:10px; margin-top:10px; border-radius:6px; font-size:14px; }

    .chat-bubble { position:fixed; bottom:20px; right:20px; background:#2ecc71; color:#fff; border-radius:50%; width:60px; height:60px; display:flex; align-items:center; justify-content:center; cursor:pointer; font-size:26px; box-shadow:0 0 15px rgba(0,0,0,0.4); }
    #chat-window { position:fixed; bottom:90px; right:20px; width:300px; height:400px; background:#fff; color:#000; border-radius:10px; display:none; flex-direction:column; }
    #chat-messages { flex:1; padding:10px; overflow-y:auto; }
    #chat-input { display:flex; }
    #chat-input input { flex:1; padding:8px; border:none; border-top:1px solid #ccc; }
    #chat-input button { padding:8px 12px; border:none; background:#2ecc71; color:#fff; cursor:pointer; }
  </style>
</head>
<body>
  <header>‚ö° Centrale Nucl√©aire M√©t√©o ‚Äì Console Admin</header>

  <!-- Boutons + Progress -->
  <div class="controls">
    <div><button id="btn-europe-forecast" class="run-btn orange" onclick="triggerRun('europe','forecast')">Pr√©visions Europe</button><div class="progress"><div id="prog-europe-forecast" class="progress-bar"></div></div></div>
    <div><button id="btn-europe-alerts" class="run-btn orange" onclick="triggerRun('europe','alerts')">Alertes Europe</button><div class="progress"><div id="prog-europe-alerts" class="progress-bar"></div></div></div>
    <div><button id="btn-usa-forecast" class="run-btn orange" onclick="triggerRun('usa','forecast')">Pr√©visions USA</button><div class="progress"><div id="prog-usa-forecast" class="progress-bar"></div></div></div>
    <div><button id="btn-usa-alerts" class="run-btn orange" onclick="triggerRun('usa','alerts')">Alertes USA</button><div class="progress"><div id="prog-usa-alerts" class="progress-bar"></div></div></div>
    <div><button id="btn-continental-alerts" class="run-btn orange" onclick="triggerRun('continental','alerts')">Continental Alertes</button><div class="progress"><div id="prog-continental-alerts" class="progress-bar"></div></div></div>
    <div><button id="btn-fusion-alerts" class="run-btn orange" onclick="triggerRun('fusion','alerts')">Fusion Alertes</button><div class="progress"><div id="prog-fusion-alerts" class="progress-bar"></div></div></div>
    <div><button id="btn-ia-forecast" class="run-btn orange" onclick="triggerRun('ia','forecast')">IA Analyse Pr√©visions</button><div class="progress"><div id="prog-ia-forecast" class="progress-bar"></div></div></div>
    <div><button id="btn-ia-alerts" class="run-btn orange" onclick="triggerRun('ia','alerts')">IA Analyse Alertes</button><div class="progress"><div id="prog-ia-alerts" class="progress-bar"></div></div></div>
  </div>

  <!-- Colonnes Europe / USA -->
  <div class="columns">
    <div class="col"><h2>üåç Europe ‚Äì Pr√©visions</h2><div id="europe-forecast"></div></div>
    <div class="col"><h2>üåç Europe ‚Äì Alertes</h2><div id="europe-alerts"></div></div>
  </div>
  <div class="columns">
    <div class="col"><h2>üá∫üá∏ USA ‚Äì Pr√©visions</h2><div id="usa-forecast"></div></div>
    <div class="col"><h2>üá∫üá∏ USA ‚Äì Alertes</h2><div id="usa-alerts"></div></div>
  </div>

  <!-- Logs -->
  <div class="logs">
    <div class="logs-header" onclick="toggleLogs()">üìú Logs (cliquez pour afficher/masquer)</div>
    <select id="cycleSelect" onchange="loadLogsByCycle(this.value)">
      <option value="current">Cycle courant</option>
      <option value="all">Tous les logs</option>
    </select>
    <div class="logs-content" id="logsContent"></div>
  </div>

  <!-- Chat moteur -->
  <div class="chat-bubble" onclick="toggleChat()">üí¨</div>
  <div id="chat-window">
    <div id="chat-messages"></div>
    <div id="chat-input">
      <input type="text" id="chatMessage" placeholder="Question au moteur..." />
      <button onclick="sendChat()">Envoyer</button>
    </div>
  </div>

  <script>
    const EUROPE_COUNTRIES = ["Belgium","France","Germany","Netherlands","Luxembourg","Switzerland","Austria","Denmark","Norway","Sweden","Finland","Iceland","Poland","Czechia","Slovakia","Hungary","Romania","Moldova","Ukraine","Estonia","Latvia","Lithuania","Spain","Portugal","Italy","Malta","Greece","Cyprus","Croatia","Slovenia","BosniaHerzegovina","Serbia","Montenegro","Kosovo","NorthMacedonia","Albania","UnitedKingdom","Ireland"];
    const USA_STATES = ["California","Texas","Florida","New York","Illinois","Ohio","Georgia","North Carolina","Michigan","Pennsylvania"];

    function renderCountries(containerId, list) {
      const el=document.getElementById(containerId); el.innerHTML="";
      list.forEach(c=>{
        const div=document.createElement("div");
        div.className="country";
        div.innerHTML=`<div class="bubble" id="${containerId}-${c}"></div>${c}`;
        el.appendChild(div);
      });
    }
    renderCountries("europe-forecast", EUROPE_COUNTRIES);
    renderCountries("europe-alerts", EUROPE_COUNTRIES);
    renderCountries("usa-forecast", USA_STATES);
    renderCountries("usa-alerts", USA_STATES);

    function toggleLogs(){const logs=document.getElementById("logsContent"); logs.style.display=logs.style.display==="block"?"none":"block";}
    async function loadLogsByCycle(cycle){const res=await fetch(`/api/logs?cycle=${cycle}`); const logs=await res.json(); document.getElementById("logsContent").innerText=logs.map(l=>`${l.time} - ${l.msg}`).join("\n");}

    function toggleChat(){const chat=document.getElementById("chat-window"); chat.style.display=chat.style.display==="flex"?"none":"flex";}
    async function sendChat(){const input=document.getElementById("chatMessage"); const msg=input.value; input.value=""; const res=await fetch("/api/chat/engine",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({message:msg})}); const data=await res.json(); const chatBox=document.getElementById("chat-messages"); chatBox.innerHTML+=`<div><b>Moi:</b> ${msg}</div><div><b>IA:</b> ${data.reply}</div>`; chatBox.scrollTop=chatBox.scrollHeight;}

    async function triggerRun(zone,type){
      const map={ "europe-forecast":"/api/run-europe","europe-alerts":"/api/run-alerts","usa-forecast":"/api/run-usa","usa-alerts":"/api/run-alerts","continental-alerts":"/api/run-alerts-continental","fusion-alerts":"/api/run-alerts-world","ia-forecast":"/api/run-orchestrator","ia-alerts":"/api/run-orchestrator"};
      const key=`${zone}-${type}`;
      const btn=document.getElementById("btn-"+key); const bar=document.getElementById("prog-"+key);
      if(btn){btn.className="run-btn orange";} if(bar){bar.style.width="0%";}
      const res=await fetch(map[key]||"",{method:"POST"}); if(res.ok){alert(`‚úÖ Run ${zone} ${type} lanc√©`);} else {alert(`‚ùå Erreur lancement run ${zone} ${type}`);}
    }

    async function updateProgress(){
      const res=await fetch("/api/checkup"); const state=await res.json();
      const mapping={ "europe-forecast":state?.zonesCoveredSummaryEurope,"europe-alerts":state?.alertsEurope,"usa-forecast":state?.zonesCoveredSummaryUSA,"usa-alerts":state?.alertsUSA};
      for(const [key,data] of Object.entries(mapping)){
        const bar=document.getElementById("prog-"+key);
        if(!bar) continue;
        let percent=0;
        if(data?.points>0){percent=Math.round((data.success/data.points)*100);} else if(Array.isArray(data)){percent=100;}
        bar.style.width=percent+"%";
      }
    }
    setInterval(updateProgress,3000);

    const evtSource=new EventSource("/api/logs/stream");
    evtSource.onmessage=(e)=>{const log=JSON.parse(e.data); const logs=document.getElementById("logsContent"); logs.innerText+=`\n${log.time} - ${log.msg}`; updateProgress();};
  </script>
</body>
</html>
