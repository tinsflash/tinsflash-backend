<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>‚ö° Cockpit Administrateur ‚Äî Centrale Nucl√©aire M√©t√©o</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    body { background:#111; color:#0f0; font-family:monospace; margin:0; }
    header { background:#000; padding:10px; }
    nav a { margin-right:20px; color:#ccc; text-decoration:none; }
    nav a:hover { color:#fff; }
    h2 { margin-top:20px; color:#fff; }
    .ok { background:#060; color:#fff; padding:5px 10px; border-radius:5px; }
    .error { background:#600; color:#fff; padding:5px 10px; border-radius:5px; }
    .warn { background:#663; color:#fff; padding:5px 10px; border-radius:5px; }
    pre { background:#000; color:#0f0; padding:10px; overflow-x:auto; }
    button { margin:5px; padding:5px 10px; border:none; border-radius:4px; cursor:pointer; }
    .btn-run { background:#900; color:#fff; }
    .btn-copy { background:#444; color:#fff; }
    .btn-export { background:#060; color:#fff; }
    details summary { cursor:pointer; }
    ul { list-style:none; padding-left:20px; }
    li { margin:2px 0; }
  </style>
</head>
<body>
  <header>
    <h1>‚ö° Cockpit Administrateur ‚Äî Centrale Nucl√©aire M√©t√©o</h1>
    <nav>
      <a href="/admin">Cockpit</a>
      <a href="/admin-alertes.html">Alertes</a>
      <a href="/admin-chat.html">Chat IA</a>
      <a href="/admin-radar.html">Radar</a>
      <a href="/admin-index.html">Pr√©visualisation Index</a>
      <a href="/admin-news.html">Infos M√©t√©o Mondiales</a>
      <a href="/admin-users.html">Utilisateurs</a>
    </nav>
  </header>

  <section id="cockpit">
    <h2>üåç Cockpit</h2>
    <button class="btn-run" onclick="runGlobal()">‚ñ∂Ô∏è Lancer Run Global</button>
    <div id="checklist"></div>
  </section>

  <section id="logs">
    <h2>üìú Logs moteur</h2>
    <pre id="logsContent">Chargement...</pre>
  </section>

  <section id="engine">
    <h2>üõ∞Ô∏è √âtat complet du moteur</h2>
    <button class="btn-export" onclick="exportJSON()">üìÇ Export JSON</button>
    <button class="btn-copy" onclick="copyJSON()">üìã Copier JSON</button>
    <div id="engineState">Chargement...</div>
  </section>

  <script>
    async function refreshChecklist() {
      try {
        const res = await fetch("/api/checkup");
        const data = await res.json();
        let html = "<h3>‚úÖ Checklist moteur</h3>";
        for (const [key, val] of Object.entries(data)) {
          let cls = (val === "OK" ? "ok" : (val === "PENDING" ? "warn" : "error"));
          html += `<span class="${cls}">${key}: ${val}</span> `;
        }
        document.getElementById("checklist").innerHTML = html;
      } catch (err) {
        document.getElementById("checklist").innerHTML = "<span class='error'>Erreur chargement</span>";
      }
    }

    async function refreshLogs() {
      try {
        const res = await fetch("/api/logs");
        const data = await res.json();
        document.getElementById("logsContent").textContent = JSON.stringify(data, null, 2);
      } catch (err) {
        document.getElementById("logsContent").textContent = "Erreur logs: " + err;
      }
    }

    function renderEngineState(data) {
      if (!data || !data.zonesCovered) return "Aucune donn√©e centrale m√©t√©o.";

      let html = "";
      for (const [country, info] of Object.entries(data.zonesCovered)) {
        html += `<details><summary>üåç ${country}</summary><ul>`;
        if (info.regions) {
          for (const region of info.regions) {
            html += `<li><details><summary>üìç ${region.region}</summary>`;
            // Forecast synth√©tique
            if (region.forecast && region.forecast.startsWith("Erreur")) {
              html += `<div class="error">‚ùå Forecast: ${region.forecast}</div>`;
            } else if (region.forecast) {
              html += `<div class="ok">‚úÖ Forecast g√©n√©r√©</div>`;
            } else {
              html += `<div class="warn">‚ö†Ô∏è Forecast: Pas de donn√©es</div>`;
            }
            // Sources
            if (region.sources) {
              html += `<div>üì° Sources:<ul>`;
              for (const [src, val] of Object.entries(region.sources)) {
                if (val && val.error) {
                  html += `<li class="error">${src}: ${val.error}</li>`;
                } else {
                  html += `<li class="ok">${src}: OK</li>`;
                }
              }
              html += `</ul></div>`;
            }
            html += `</details></li>`;
          }
        }
        html += `</ul></details>`;
      }
      return html;
    }

    async function refreshEngine() {
      try {
        const res = await fetch("/api/engine-state");
        const data = await res.json();
        window._lastEngineState = data;
        document.getElementById("engineState").innerHTML = renderEngineState(data);
      } catch (err) {
        document.getElementById("engineState").textContent = "Erreur moteur: " + err;
      }
    }

    async function runGlobal() {
      document.getElementById("logsContent").textContent = "‚è≥ Lancement en cours...";
      await fetch("/api/run-global", { method: "POST" });
      await refreshLogs();
      await refreshEngine();
      await refreshChecklist();
    }

    function exportJSON() {
      const data = window._lastEngineState || {};
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "engine-state.json";
      a.click();
      URL.revokeObjectURL(url);
    }

    function copyJSON() {
      const data = window._lastEngineState || {};
      navigator.clipboard.writeText(JSON.stringify(data, null, 2));
      alert("JSON copi√© !");
    }

    // Auto refresh toutes les 20s
    setInterval(() => { refreshChecklist(); refreshLogs(); refreshEngine(); }, 20000);

    refreshChecklist();
    refreshLogs();
    refreshEngine();
  </script>
</body>
</html>
