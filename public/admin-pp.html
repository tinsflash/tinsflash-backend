<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Console Admin TINSFLASH</title>
  <style>
    body { font-family: Arial, sans-serif; background: #0d1117; color: #e6edf3; margin: 20px; }
    .card { background: #161b22; padding: 20px; margin-bottom: 20px; border-radius: 8px; }
    h1,h2 { color: #58a6ff; }
    .status { font-weight: bold; margin: 10px 0; }
    ul { list-style: none; padding: 0; }
    li { margin: 5px 0; }
    pre { background: #0d1117; color: #7ee787; padding: 10px; border-radius: 4px; max-height: 200px; overflow-y: auto; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #30363d; padding: 6px; }
    th { background: #21262d; color: #58a6ff; }
    tr:hover { background: #21262d; }
    .country { cursor: pointer; color: #7ee787; }
    .regions { display: none; background: #0d1117; }
  </style>
</head>
<body>
  <h1>âš¡ Centrale NuclÃ©aire MÃ©tÃ©o â€“ Console Admin</h1>

  <div class="card">
    <h2>RÃ©sumÃ© Moteur</h2>
    <div id="engineStatus" class="status">ðŸŸ  En attente</div>
    <ul>
      <li><b>Pays couverts :</b> <span id="countriesCount">0</span></li>
      <li><b>Points calculÃ©s :</b> <span id="pointsCount">0</span></li>
      <li><b>Points rÃ©ussis :</b> <span id="successCount">0</span></li>
    </ul>
  </div>

  <div class="card">
    <h2>DÃ©tail par pays</h2>
    <table>
      <thead>
        <tr>
          <th>Pays</th>
          <th>Nb rÃ©gions</th>
        </tr>
      </thead>
      <tbody id="countriesTable"></tbody>
    </table>
  </div>

  <div class="card">
    <h2>Logs</h2>
    <pre id="logs">Chargementâ€¦</pre>
  </div>

  <script>
    async function refreshEngineStatus() {
      try {
        const res = await fetch("/api/engine-state");
        const state = await res.json();

        // === Statut global ===
        const statusEl = document.getElementById("engineStatus");
        const status = state?.checkup?.engineStatus || "PENDING";
        if (status === "OK") statusEl.innerHTML = "ðŸŸ¢ OK";
        else if (status === "FAIL") statusEl.innerHTML = "ðŸ”´ FAIL";
        else statusEl.innerHTML = "ðŸŸ  En attente";

        // === RÃ©sumÃ© global ===
        if (state?.zonesCoveredSummary) {
          document.getElementById("countriesCount").innerText = state.zonesCoveredSummary.countries || 0;
          document.getElementById("pointsCount").innerText = state.zonesCoveredSummary.points || 0;
          document.getElementById("successCount").innerText = state.zonesCoveredSummary.success || 0;
        }

        // === DÃ©tail par pays ===
        const tableBody = document.getElementById("countriesTable");
        tableBody.innerHTML = "";
        if (state?.zonesCovered) {
          for (const [country, data] of Object.entries(state.zonesCovered)) {
            const tr = document.createElement("tr");
            tr.innerHTML = `
              <td class="country">${country}</td>
              <td>${data.regions.length}</td>
            `;
            tr.addEventListener("click", () => {
              let detailRow = tr.nextSibling;
              if (detailRow && detailRow.classList?.contains("regions")) {
                detailRow.style.display = detailRow.style.display === "none" ? "table-row" : "none";
              } else {
                detailRow = document.createElement("tr");
                detailRow.className = "regions";
                detailRow.style.display = "table-row";
                detailRow.innerHTML = `
                  <td colspan="2">
                    <ul>
                      ${data.regions.map(r => `<li><b>${r.region}</b> (lat:${r.lat}, lon:${r.lon})</li>`).join("")}
                    </ul>
                  </td>
                `;
                tr.parentNode.insertBefore(detailRow, tr.nextSibling);
              }
            });
            tableBody.appendChild(tr);
          }
        }
      } catch (err) {
        console.error("Erreur refreshEngineStatus:", err);
      }
    }

    async function refreshLogs() {
      try {
        const res = await fetch("/api/logs");
        const logs = await res.json();
        document.getElementById("logs").innerText = logs.join("\n");
      } catch (err) {
        console.error("Erreur refreshLogs:", err);
      }
    }

    setInterval(() => { refreshEngineStatus(); refreshLogs(); }, 5000);
    refreshEngineStatus(); refreshLogs();
  </script>
</body>
</html>
