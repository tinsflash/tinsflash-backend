<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="robots" content="noindex,nofollow" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ğŸ›°ï¸ Console IA J.E.A.N â€“ TINSFLASH</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    :root{--accent:#4fc3f7;--bg:#0b1220;--card:#0f1724;--muted:#9fbfce}
    body{margin:0;background:var(--bg);color:#e6f6ff;font-family:Inter,system-ui,Arial}
    header{background:linear-gradient(90deg,#08101f,#15294d);padding:14px;text-align:center;color:var(--accent);font-weight:700}
    nav{display:flex;gap:10px;justify-content:center;padding:10px;background:#0d1624}
    nav a{color:#cfefff;text-decoration:none;padding:8px 12px;border-radius:6px}
    nav a:hover{background:#0b2b3a}
    .container{max-width:1200px;margin:16px auto;padding:12px}
    .toolbar{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;margin-bottom:12px}
    button{background:var(--accent);color:#001;border:none;padding:10px 14px;border-radius:8px;cursor:pointer;font-weight:700}
    #fusionBtn{background:#f5b642;color:#000}
    .grid{display:grid;grid-template-columns:1fr 420px;gap:12px}
    .card{background:var(--card);padding:12px;border-radius:10px;box-shadow:0 6px 18px rgba(0,0,0,0.6)}
    #mapForecast,#mapAlerts{height:300px;border-radius:8px}
    #logs{height:220px;overflow:auto;background:#061119;padding:8px;border-radius:8px;font-family:monospace}
    .chat-panel{height:300px;display:flex;flex-direction:column}
    .chat-messages{flex:1;overflow:auto;padding:8px;background:#07131a;border-radius:8px;margin-bottom:8px}
    .chat-input{display:flex;gap:8px}
    input[type="text"]{flex:1;padding:10px;border-radius:8px;border:1px solid #123;background:#07121a;color:#e6f6ff}
    @media(max-width:920px){.grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
<script>
  const pin=sessionStorage.getItem("tinsflashPIN");
  if(!pin){
    const p=prompt("Code dâ€™accÃ¨s admin ?");
    if(p!=="202679"){alert("â›” AccÃ¨s refusÃ©");location.href="/";}
    else sessionStorage.setItem("tinsflashPIN","ok");
  }
</script>

<header>ğŸ›°ï¸ Console IA J.E.A.N â€“ TINSFLASH (Cockpit)</header>
<nav>
  <a href="/admin-pp.html">Console</a>
  <a href="/admin-alerts.html">Alertes</a>
  <a href="/admin-chat.html">Chat</a>
  <a href="/admin-radar.html">Radar</a>
  <a href="/admin-users.html">Utilisateurs</a>
  <a href="/admin-index.html">Index</a>
</nav>

<div class="container">
  <div class="toolbar">
    <button id="runBtn">âš™ï¸ Extraction</button>
    <button id="aiBtn">ğŸ§  Analyse IA J.E.A.N</button>
    <button id="fusionBtn">âš¡ Fusion & Diffusion</button>
    <button id="refreshBtn">ğŸ”„ RafraÃ®chir</button>
  </div>

  <div class="grid">
    <div>
      <div class="card">
        <h3>âš™ï¸ Ã‰tat du moteur</h3>
        <div><b>Statut :</b> <span id="engineStatus">â€”</span> | <b>Dernier run :</b> <span id="lastRun">â€”</span></div>
        <div><b>Alertes actives :</b> <span id="alertsCount">0</span></div>
      </div>
      <div class="card" style="margin-top:12px">
        <h3>ğŸŒ Carte prÃ©visions</h3><div id="mapForecast"></div>
      </div>
      <div class="card" style="margin-top:12px">
        <h3>ğŸŒ‹ Carte alertes</h3><div id="mapAlerts"></div>
      </div>
    </div>

    <div>
      <div class="card">
        <h3>ğŸ“œ Logs moteur</h3><div id="logs">Connexionâ€¦</div>
      </div>

      <div class="card" style="margin-top:12px">
        <h3>ğŸ’¬ Chat console (GPT-4o-mini)</h3>
        <div class="chat-panel">
          <div class="chat-messages" id="chatMessages"><div style="color:#9ad6ff">ğŸ¤– J.E.A.N prÃªt</div></div>
          <div class="chat-input">
            <input type="text" id="chatInput" placeholder="Pose ta questionâ€¦" />
            <button id="sendChat">Envoyer</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
const API=location.origin;
const mapF=L.map("mapForecast").setView([20,0],2);
const mapA=L.map("mapAlerts").setView([20,0],2);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(mapF);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(mapA);
let fMarks=[],aMarks=[];

async function getJSON(u){try{const r=await fetch(u);return r.ok?await r.json():null}catch{return null}}

async function updateStatus(){
  const d=await getJSON(API+"/api/status");if(!d)return;
  engineStatus.textContent=d.status||"â€”";
  lastRun.textContent=d.lastRun?new Date(d.lastRun).toLocaleString():"Jamais";
  alertsCount.textContent=(d.alerts||[]).length;
  fMarks.forEach(m=>mapF.removeLayer(m));aMarks.forEach(m=>mapA.removeLayer(m));fMarks=[];aMarks=[];
  (d.coveredZones||[]).slice(0,500).forEach(p=>fMarks.push(L.circleMarker([p.lat,p.lon],{radius:4,color:"#4caf50"}).addTo(mapF)));
  (d.alerts||[]).forEach(a=>{
    const c=a.certainty||0;
    const col=c>=90?"#00ff80":c>=70?"#ffc107":"#ff7043";
    aMarks.push(L.circleMarker([a.geo?.lat||0,a.geo?.lon||0],{radius:5,color:col}).addTo(mapA)
      .bindPopup(`<b>${a.zone}</b><br>${a.title}<br>${c}%`));
  });
}

const es=new EventSource(API+"/api/logs/stream");
es.onmessage=e=>{
  try{const d=JSON.parse(e.data);
    const line=document.createElement("div");
    line.textContent=`[${new Date(d.timestamp||Date.now()).toLocaleTimeString()}] ${d.message}`;
    logs.appendChild(line);logs.scrollTop=logs.scrollHeight;
  }catch{}
};

runBtn.onclick=async()=>{await fetch(API+"/api/run-global",{method:"POST"});updateStatus()};
aiBtn.onclick=async()=>{await fetch(API+"/api/ai-analyse",{method:"POST"});updateStatus()};
refreshBtn.onclick=updateStatus;

// âš¡ Fusion complÃ¨te : extraction + IA + push
fusionBtn.onclick=async()=>{
  if(!confirm("âš¡ Lancer la Fusion complÃ¨te ?"))return;
  try{
    logs.innerHTML+="<div>âš™ï¸ Fusion en coursâ€¦</div>";
    await fetch(API+"/api/run-global",{method:"POST"});
    await fetch(API+"/api/ai-analyse",{method:"POST"});
    await fetch(API+"/api/push/broadcast",{method:"POST"});
    logs.innerHTML+="<div>âœ… Fusion & Diffusion terminÃ©es !</div>";
  }catch(e){
    logs.innerHTML+=`<div>âŒ Erreur Fusion : ${e.message}</div>`;
  }
  updateStatus();
};

sendChat.onclick=async()=>{
  const txt=chatInput.value.trim();if(!txt)return;
  chatMessages.innerHTML+=`<div style='color:#9ad6ff'>Vous : ${txt}</div>`;
  chatInput.value="";
  const r=await fetch(API+"/api/ai-admin",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({message:txt,mode:"moteur"})});
  const j=await r.json();
  chatMessages.innerHTML+=`<div style='color:#b2f5c9'>J.E.A.N : ${j.reply}</div>`;
  chatMessages.scrollTop=chatMessages.scrollHeight;
};
updateStatus();setInterval(updateStatus,15000);
</script>
</body>
</html>
