<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>TINSFLASH Console Admin</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
  <style>
    body { background:#0d1117; color:#eee; }
    .nav-link.active { background:#21262d; border-radius:6px; }
    pre { background:#161b22; padding:10px; border-radius:6px; color:#0f0; max-height:250px; overflow:auto; }
    iframe { width:100%; height:600px; border:none; }
  </style>
</head>
<body>
<div class="container-fluid">
  <h1 class="my-3">‚ö° Centrale Nucl√©aire M√©t√©o ‚Äî Console Admin</h1>

  <!-- Menu principal -->
  <ul class="nav nav-tabs" id="adminMenu">
    <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#dashboard">Tableau de bord</a></li>
    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#alerts">Alertes</a></li>
    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#simulate">Vue utilisateur</a></li>
    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#news">Actualit√©s</a></li>
    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#radar">Radar</a></li>
    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#ai">IA</a></li>
  </ul>

  <div class="tab-content p-3 bg-dark border rounded-bottom">
    <!-- DASHBOARD -->
    <div class="tab-pane fade show active" id="dashboard">
      <button class="btn btn-danger my-2" onclick="runGlobal()">üöÄ Lancer RUN GLOBAL</button>
      <button class="btn btn-warning my-2" onclick="runContinental()">üåç Lancer RUN CONTINENTAL</button>

      <h4>√âtat moteur</h4>
      <pre id="engineState">Chargement...</pre>

      <h4>Logs r√©cents</h4>
      <pre id="logs">Chargement...</pre>
    </div>

    <!-- ALERTS -->
    <div class="tab-pane fade" id="alerts">
      <h4>Alertes Publi√©es</h4>
      <div id="alerts-published"></div>
      <h4>√Ä Valider (70‚Äì90%)</h4>
      <div id="alerts-validate"></div>
      <h4>En Attente / Expert</h4>
      <div id="alerts-other"></div>
    </div>

    <!-- VUE UTILISATEUR -->
    <div class="tab-pane fade" id="simulate">
      <h4>Simulation vue utilisateur</h4>
      <form class="row g-2" onsubmit="simulateUser(event)">
        <div class="col-md-6"><input id="city" class="form-control" placeholder="Ville"></div>
        <div class="col-md-4">
          <select id="country" class="form-select">
            <option value="BE">Belgique</option>
            <option value="FR">France</option>
            <option value="US">USA</option>
            <option value="BR">Br√©sil</option>
            <option value="IN">Inde</option>
            <option value="CN">Chine</option>
          </select>
        </div>
        <div class="col-md-2"><button class="btn btn-primary">Voir</button></div>
      </form>
      <div id="simulate-result" class="mt-3"></div>
    </div>

    <!-- ACTUALIT√âS -->
    <div class="tab-pane fade" id="news">
      <h4>Actualit√©s m√©t√©o & climat</h4>
      <div id="news-list">Chargement...</div>
    </div>

    <!-- RADAR -->
    <div class="tab-pane fade" id="radar">
      <h4>Radar M√©t√©o (Windy)</h4>
      <iframe src="https://embed.windy.com/embed2.html?lat=50&lon=4&detailLat=50&detailLon=4&zoom=5&level=surface&overlay=rain&product=ecmwf"></iframe>
    </div>

    <!-- IA -->
    <div class="tab-pane fade" id="ai">
      <h4>Discussion avec IA (moteur interne)</h4>
      <textarea id="aiInput" class="form-control" rows="3"></textarea>
      <button class="btn btn-success my-2" onclick="askAI()">Envoyer</button>
      <pre id="aiReply"></pre>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
let cache = { engine:null, logs:null, alerts:null, news:null };

// Dashboard refresh
async function refreshDashboard(){
  const s = await fetch("/api/engine-state").then(r=>r.json());
  document.getElementById("engineState").textContent = JSON.stringify(s.state,null,2);
  cache.engine = s.state;

  const l = await fetch("/api/logs").then(r=>r.json());
  document.getElementById("logs").textContent = JSON.stringify(l.logs,null,2);
  cache.logs = l.logs;
}

// Runs
async function runGlobal(){ await fetch("/api/run-global",{method:"POST"}); refreshDashboard(); loadAlerts(); }
async function runContinental(){ await fetch("/api/run-continental",{method:"POST"}); loadAlerts(); }

// Alerts
async function loadAlerts(){
  const a = await fetch("/api/alerts").then(r=>r.json());
  cache.alerts = a.alerts;
  renderAlerts();
}
function renderAlerts(){
  const p=document.getElementById("alerts-published");
  const v=document.getElementById("alerts-validate");
  const o=document.getElementById("alerts-other");
  p.innerHTML=v.innerHTML=o.innerHTML="";
  cache.alerts.published.forEach(x=>p.innerHTML+=`<div class="alert alert-danger">${x.country||x.continent}: ${x.message} (${x.confidence}%)</div>`);
  cache.alerts.toValidate.forEach(x=>v.innerHTML+=`<div class="alert alert-warning">${x.country||x.continent}: ${x.message} (${x.confidence}%) <button class="btn btn-sm btn-success" onclick="updateAlert('${x.createdAt+x.type}','validate')">Valider</button></div>`);
  [...cache.alerts.expert,...cache.alerts.pending].forEach(x=>o.innerHTML+=`<div class="alert alert-info">${x.country||x.continent}: ${x.message} (${x.confidence}%)</div>`);
}
async function updateAlert(id,action){
  await fetch("/api/alerts/"+id+"/"+action,{method:"POST"});
  loadAlerts();
}

// Simulate user
async function simulateUser(e){
  e.preventDefault();
  const city=document.getElementById("city").value;
  const country=document.getElementById("country").value;
  const res=await fetch("/api/chat",{method:"POST",headers:{'Content-Type':'application/json'},body:JSON.stringify({message:`M√©t√©o √† ${city}`,country})}).then(r=>r.json());
  document.getElementById("simulate-result").innerHTML="<pre>"+JSON.stringify(res.response,null,2)+"</pre>";
}

// News
async function loadNews(){
  const n=await fetch("/api/news").then(r=>r.json());
  cache.news=n;
  document.getElementById("news-list").innerHTML=n.map(x=>`<div class="border p-2 my-1">${x.title}</div>`).join("");
}

// AI
async function askAI(){
  const msg=document.getElementById("aiInput").value;
  const res=await fetch("/api/chat",{method:"POST",headers:{'Content-Type':'application/json'},body:JSON.stringify({message:msg})}).then(r=>r.json());
  document.getElementById("aiReply").textContent=JSON.stringify(res.response,null,2);
}

// Initial load
refreshDashboard(); loadAlerts(); loadNews();
</script>
</body>
</html>
