<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Console TINSFLASH – Centrale Nucléaire Météo</title>
  <style>
    body { font-family: Arial, sans-serif; margin:0; background:#111; color:#eee; }
    nav { background:#222; padding:10px; display:flex; gap:15px; }
    nav a { color:#fff; text-decoration:none; padding:8px 12px; background:#333; border-radius:5px; }
    nav a:hover { background:#555; }
    section { padding:20px; }
    h2 { margin-top:0; color:#4af; }
    textarea { width:100%; min-height:80px; resize:vertical; padding:10px; font-size:14px; }
    button { padding:8px 12px; background:#4af; border:none; border-radius:5px; cursor:pointer; color:#fff; margin-top:8px; }
    button:hover { background:#6cf; }
    .alert-box { border:1px solid #444; padding:10px; margin:10px 0; border-radius:5px; }
    .alert-published { border-left:5px solid #0f0; }
    .alert-tovalidate { border-left:5px solid #ff0; }
    .alert-waiting { border-left:5px solid #09f; }
    .alert-ignored { border-left:5px solid #555; }
  </style>
</head>
<body>

  <nav>
    <a href="#dashboard">🏠 Dashboard</a>
    <a href="#alerts">⚠️ Alertes</a>
    <a href="#news">📰 Actualités</a>
    <a href="#user-view">🌍 Vue Utilisateur</a>
    <a href="#chat">🤖 IA Chat</a>
  </nav>

  <section id="dashboard">
    <h2>⚡ Contrôle moteur</h2>
    <button onclick="runGlobal()">RUN Global</button>
    <button onclick="runContinental()">RUN Continental</button>
    <h3>Logs</h3>
    <pre id="logs"></pre>
    <h3>Erreurs</h3>
    <pre id="errors"></pre>
  </section>

  <section id="alerts">
    <h2>⚠️ Alertes</h2>
    <div>
      <button onclick="loadAlerts('published')">✔ Publiées</button>
      <button onclick="loadAlerts('toValidate')">❓ À valider</button>
      <button onclick="loadAlerts('waiting')">⏳ En attente</button>
      <button onclick="loadAlerts('ignored')">🚫 Ignorées</button>
      <button onclick="loadAlerts('all')">🌍 Mondiales</button>
    </div>
    <div id="alertsList"></div>
  </section>

  <section id="news">
    <h2>📰 Actualités météo & climat</h2>
    <div id="newsContent">Chargement...</div>
  </section>

  <section id="user-view">
    <h2>🌍 Vue Utilisateur</h2>
    <p>Simuler la page index depuis une ville/pays :</p>
    <input id="city" placeholder="Ville" />
    <select id="country">
      <option>France</option>
      <option>Belgium</option>
      <option>USA</option>
      <option>Germany</option>
      <option>Other...</option>
    </select>
    <button onclick="simulateUser()">Voir simulation</button>
    <iframe id="userFrame" style="width:100%; height:600px; border:1px solid #444; margin-top:10px;"></iframe>
  </section>

  <section id="chat">
    <h2>🤖 IA Météo (moteur nucléaire)</h2>
    <textarea id="chatInput" placeholder="Pose ta question sur les runs, alertes, prévisions..."></textarea>
    <button onclick="askAI()">Envoyer</button>
    <pre id="chatOutput"></pre>
  </section>

<script>
async function runGlobal() {
  const res = await fetch("/api/run-global", { method:"POST" });
  const data = await res.json();
  alert("RUN Global terminé");
  loadLogs();
}
async function runContinental() {
  const res = await fetch("/api/run-continental", { method:"POST" });
  const data = await res.json();
  alert("RUN Continental terminé");
  loadLogs();
}
async function loadLogs() {
  const res = await fetch("/api/logs");
  const data = await res.json();
  document.getElementById("logs").innerText = JSON.stringify(data, null, 2);
}
async function loadAlerts(bucket) {
  const res = await fetch("/api/alerts");
  const data = await res.json();
  let alerts = [];
  if(bucket==="all") {
    alerts = [...data.alerts.published, ...data.alerts.toValidate, ...data.alerts.waiting];
  } else {
    alerts = data.alerts[bucket] || [];
  }
  const container = document.getElementById("alertsList");
  container.innerHTML = alerts.map(a => `
    <div class="alert-box alert-${a.status}">
      <b>${a.zoneName}</b> (${a.zoneType})<br/>
      ${a.description}<br/>
      Fiabilité: ${a.reliability}%<br/>
      Détection: ${a.firstDetected ? "🟢 Première" : "⚪ Déjà signalée"}
    </div>
  `).join("");
}
async function askAI() {
  const msg = document.getElementById("chatInput").value;
  const res = await fetch("/api/chat", { method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify({ message: msg }) });
  const data = await res.json();
  document.getElementById("chatOutput").innerText = data.reply || JSON.stringify(data, null, 2);
}
function simulateUser() {
  const city = document.getElementById("city").value;
  const country = document.getElementById("country").value;
  document.getElementById("userFrame").src = `/index.html?city=${encodeURIComponent(city)}&country=${encodeURIComponent(country)}`;
}
loadLogs();
</script>

</body>
</html>
