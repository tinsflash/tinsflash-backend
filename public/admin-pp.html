<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<meta name="robots" content="noindex,nofollow"/>
<title>🚀 TINSFLASH PRO+++ • Cockpit Administrateur</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<style>
body{margin:0;background:#020b17;color:#e8f6ff;font-family:"Segoe UI",sans-serif;display:flex;min-height:100vh;}
nav{width:230px;background:#001027;flex-shrink:0;display:flex;flex-direction:column;padding:16px 0;border-right:1px solid #093c60;}
nav h1{color:#4fc3f7;text-align:center;margin:0 0 16px 0;font-size:1.1em;}
nav a{color:#aeeaff;text-decoration:none;padding:10px 20px;display:block;transition:.2s;}
nav a:hover{background:#032347;color:#fff;}
nav .active{background:#4fc3f7;color:#000;}
main{flex:1;padding:16px;overflow-y:auto;}
header{background:#001027;text-align:center;padding:14px;color:#4fc3f7;
font-size:1.5em;text-shadow:0 0 10px #4fc3f7,0 0 20px #0288d1;margin-bottom:10px;border-radius:8px;}
h2{color:#4fc3f7;border-left:4px solid #4fc3f7;padding-left:10px;margin-top:30px;}
button{background:#071d34;color:#4fc3f7;border:1px solid #4fc3f7;
padding:10px;margin:6px;border-radius:10px;font-weight:bold;cursor:pointer;
display:flex;align-items:center;gap:6px;justify-content:center;transition:.2s;}
button:hover{background:#4fc3f7;color:#000;}
.btn-active{background:#22c55e;color:#000!important;animation:blink 1s infinite alternate;}
@keyframes blink{from{opacity:1;}to{opacity:.5;}}
.status-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:10px;}
.light{width:14px;height:14px;border-radius:50%;display:inline-block;margin-right:6px;}
.ok{background:#00ff88;box-shadow:0 0 8px #00ff88;}
.warn{background:#ffaa00;box-shadow:0 0 8px #ffaa00;}
.err{background:#ff4444;box-shadow:0 0 8px #ff4444;}
.idle{background:#555;}
.map{height:280px;margin-top:10px;border-radius:10px;overflow:hidden;}
.logs{background:#081527;border-radius:10px;padding:10px;height:340px;overflow-y:auto;
font-family:monospace;font-size:13px;white-space:pre-wrap;border:1px solid #093c60;}
.shell{color:#4fc3f7;font-size:12px;margin-top:2px;font-family:monospace;opacity:0.7;}
footer{text-align:center;font-size:13px;color:#555;margin:30px 0;}
</style>
</head>
<body>

<script>
if(!sessionStorage.getItem("tinsflashPIN")){
 const p=prompt("Code d’accès admin ?");
 if(p!=="202679"){alert("Accès refusé");location.href="/";}
 else sessionStorage.setItem("tinsflashPIN","ok");
}
</script>

<nav>
  <h1>🛰️ TINSFLASH PRO+++<br/>Menu Admin</h1>
  <a href="/admin-pp.html" class="active">🏠 Tableau principal</a>
  <a href="/admin-alerts.html">🚨 Alertes</a>
  <a href="/admin-radar.html">🌦️ Radar IA</a>
  <a href="/admin-news.html">📰 Actualités</a>
  <a href="/admin-users.html">👥 Utilisateurs</a>
  <a href="/admin-chat.html">💬 Chat IA</a>
  <a href="/cockpit.html">🧠 Cockpit Standard</a>
  <a href="/cockpit-pro.html">🚀 Cockpit Pro</a>
  <a href="/cockpit-proplus.html">💎 Pro+</a>
  <a href="/premium.html">⭐ Premium</a>
  <a href="/provincenamur.html">📍 Province Namur</a>
  <a href="/">↩️ Accueil public</a>
</nav>

<main>
<header>COCKPIT ADMINISTRATEUR – IA J.E.A.N. – Moteur Central</header>

<h2>⚙️ Extraction – Zones couvertes</h2>
<div class="status-grid">
  <div><button onclick="run('global-europe')">🇪🇺 Europe</button></div>
  <div><button onclick="run('global-usa')">🇺🇸 USA / 🇨🇦 Canada</button></div>
  <div><button onclick="run('afrique')">🌍 Afrique</button></div>
  <div><button onclick="run('asie')">🌏 Asie</button></div>
  <div><button onclick="run('oceanie')">🌊 Océanie</button></div>
  <div><button onclick="run('ameriquesud')">🌎 Amérique Sud</button></div>
  <div><button onclick="run('belgique')">🇧🇪 Belgique</button></div>
  <div><button onclick="run('bouke')">📺 Bouké (Namur)</button></div>
</div>

<h2>🧠 IA & Alertes</h2>
<div class="status-grid">
  <div><button onclick="runAI()">🤖 Analyse IA J.E.A.N.</button></div>
  <div><button onclick="runAIExternal()">🧩 IA Externes (GraphCast / Pangu / CorrDiff / NowcastNet)</button></div>
  <div><button onclick="runAlerts()">🚨 Fusion alertes</button></div>
  <div><button onclick="checkStatus()">🔍 Vérifier moteur</button></div>
</div>

<h2>📊 État du moteur</h2>
<div id="status" class="status-grid">
  <div><span class="light idle" id="lightEngine"></span>Moteur principal</div>
  <div><span class="light idle" id="lightIA"></span>IA J.E.A.N.</div>
  <div><span class="light idle" id="lightIAext"></span>IA Externes</div>
  <div><span class="light idle" id="lightAlerts"></span>Alertes</div>
  <div><span class="light idle" id="lightDB"></span>MongoDB</div>
</div>

<h2>🌍 Cartes – Prévisions & Alertes</h2>
<div id="mapForecast" class="map"></div>
<div id="mapAlerts" class="map"></div>

<h2>📜 Logs en direct</h2>
<div id="logs" class="logs">Connexion en cours...</div>

<footer>© 2025 – Centrale Météo IA TINSFLASH PRO+++ • Moteur J.E.A.N.</footer>
</main>

<script>
const logs=document.getElementById("logs");
function addLog(msg){const line=`${new Date().toLocaleTimeString()} ${msg}`;logs.textContent+="\n"+line;logs.scrollTop=logs.scrollHeight;}
function setLight(id,state){const e=document.getElementById(id);e.className="light "+state;}

// ======================================================
// 🔘 RUN Zones
// ======================================================
async function run(zone){
 event.target.classList.add("btn-active");
 addLog(`▶️ Lancement run-${zone}...`);
 try{
   const res=await fetch(`/api/run-${zone}`,{method:"POST"});
   const j=await res.json();
   if(j.success){addLog(`✅ Run ${zone} terminé`);setLight("lightEngine","ok");}
   else{addLog(`⚠️ Erreur ${zone}: ${j.error}`);setLight("lightEngine","warn");}
 }catch(e){addLog(`❌ Crash ${zone}: ${e.message}`);setLight("lightEngine","err");}
 event.target.classList.remove("btn-active");
 checkStatus();
}

// ======================================================
// 🧠 IA / IA Externes / Alertes
// ======================================================
async function runAI(){
 try{
   const r=await fetch("/api/runAI",{method:"POST"});
   if(r.ok){addLog("🧠 IA J.E.A.N. activée.");setLight("lightIA","ok");}
   else addLog("⚠️ Erreur activation IA.");
 }catch(e){addLog("❌ Crash IA: "+e.message);}
}

async function runAIExternal(){
 try{
   addLog("🧩 Démarrage IA externes (phase 3)...");
   const r=await fetch("/api/runAIExternal",{method:"POST"});
   const j=await r.json();
   if(j.success){
     addLog("✅ IA externes terminées : "+(j.result?.synthese||"ok"));
     setLight("lightIAext","ok");
   }else{
     addLog("⚠️ Échec IA externes : "+j.error);
     setLight("lightIAext","warn");
   }
 }catch(e){
   addLog("❌ Crash IA externes: "+e.message);
   setLight("lightIAext","err");
 }
}

async function runAlerts(){
 try{
   const r=await fetch("/api/runWorldAlerts",{method:"POST"});
   if(r.ok){addLog("🚨 Fusion alertes terminée.");setLight("lightAlerts","ok");}
   else addLog("⚠️ Erreur fusion alertes.");
 }catch(e){addLog("❌ Crash Alertes: "+e.message);}
}

// ======================================================
// 🛰️ STATUS CHECK
// ======================================================
async function checkStatus(){
 try{
   const r=await fetch("/api/status");
   if(!r.ok) throw new Error("Status HTTP "+r.status);
   const s=await r.json();
   addLog("ℹ️ État moteur : "+JSON.stringify(s));
   setLight("lightEngine",s.status==="RUN_OK"?"ok":"warn");
   setLight("lightDB",s.db==="connected"?"ok":"err");
   if(s.checkup?.iaActive)setLight("lightIA","ok");
   if(s.checkup?.alerts)setLight("lightAlerts","ok");
 }catch(e){addLog("❌ Erreur /api/status : "+e.message);}
}

// ======================================================
// 🛰️ LOGS LIVE (SSE)
// ======================================================
const evt=new EventSource("/api/logs");
evt.onmessage=e=>{
 try{const log=JSON.parse(e.data);addLog(log.message||e.data);}
 catch{addLog(e.data);}
};

// ======================================================
// 🌍 CARTES
// ======================================================
const mapF=L.map("mapForecast").setView([50,4],6);
const mapA=L.map("mapAlerts").setView([20,0],2);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(mapF);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(mapA);

async function loadForecasts(){
 try{
   const r=await fetch("/api/forecast?lat=50&lon=4");
   const d=await r.json();
   L.marker([d.lat||50,d.lon||4])
     .addTo(mapF)
     .bindPopup(`Température : ${d.temperature||'--'}°C<br>${d.condition||''}`);
 }catch(e){addLog("⚠️ Erreur loadForecasts: "+e.message);}
}
async function loadAlerts(){
 try{
   const r=await fetch("/api/alerts");
   const a=await r.json();
   a.forEach(x=>{
     if(x.lat&&x.lon)L.circle([x.lat,x.lon],{radius:60000,color:"red"})
       .addTo(mapA).bindPopup(`<b>${x.title||"Alerte"}</b><br>${x.zone||''}`);
   });
 }catch(e){addLog("⚠️ Erreur loadAlerts: "+e.message);}
}
loadForecasts();loadAlerts();
</script>
</body>
</html>
