<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="robots" content="noindex,nofollow">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‚ö° Console Admin ‚Äî Centrale M√©t√©o Mondiale</title>
  <style>
    body { font-family: Arial, sans-serif; background:#0d1117; color:#e6edf3; margin:0; }
    header { background:#111; padding:12px; text-align:center; font-size:22px; font-weight:bold; color:#0af; }
    nav { background:#1c1f26; padding:10px; text-align:center; }
    nav a { color:#0af; margin:0 12px; text-decoration:none; }
    h2, h3 { margin:15px 0 10px; color:#0af; }
    .grid { display:grid; grid-template-columns: repeat(auto-fill,minmax(200px,1fr)); gap:10px; margin:10px 0; }
    .zone { background:#161b22; border-radius:6px; padding:10px; }
    button { margin:6px 0; padding:8px 12px; border:none; border-radius:6px; cursor:pointer; background:#0af; color:#000; font-weight:bold; }
    .status-ball { width:14px; height:14px; border-radius:50%; display:inline-block; margin-right:6px; }
    .status-ball.pending { background:#cc0; }
    .status-ball.ok { background:#2a2; }
    .status-ball.fail { background:#a22; }
    #logs { background:#000; color:#eee; font-family:monospace; padding:10px; height:250px; overflow-y:auto; border-radius:8px; margin-top:10px; white-space:pre-wrap; }
    .info { color:#0af; }
    .warn { color:#cc0; }
    .error { color:#f55; }
    #chatButton { position:fixed; bottom:20px; right:20px; width:60px; height:60px; border-radius:50%; background:#0af; color:#fff; font-size:22px; font-weight:bold; border:none; cursor:pointer; }
    #chatBubble { position:fixed; bottom:90px; right:20px; width:320px; height:420px; background:#161b22; border:2px solid #0af; border-radius:10px; display:none; flex-direction:column; }
    #chatBubble header { padding:8px; font-weight:bold; text-align:center; color:#0af; }
    #chatLog { flex:1; overflow-y:auto; padding:8px; background:#0d1117; border-radius:6px; }
    #chatInput { display:flex; }
    #chatInput input { flex:1; padding:6px; border:none; border-radius:6px; }
    #chatInput button { padding:6px 10px; background:#0af; border:none; border-radius:6px; cursor:pointer; }
    #runStatus { display:none; position:fixed; top:0; left:0; width:100%; padding:12px; text-align:center; font-weight:bold; font-size:18px; background:#111; color:#fff; z-index:9999; }
    .country-row { display:flex; align-items:center; justify-content:space-between; background:#161b22; padding:6px 10px; margin:4px 0; border-radius:6px; }
    .country-name { font-weight:bold; }
  </style>
</head>
<body>
<script>
  const pass = prompt("Code d'acc√®s ?");
  if (pass !== "202679") {
    document.body.innerHTML = "<h1 style='color:red;text-align:center;'>‚õî Acc√®s refus√©</h1>";
    throw new Error("Acc√®s refus√©");
  }
</script>

<header>‚ö° Centrale M√©t√©o Mondiale ‚Äî Console Admin</header>
<nav>
  <a href="/admin">Console</a>
  <a href="/admin-alerts">Alertes</a>
  <a href="/admin-chat">Chat IA</a>
  <a href="/admin-index">Vue Index</a>
  <a href="/admin-radar">Radar & News</a>
  <a href="/admin-users">Utilisateurs</a>
</nav>

<div id="runStatus"></div>

<main style="padding:20px;">
  <h2>üõ∞Ô∏è Cockpit Global</h2>

  <h3>üìä Pr√©visions zones couvertes</h3>
  <button onclick="runGlobalForecasts()">‚ñ∂Ô∏è Lancer Pr√©visions</button>

  <h3>üö® Alertes zones couvertes</h3>
  <button onclick="runGlobalAlerts()">‚ñ∂Ô∏è Lancer Alertes</button>

  <h3>üåç Alertes continentales</h3>
  <button onclick="runContinentalAlerts()">‚ñ∂Ô∏è Lancer Continental</button>

  <h3>ü§ñ Fusion & Orchestration IA</h3>
  <div id="fusion-ia" class="zone">
    <span class="status-ball pending"></span> Orchestration Globale
  </div>
  <button onclick="runFusion()">‚ñ∂Ô∏è Finalisation</button>

  <h2>üìú Logs moteur (live)</h2>
  <div id="logs">Connexion en cours‚Ä¶</div>

  <h2>üõ∞Ô∏è Pompage des mod√®les</h2>
  <div id="models-status" class="grid"></div>

  <h2>‚ö° √âtapes du moteur</h2>
  <div id="engine-steps" class="grid"></div>

  <h2>üåç Supervision par pays</h2>
  <div id="zones-status" style="display:grid; grid-template-columns:1fr 1fr; gap:20px;">
    <div>
      <h3>üìä Pr√©visions</h3>
      <div id="forecast-countries"></div>
    </div>
    <div>
      <h3>üö® Alertes</h3>
      <div id="alert-countries"></div>
    </div>
  </div>
</main>

<!-- Chat bulle -->
<button id="chatButton" onclick="toggleChat()">üí¨</button>
<div id="chatBubble">
  <header>ü§ñ Chat IA Moteur</header>
  <div id="chatLog"></div>
  <div id="chatInput">
    <input type="text" id="chatMsg" placeholder="Demander au moteur..." onkeypress="if(event.key==='Enter') sendChat()">
    <button onclick="sendChat()">Envoyer</button>
  </div>
</div>

<script>
  // Bandeau visuel
  function showRunStatus(msg, color){
    const bar=document.getElementById("runStatus");
    bar.style.display="block"; bar.style.background=color; bar.innerText=msg;
    setTimeout(()=>{ bar.style.display="none"; },8000);
  }

  // Zones
  const zonesSupervision = ["France","Belgique","Allemagne","Espagne","Italie","√âtats-Unis","Canada","Afrique","Asie","Oc√©anie","Am√©rique du Sud"];
  function buildCountriesStatus(){
    const f=document.getElementById("forecast-countries");
    const a=document.getElementById("alert-countries");
    f.innerHTML=""; a.innerHTML="";
    zonesSupervision.forEach(z=>{
      f.innerHTML+=`<div id="forecast-${z}" class="country-row"><span class="country-name">${z}</span><span class="status-ball pending"></span></div>`;
      a.innerHTML+=`<div id="alert-${z}" class="country-row"><span class="country-name">${z}</span><span class="status-ball pending"></span></div>`;
    });
  }
  buildCountriesStatus();

  function setStatus(zone,state){
    const el=document.querySelector(`#${zone} .status-ball`);
    if(el) el.className="status-ball "+state;
  }

  // Models
  const models = ["ECMWF","GFS","ICON","Meteomatics","Copernicus ERA5","NOAA","NASA POWER","OpenWeather"];
  function buildModels(){
    const m=document.getElementById("models-status"); m.innerHTML="";
    models.forEach(md=>{
      m.innerHTML+=`<div id="model-${md}" class="zone"><span class="status-ball pending"></span>${md}</div>`;
    });
  }
  buildModels();

  // Steps
  const steps = ["Pompage des mod√®les","Analyse relief & climat","Pr√©visions zones couvertes","Alertes zones couvertes","Alertes continentales","Fusion IA alertes & pr√©visions","D√©ploiement final"];
  function buildEngineSteps(){
    const s=document.getElementById("engine-steps"); s.innerHTML="";
    steps.forEach(st=>{
      const safeId=st.replace(/\s+/g,"-");
      s.innerHTML+=`<div id="step-${safeId}" class="zone"><span class="status-ball pending"></span> ${st}</div>`;
    });
  }
  buildEngineSteps();

  function setStatusDynamic(type,zone,state){
    const safeId = zone.replace(/\s+/g,"-");
    const el=document.querySelector(`#${type}-${safeId} .status-ball`);
    if(el) el.className="status-ball "+state;
  }

  // Refresh details
  async function refreshEngineDetails(){
    try {
      const res = await fetch("/api/checkup");
      const data = await res.json();
      if(data.models){ Object.entries(data.models).forEach(([m,s])=>setStatusDynamic("model",m,s)); }
      if(data.steps){ Object.entries(data.steps).forEach(([st,s])=>setStatusDynamic("step",st,s)); }
    } catch(e){ console.warn("Erreur refreshEngineDetails:", e.message); }
  }
  setInterval(refreshEngineDetails,10000);

  // Logs live
  const logDiv=document.getElementById("logs");
  const evt=new EventSource("/api/logs/stream");
  evt.onmessage=(e)=>{
    const log=JSON.parse(e.data);
    let cls="info"; if(log.message.includes("ERROR")) cls="error"; if(log.message.includes("WARN")) cls="warn";
    logDiv.innerHTML+=`<div class="${cls}">[${new Date(log.ts).toLocaleTimeString()}] ${log.message}</div>`;
    logDiv.scrollTop=logDiv.scrollHeight;
  };

  // Runs
  async function runGlobalForecasts(){ showRunStatus("‚ñ∂Ô∏è Pr√©visions en cours...","#cc0"); await fetch("/api/run-global",{method:"POST"}); }
  async function runGlobalAlerts(){ showRunStatus("‚ñ∂Ô∏è Alertes en cours...","#cc0"); await fetch("/api/run-alerts",{method:"POST"}); }
  async function runContinentalAlerts(){ showRunStatus("‚ñ∂Ô∏è Continental en cours...","#cc0"); await fetch("/api/run-alerts-continental",{method:"POST"}); }
  async function runFusion(){ showRunStatus("‚ñ∂Ô∏è Fusion IA en cours...","#cc0"); await fetch("/api/run-orchestrator",{method:"POST"}); }

  // Chat IA
  function toggleChat(){ const c=document.getElementById("chatBubble"); c.style.display=c.style.display==="flex"?"none":"flex"; }
  async function sendChat(){
    const input=document.getElementById("chatMsg"); const msg=input.value.trim(); if(!msg) return;
    const log=document.getElementById("chatLog"); log.innerHTML+=`<div><b>Moi:</b> ${msg}</div>`; input.value="";
    const res=await fetch("/api/chat/engine",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({message:msg})});
    const data=await res.json(); log.innerHTML+=`<div><b>Moteur:</b> ${data.reply}</div>`; log.scrollTop=log.scrollHeight;
  }
</script>
</body>
</html>
