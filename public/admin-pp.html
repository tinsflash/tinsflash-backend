<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Console Admin — Centrale Nucléaire Météo</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <style>
    body { background:#0b0f1a; color:#eee; }
    .navbar { background:#111; }
    .tab-content { margin-top:20px; }
    pre { background:#111; color:#0f0; padding:10px; border-radius:8px; max-height:400px; overflow:auto; }
  </style>
</head>
<body>
<nav class="navbar navbar-dark">
  <div class="container-fluid">
    <a class="navbar-brand" href="#">⚡ Centrale Nucléaire Météo</a>
  </div>
</nav>

<div class="container mt-4">
  <ul class="nav nav-tabs" id="adminTabs">
    <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#dashboard">Dashboard</button></li>
    <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#alerts">Alertes publiées</button></li>
    <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#alertsPending">Alertes à valider</button></li>
    <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#news">Actualités</button></li>
    <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#userView">Vue Utilisateur</button></li>
  </ul>

  <div class="tab-content">
    <!-- Dashboard -->
    <div class="tab-pane fade show active" id="dashboard">
      <h3>🚀 Lancer le moteur</h3>
      <button class="btn btn-danger" id="runGlobal">RUN GLOBAL</button>
      <button class="btn btn-warning" id="runContinental">RUN CONTINENTAL</button>
      <pre id="runResult">Résultat...</pre>

      <h3>📜 Logs</h3>
      <button class="btn btn-secondary" id="loadLogs">Recharger Logs</button>
      <pre id="logs">Logs...</pre>

      <h3>❌ Erreurs</h3>
      <button class="btn btn-secondary" id="loadState">Vérifier état moteur</button>
      <pre id="errors">Erreurs...</pre>

      <h3>💬 Intelligence Artificielle</h3>
      <input type="text" id="aiQuestion" class="form-control" placeholder="Posez une question...">
      <div class="mt-2">
        <button id="askAI" class="btn btn-primary">Interroger IA (général)</button>
        <button id="askAIMotor" class="btn btn-success">Interroger IA (moteur)</button>
      </div>
      <pre id="aiReply">Réponse IA...</pre>
    </div>

    <!-- Alertes publiées -->
    <div class="tab-pane fade" id="alerts">
      <h3>🔔 Alertes publiées (>90%)</h3>
      <button class="btn btn-info" id="loadAlerts">Charger Alertes</button>
      <pre id="alertsBox">Aucune alerte...</pre>
    </div>

    <!-- Alertes à valider -->
    <div class="tab-pane fade" id="alertsPending">
      <h3>⚠️ Alertes à valider (70–90%)</h3>
      <button class="btn btn-info" id="loadPendingAlerts">Charger Alertes à valider</button>
      <div id="pendingAlertsBox">Aucune alerte...</div>
    </div>

    <!-- Actualités -->
    <div class="tab-pane fade" id="news">
      <h3>📰 Actualités Météo & Climat</h3>
      <iframe src="/api/news" width="100%" height="500"></iframe>
    </div>

    <!-- Vue Utilisateur -->
    <div class="tab-pane fade" id="userView">
      <h3>🌍 Vue utilisateur</h3>
      <input type="text" id="userCity" placeholder="Ville">
      <input type="text" id="userCountry" placeholder="Pays (code)">
      <button class="btn btn-primary" id="viewUser">Voir Index</button>
      <iframe id="userFrame" width="100%" height="500"></iframe>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
// === Runs ===
document.getElementById("runGlobal").onclick = async () => {
  const res = await fetch("/api/run-global", { method:"POST" });
  document.getElementById("runResult").textContent = JSON.stringify(await res.json(), null, 2);
};
document.getElementById("runContinental").onclick = async () => {
  const res = await fetch("/api/run-continental", { method:"POST" });
  document.getElementById("runResult").textContent = JSON.stringify(await res.json(), null, 2);
};

// === Logs & State ===
document.getElementById("loadLogs").onclick = async () => {
  const res = await fetch("/api/logs"); document.getElementById("logs").textContent = JSON.stringify(await res.json(), null, 2);
};
document.getElementById("loadState").onclick = async () => {
  const res = await fetch("/api/engine-state"); document.getElementById("errors").textContent = JSON.stringify(await res.json(), null, 2);
};

// === Chat ===
document.getElementById("askAI").onclick = async () => {
  const q=document.getElementById("aiQuestion").value;
  const res=await fetch("/api/chat",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({message:q})});
  document.getElementById("aiReply").textContent = JSON.stringify(await res.json(),null,2);
};
document.getElementById("askAIMotor").onclick = async () => {
  const q=document.getElementById("aiQuestion").value;
  const res=await fetch("/api/chat/engine",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({message:q})});
  document.getElementById("aiReply").textContent = JSON.stringify(await res.json(),null,2);
};

// === Alertes publiées ===
document.getElementById("loadAlerts").onclick = async () => {
  const res=await fetch("/api/alerts"); document.getElementById("alertsBox").textContent = JSON.stringify(await res.json(),null,2);
};

// === Alertes à valider ===
document.getElementById("loadPendingAlerts").onclick = async () => {
  const res=await fetch("/api/alerts/pending");
  const data=await res.json();
  const box=document.getElementById("pendingAlertsBox");
  box.innerHTML="";
  if(!data.alerts || !data.alerts.length){ box.textContent="Aucune alerte en attente."; return; }
  data.alerts.forEach(a=>{
    const div=document.createElement("div");
    div.className="alert alert-dark mt-2";
    div.innerHTML=`
      <b>${a.country||"?"}</b> — ${a.type||"?"} — Fiabilité: ${a.reliability}%
      <div>
        <button class="btn btn-success btn-sm" onclick="updateAlert('${a.id}','validate')">Valider</button>
        <button class="btn btn-warning btn-sm" onclick="updateAlert('${a.id}','expert')">Expert</button>
        <button class="btn btn-secondary btn-sm" onclick="updateAlert('${a.id}','wait')">Attente</button>
      </div>`;
    box.appendChild(div);
  });
};
async function updateAlert(id,action){
  await fetch(`/api/alerts/${id}/${action}`,{method:"POST"});
  document.getElementById("loadPendingAlerts").click();
}

// === Vue utilisateur ===
document.getElementById("viewUser").onclick = () => {
  const city=document.getElementById("userCity").value;
  const country=document.getElementById("userCountry").value;
  document.getElementById("userFrame").src=`/index.html?city=${encodeURIComponent(city)}&country=${encodeURIComponent(country)}`;
};
</script>
</body>
</html>
