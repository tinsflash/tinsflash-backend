<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="robots" content="noindex,nofollow" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>🛰️ Console IA J.E.A.N – TINSFLASH</title>
  <link href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" rel="stylesheet" />
  <style>
    body { font-family:"Inter",sans-serif;background:#0b0f19;color:#eaeaea;margin:0; }
    header { background:#111831;padding:15px;text-align:center;color:#4fc3f7;font-size:22px;font-weight:bold; }
    nav { background:#1a2238;padding:10px;display:flex;justify-content:center;gap:15px;flex-wrap:wrap; }
    nav a { color:#ccc;text-decoration:none;font-weight:600; }
    nav a:hover { color:#4fc3f7; }
    main { padding:15px; }
    h2 { color:#4fc3f7;border-bottom:1px solid #333;padding-bottom:6px;margin-top:25px;display:flex;align-items:center;justify-content:space-between; }
    button { background:#4fc3f7;color:#000;border:none;border-radius:6px;padding:8px 15px;cursor:pointer;font-weight:bold; }
    button:hover { background:#0288d1; }
    .status-grid { display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:10px;margin-top:10px; }
    .status-box { background:#1a2238;padding:10px;border-radius:8px;text-align:center; }
    .status-box span { display:block;margin-top:4px;font-size:13px;color:#aaa; }
    #logs { background:#111;border-radius:8px;padding:10px;height:250px;overflow-y:auto;font-size:13px;margin-top:10px; }
    #errors { background:#260000;border-radius:8px;padding:10px;margin-top:10px;color:#ffbaba;font-size:13px;display:none; }
    #mapForecast,#mapAlerts { height:380px;margin-top:10px;border-radius:8px; }
    .chat-float { position:fixed;bottom:15px;right:15px;width:300px;background:#111831;border-radius:10px;box-shadow:0 0 12px #000;overflow:hidden; }
    .chat-header { background:#4fc3f7;color:#000;font-weight:bold;padding:8px;text-align:center;cursor:pointer; }
    .chat-body { display:none;flex-direction:column;height:260px; }
    .chat-messages { flex:1;overflow-y:auto;padding:8px;font-size:13px; }
    .chat-input { display:flex;gap:5px;padding:8px;background:#0b0f19; }
    .chat-input input { flex:1;padding:6px;border-radius:6px;border:1px solid #555;background:#111;color:#eee; }
    .chat-input button { padding:6px 10px;background:#4fc3f7;border:none;border-radius:6px;cursor:pointer; }
    .msg { margin:4px 0;padding:6px 10px;border-radius:6px;max-width:75%; }
    .bot { background:#333;color:#fff;text-align:left; }
    .user { background:#4fc3f7;color:#000;margin-left:auto;text-align:right; }
  </style>
</head>
<body>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
const pin=sessionStorage.getItem("tinsflashPIN");
if(!pin){const p=prompt("Code d’accès admin ?");if(p!=="202679"){alert("⛔ Accès refusé");location.href="/";}else sessionStorage.setItem("tinsflashPIN","ok");}

let mapForecast,mapAlerts;
function initMaps(){
  mapForecast=L.map("mapForecast").setView([20,0],2);
  mapAlerts=L.map("mapAlerts").setView([20,0],2);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:"© OpenStreetMap"}).addTo(mapForecast);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:"© OpenStreetMap"}).addTo(mapAlerts);
}

async function loadStatus(){
  const res=await fetch("/api/status");
  const d=await res.json();
  document.getElementById("engineStatus").innerText=d.status||"–";
  document.getElementById("lastRun").innerText=d.lastRun?new Date(d.lastRun).toLocaleString():"Jamais";
  document.getElementById("engineStatus").style.color=d.status==="ok"?"#4caf50":d.status==="fail"?"#ff5252":"#ff9800";
}

const evtSource=new EventSource("/api/logs/stream");
evtSource.onmessage=e=>{
  const log=JSON.parse(e.data);
  const div=document.getElementById("logs");
  const line=document.createElement("div");
  line.textContent=`[${new Date(log.timestamp).toLocaleTimeString()}] ${log.message}`;
  div.appendChild(line);div.scrollTop=div.scrollHeight;
};

async function refreshSection(section){
  if(section==="status") loadStatus();
  if(section==="forecast") updateMapForecast();
  if(section==="alerts") updateMapAlerts();
  if(section==="summary") loadSummary();
  if(section==="logs") refreshLogs();
  if(section==="errors") loadErrors();
}

async function refreshLogs(){
  const res=await fetch("/api/status");
  const d=await res.json();
  const div=document.getElementById("logs");
  const logs=d.checkup?.logs||[];
  div.innerHTML=logs.slice(-50).map(l=>`<div>[${new Date(l.timestamp).toLocaleTimeString()}] ${l.message}</div>`).join("");
  div.scrollTop=div.scrollHeight;
}

async function loadErrors(){
  const res=await fetch("/api/status");
  const d=await res.json();
  const box=document.getElementById("errors");
  if(d.engineErrors?.length){
    box.innerHTML="<b>Erreurs récentes :</b><br>"+d.engineErrors.map(e=>`• ${e.message}`).join("<br>");
    box.style.display="block";
  }
}

async function loadSummary(){
  const res=await fetch("/api/alerts/summary");
  const s=await res.json();
  document.getElementById("summaryBody").innerHTML=`
    <tr><td>Locales/Nationales</td><td>${s.byStatus?.toValidate+s.byStatus?.published+s.byStatus?.["under-surveillance"]||0}</td></tr>
    <tr><td>Publiées (≥90%)</td><td>${s.byStatus?.published||0}</td></tr>
    <tr><td>À valider (70–89%)</td><td>${s.byStatus?.toValidate||0}</td></tr>
    <tr><td>Sous surveillance</td><td>${s.byStatus?.["under-surveillance"]||0}</td></tr>
    <tr><td>Archivées</td><td>${s.byStatus?.archived||0}</td></tr>`;
}

async function updateMapForecast(){
  mapForecast.eachLayer(l=>{if(l instanceof L.CircleMarker)mapForecast.removeLayer(l);});
  const res=await fetch("/api/status");
  const d=await res.json();
  const forecasts=d.forecasts||{};
  for(const [country,info] of Object.entries(forecasts)){
    const color=info.status==="ok"?"#4caf50":info.status==="fail"?"#ff5252":"#ff9800";
    L.circleMarker([info.lat||0,info.lon||0],{radius:6,color,fillOpacity:0.8})
      .addTo(mapForecast).bindPopup(`<b>${country}</b><br>${info.summary||"Prévision en cours"}`);
  }
}

async function updateMapAlerts(){
  mapAlerts.eachLayer(l=>{if(l instanceof L.CircleMarker)mapAlerts.removeLayer(l);});
  const res=await fetch("/api/alerts");
  const alerts=await res.json();
  alerts.forEach(a=>{
    const col=a.severity==="red"?"#ff0000":a.severity==="orange"?"#ff9800":"#4caf50";
    L.circleMarker([a.lat,a.lon],{radius:7,color:col,fillOpacity:0.8})
      .addTo(mapAlerts)
      .bindPopup(`<b>${a.region||a.country}</b><br>${a.title}<br>Fiabilité: ${a.confidence||"?"}%`);
  });
}

async function runGlobal(){
  const btn=document.getElementById("runBtn");
  btn.disabled=true;btn.innerText="⏳ Lancement...";
  const res=await fetch("/api/run-global",{method:"POST",headers:{"Content-Type":"application/json"}});
  const data=await res.json();
  alert(data.success?"✅ RUN GLOBAL lancé avec succès":"❌ Erreur run");
  btn.disabled=false;btn.innerText="⚡ Lancer Run Global";
  refreshSection("logs");
  refreshSection("status");
}

function addMsg(txt,who="bot"){
  const box=document.querySelector(".chat-messages");
  const div=document.createElement("div");
  div.className=`msg ${who}`;div.innerText=txt;
  box.appendChild(div);box.scrollTop=box.scrollHeight;
}
async function sendMsg(){
  const input=document.getElementById("chatInput");
  const text=input.value.trim();if(!text)return;
  addMsg(text,"user");input.value="";
  const res=await fetch("/api/chat-engine",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({message:text})});
  const data=await res.json();
  addMsg(data.reply||"⚠️ Pas de réponse","bot");
}
function toggleChat(){
  const body=document.querySelector(".chat-body");
  body.style.display=body.style.display==="flex"?"none":"flex";
}
window.onload=()=>{initMaps();loadStatus();loadErrors();loadSummary();updateMapAlerts();updateMapForecast();};
</script>

<header>🛰️ Console IA J.E.A.N – TINSFLASH</header>
<nav>
  <a href="/admin-pp.html">Console</a>
  <a href="/admin-alerts.html">Alertes</a>
</nav>

<main>
  <h2>⚙️ État du moteur <button onclick="refreshSection('status')">🔄</button></h2>
  <button id="runBtn" onclick="runGlobal()">⚡ Lancer Run Global</button>
  <div class="status-grid">
    <div class="status-box"><b>Statut moteur</b><span id="engineStatus">–</span></div>
    <div class="status-box"><b>Dernier run</b><span id="lastRun">–</span></div>
    <div class="status-box"><b>Modèles actifs</b><span>IA + GFS + ECMWF + ICON</span></div>
  </div>

  <h2>📊 Synthèse alertes <button onclick="refreshSection('summary')">🔄</button></h2>
  <table id="summaryTable"><thead><tr><th>Type</th><th>Nombre</th></tr></thead><tbody id="summaryBody"><tr><td colspan="2">Chargement...</td></tr></tbody></table>

  <h2>🌍 Carte prévisions <button onclick="refreshSection('forecast')">🔄</button></h2>
  <div id="mapForecast"></div>

  <h2>🚨 Carte alertes (monde) <button onclick="refreshSection('alerts')">🔄</button></h2>
  <div id="mapAlerts"></div>

  <h2>📜 Logs moteur <button onclick="refreshSection('logs')">🔄</button></h2>
  <div id="logs"></div>
  <div id="errors"></div>
</main>

<div class="chat-float">
  <div class="chat-header" onclick="toggleChat()">💬 Chat IA moteur</div>
  <div class="chat-body">
    <div class="chat-messages"></div>
    <div class="chat-input"><input id="chatInput" placeholder="Demande à l’IA..." /><button onclick="sendMsg()">▶</button></div>
  </div>
</div>
</body>
</html>
