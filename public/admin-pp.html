<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Console Admin TINSFLASH</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body { font-family: Arial, sans-serif; background:#0d1117; color:#eee; margin:0; }
    header { background:#161b22; padding:10px; text-align:center; }
    h1 { margin:0; font-size:22px; color:#58a6ff; }
    button { background:#238636; color:white; border:none; padding:8px 16px; margin:5px; cursor:pointer; border-radius:6px; }
    button:hover { background:#2ea043; }
    .container { padding:15px; }
    .section { margin-bottom:20px; padding:15px; background:#161b22; border-radius:8px; }
    .section h2 { margin-top:0; font-size:18px; color:#ffa657; }
    pre { background:#0d1117; padding:10px; border-radius:6px; overflow:auto; }
    nav { display:flex; justify-content:center; background:#21262d; }
    nav button { background:none; border:none; color:#ccc; padding:10px 15px; cursor:pointer; font-size:15px; }
    nav button.active { color:#58a6ff; border-bottom:2px solid #58a6ff; }
    .tab { display:none; padding:15px; }
    .tab.active { display:block; }
    iframe { width:100%; height:600px; border:none; }
  </style>
</head>
<body>
  <header>
    <h1>⚡ Console Admin — Centrale Nucléaire Météo</h1>
    <button onclick="runGlobal()">🚀 Lancer RUN GLOBAL</button>
    <button onclick="runContinental()">🌍 Lancer RUN CONTINENTAL</button>
  </header>

  <div class="container">
    <div class="section">
      <h2>📝 Logs moteur</h2>
      <button onclick="loadLogs()">🔄 Rafraîchir</button>
      <pre id="logs">Chargement...</pre>
    </div>

    <div class="section">
      <h2>❌ Erreurs</h2>
      <pre id="errors">Aucune</pre>
    </div>

    <div class="section">
      <h2>🧠 Diagnostic IA</h2>
      <button onclick="checkIA()">Vérifier par IA</button>
      <pre id="ia-diagnostic">En attente...</pre>
    </div>

    <div class="section">
      <h2>⚙️ État moteur</h2>
      <button onclick="loadEngineState()">🔄 Rafraîchir</button>
      <pre id="engine-state">Chargement...</pre>
    </div>
  </div>

  <nav>
    <button onclick="openTab('alerts')" id="tab-alerts">🔔 Alertes</button>
    <button onclick="openTab('radar')" id="tab-radar">📡 Radar</button>
    <button onclick="openTab('preview')" id="tab-preview">🌍 Preview Index</button>
    <button onclick="openTab('news')" id="tab-news">📰 Actualités</button>
  </nav>

  <div class="tab" id="alerts">
    <h2>🔔 Alertes actives</h2>
    <button onclick="loadAlerts()">🔄 Rafraîchir</button>
    <pre id="alerts-content">Chargement...</pre>
  </div>

  <div class="tab" id="radar">
    <h2>📡 Radar météo global</h2>
    <iframe src="https://embed.windy.com/embed2.html?lat=50&lon=4&detailLat=50&detailLon=4&zoom=4&level=surface&overlay=rain&menu=&message=true&calendar=12&pressure=true&type=map&location=coordinates&detail=true&metricWind=default&metricTemp=default&radarRange=-1"></iframe>
  </div>

  <div class="tab" id="preview">
    <h2>🌍 Preview Index utilisateur</h2>
    <label>Ville: <input type="text" id="preview-city" placeholder="Bruxelles" /></label>
    <label>Pays:
      <select id="preview-country">
        <option value="be">Belgique</option>
        <option value="fr">France</option>
        <option value="de">Allemagne</option>
        <option value="us">USA</option>
        <option value="uk">Royaume-Uni</option>
      </select>
    </label>
    <button onclick="previewIndex()">Voir la preview</button>
    <iframe id="preview-frame"></iframe>
  </div>

  <div class="tab" id="news">
    <h2>📰 Actualités météo et climat</h2>
    <button onclick="loadNews()">🔄 Rafraîchir</button>
    <pre id="news-content">Chargement...</pre>
  </div>

  <script>
    // Navigation avec conservation onglet
    function openTab(tabId) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
      document.getElementById(tabId).classList.add('active');
      document.getElementById('tab-' + tabId).classList.add('active');
      localStorage.setItem('activeTab', tabId);
    }
    const savedTab = localStorage.getItem('activeTab') || 'alerts';
    openTab(savedTab);

    // API calls
    async function runGlobal() {
      document.getElementById("logs").textContent = "RUN GLOBAL en cours...";
      const res = await fetch("/api/run-global", { method: "POST" });
      const data = await res.json();
      loadLogs();
      loadEngineState();
      alert("RUN GLOBAL terminé");
    }

    async function runContinental() {
      const res = await fetch("/api/run-continental", { method: "POST" });
      const data = await res.json();
      loadLogs();
      loadEngineState();
      alert("RUN CONTINENTAL terminé");
    }

    async function loadLogs() {
      const res = await fetch("/api/logs");
      const data = await res.json();
      document.getElementById("logs").textContent = JSON.stringify(data.logs, null, 2);
    }

    async function loadEngineState() {
      const res = await fetch("/api/engine-state");
      const data = await res.json();
      document.getElementById("engine-state").textContent = JSON.stringify(data.state, null, 2);
      document.getElementById("errors").textContent = JSON.stringify(data.state.errors, null, 2);
    }

    async function checkIA() {
      const res = await fetch("/api/chat", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ message: "diagnostic moteur" })
      });
      const data = await res.json();
      document.getElementById("ia-diagnostic").textContent = JSON.stringify(data.response, null, 2);
    }

    async function loadAlerts() {
      const res = await fetch("/api/alerts");
      const data = await res.json();
      document.getElementById("alerts-content").textContent = JSON.stringify(data.alerts, null, 2);
    }

    async function previewIndex() {
      const city = document.getElementById("preview-city").value;
      const country = document.getElementById("preview-country").value;
      document.getElementById("preview-frame").src = `/index.html?city=${city}&country=${country}`;
    }

    async function loadNews() {
      const res = await fetch("/api/news");
      const data = await res.json();
      document.getElementById("news-content").textContent = JSON.stringify(data, null, 2);
    }

    // Chargement initial
    loadLogs();
    loadEngineState();
    loadAlerts();
    loadNews();
  </script>
</body>
</html>
