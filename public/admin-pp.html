<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>‚ö° Centrale Nucl√©aire M√©t√©o ‚Äì Admin Pro+</title>
  <style>
    body { font-family: Arial, sans-serif; background: #111; color: #fff; }
    h1 { background: #222; padding: 10px; }
    .section { margin: 20px 0; padding: 15px; border-radius: 10px; }
    .ok { color: #4CAF50; }
    .warn { color: #FFC107; }
    .err { color: #F44336; }
    .logs { background: #000; color: #0f0; padding: 10px; height: 200px; overflow-y: auto; }
    button { padding: 8px 15px; border: none; border-radius: 8px; cursor: pointer; }
    .btn { background: #2196F3; color: white; }
    .alert-block { background: #222; padding: 10px; margin: 10px 0; border-radius: 8px; }
    .chat-box { background: #1e1e1e; padding: 10px; border-radius: 10px; height: 250px; overflow-y: auto; }
    .chat-msg { margin: 5px 0; }
    .user { color: #4FC3F7; }
    .jean { color: #81C784; }
  </style>
</head>
<body>
  <h1>üåç Console Admin Pro+</h1>

  <!-- Lancer un run -->
  <div class="section" style="background:#1e1e1e;">
    <h2>üöÄ Lancer un Run complet</h2>
    <button id="runBtn" class="btn">Lancer maintenant</button>
    <p id="runStatus">[En attente d‚Äôun run...]</p>
    <div class="logs" id="runLogs"></div>
  </div>

  <!-- Alertes automatiques -->
  <div class="section" style="background:#2e2e2e;">
    <h2>‚úÖ Alertes valid√©es automatiquement (‚â•90 %)</h2>
    <div id="autoAlerts"></div>
  </div>

  <!-- Alertes manuelles -->
  <div class="section" style="background:#3e3e1e;">
    <h2>‚ö†Ô∏è Alertes en attente de validation (70‚Äì89 %)</h2>
    <div id="manualAlerts"></div>
  </div>

  <!-- Statistiques -->
  <div class="section" style="background:#1e2e3e;">
    <h2>üìä Statistiques Syst√®me</h2>
    <p id="stats">Chargement...</p>
  </div>

  <!-- Chat JEAN -->
  <div class="section" style="background:#222;">
    <h2>ü§ñ Chat avec J.E.A.N.</h2>
    <div id="chatBox" class="chat-box"></div>
    <input type="text" id="chatInput" placeholder="Pose ta question √† JEAN..." style="width:80%; padding:5px;">
    <button id="chatBtn" class="btn">Envoyer</button>
  </div>

  <script>
    async function lancerRun() {
      document.getElementById("runStatus").textContent = "üöÄ Lancement du run...";
      document.getElementById("runLogs").innerHTML = "";

      try {
        const res = await fetch("/api/supercalc/run", { method: "POST" });
        const data = await res.json();

        if (data.error) {
          document.getElementById("runStatus").textContent = "‚ùå Erreur: " + data.error;
          return;
        }

        // Log d‚Äô√©volution
        logRun("üîé Sources m√©t√©o fusionn√©es...");
        logRun("ü§ñ IA en cours d‚Äôanalyse...");
        logRun("‚ö° D√©tection des alertes m√©t√©o...");
        logRun("‚úÖ Run termin√© avec succ√®s !");

        // Afficher alertes
        afficherAlertes(data.alerts);

        // Stats
        chargerStats();

      } catch (err) {
        document.getElementById("runStatus").textContent = "‚ùå Erreur run: " + err.message;
      }
    }

    function logRun(msg) {
      const logs = document.getElementById("runLogs");
      logs.innerHTML += msg + "<br>";
      logs.scrollTop = logs.scrollHeight;
    }

    function afficherAlertes(alerts) {
      const autoDiv = document.getElementById("autoAlerts");
      const manualDiv = document.getElementById("manualAlerts");
      autoDiv.innerHTML = "";
      manualDiv.innerHTML = "";

      alerts.forEach(a => {
        const div = document.createElement("div");
        div.className = "alert-block";
        div.innerHTML = `<b>${a.type}</b> - ${a.value} (Confiance: ${a.confidence}%)`;

        if (a.action === "AUTO") {
          autoDiv.appendChild(div);
        } else {
          const btn = document.createElement("button");
          btn.className = "btn";
          btn.textContent = "Valider";
          btn.onclick = async () => {
            await fetch("/api/alerts/validate", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ id: a.id })
            });
            btn.disabled = true;
            btn.textContent = "‚úî Valid√©e";
          };
          div.appendChild(btn);
          manualDiv.appendChild(div);
        }
      });
    }

    async function chargerStats() {
      const res = await fetch("/api/admin/stats");
      const stats = await res.json();
      document.getElementById("stats").textContent =
        `Pr√©visions: ${stats.forecasts} | Alertes: ${stats.alerts} | Uptime: ${Math.round(stats.uptime/60)} min`;
    }

    async function envoyerChat() {
      const input = document.getElementById("chatInput");
      const msg = input.value.trim();
      if (!msg) return;

      afficherChat("user", msg);
      input.value = "";

      const res = await fetch("/api/chat", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ message: msg })
      });
      const data = await res.json();

      afficherChat("jean", data.reply || "Pas de r√©ponse.");
    }

    function afficherChat(who, text) {
      const chatBox = document.getElementById("chatBox");
      const div = document.createElement("div");
      div.className = "chat-msg " + who;
      div.textContent = (who === "user" ? "üë§ Toi: " : "ü§ñ JEAN: ") + text;
      chatBox.appendChild(div);
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    document.getElementById("runBtn").addEventListener("click", lancerRun);
    document.getElementById("chatBtn").addEventListener("click", envoyerChat);

    // Auto-refresh stats toutes les 30s
    setInterval(chargerStats, 30000);
    chargerStats();
  </script>
</body>
</html>
