<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Console Admin ‚Äì Centrale Nucl√©aire M√©t√©o</title>
  <meta name="robots" content="noindex,nofollow" />
  <style>
    body { font-family: Arial, sans-serif; background:#0d1117; color:#e6edf3; margin:0; padding:20px; }
    h1 { color:#58a6ff; }
    .section { margin:20px 0; padding:15px; border:1px solid #30363d; border-radius:8px; background:#161b22; }
    .ok { color:#2ecc71; font-weight:bold; }
    .fail { color:#e74c3c; font-weight:bold; }
    .pending { color:#f39c12; font-weight:bold; }
    pre { background:#0d1117; padding:10px; border-radius:5px; max-height:300px; overflow:auto; }
    button { padding:10px 20px; border:none; border-radius:6px; cursor:pointer; font-size:16px; }
    .run { background:#58a6ff; color:#fff; }
    .log { font-size:13px; border-bottom:1px solid #30363d; padding:4px; }
    .green { color:#2ecc71; }
    .red { color:#e74c3c; }
    .orange { color:#f39c12; }
  </style>
  <script>
    async function runGlobal() {
      const btn = document.getElementById("btnRun");
      btn.style.background = "#f39c12"; // orange = en cours
      try {
        const res = await fetch("/api/run-global", { method:"POST", headers:{ "Content-Type":"application/json" }, body:JSON.stringify({zone:"All"}) });
        const data = await res.json();
        btn.style.background = data.success ? "#2ecc71" : "#e74c3c"; // vert ou rouge
        loadCheckup();
        loadFinalReport();
      } catch (e) {
        btn.style.background = "#e74c3c";
      }
    }

    async function loadCheckup() {
      const res = await fetch("/api/checkup");
      const data = await res.json();
      const el = document.getElementById("checkup");
      el.innerHTML = "";
      for (const [k,v] of Object.entries(data)) {
        const css = v==="OK" ? "ok" : v==="FAIL" ? "fail" : "pending";
        el.innerHTML += `<div><b>${k}</b>: <span class="${css}">${v}</span></div>`;
      }
    }

    function loadLogs() {
      const logsEl = document.getElementById("logs");
      const es = new EventSource("/api/logs/stream");
      es.onmessage = (event) => {
        const logs = JSON.parse(event.data);
        logsEl.innerHTML = "";
        logs.slice(-50).reverse().forEach(log => {
          const time = new Date(log.timestamp).toLocaleTimeString();
          logsEl.innerHTML += `<div class="log">[${time}] ${log.message}</div>`;
        });
      };
    }

    async function loadFinalReport() {
      const res = await fetch("/api/engine-state");
      const data = await res.json();
      const el = document.getElementById("finalReport");
      if (!data.finalReport) {
        el.innerHTML = "<i>Aucun rapport IA disponible pour le moment.</i>";
        return;
      }
      const rep = data.finalReport;
      el.innerHTML = `
        <h3>R√©sum√© IA</h3>
        <p>${rep.resume || rep.raw || "‚ö†Ô∏è Pas de r√©sum√©"}</p>
        <h4>Points forts</h4>
        <ul>${(rep.points_forts||[]).map(p=>`<li>${p}</li>`).join("")}</ul>
        <h4>Alertes majeures</h4>
        <ul>${(rep.alertes_majeures||[]).map(a=>`<li>${a}</li>`).join("")}</ul>
        <p><b>Fiabilit√© globale:</b> ${rep.fiabilite_globale || "?"}</p>
        <div style="margin-top:10px;padding:10px;background:#21262d;border-radius:6px;">
          <b>Message utilisateur:</b><br/>
          ${rep.message_utilisateur || ""}
        </div>
      `;
    }

    window.onload = () => {
      loadCheckup();
      loadLogs();
      loadFinalReport();
    };
  </script>
</head>
<body>
  <h1>‚ö° Centrale Nucl√©aire M√©t√©o ‚Äì Console Admin</h1>

  <div class="section">
    <button id="btnRun" class="run" onclick="runGlobal()">üöÄ Lancer RUN GLOBAL</button>
  </div>

  <div class="section">
    <h2>üìã Checkup moteur</h2>
    <div id="checkup"></div>
  </div>

  <div class="section">
    <h2>üìú Logs (live cockpit)</h2>
    <div id="logs"></div>
  </div>

  <div class="section">
    <h2>ü§ñ Rapport IA final (Pr√©visions + Alertes fusionn√©es)</h2>
    <div id="finalReport"></div>
  </div>

</body>
</html>
