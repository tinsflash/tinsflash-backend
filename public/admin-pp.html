<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>TINSFLASH ‚Äì Console Admin</title>
  <meta name="robots" content="noindex,nofollow">
  <style>
    body { font-family: Arial, sans-serif; background:#0b0c10; color:#eee; margin:0; padding:0; }
    header { background:#1f2833; padding:15px; text-align:center; }
    h1 { margin:0; color:#66fcf1; }
    section { margin:20px; padding:15px; background:#1f2833; border-radius:8px; }
    button { padding:10px 20px; margin:5px; background:#45a29e; border:none; color:#fff; border-radius:5px; cursor:pointer; }
    button:hover { background:#66fcf1; color:#000; }
    .checklist-item { display:flex; justify-content:space-between; margin:5px 0; }
    .status { font-weight:bold; }
    .pending { color:orange; }
    .ok { color:lightgreen; }
    .fail { color:red; }
    #logs { max-height:250px; overflow-y:auto; background:#000; padding:10px; font-family:monospace; font-size:13px; }
    .log-info { color:lightgreen; }
    .log-error { color:red; }
    .alert { border:1px solid #444; padding:10px; margin-bottom:10px; border-radius:6px; background:#0b0c10; }
    .alert.primeur { border-left:5px solid orange; }
    .alert.primeur-auto { border-left:5px solid gold; }
    .alert.auto { border-left:5px solid lightgreen; }
    .alert.pending { border-left:5px solid dodgerblue; }
  </style>
</head>
<body>
<header>
  <h1>‚ö° Centrale Nucl√©aire M√©t√©o ‚Äì Console Admin</h1>
</header>

<section>
  <h2>üöÄ Lancement du moteur</h2>
  <button onclick="launchRuns()">Lancer la Centrale</button>
</section>

<section>
  <h2>üìã Checklist moteur</h2>
  <div id="checklist"></div>
</section>

<section>
  <h2>üìú Logs en direct</h2>
  <div id="logs">‚è≥ En attente de nouveaux logs‚Ä¶</div>
</section>

<section>
  <h2>üö® Alertes d√©tect√©es</h2>
  <div id="alerts">‚è≥ Chargement des alertes‚Ä¶</div>
</section>

<script>
  // === RUN GLOBAL + CONTINENTAL ===
  async function launchRuns() {
    await fetch('/api/run-global', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ zone:"ALL" })});
    await fetch('/api/run-continental', { method:'POST' });
    alert("üöÄ Centrale lanc√©e !");
  }

  // === CHECKLIST ===
  async function refreshChecklist() {
    const res = await fetch('/api/checkup');
    const data = await res.json();
    const container = document.getElementById("checklist");
    container.innerHTML = "";

    const steps = [
      { key:"models", label:"Extraction des mod√®les" },
      { key:"runGlobalEurope", label:"Run Global Europe" },
      { key:"runGlobalUSA", label:"Run Global USA" },
      { key:"runContinental", label:"Runs Continentaux" },
      { key:"fileSave", label:"Mise sous fichier des extractions" },
      { key:"analysisIA", label:"Analyse IA (relief, climat, environnement‚Ä¶)" },
      { key:"forecasts", label:"Pr√©visions locales & nationales (zones couvertes)" },
      { key:"alertsLocalNational", label:"Alertes locales & nationales (zones couvertes)" },
      { key:"alertsContinental", label:"Alertes continentales (zones non couvertes)" },
      { key:"byCountry", label:"Vue par pays (zones couvertes)" }
    ];

    steps.forEach(s => {
      let status = data[s.key] || "PENDING";
      let css = "pending";
      if (status === "OK") css = "ok";
      if (status === "FAIL") css = "fail";
      container.innerHTML += `
        <div class="checklist-item">
          <span>${s.label}</span>
          <span class="status ${css}">${status}</span>
        </div>`;
    });
  }
  setInterval(refreshChecklist, 10000);
  refreshChecklist();

  // === LOGS LIVE (SSE) ===
  function connectLogs() {
    const logBox = document.getElementById("logs");
    logBox.innerHTML = "";
    const evtSource = new EventSource("/api/logs/stream");
    evtSource.onmessage = function(e) {
      const logs = JSON.parse(e.data);
      if (logs.length === 0) return;
      const last = logs[logs.length - 1];
      const css = last.includes("Erreur") || last.includes("‚ùå") ? "log-error" : "log-info";
      const ts = new Date().toLocaleTimeString();
      logBox.innerHTML += `<div class="${css}">[${ts}] ${last}</div>`;
      logBox.scrollTop = logBox.scrollHeight;
    };
  }
  connectLogs();

  // === ALERTES ===
  async function refreshAlerts() {
    const res = await fetch('/api/alerts');
    const data = await res.json();
    const container = document.getElementById("alerts");
    container.innerHTML = "";

    data.alerts.forEach(a => {
      container.innerHTML += `
        <div class="alert ${a.category}">
          <strong>${a.type}</strong> ‚Äì ${a.zone}<br>
          Intensit√©: ${a.intensity}<br>
          Fiabilit√©: ${a.reliability}% ‚Äì Primeur: ${a.firstDetector}<br>
          D√©but: ${a.start || "?"} ‚Äì Fin: ${a.end || "?"}<br>
          Cons√©quences: ${a.consequences}<br>
          Recommandations: ${a.recommendations}<br>
          <em>Cat√©gorie: ${a.category}</em><br>
          ${a.category === "primeur" || a.category === "pending" ? `
            <button onclick="updateAlert('${a.id}','validate')">‚úÖ Valider</button>
            <button onclick="updateAlert('${a.id}','ignore')">‚ùå Ignorer</button>
          ` : ""}
        </div>`;
    });
  }
  async function updateAlert(id, action) {
    await fetch('/api/alerts/'+id+'/'+action, { method:'POST' });
    refreshAlerts();
  }
  setInterval(refreshAlerts, 15000);
  refreshAlerts();
</script>
</body>
</html>
