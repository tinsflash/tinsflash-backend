<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="robots" content="noindex,nofollow" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ğŸ›°ï¸ Console IA J.E.A.N â€“ TINSFLASH</title>

  <!-- === STYLES === -->
  <link href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" rel="stylesheet" />
  <style>
    body { font-family:"Inter",sans-serif;background:#0b0f19;color:#eaeaea;margin:0; }
    header { background:#111831;padding:15px;text-align:center;color:#4fc3f7;font-size:22px;font-weight:bold; }
    nav { background:#1a2238;padding:10px;display:flex;justify-content:center;gap:15px;flex-wrap:wrap; }
    nav a { color:#ccc;text-decoration:none;font-weight:600; }
    nav a:hover { color:#4fc3f7; }
    main { padding:15px; }
    h2 { color:#4fc3f7;border-bottom:1px solid #333;padding-bottom:6px;margin-top:25px; }

    .status-grid { display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:10px;margin-top:10px; }
    .status-box { background:#1a2238;padding:10px;border-radius:8px;text-align:center; }
    .status-box span { display:block;margin-top:4px;font-size:13px;color:#aaa; }

    button { background:#4fc3f7;color:#000;border:none;border-radius:6px;padding:8px 15px;cursor:pointer;font-weight:bold; }
    button:hover { background:#0288d1; }

    #summaryTable { width:100%;margin-top:10px;border-collapse:collapse;font-size:14px; }
    #summaryTable th,#summaryTable td { border:1px solid #333;padding:6px;text-align:center; }
    #summaryTable th { background:#1a2238;color:#4fc3f7; }

    #logs { background:#111;border-radius:8px;padding:10px;height:220px;overflow-y:auto;font-size:13px;margin-top:10px; }
    #errors { background:#260000;border-radius:8px;padding:10px;margin-top:10px;color:#ffbaba;font-size:13px;display:none; }

    #mapForecast,#mapAlerts { height:380px;margin-top:10px;border-radius:8px; }

    .chat-float { position:fixed;bottom:15px;right:15px;width:280px;background:#111831;border-radius:10px;box-shadow:0 0 12px #000;overflow:hidden; }
    .chat-header { background:#4fc3f7;color:#000;font-weight:bold;padding:8px;text-align:center;cursor:pointer; }
    .chat-body { display:none;flex-direction:column;height:260px; }
    .chat-messages { flex:1;overflow-y:auto;padding:8px;font-size:13px; }
    .chat-input { display:flex;gap:5px;padding:8px;background:#0b0f19; }
    .chat-input input { flex:1;padding:6px;border-radius:6px;border:1px solid #555;background:#111;color:#eee; }
    .chat-input button { padding:6px 10px;background:#4fc3f7;border:none;border-radius:6px;cursor:pointer; }

    .msg { margin:4px 0;padding:6px 10px;border-radius:6px;max-width:75%; }
    .bot { background:#333;color:#fff;text-align:left; }
    .user { background:#4fc3f7;color:#000;margin-left:auto;text-align:right; }

    @media(max-width:768px){.chat-float{width:90%;right:5%;bottom:10px;}#mapForecast,#mapAlerts{height:280px;}}
  </style>
</head>
<body>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
/* === SÃ©curitÃ© === */
const storedPin=sessionStorage.getItem("tinsflashPIN");
if(!storedPin){
  const pin=prompt("Code dâ€™accÃ¨s admin ?");
  if(pin!=="202679"){alert("â›” AccÃ¨s refusÃ©");location.href="/";}else{sessionStorage.setItem("tinsflashPIN","ok");}
}

/* === Variables globales === */
let mapForecast,mapAlerts;

/* === Initialisation cartes === */
function initMaps(){
  mapForecast=L.map("mapForecast").setView([20,0],2);
  mapAlerts=L.map("mapAlerts").setView([20,0],2);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:"Â© OpenStreetMap"}).addTo(mapForecast);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:"Â© OpenStreetMap"}).addTo(mapAlerts);
}

/* === Charger Ã©tat moteur === */
async function loadStatus(){
  try{
    const res=await fetch("/api/status");
    const data=await res.json();
    document.getElementById("engineStatus").innerText=data.status||"â€“";
    document.getElementById("lastRun").innerText=data.lastRun?new Date(data.lastRun).toLocaleString():"Jamais";
    document.getElementById("engineStatus").style.color=data.status==="ok"?"#4caf50":data.status==="fail"?"#ff5252":"#ff9800";
  }catch(e){console.error(e);}
}

/* === Logs SSE === */
const evtSource=new EventSource("/api/logs/stream");
evtSource.onmessage=e=>{
  const log=JSON.parse(e.data);
  const div=document.getElementById("logs");
  const line=document.createElement("div");
  line.textContent=`[${new Date(log.timestamp).toLocaleTimeString()}] ${log.message}`;
  div.appendChild(line);
  div.scrollTop=div.scrollHeight;
};

/* === RafraÃ®chir manuellement === */
async function refreshSection(section){
  if(section==="status") loadStatus();
  if(section==="forecast") updateMapForecast();
  if(section==="alerts") updateMapAlerts();
  if(section==="summary") loadSummary();
  if(section==="logs") refreshLogs();
  if(section==="errors") loadErrors();
}
setInterval(()=>{loadStatus();updateMapAlerts();updateMapForecast();loadSummary();},10000);

/* === RafraÃ®chir logs manuellement === */
async function refreshLogs(){
  const res=await fetch("/api/logs");
  const data=await res.json();
  const div=document.getElementById("logs");
  div.innerHTML=data.slice(-50).map(l=>`<div>[${new Date(l.timestamp).toLocaleTimeString()}] ${l.message}</div>`).join("");
  div.scrollTop=div.scrollHeight;
}

/* === Charger erreurs === */
async function loadErrors(){
  try{
    const res=await fetch("/api/status");
    const data=await res.json();
    if(data.engineErrors?.length){
      const box=document.getElementById("errors");
      box.innerHTML="<b>Erreurs rÃ©centes :</b><br>"+data.engineErrors.map(e=>`â€¢ ${e.message}`).join("<br>");
      box.style.display="block";
    }
  }catch(e){console.error(e);}
}

/* === RÃ©sumÃ© des alertes === */
async function loadSummary(){
  try{
    const res=await fetch("/api/alerts/summary");
    const s=await res.json();
    document.getElementById("summaryBody").innerHTML=`
      <tr><td>Locales/Nationales</td><td>${s.byStatus?.toValidate+s.byStatus?.published+s.byStatus?.["under-surveillance"]||0}</td></tr>
      <tr><td>PubliÃ©es (â‰¥90%)</td><td>${s.byStatus?.published||0}</td></tr>
      <tr><td>Ã€ valider (70â€“89%)</td><td>${s.byStatus?.toValidate||0}</td></tr>
      <tr><td>Sous surveillance</td><td>${s.byStatus?.["under-surveillance"]||0}</td></tr>
      <tr><td>ArchivÃ©es</td><td>${s.byStatus?.archived||0}</td></tr>`;
  }catch(e){console.error(e);}
}

/* === Cartes === */
async function updateMapForecast(){
  mapForecast.eachLayer(l=>{if(l instanceof L.CircleMarker)mapForecast.removeLayer(l);});
  try{
    const res=await fetch("/api/status");
    const data=await res.json();
    const forecasts=data.forecasts||{};
    for(const [country,info] of Object.entries(forecasts)){
      const color=info.status==="ok"?"#4caf50":info.status==="fail"?"#ff5252":"#ff9800";
      const lat=info.lat||0,lon=info.lon||0;
      L.circleMarker([lat,lon],{radius:6,color,fillOpacity:0.8})
        .addTo(mapForecast)
        .bindPopup(`<b>${country}</b><br>${info.summary||"PrÃ©vision en cours"}`);
    }
  }catch(e){console.error(e);}
}
async function updateMapAlerts(){
  mapAlerts.eachLayer(l=>{if(l instanceof L.CircleMarker)mapAlerts.removeLayer(l);});
  const res=await fetch("/api/alerts");
  const alerts=await res.json();
  alerts.forEach(a=>{
    const col=a.severity==="red"?"#ff0000":a.severity==="orange"?"#ff9800":"#4caf50";
    L.circleMarker([a.lat,a.lon],{radius:7,color:col,fillOpacity:0.8})
      .addTo(mapAlerts)
      .bindPopup(`<b>${a.region||a.country}</b><br>${a.title}<br>FiabilitÃ©: ${a.confidence||"?"}%`);
  });
}

/* === Bouton run === */
async function runGlobal(){
  const btn=document.getElementById("runBtn");
  btn.disabled=true;btn.innerText="â³ Lancement...";
  const res=await fetch("/api/run-global",{method:"POST",headers:{"Content-Type":"application/json"}});
  const data=await res.json();
  alert(data.success?"âœ… Run lancÃ© avec succÃ¨s":"âŒ Erreur run");
  btn.disabled=false;btn.innerText="âš¡ Lancer Run Global";
  loadStatus();updateMapAlerts();updateMapForecast();loadSummary();
}

/* === Relance ciblÃ©e IA / Alertes === */
async function retryPhase(phase){
  const btn=document.getElementById(`retry${phase}`);
  btn.disabled=true;btn.innerText="â³...";
  const res=await fetch(`/api/retryPhase/${phase}`,{method:"POST"});
  const data=await res.json();
  alert(data.success?`âœ… Phase ${phase} relancÃ©e`:`âŒ ${data.error||"Erreur relance"}`);
  btn.disabled=false;btn.innerText=`ğŸ” Relancer ${phase}`;
  loadStatus();updateMapAlerts();updateMapForecast();
}

/* === Chat IA (GPT-5) === */
function addMsg(txt,who="bot"){
  const box=document.querySelector(".chat-messages");
  const div=document.createElement("div");
  div.className=`msg ${who}`;div.innerText=txt;
  box.appendChild(div);box.scrollTop=box.scrollHeight;
}
async function sendMsg(){
  const input=document.getElementById("chatInput");
  const text=input.value.trim();if(!text)return;
  addMsg(text,"user");input.value="";
  try{
    const res=await fetch("/api/chat-engine",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({message:text})});
    const data=await res.json();
    addMsg(data.reply||"âš ï¸ Pas de rÃ©ponse","bot");
  }catch(e){addMsg("Erreur: "+e.message,"bot");}
}
function toggleChat(){
  const body=document.querySelector(".chat-body");
  body.style.display=body.style.display==="flex"?"none":"flex";
}

/* === Initialisation === */
window.onload=()=>{initMaps();loadStatus();loadErrors();loadSummary();updateMapAlerts();updateMapForecast();};
</script>

<header>ğŸ›°ï¸ Console IA J.E.A.N â€“ TINSFLASH</header>
<nav>
  <a href="/admin-pp.html">Console</a>
  <a href="/admin-alerts.html">Alertes</a>
  <a href="/admin-chat.html">Chat</a>
  <a href="/admin-index.html">Vue Index</a>
  <a href="/admin-radar.html">Radar & News</a>
  <a href="/admin-users.html">Utilisateurs</a>
</nav>

<main>
  <h2>âš™ï¸ Ã‰tat du moteur 
    <button onclick="refreshSection('status')">ğŸ”„</button>
  </h2>
  <button id="runBtn" onclick="runGlobal()">âš¡ Lancer Run Global</button>
  <button id="retryIA" onclick="retryPhase('IA')">ğŸ” Relancer IA</button>
  <button id="retryALERTES" onclick="retryPhase('ALERTES')">ğŸ” Relancer Alertes</button>

  <div class="status-grid">
    <div class="status-box"><b>Statut moteur</b><span id="engineStatus">â€“</span></div>
    <div class="status-box"><b>Dernier run</b><span id="lastRun">1970</span></div>
    <div class="status-box"><b>ModÃ¨les actifs</b><span>IA + GFS + ECMWF + ICON</span></div>
    <div class="status-box"><b>Zones couvertes</b><span>Europe + USA + UK + Ukraine + Scandinavie + Suisse</span></div>
  </div>

  <h2>ğŸ“Š SynthÃ¨se alertes 
    <button onclick="refreshSection('summary')">ğŸ”„</button>
  </h2>
  <table id="summaryTable">
    <thead><tr><th>Type</th><th>Nombre</th></tr></thead>
    <tbody id="summaryBody"><tr><td colspan="2">Chargement...</td></tr></tbody>
  </table>

  <h2>ğŸŒ Carte prÃ©visions (zones couvertes)
    <button onclick="refreshSection('forecast')">ğŸ”„</button>
  </h2>
  <div id="mapForecast"></div>

  <h2>ğŸš¨ Carte alertes (monde)
    <button onclick="refreshSection('alerts')">ğŸ”„</button>
  </h2>
  <div id="mapAlerts"></div>

  <h2>ğŸ“œ Logs moteur
    <button onclick="refreshSection('logs')">ğŸ”„</button>
  </h2>
  <div id="logs"></div>
  <div id="errors"></div>
</main>

<!-- === Chat IA === -->
<div class="chat-float">
  <div class="chat-header" onclick="toggleChat()">ğŸ’¬ Chat IA moteur</div>
  <div class="chat-body">
    <div class="chat-messages"></div>
    <div class="chat-input">
      <input id="chatInput" placeholder="Demande Ã  lâ€™IA moteur..." />
      <button onclick="sendMsg()">â–¶</button>
    </div>
  </div>
</div>

</body>
</html>
