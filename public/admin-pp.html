<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>üõ∞Ô∏è Console IA J.E.A.N ‚Äì TINSFLASH (Cockpit)</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <style>
    body{margin:0;background:#0b1220;color:#e0e6f0;font-family:"Segoe UI",sans-serif;}
    header{background:#111b2e;padding:15px;text-align:center;color:#4fc3f7;font-weight:bold;font-size:1.4em;text-shadow:0 0 10px #4fc3f7;}
    nav{display:flex;justify-content:center;flex-wrap:wrap;gap:10px;background:#141e33;padding:8px;}
    nav a{color:#a9b7d0;text-decoration:none;padding:8px 14px;border-radius:8px;transition:.3s;background:#1a2744;}
    nav a:hover,nav a.active{background:#4fc3f7;color:#000;}
    main{max-width:1200px;margin:auto;padding:20px;}
    h2{color:#4fc3f7;margin-top:25px;}
    .section{background:#101a30;border-radius:12px;padding:18px;margin-bottom:25px;box-shadow:0 0 10px rgba(0,0,0,.4);}
    .btn{background:#1a2744;color:#4fc3f7;border:1px solid #4fc3f7;padding:8px 14px;border-radius:6px;cursor:pointer;font-weight:bold;margin:4px;transition:.3s;}
    .btn:hover{background:#4fc3f7;color:#000;}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:20px;}
    #map-forecast,#map-alerts{height:320px;border-radius:10px;overflow:hidden;}
    #logStream{background:#000;color:#4fc3f7;font-family:monospace;padding:10px;border-radius:6px;height:200px;overflow-y:auto;}
    small{color:#7a8cab;}
    /* === POPUP NASA === */
    #popupOverlay{
      position:fixed;inset:0;background:rgba(0,0,0,.88);
      display:flex;flex-direction:column;align-items:center;justify-content:center;
      color:#4fc3f7;font-family:'Segoe UI',sans-serif;z-index:9999;text-align:center;
      backdrop-filter:blur(4px);
    }
    #popupOverlay .spinner{
      border:4px solid #4fc3f7;border-top-color:transparent;border-radius:50%;
      width:90px;height:90px;margin-bottom:25px;
      animation:spin 1.3s linear infinite;
      box-shadow:0 0 15px rgba(79,195,247,0.6);
    }
    @keyframes spin{to{transform:rotate(360deg)}}
  </style>
</head>
<body>
  <header>üõ∞Ô∏è Console IA J.E.A.N ‚Äì TINSFLASH (Cockpit)</header>

  <nav>
    <a href="admin-alerts.html">Alertes</a>
    <a href="admin-chat.html">Chat</a>
    <a href="admin-radar.html">Radar</a>
    <a href="admin-users.html">Utilisateurs</a>
    <a href="index.html">Index</a>
  </nav>

  <main>
    <div class="section">
      <h2>üß† Commandes moteur</h2>
      <button class="btn" onclick="runExtraction()">‚ö° Extraction</button>
      <button class="btn" onclick="runIAJEAN()">üß† Analyse IA J.E.A.N.</button>
      <button class="btn" onclick="integrateAlerts()">‚ö° Int√©grer alertes IA ‚Üí moteur</button>
      <button class="btn" onclick="refreshStatus()">üîÑ Rafra√Æchir</button>
    </div>

    <div class="section">
      <h2>‚öôÔ∏è √âtat du moteur</h2>
      <div id="engineStatus">Chargement...</div>
    </div>

    <div class="section grid">
      <div><h2>üåç Carte pr√©visions</h2><div id="map-forecast"></div></div>
      <div><h2>üåã Carte alertes</h2><div id="map-alerts"></div></div>
    </div>

    <div class="section">
      <h2>üìú Logs moteur</h2>
      <div id="logStream">Connexion...</div>
    </div>
  </main>

  <script>
    const API="/api";
    const logDiv=document.getElementById("logStream");

    // === Flux SSE ===
    function startLogStream(){
      const evt=new EventSource(`${API}/logs/stream`);
      evt.onmessage=(e)=>{
        try{
          const d=JSON.parse(e.data);
          const t=new Date(d.timestamp).toLocaleTimeString();
          logDiv.innerHTML+=`<div>[${t}] [${d.level.toUpperCase()}][${d.module}] ${d.message}</div>`;
          logDiv.scrollTop=logDiv.scrollHeight;
        }catch{}
      };
      evt.onerror=()=>logDiv.innerHTML+="<div>‚ö†Ô∏è Flux SSE interrompu...</div>";
    }

    // === Status moteur ===
    async function refreshStatus(){
      const e=document.getElementById("engineStatus");
      e.innerHTML="Mise √† jour...";
      try{
        const r=await fetch(`${API}/status`);
        const d=await r.json();
        e.innerHTML=`<b>Statut:</b> ${d.status}<br>
        <b>Dernier run:</b> ${new Date(d.lastRun).toLocaleString()}<br>
        <b>Alertes actives:</b> ${d.alerts?.length||0}<br>
        <b>Zones couvertes:</b> ${d.coveredZones?.length||0}`;
      }catch(err){e.innerHTML="‚ùå "+err.message;}
    }

    // === Popups anim√©s ===
    function showPopup(t,st=""){
      const o=document.createElement("div");
      o.id="popupOverlay";
      o.innerHTML=`<div class='spinner'></div><h3>${t}</h3><small>${st}</small>`;
      document.body.appendChild(o);
    }
    function closePopup(){const p=document.getElementById("popupOverlay");if(p)p.remove();}

    // === Extraction ===
    async function runExtraction(){
      showPopup("‚öôÔ∏è Extraction en cours...","Fusion des mod√®les r√©els GFS / ECMWF / ICON / NASA");
      try{
        const r=await fetch(`${API}/run-global`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({zone:"All"})});
        const d=await r.json();closePopup();
        if(!d.success)throw new Error(d.error||"Erreur inconnue");
        alert("‚úÖ Extraction compl√®te r√©ussie !");
        refreshStatus();
      }catch(e){closePopup();alert("‚ùå "+e.message);}
    }

    // === IA J.E.A.N ===
    async function runIAJEAN(){
      showPopup("üß† Analyse IA J.E.A.N. en cours...","Fusion IA / mod√®les / relief / climat");
      try{
        const r=await fetch(`${API}/ai-analyse`,{method:"POST"});
        const d=await r.json();closePopup();
        if(!d.success)throw new Error(d.error||"Erreur inconnue");
        alert("‚úÖ Analyse IA J.E.A.N. termin√©e !");
        refreshStatus();
      }catch(e){closePopup();alert("‚ùå "+e.message);}
    }

    // === Int√©gration alertes ===
    async function integrateAlerts(){
      showPopup("‚ö° Int√©gration des alertes IA...","Mise √† jour du moteur en cours");
      try{
        const r=await fetch(`${API}/alerts`);
        const d=await r.json();closePopup();
        if(!Array.isArray(d))throw new Error("Aucune alerte disponible");
        alert(`‚úÖ ${d.length} alertes int√©gr√©es !`);
      }catch(e){closePopup();alert("‚ùå "+e.message);}
    }

    // === Cartes ===
    function initMaps(){
      const f=L.map("map-forecast").setView([30,10],2);
      const a=L.map("map-alerts").setView([30,10],2);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(f);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(a);
    }

    document.addEventListener("DOMContentLoaded",()=>{
      initMaps();
      startLogStream();
      refreshStatus();
    });
  </script>
</body>
</html>
