<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>üö® Console Admin ‚Äì TINSFLASH</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body { margin:0; font-family:"Segoe UI", sans-serif; background:#0d1117; color:#e6edf3; }
    header { background:#161b22; padding:8px; text-align:center; }
    header h1 { margin:0; font-size:1.5rem; color:#00bfff; }
    main { display:grid; grid-template-columns:1fr 1fr; gap:10px; padding:10px; }

    .card {
      background:#1c2128; border-radius:10px; padding:10px;
      box-shadow:0 2px 6px rgba(0,0,0,0.4);
    }
    h2 { font-size:1.1rem; margin-top:0; color:#00bfff; }
    button { background:#00bfff; border:none; padding:6px 10px; border-radius:6px; cursor:pointer; margin:2px; }
    button:hover { background:#008ccc; }

    table { width:100%; border-collapse:collapse; margin-top:6px; font-size:0.9rem; }
    th, td { border:1px solid #333; padding:6px; text-align:left; }
    th { background:#222; }
    .ok { color:#2ecc71; font-weight:bold; }
    .fail { color:#f55; font-weight:bold; }
    .pending { color:#ff9900; font-weight:bold; }

    /* Chat moteur */
    #chatBubble {
      position:fixed; bottom:80px; right:15px;
      width:320px; height:380px;
      display:none; flex-direction:column;
      background:#1c2128; border-radius:10px;
      box-shadow:0 2px 10px rgba(0,0,0,0.5);
      z-index:1000;
    }
    #chatHeader {
      background:#00bfff; color:#fff;
      padding:6px; border-radius:10px 10px 0 0;
      font-size:0.9rem; font-weight:bold;
    }
    #chatLog {
      flex:1; padding:6px; overflow-y:auto;
      font-size:0.85rem; line-height:1.3;
    }
    #chatInput { display:flex; }
    #chatMsg {
      flex:1; border:none; padding:6px; font-size:0.85rem;
    }
    #chatSend {
      background:#00bfff; color:#fff;
      border:none; padding:6px 10px; cursor:pointer;
    }
    #chatToggle {
      position:fixed; bottom:20px; right:20px;
      width:55px; height:55px;
      background:#00bfff; border-radius:50%;
      display:flex; align-items:center; justify-content:center;
      font-size:1.5rem; color:#fff; cursor:pointer;
      box-shadow:0 2px 6px rgba(0,0,0,0.5);
    }
  </style>
</head>
<body>
  <header>
    <h1>üö® Console Admin ‚Äì TINSFLASH</h1>
  </header>

  <main>
    <div class="card">
      <h2>‚ö° Lancement moteur</h2>
      <button onclick="runGlobal('Europe')">üåç Run Europe</button>
      <button onclick="runGlobal('USA')">üá∫üá∏ Run USA</button>
      <button onclick="runGlobal('All')">üåê Run Global (Orchestre)</button>
    </div>

    <div class="card">
      <h2>üìä √âtat du moteur</h2>
      <p>Dernier run : <span id="lastRun">‚Äî</span></p>
      <table id="statusTable">
        <thead>
          <tr><th>Phase</th><th>Statut</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="card" style="grid-column:span 2;">
      <h2>üö® Alertes actives</h2>
      <ul id="alertsList">‚è≥ Chargement...</ul>
    </div>
  </main>

  <!-- Chat IA Moteur -->
  <div id="chatBubble">
    <div id="chatHeader">ü§ñ Chat IA Moteur</div>
    <div id="chatLog"></div>
    <div id="chatInput">
      <input type="text" id="chatMsg" placeholder="Demander au moteur..."/>
      <button id="chatSend">Envoyer</button>
    </div>
  </div>
  <div id="chatToggle" onclick="toggleChat()">üí¨</div>

  <!-- Audio alerte -->
  <audio id="alertSound">
    <source src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg" type="audio/ogg">
  </audio>

  <script>
    // Toggle chat
    function toggleChat(){
      const c=document.getElementById("chatBubble");
      c.style.display=c.style.display==="flex"?"none":"flex";
    }

    // Envoi au moteur IA
    async function sendChat(){
      const input=document.getElementById("chatMsg");
      const msg=input.value.trim();
      if(!msg) return;
      const log=document.getElementById("chatLog");
      log.innerHTML+=`<div><b>Moi:</b> ${msg}</div>`;
      input.value="";

      try {
        const res=await fetch("/api/chat/engine",{
          method:"POST", headers:{"Content-Type":"application/json"},
          body:JSON.stringify({message:msg})
        });
        const data=await res.json();
        let reply=data.reply||"‚ö†Ô∏è Pas de r√©ponse moteur";

        let css="color:#0af;";
        if(/fail/i.test(reply)){ css="color:#f55; font-weight:bold;"; playAlert(); }
        else if(/pending/i.test(reply)) css="color:#ff9900; font-weight:bold;";
        else if(/ok/i.test(reply)) css="color:#2ecc71; font-weight:bold;";

        log.innerHTML+=`<div style="${css}"><b>Moteur:</b> ${reply}</div>`;
        log.scrollTop=log.scrollHeight;
      } catch(e){
        log.innerHTML+=`<div style="color:#f55;"><b>Moteur:</b> ‚ö†Ô∏è Erreur serveur: ${e.message}</div>`;
      }
    }
    document.getElementById("chatSend").addEventListener("click", sendChat);
    document.getElementById("chatMsg").addEventListener("keypress", e=>{ if(e.key==="Enter") sendChat(); });

    // Son alerte
    function playAlert(){
      const snd=document.getElementById("alertSound");
      snd.currentTime=0; snd.play().catch(()=>{});
    }

    // Run global
    async function runGlobal(zone){
      try{
        await fetch("/api/run-global",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({zone})});
      }catch(e){ alert("‚ùå Erreur run: "+e.message); }
    }

    // Auto refresh √©tat moteur
    async function refreshStatus(){
      try{
        const res=await fetch("/api/status");
        const data=await res.json();
        document.getElementById("lastRun").textContent=data.lastRun || "‚Äî";

        const tbody=document.querySelector("#statusTable tbody");
        tbody.innerHTML="";
        Object.entries(data.steps||{}).forEach(([phase,stat])=>{
          let cls=""; if(/fail/i.test(stat)) cls="fail"; else if(/pending/i.test(stat)) cls="pending"; else if(/ok/i.test(stat)) cls="ok";
          tbody.innerHTML+=`<tr><td>${phase}</td><td class="${cls}">${stat}</td></tr>`;
        });
      }catch(e){
        document.getElementById("lastRun").textContent="‚ùå Erreur";
      }
    }

    // Auto refresh alertes
    async function refreshAlerts(){
      try{
        const res=await fetch("/api/alerts");
        const data=await res.json();
        const list=document.getElementById("alertsList");
        list.innerHTML="";
        if(!data || data.length===0){ list.innerHTML="<li>Aucune alerte active</li>"; return; }
        data.forEach(a=>{
          list.innerHTML+=`<li>[${a.country||"?"}] ${a.type||"?"} ‚Äì ${a.data?.status||"?"} (${a.data?.confidence||0}%)</li>`;
        });
      }catch(e){
        document.getElementById("alertsList").innerHTML="‚ùå Erreur alerts";
      }
    }

    setInterval(refreshStatus, 10000);
    setInterval(refreshAlerts, 12000);
    refreshStatus();
    refreshAlerts();
  </script>
</body>
</html>
