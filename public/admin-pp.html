<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>‚ö° Centrale Nucl√©aire M√©t√©o ‚Äì Console Admin</title>
  <link rel="stylesheet" href="styles.css" />
  <style>
    body { background: #0d1117; color: #fff; font-family: Arial, sans-serif; margin: 0; padding: 0; }
    header { background: #111827; padding: 15px; text-align: center; }
    h1 { color: #3b82f6; margin: 0; }
    section { margin: 20px; padding: 15px; background: #1f2937; border-radius: 10px; }
    h2 { margin-top: 0; }
    button { padding: 8px 16px; margin: 5px; border: none; border-radius: 6px; cursor: pointer; }
    .run-btn { background: #ef4444; color: white; font-size: 16px; margin-bottom: 10px; }
    .run-btn.running { background: #f59e0b; }
    .ok { color: #10b981; font-weight: bold; }
    .fail { color: #ef4444; font-weight: bold; }
    .alert { background: #374151; padding: 10px; border-radius: 8px; margin-bottom: 12px; }
    .auto { border-left: 4px solid #10b981; }
    .manual { border-left: 4px solid #f59e0b; }
    #logs { max-height: 250px; overflow-y: auto; font-size: 14px; background: #0f172a; padding: 10px; border-radius: 6px; }
    footer { margin-top: 30px; padding: 10px; text-align: center; font-size: 12px; color: #9ca3af; }
  </style>
</head>
<body>
  <header>
    <h1>‚ö° Centrale Nucl√©aire M√©t√©o ‚Äì Console Admin</h1>
    <p>Pilotage du moteur m√©t√©o ‚Äì run, logs, checklist, alertes</p>
  </header>

  <!-- 1. Bouton Run -->
  <section>
    <button id="runBtn" class="run-btn">üöÄ Lancer la Centrale (Global + Continental)</button>
    <div id="runStatus"></div>
  </section>

  <!-- 2. Checklist -->
  <section>
    <h2>üìã Checklist moteur</h2>
    <ul id="checklist"></ul>
  </section>

  <!-- 3. Logs -->
  <section>
    <h2>üìú Logs en direct</h2>
    <div id="logs"><p>‚è≥ En attente de nouveaux logs...</p></div>
  </section>

  <!-- 4. Alertes -->
  <section>
    <h2>üö® Alertes Primeur / √Ä valider / √Ä surveiller</h2>
    <div id="alerts">Chargement...</div>
  </section>

  <footer>
    ¬© Tinsflash ‚Äì Syst√®me J.E.A.N. by Pydaris ‚Äì Reproduction interdite
  </footer>

  <script>
    // === Bouton Run ===
    document.getElementById("runBtn").addEventListener("click", async () => {
      const btn = document.getElementById("runBtn");
      btn.classList.add("running");
      btn.innerText = "‚è≥ Lancement en cours...";
      document.getElementById("runStatus").innerText = "";

      try {
        const res = await fetch("/api/run-global", { method: "POST" });
        const data = await res.json();
        document.getElementById("runStatus").innerText = "‚úÖ Centrale lanc√©e avec succ√®s";
      } catch (err) {
        document.getElementById("runStatus").innerText = "‚ùå Erreur de lancement : " + err.message;
      } finally {
        btn.classList.remove("running");
        btn.innerText = "üöÄ Lancer la Centrale (Global + Continental)";
      }
    });

    // === Checklist ===
    async function loadChecklist() {
      try {
        const res = await fetch("/api/checkup");
        const data = await res.json();
        const list = document.getElementById("checklist");
        list.innerHTML = "";
        Object.entries(data).forEach(([key, value]) => {
          const li = document.createElement("li");
          li.innerHTML = `${key}: <span class="${value === 'OK' ? 'ok' : 'fail'}">${value}</span>`;
          list.appendChild(li);
        });
      } catch {
        document.getElementById("checklist").innerHTML = "<li class='fail'>Erreur chargement checklist</li>";
      }
    }

    // === Logs SSE ===
    function connectLogs() {
      const logDiv = document.getElementById("logs");
      logDiv.innerHTML = "<p>‚è≥ En attente de nouveaux logs...</p>";

      const evtSource = new EventSource("/api/logs/stream");
      evtSource.onmessage = (event) => {
        const logs = JSON.parse(event.data);
        if (logDiv.innerHTML.includes("En attente")) logDiv.innerHTML = "";

        logs.forEach(log => {
          const p = document.createElement("p");
          const ts = log.timestamp ? new Date(log.timestamp).toLocaleString() : "‚è≥";
          p.textContent = `[${ts}] ${log.message || "‚Äî"}`;
          logDiv.appendChild(p);
          logDiv.scrollTop = logDiv.scrollHeight;
        });
      };
      evtSource.onerror = () => {
        logDiv.innerHTML += "<p style='color:red'>‚ùå Connexion SSE perdue, reconnexion...</p>";
        setTimeout(connectLogs, 5000);
      };
    }

    // === Alertes Primeur ===
    async function loadAlerts() {
      try {
        const res = await fetch("/api/alerts");
        const data = await res.json();
        const alertsDiv = document.getElementById("alerts");
        alertsDiv.innerHTML = "";

        if (!data.alerts || data.alerts.length === 0) {
          alertsDiv.innerHTML = "<p>Aucune alerte d√©tect√©e.</p>";
        } else {
          data.alerts.forEach(alert => {
            const reliability = alert.reliability || 0;
            if (reliability >= 70) {
              const div = document.createElement("div");
              div.className = "alert " + (reliability >= 90 ? "auto" : "manual");
              div.innerHTML = `
                <strong>${alert.zone || "Zone inconnue"}</strong><br>
                Type: ${alert.type || "N/A"}<br>
                Fiabilit√©: ${reliability}%<br>
                D√©but: ${alert.start || "?"} ‚Äì Fin: ${alert.end || "?"}<br>
                Cons√©quences: ${alert.consequences || "?"}<br>
                Recommandations: ${alert.recommendations || "?"}<br>
              `;

              if (reliability >= 90) {
                div.innerHTML += "<p class='ok'>‚úÖ Publi√©e automatiquement (fiabilit√© ‚â• 90%)</p>";
              } else {
                div.innerHTML += `
                  <button onclick="validateAlert('${alert._id}')">‚úÖ Publier</button>
                  <button onclick="delayAlert('${alert._id}')">‚è≥ En attente</button>
                  <button onclick="watchAlert('${alert._id}')">üëÅ Garder √† l'≈ìil</button>
                `;
              }
              alertsDiv.appendChild(div);
            }
          });
        }
      } catch {
        document.getElementById("alerts").innerHTML = "<p class='fail'>Erreur chargement alertes</p>";
      }
    }

    // Actions alertes
    async function validateAlert(id) { await fetch(`/api/alerts/${id}/validate`, { method: "POST" }); loadAlerts(); }
    async function delayAlert(id) { await fetch(`/api/alerts/${id}/delay`, { method: "POST" }); loadAlerts(); }
    async function watchAlert(id) { await fetch(`/api/alerts/${id}/watch`, { method: "POST" }); loadAlerts(); }

    // Auto-refresh
    loadChecklist();
    loadAlerts();
    connectLogs();
    setInterval(() => { loadChecklist(); loadAlerts(); }, 10000);
  </script>
</body>
</html>
