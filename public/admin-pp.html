<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="robots" content="noindex, nofollow" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Console Admin - Centrale Nucl√©aire M√©t√©o</title>
  <style>
    body { font-family: Arial, sans-serif; background: #0d1117; color: #e6edf3; margin: 0; padding: 20px; }
    h1 { color: #58a6ff; }
    button { margin: 5px; padding: 8px 12px; background: #238636; border: none; color: white; border-radius: 5px; cursor: pointer; }
    button.danger { background: #d73a49; }
    .logs, .checklist, .alerts { margin-top: 20px; }
    .log-line { font-size: 0.9em; border-bottom: 1px solid #30363d; padding: 2px; }
    .accordion { background: #161b22; border: 1px solid #30363d; border-radius: 5px; margin-bottom: 10px; }
    .accordion-header { padding: 10px; cursor: pointer; font-weight: bold; }
    .accordion-content { display: none; padding: 10px; border-top: 1px solid #30363d; }
    .status-new { color: orange; }
    .status-validated { color: lightgreen; }
    .status-ignored { color: gray; }
  </style>
</head>
<body>
  <h1>‚ö° Centrale Nucl√©aire M√©t√©o ‚Äì Console Admin</h1>
  
  <button onclick="launchRun()">üöÄ Lancer la Centrale (Global + Continental)</button>

  <div class="checklist">
    <h2>üìã Checklist moteur</h2>
    <pre id="checkup">Chargement...</pre>
  </div>

  <div class="alerts">
    <h2>üö® Alertes d√©tect√©es</h2>
    <div id="alerts"></div>
  </div>

  <div class="logs">
    <h2>üìú Logs en direct</h2>
    <div id="logs"></div>
  </div>

  <script>
    async function launchRun() {
      await fetch("/api/run-global", { method: "POST", headers: { "Content-Type": "application/json" }});
      await fetch("/api/run-continental", { method: "POST", headers: { "Content-Type": "application/json" }});
      loadAlerts();
    }

    // üîé Charger les alertes
    async function loadAlerts() {
      const res = await fetch("/api/alerts");
      const data = await res.json();
      const container = document.getElementById("alerts");
      container.innerHTML = "";
      if (!data.alerts || data.alerts.length === 0) {
        container.innerHTML = "<p>Aucune alerte active.</p>";
        return;
      }
      data.alerts.forEach(alert => {
        const acc = document.createElement("div");
        acc.className = "accordion";

        const header = document.createElement("div");
        header.className = "accordion-header " + "status-" + alert.status;
        header.textContent = `${alert.type} (${alert.reliability}%) ‚Äì ${alert.continent || alert.country} [${alert.status}]`;
        header.onclick = () => {
          content.style.display = content.style.display === "block" ? "none" : "block";
        };

        const content = document.createElement("div");
        content.className = "accordion-content";
        content.innerHTML = `
          <p><b>Zones :</b> ${alert.details?.zones?.join(", ") || "-"}</p>
          <p><b>Intensit√© :</b> ${alert.details?.intensity || "-"}</p>
          <p><b>D√©but :</b> ${alert.details?.start || "-"}</p>
          <p><b>Fin :</b> ${alert.details?.end || "-"}</p>
          <p><b>Cons√©quences :</b> ${(alert.details?.consequences || []).join(", ")}</p>
          <p><b>Recommandations :</b> ${(alert.details?.recommendations || []).join(", ")}</p>
          <button onclick="updateAlert('${alert.id}', 'validate')">‚úÖ Valider</button>
          <button class="danger" onclick="updateAlert('${alert.id}', 'ignore')">‚ùå Ignorer</button>
        `;

        acc.appendChild(header);
        acc.appendChild(content);
        container.appendChild(acc);
      });
    }

    async function updateAlert(id, action) {
      await fetch(`/api/alerts/${id}/${action}`, { method: "POST" });
      loadAlerts();
    }

    // üìú Logs SSE
    const logsDiv = document.getElementById("logs");
    const evtSource = new EventSource("/api/logs/stream");
    evtSource.onmessage = function (event) {
      const logs = JSON.parse(event.data);
      logsDiv.innerHTML = logs.map(l => `<div class="log-line">${l}</div>`).join("");
    };

    // ‚úÖ Checklist refresh
    async function refreshCheckup() {
      const res = await fetch("/api/checkup");
      const data = await res.json();
      document.getElementById("checkup").textContent = JSON.stringify(data, null, 2);
    }
    setInterval(refreshCheckup, 5000);

    // Charge au d√©marrage
    loadAlerts();
    refreshCheckup();
  </script>
</body>
</html>
