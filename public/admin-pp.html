<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="robots" content="noindex,nofollow" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TINSFLASH ‚Äì Console Moteur IA J.E.A.N.</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <style>
    body {
      background:#020818;
      color:#d4e7ff;
      font-family: "Orbitron", sans-serif;
      margin:0;
      overflow:hidden;
    }
    header {
      background:linear-gradient(90deg,#00224e,#004ba8);
      padding:1rem;
      text-align:center;
      font-size:1.5rem;
      color:#fff;
      text-shadow:0 0 10px #00eaff;
    }
    .controls {
      display:flex;
      justify-content:center;
      gap:1rem;
      margin-top:1rem;
    }
    button {
      background:#001f3f;
      color:#00eaff;
      border:1px solid #00eaff;
      border-radius:8px;
      padding:0.7rem 1.2rem;
      cursor:pointer;
      font-weight:bold;
      transition:0.3s;
    }
    button:hover { background:#00eaff; color:#001f3f; }
    #mapForecast, #mapAlerts {
      height:45vh;
      margin:1rem;
      border:2px solid #00eaff;
      border-radius:10px;
    }
    .logs {
      background:#000c1e;
      height:18vh;
      overflow-y:auto;
      padding:0.5rem;
      border-top:1px solid #00eaff;
      font-size:0.85rem;
    }
    .chat-bubble {
      position:fixed;
      bottom:20px;
      right:20px;
      background:#002850;
      color:#00eaff;
      border-radius:50%;
      width:60px; height:60px;
      display:flex; align-items:center; justify-content:center;
      font-size:1.4rem;
      box-shadow:0 0 20px #00eaff;
      cursor:pointer;
    }
  </style>
</head>
<body>
  <header>üåç TINSFLASH ‚Äì IA J.E.A.N. Central Cockpit</header>

  <div class="controls">
    <button onclick="runEngine('EU')">Run Europe</button>
    <button onclick="runEngine('US')">Run USA</button>
    <button onclick="runWorld()">Run World Alerts</button>
    <button onclick="runAI()">IA Analyse</button>
    <button onclick="stopEngine()">üõë Arr√™t</button>
    <button onclick="resetEngine()">‚ôªÔ∏è Reset</button>
  </div>

  <div id="mapForecast"></div>
  <div id="mapAlerts"></div>
  <div class="logs" id="logs"></div>

  <div class="chat-bubble" onclick="toggleChat()">üí¨</div>

  <script>
    const logBox = document.getElementById("logs");
    const forecastMap = L.map("mapForecast").setView([50, 10], 4);
    const alertMap = L.map("mapAlerts").setView([20, 0], 2);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", { attribution:"TINSFLASH" }).addTo(forecastMap);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", { attribution:"TINSFLASH" }).addTo(alertMap);

    const colors = { primeur:"#0066ff", confirm:"#00ff7f", valider:"#ffcc00", surveiller:"#ff0033" };
    let layers = { primeur:L.layerGroup().addTo(alertMap), confirm:L.layerGroup().addTo(alertMap),
                   valider:L.layerGroup().addTo(alertMap), surveiller:L.layerGroup().addTo(alertMap) };

    async function runEngine(zone){
      appendLog(`‚ñ∂Ô∏è Lancement ${zone}`);
      await axios.post("/api/runGlobal", { zone });
      appendLog("‚úÖ Termin√© "+zone);
    }
    async function runWorld(){
      appendLog("üåê Lancement World Alerts");
      await axios.post("/api/runWorldAlerts");
      appendLog("‚úÖ Alertes Monde trait√©es");
      refreshAlerts();
    }
    async function runAI(){
      appendLog("ü§ñ IA Analyse en cours‚Ä¶");
      await axios.post("/api/ai-analyse");
      appendLog("‚úÖ IA J.E.A.N. termin√©");
      refreshForecast();
    }
    async function stopEngine(){ await axios.post("/api/stop-extraction"); appendLog("üõë Moteur arr√™t√©"); }
    async function resetEngine(){ await axios.post("/api/reset-stop-extraction"); appendLog("‚ôªÔ∏è Reset complet"); }

    function appendLog(msg){
      const time = new Date().toLocaleTimeString();
      logBox.innerHTML += `<div>[${time}] ${msg}</div>`;
      logBox.scrollTop = logBox.scrollHeight;
    }

    async function refreshForecast(){
      const res = await axios.get("/api/forecasts");
      forecastMap.eachLayer((l)=>{ if(l instanceof L.CircleMarker) forecastMap.removeLayer(l); });
      res.data.forEach(f=>{
        const color = f.reliability>=0.9?colors.confirm:(f.reliability>=0.7?colors.valider:colors.surveiller);
        L.circleMarker([f.lat,f.lon],{radius:6,color,fillOpacity:0.6}).bindTooltip(
          `Fiabilit√©: ${Math.round(f.reliability*100)}%<br>${f.temperature}¬∞C<br>${f.precipitation}mm`
        ).addTo(forecastMap);
      });
    }

    async function refreshAlerts(){
      const res = await axios.get("/api/alerts");
      Object.values(layers).forEach(l=>l.clearLayers());
      res.data.forEach(a=>{
        let color = a.isPrimeur?colors.primeur:(a.reliability>=0.9?colors.confirm:(a.reliability>=0.7?colors.valider:colors.surveiller));
        L.circleMarker([a.lat,a.lon],{radius:8,color,fillOpacity:0.8})
          .bindPopup(`<b>${a.type}</b><br>${Math.round(a.reliability*100)}%<br>${a.country}`)
          .addTo(a.isPrimeur?layers.primeur:(a.reliability>=0.9?layers.confirm:(a.reliability>=0.7?layers.valider:layers.surveiller)));
      });
    }

    function toggleChat(){ window.open("/admin-chat.html","chat","width=400,height=600"); }
    refreshForecast(); refreshAlerts();
  </script>
</body>
</html>
