<!-- PATH: public/admin-pp.html -->
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="robots" content="noindex,nofollow" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>üõ∞Ô∏è Console IA J.E.A.N ‚Äì TINSFLASH</title>
  <link href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" rel="stylesheet" />
  <style>
    body{font-family:Inter,system-ui,Arial;background:#0b0f19;color:#eaeaea;margin:0}
    header{background:#111831;padding:15px;text-align:center;color:#4fc3f7;font-size:22px;font-weight:bold}
    nav{background:#1a2238;padding:10px;display:flex;justify-content:center;gap:15px;flex-wrap:wrap}
    nav a{color:#ccc;text-decoration:none;font-weight:600}nav a:hover{color:#4fc3f7}
    main{padding:15px}h2{color:#4fc3f7;border-bottom:1px solid #333;padding-bottom:6px;margin-top:25px}
    .status-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:10px;margin-top:10px}
    .status-box{background:#1a2238;padding:10px;border-radius:8px;text-align:center}
    .status-box span{display:block;margin-top:4px;font-size:13px;color:#aaa}
    button{background:#4fc3f7;color:#000;border:none;border-radius:6px;padding:8px 15px;cursor:pointer;font-weight:bold}
    button:hover{background:#0288d1}
    .btn-secondary{background:#8bc34a;color:#000} .btn-danger{background:#ef5350;color:#fff}
    #summaryTable{width:100%;margin-top:10px;border-collapse:collapse;font-size:14px}
    #summaryTable th,#summaryTable td{border:1px solid #333;padding:6px;text-align:center}
    #summaryTable th{background:#1a2238;color:#4fc3f7}
    #logs{background:#111;border-radius:8px;padding:10px;height:220px;overflow-y:auto;font-size:13px;margin-top:10px}
    #errors{background:#260000;border-radius:8px;padding:10px;margin-top:10px;color:#ffbaba;font-size:13px;display:none}
    #mapForecast,#mapAlerts{height:380px;margin-top:10px;border-radius:8px}
    .chat-float{position:fixed;bottom:15px;right:15px;width:280px;background:#111831;border-radius:10px;box-shadow:0 0 12px #000;overflow:hidden}
    .chat-header{background:#4fc3f7;color:#000;font-weight:bold;padding:8px;text-align:center;cursor:pointer}
    .chat-body{display:none;flex-direction:column;height:260px}
    .chat-messages{flex:1;overflow-y:auto;padding:8px;font-size:13px}
    .chat-input{display:flex;gap:5px;padding:8px;background:#0b0f19}
    .chat-input input{flex:1;padding:6px;border-radius:6px;border:1px solid #555;background:#111;color:#eee}
    .chat-input button{padding:6px 10px;background:#4fc3f7;border:none;border-radius:6px;cursor:pointer}
    .msg{margin:4px 0;padding:6px 10px;border-radius:6px;max-width:75%}.bot{background:#333;color:#fff}.user{background:#4fc3f7;color:#000;margin-left:auto}
    .bad{color:#ef5350}.ok{color:#66bb6a}.warn{color:#ffca28}
    .actions{display:flex;gap:10px;flex-wrap:wrap;margin:8px 0}
    @media(max-width:768px){.chat-float{width:90%;right:5%;bottom:10px}#mapForecast,#mapAlerts{height:280px}}
  </style>
</head>
<body>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
// === S√©curit√© simple ===
const storedPin = sessionStorage.getItem("tinsflashPIN");
if(!storedPin){
  const pin = prompt("Code d‚Äôacc√®s admin ?");
  if(pin!=="202679"){ alert("‚õî Acc√®s refus√©"); location.href="/"; }
  else { sessionStorage.setItem("tinsflashPIN","ok"); }
}

let mapForecast, mapAlerts;

// === Cartes ===
function initMaps(){
  mapForecast=L.map("mapForecast").setView([20,0],2);
  mapAlerts=L.map("mapAlerts").setView([20,0],2);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:"¬© OpenStreetMap"}).addTo(mapForecast);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:"¬© OpenStreetMap"}).addTo(mapAlerts);
}

// === Status moteur ===
async function loadStatus(){
  try{
    const res = await fetch("/api/status");
    const data = await res.json();
    document.getElementById("engineStatus").innerText = data.status || "‚Äì";
    document.getElementById("lastRun").innerText = data.lastRun?new Date(data.lastRun).toLocaleString():"Jamais";
    const cls = data.status?.includes("OK")||data.status==="ok"||data.status==="OK-EXTRACTED" ? "ok" : (data.status==="fail"||data.status==="FAIL"?"bad":"warn");
    document.getElementById("engineStatus").className = cls;

    // Partiel: synth√®se extraction
    const pr = data.partialReport || {};
    const models = pr.models || {};
    const rows = [];
    for(const [m,st] of Object.entries(models)){
      rows.push(`<tr><td>${m}</td><td>${st.ok}</td><td>${st.fail}</td></tr>`);
    }
    document.getElementById("modelsBody").innerHTML = rows.join("") || "<tr><td colspan='3'>Aucun mod√®le extrait</td></tr>";

    // recap alertes
    const s = {
      local: data?.alerts?.length || 0,
      continental: (data?.alertsContinental||[]).length || 0,
      world: (data?.alertsWorld||[]).length || 0
    };
    document.getElementById("summaryBody").innerHTML = `
      <tr><td>Locales/Nationales</td><td>${s.local}</td></tr>
      <tr><td>Continentales</td><td>${s.continental}</td></tr>
      <tr><td>Mondiales (fusion)</td><td>${s.world}</td></tr>
    `;
  }catch(e){ console.error(e); }
}

// === Logs SSE ===
const evtSource = new EventSource("/api/logs/stream");
evtSource.onmessage = e => {
  const log = JSON.parse(e.data);
  const div = document.getElementById("logs");
  const line = document.createElement("div");
  line.textContent = `[${new Date(log.timestamp||log.ts).toLocaleTimeString()}] ${log.message}`;
  div.appendChild(line);
  div.scrollTop = div.scrollHeight;
};

// === Erreurs ===
async function loadErrors(){
  try{
    const res = await fetch("/api/status");
    const data = await res.json();
    if(data.engineErrors?.length){
      const box = document.getElementById("errors");
      box.innerHTML = "<b>Erreurs r√©centes :</b><br>"+data.engineErrors.map(e=>`‚Ä¢ ${e.message}`).join("<br>");
      box.style.display="block";
    }
  }catch(e){ console.error(e); }
}

// === Carte pr√©visions (voyants pays) ===
async function updateMapForecast(){
  mapForecast.eachLayer(l=>{ if(l instanceof L.CircleMarker) mapForecast.removeLayer(l); });
  try{
    const res = await fetch("/api/status");
    const data = await res.json();
    const pr = data.partialReport || {};
    const countriesOK = new Set(pr.extraction?.countriesOK||[]);
    const countriesFail = new Set(pr.extraction?.countriesFail||[]);
    // On projette un point par pays (simplifi√©: lat/lon m√©dian si dispo c√¥t√© back plus tard)
    const all = [...countriesOK].map(c=>({c,ok:true})).concat([...countriesFail].map(c=>({c,ok:false})));
    all.forEach(e=>{
      // couleurs voyant
      const col = e.ok ? "#4caf50" : "#ef5350";
      // Fallback lat/lon approximatifs par centre monde si pas dispo ‚Äî la popup suffit
      L.circleMarker([0,0],{radius:6,color:col,fillOpacity:0.8})
        .addTo(mapForecast)
        .bindPopup(`<b>${e.c}</b><br>${e.ok?"Pr√©visions OK":"Erreur d'extraction"}`);
    });
  }catch(e){ console.error(e); }
}

// === Carte alertes monde ===
async function updateMapAlerts(){
  mapAlerts.eachLayer(l=>{ if(l instanceof L.CircleMarker) mapAlerts.removeLayer(l); });
  try{
    const res = await fetch("/api/alerts");
    const alerts = await res.json();
    alerts.forEach(a=>{
      const col = a.severity==="extreme"?"#ff0000":a.severity==="high"?"#ff9800":"#4caf50";
      const lat = a.lat || a.latitude || 0, lon = a.lon || a.longitude || 0;
      L.circleMarker([lat,lon],{radius:7,color:col,fillOpacity:0.8})
        .addTo(mapAlerts)
        .bindPopup(`<b>${a.region||a.country}</b><br>${a.title}<br>Fiabilit√©: ${a.certainty??"?"}%`);
    });
  }catch(e){ console.error(e); }
}

// === Boutons ===
async function runExtraction(){
  const btn=document.getElementById("runBtn");
  btn.disabled=true; btn.innerText="‚è≥ Extraction...";
  const r = await fetch("/api/run-global",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({zone:"All"})});
  const d = await r.json();
  alert(d.success?"‚úÖ Extraction termin√©e":"‚ùå √âchec extraction");
  btn.disabled=false; btn.innerText="‚ö° Lancer Extraction (sans IA)";
  refreshAll();
}

async function runAI(){
  const btn=document.getElementById("aiBtn");
  btn.disabled=true; btn.innerText="‚è≥ IA J.E.A.N...";
  const r = await fetch("/api/ai-analyse",{method:"POST"});
  const d = await r.json();
  alert(d.success?"‚úÖ IA J.E.A.N termin√©e":"‚ùå Erreur IA: "+(d.error||""));
  btn.disabled=false; btn.innerText="üß† Lancer Analyse IA J.E.A.N.";
  refreshAll();
}

// === Rafra√Æchissements manuels par section ===
async function refreshSection(section){
  if(section==="status") loadStatus();
  if(section==="forecast") updateMapForecast();
  if(section==="alerts") updateMapAlerts();
  if(section==="summary") loadStatus();
  if(section==="logs") {/* SSE en continu, rien √† faire */}
  if(section==="errors") loadErrors();
}

function refreshAll(){
  loadStatus(); updateMapForecast(); updateMapAlerts(); loadErrors();
}

setInterval(refreshAll, 10000);

window.onload = ()=>{
  initMaps();
  refreshAll();
};
</script>

<header>üõ∞Ô∏è Console IA J.E.A.N ‚Äì TINSFLASH</header>
<nav>
  <a href="/admin-pp.html">Console</a>
  <a href="/admin-alerts.html">Alertes</a>
  <a href="/admin-chat.html">Chat</a>
  <a href="/admin-index.html">Vue Index</a>
  <a href="/admin-radar.html">Radar & News</a>
  <a href="/admin-users.html">Utilisateurs</a>
</nav>

<main>
  <div class="actions">
    <button id="runBtn" onclick="runExtraction()">‚ö° Lancer Extraction (sans IA)</button>
    <button id="aiBtn" class="btn-secondary" onclick="runAI()">üß† Lancer Analyse IA J.E.A.N.</button>
    <button onclick="refreshAll()">üîÑ Tout rafra√Æchir</button>
  </div>

  <h2>‚öôÔ∏è √âtat du moteur 
    <button onclick="refreshSection('status')">üîÑ</button>
  </h2>
  <div class="status-grid">
    <div class="status-box"><b>Statut</b><span id="engineStatus" class="warn">‚Äì</span></div>
    <div class="status-box"><b>Dernier run</b><span id="lastRun">Jamais</span></div>
    <div class="status-box"><b>Mod√®les actifs</b><span>GFS, ECMWF, ICON, HRRR, UKMO, DWD, NASA POWER, OpenWeather</span></div>
    <div class="status-box"><b>Pipeline</b><span>Extraction ‚ûú IA (sur ordre)</span></div>
  </div>

  <h2>üìä Mod√®les ‚Äì R√©sum√© extraction 
    <button onclick="refreshSection('summary')">üîÑ</button>
  </h2>
  <table id="summaryTable">
    <thead><tr><th>Type</th><th>Nombre</th></tr></thead>
    <tbody id="summaryBody"><tr><td colspan="2">‚Äì</td></tr></tbody>
  </table>

  <h2>üìö D√©tail par mod√®le (OK/Fail)
    <button onclick="refreshSection('summary')">üîÑ</button>
  </h2>
  <table id="modelsTable">
    <thead><tr><th>Mod√®le</th><th>OK</th><th>Fail</th></tr></thead>
    <tbody id="modelsBody"><tr><td colspan="3">Chargement‚Ä¶</td></tr></tbody>
  </table>

  <h2>üåç Carte pr√©visions (voyants pays)
    <button onclick="refreshSection('forecast')">üîÑ</button>
  </h2>
  <div id="mapForecast"></div>

  <h2>üö® Carte alertes (monde)
    <button onclick="refreshSection('alerts')">üîÑ</button>
  </h2>
  <div id="mapAlerts"></div>

  <h2>üìú Logs moteur (temps r√©el)
    <button onclick="refreshSection('logs')">üîÑ</button>
  </h2>
  <div id="logs"></div>
  <div id="errors"></div>
</main>
</body>
</html>
