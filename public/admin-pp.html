<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="robots" content="noindex,nofollow">
  <title>Console Centrale â€“ TINSFLASH</title>
  <style>
    body { font-family: Arial, sans-serif; background:#0b0e12; color:#eee; margin:0; }
    header { background:#1c1f26; padding:15px; text-align:center; }
    h1 { margin:0; color:#00d8ff; }
    .btn { padding:15px 25px; border:none; border-radius:8px; cursor:pointer; font-size:18px; font-weight:bold; }
    .btn-run { background:#f39c12; color:#000; }
    .status { display:grid; grid-template-columns: repeat(auto-fit,minmax(160px,1fr)); gap:10px; margin:15px; }
    .status div { padding:20px; border-radius:10px; text-align:center; font-weight:bold; font-size:14px; }
    .ok { background:#2ecc71; }
    .fail { background:#e74c3c; }
    .pending { background:#f39c12; }
    .section { padding:15px; }
    .logs { max-height:250px; overflow-y:auto; background:#111; padding:10px; border-radius:8px; font-family: monospace; }
    .log-line { margin:3px 0; }
    pre { background:#111; padding:10px; border-radius:8px; max-height:300px; overflow-y:auto; }
    h2 { border-bottom:1px solid #333; padding-bottom:5px; color:#00d8ff; }
    .userbox { display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:10px; }
    .usercard { background:#1c1f26; padding:10px; border-radius:8px; }
  </style>
</head>
<body>
  <header>
    <h1>âš¡ Centrale NuclÃ©aire MÃ©tÃ©o â€“ Console Admin</h1>
    <button class="btn btn-run" onclick="runGlobal()">ðŸš€ Lancer RUN GLOBAL</button>
  </header>

  <div class="status" id="engineStatus">
    <div id="models" class="pending">Extraction modÃ¨les</div>
    <div id="localForecasts" class="pending">PrÃ©visions locales</div>
    <div id="nationalForecasts" class="pending">PrÃ©visions nationales</div>
    <div id="aiAlerts" class="pending">Alertes IA</div>
    <div id="engine" class="pending">Moteur</div>
  </div>

  <div class="section">
    <h2>ðŸ“œ Logs moteur (live)</h2>
    <div class="logs" id="logs"></div>
  </div>

  <div class="section">
    <h2>ðŸ“Š Rapport final IA</h2>
    <pre id="finalReport">{}</pre>
  </div>

  <div class="section">
    <h2>ðŸš¨ Alertes actives</h2>
    <div id="alerts"></div>
  </div>

  <div class="section">
    <h2>ðŸ‘¥ Utilisateurs par zones</h2>
    <div class="userbox" id="users"></div>
  </div>

  <script>
    async function runGlobal(){
      document.querySelector(".btn-run").style.background="#e74c3c"; // RUNNING = rouge
      await fetch("/api/run-global?zone=All",{method:"POST"});
      setTimeout(()=>{document.querySelector(".btn-run").style.background="#2ecc71";},2000); // repasse vert si ok
    }

    function updateStatus(checkup){
      ["models","localForecasts","nationalForecasts","aiAlerts","engine"].forEach(k=>{
        const el=document.getElementById(k);
        if(!el) return;
        const v=checkup[k]||"PENDING";
        el.className=v.toLowerCase();
      });
    }

    // === Logs SSE ===
    const logBox=document.getElementById("logs");
    const evtSource=new EventSource("/api/logs/stream");
    evtSource.onmessage=function(e){
      const log=JSON.parse(e.data);
      const line=document.createElement("div");
      line.className="log-line";
      line.textContent=`[${log.timestamp}] ${log.message}`;
      logBox.appendChild(line);
      if(logBox.children.length>50) logBox.removeChild(logBox.firstChild);
      logBox.scrollTop=logBox.scrollHeight;
    };

    async function refreshData(){
      const res=await fetch("/api/engine-state");
      const data=await res.json();
      updateStatus(data.checkup || {});
      document.getElementById("finalReport").textContent=JSON.stringify(data.finalReport||{},null,2);

      // Alertes
      const res2=await fetch("/api/alerts");
      const alerts=await res2.json();
      const box=document.getElementById("alerts");
      box.innerHTML="";
      alerts.forEach(a=>{
        let cls="border:2px solid orange;";
        const fiab=parseInt(a.data?.fiabilite||0);
        if(fiab>=90) cls="border:2px solid green;";
        else if(fiab>=70) cls="border:2px solid yellow;";
        const div=document.createElement("div");
        div.style=`padding:10px;margin:5px;${cls}`;
        div.innerHTML=`
          <b>${a.data?.type||"Alerte"}</b> â€“ ${a.country} ${a.region||""}<br/>
          FiabilitÃ©: ${a.data?.fiabilite||"?"}% | IntensitÃ©: ${a.data?.intensite||"?"}<br/>
          ConsÃ©quences: ${a.data?.consequences||"?"}<br/>
          Recommandations: ${a.data?.recommandations||"?"}<br/>
          PÃ©riode: ${a.data?.debut||"?"} â†’ ${a.data?.fin||"?"}
        `;
        box.appendChild(div);
      });

      // Utilisateurs
      const res3=await fetch("/api/users");
      const users=await res3.json();
      const ubox=document.getElementById("users");
      ubox.innerHTML="";
      users.forEach(u=>{
        const div=document.createElement("div");
        div.className="usercard";
        div.innerHTML=`
          <b>${u.name}</b><br/>
          Zone: ${u.zone || "?"}<br/>
          Pays: ${u.country || "?"}
        `;
        ubox.appendChild(div);
      });
    }
    setInterval(refreshData,6000);
    refreshData();
  </script>
</body>
</html>
