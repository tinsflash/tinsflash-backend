<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>üõ∞Ô∏è Console Admin ‚Äì TINSFLASH</title>
  <meta name="robots" content="noindex,nofollow">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: Arial, sans-serif; background:#0a0a0a; color:#eee; margin:0; }
    header { background:#111; padding:1rem; text-align:center; font-size:1.5rem; border-bottom:2px solid #333; }
    section { padding:1rem; border-bottom:1px solid #222; }
    h2 { margin-top:0; color:#4db8ff; }
    button { padding:12px 24px; border:none; border-radius:6px; cursor:pointer; font-size:1rem; font-weight:bold; }
    button.orange { background:#ff9800; color:#000; }
    button.red { background:#f44336; color:#fff; }
    button.green { background:#4caf50; color:#fff; }
    ul { list-style:none; padding:0; }
    li { padding:6px; margin:4px 0; border-radius:4px; }
    .red { background:#330000; color:#f44336; }
    .orange { background:#332200; color:#ff9800; }
    .green { background:#003300; color:#4caf50; }
    #logs { max-height:300px; overflow-y:auto; font-family:monospace; background:#000; padding:1rem; }
    .log-line { border-bottom:1px dotted #333; padding:2px; }
    .alert-card { border:1px solid #555; padding:10px; margin:8px 0; border-radius:6px; background:#1a1a1a; }
    .cat-primeur { border-left:4px solid #4caf50; }
    .cat-valider { border-left:4px solid #ff9800; }
    .cat-auto { border-left:4px solid #2196f3; }
  </style>
</head>
<body>
  <header>‚ö° Centrale Nucl√©aire M√©t√©o ‚Äì Console Admin</header>

  <!-- 1. RUN -->
  <section>
    <h2>üöÄ Lancer RUN</h2>
    <button id="runBtn" onclick="launchRun()">‚ñ∂ Lancer RUN GLOBAL + CONTINENTAL</button>
    <div id="runResult"></div>
  </section>

  <!-- 2. Checklist -->
  <section>
    <h2>üìã Checklist Moteur</h2>
    <ul id="checklist">
      <li id="step1" class="red">1. Extraction mod√®les</li>
      <li id="step2" class="red">2. RUNGLOBAL Europe</li>
      <li id="step3" class="red">3. RUNGLOBAL USA</li>
      <li id="step4" class="red">4. RUN Continentales</li>
      <li id="step5" class="red">5. Mise sous fichier des extractions</li>
      <li id="step6" class="red">6. Analyse IA (relief, climat, environnement)</li>
      <li id="step7" class="red">7. Pr√©visions locales et nationales</li>
      <li id="step8" class="red">8. Alertes locales et nationales</li>
      <li id="step9" class="red">9. Alertes continentales (zones non couvertes)</li>
      <li id="step10" class="red">10. Vue par pays (zones couvertes)</li>
    </ul>
  </section>

  <!-- 3. Logs -->
  <section>
    <h2>üìú Logs en direct</h2>
    <div id="logs">Connexion aux logs...</div>
  </section>

  <!-- 4. Alertes -->
  <section>
    <h2>üö® Alertes</h2>
    <div id="alerts"></div>
  </section>

<script>
  // === RUN BUTTON ===
  async function launchRun(){
    const btn = document.getElementById("runBtn");
    btn.className = "orange";
    btn.innerText = "‚è≥ Lancement en cours...";

    try {
      const res = await fetch("/api/run-global",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({zone:"All"})});
      const data = await res.json();

      // ensuite run continental
      await fetch("/api/run-continental",{method:"POST"});

      btn.className = "green";
      btn.innerText = "‚úÖ RUN termin√© avec succ√®s";
      document.getElementById("runResult").innerText = JSON.stringify(data,null,2);
    } catch(e){
      btn.className = "red";
      btn.innerText = "‚ùå Erreur RUN";
    }
  }

  // === CHECKLIST ===
  async function refreshChecklist(){
    const res = await fetch("/api/engine-state");
    const state = await res.json();
    const mapping = {
      models:"step1",
      europe:"step2",
      usa:"step3",
      continental:"step4",
      files:"step5",
      ai:"step6",
      forecasts:"step7",
      alertsLocal:"step8",
      alertsContinental:"step9",
      perCountry:"step10"
    };
    for (const [key,id] of Object.entries(mapping)){
      const li = document.getElementById(id);
      if (!li) continue;
      if (state.checkup?.[key]==="OK") li.className="green";
      else if (state.checkup?.[key]==="PENDING") li.className="orange";
      else if (state.checkup?.[key]==="FAIL") li.className="red";
    }
  }
  setInterval(refreshChecklist,4000);

  // === LOGS (SSE) ===
  const logsDiv=document.getElementById("logs");
  const evtSource=new EventSource("/api/logs/stream");
  evtSource.onmessage=(e)=>{
    const data=JSON.parse(e.data);
    logsDiv.innerHTML="";
    data.reverse().forEach(l=>{
      const time=new Date(l.timestamp).toLocaleTimeString();
      logsDiv.innerHTML+=`<div class="log-line">[${time}] ${l.message}</div>`;
    });
  };

  // === ALERTES ===
  async function loadAlerts(){
    const res=await fetch("/api/alerts");
    const data=await res.json();
    const div=document.getElementById("alerts");
    div.innerHTML="";
    (data.alerts||[]).forEach(a=>{
      let cat="cat-valider";
      if (a.reliability>=90) cat="cat-auto";
      else if (a.reliability>=70) cat="cat-primeur";
      const card=document.createElement("div");
      card.className="alert-card "+cat;
      card.innerHTML=`<b>${a.type}</b> ‚Äì ${a.zone}<br>
        Fiabilit√©: ${a.reliability || "?"}%<br>
        Intensit√©: ${a.intensity || "?"}<br>
        Cons√©quences: ${a.consequences || ""}<br>
        Recommandations: ${a.recommendations || ""}<br>
        Dur√©e: ${a.start} ‚Üí ${a.end}`;
      div.appendChild(card);
    });
  }
  setInterval(loadAlerts,6000);
  loadAlerts();
</script>
</body>
</html>
