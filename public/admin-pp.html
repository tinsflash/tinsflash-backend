<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>‚ö° Centrale Nucl√©aire M√©t√©o ‚Äì Console Admin</title>
  <style>
    body { background:#111; color:#eee; font-family:Arial, sans-serif; }
    h1 { color:#00bfff; text-align:center; }
    button { background:#ff9800; color:white; padding:10px 20px; border:none; cursor:pointer; border-radius:6px; }
    button:hover { background:#e68900; }
    #logs { background:black; padding:10px; font-family:monospace; height:200px; overflow:auto; border:1px solid #333; }
    .log.green { color:#4caf50; }
    .log.red { color:#f44336; }
    .log.orange { color:#ff9800; }
    .checklist { display:flex; justify-content:center; margin:20px 0; gap:10px; }
    .check-item { padding:10px; border-radius:8px; font-weight:bold; }
    .pending { background:#ff9800; color:#111; }
    .ok { background:#4caf50; color:#fff; }
    .fail { background:#f44336; color:#fff; }
    #engine-status { text-align:center; font-size:18px; margin-top:15px; }
  </style>
</head>
<body>
  <h1>‚ö° Centrale Nucl√©aire M√©t√©o ‚Äì Console Admin</h1>

  <div style="text-align:center; margin:20px;">
    <button onclick="runGlobal()">üöÄ Lancer RUN GLOBAL</button>
  </div>

  <div class="checklist" id="checklist">
    <div id="models" class="check-item pending">Extraction mod√®les</div>
    <div id="localForecasts" class="check-item pending">Pr√©visions locales</div>
    <div id="nationalForecasts" class="check-item pending">Pr√©visions nationales</div>
    <div id="aiAlerts" class="check-item pending">Alertes IA</div>
    <div id="engineStatus" class="check-item pending">Moteur</div>
  </div>

  <h3>üìú Logs moteur (live)</h3>
  <div id="logs"></div>

  <h3>üìä √âtat moteur</h3>
  <div id="engine-status">Chargement...</div>

  <script>
    async function runGlobal() {
      await fetch('/api/run-global', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ zone: "All" })
      });
    }

    // === Logs SSE en direct ===
    const evtSource = new EventSource('/api/logs/stream');
    evtSource.onmessage = function(event) {
      const logs = JSON.parse(event.data);
      const logsDiv = document.getElementById('logs');
      logsDiv.innerHTML = "";
      logs.forEach(l => {
        let cls = "orange";
        if (l.message.includes("‚úÖ")) cls = "green";
        else if (l.message.includes("‚ùå")) cls = "red";
        logsDiv.innerHTML += `<div class="log ${cls}">[${new Date(l.timestamp).toLocaleTimeString()}] ${l.message}</div>`;
      });
      logsDiv.scrollTop = logsDiv.scrollHeight;
    };

    // === Checkup + √©tat moteur ===
    async function refreshState() {
      const res = await fetch('/api/checkup');
      const checkup = await res.json();
      for (const key in checkup) {
        const el = document.getElementById(key);
        if (el) {
          if (checkup[key] === "OK") el.className = "check-item ok";
          else if (checkup[key] === "FAIL") el.className = "check-item fail";
          else el.className = "check-item pending";
        }
      }

      const res2 = await fetch('/api/engine-state');
      const state = await res2.json();
      const eng = document.getElementById("engine-status");
      eng.textContent = `‚è±Ô∏è ${state.status || "inconnu"} | Dernier run: ${state.runTime || "‚Äî"}`;
    }

    setInterval(refreshState, 3000);
    refreshState();
  </script>
</body>
</html>
