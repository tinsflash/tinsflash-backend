<!-- PATH: public/admin-pp.html -->
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="robots" content="noindex,nofollow" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>üõ∞ Centrale de Contr√¥le ‚Äì TINSFLASH</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    body{font-family:"Segoe UI",sans-serif;background:#0b101a;color:#d9e9ff;margin:0;padding:0;text-align:center}
    header{background:#08121d;padding:10px;font-size:22px;font-weight:bold;color:#6bf3ff}
    nav{background:#091626;display:flex;justify-content:center;flex-wrap:wrap;padding:8px;gap:10px}
    nav a{color:#9ad6ff;text-decoration:none;font-weight:600;padding:6px 10px;border-radius:6px}
    nav a:hover{background:#102030;color:#fff}
    button{border:none;border-radius:8px;padding:10px 16px;margin:5px;cursor:pointer;font-weight:600}
    #runBtn{background:#007bff;color:white}
    #aiBtn{background:#28a745;color:white}
    #refreshBtn{background:#17a2b8;color:white}
    #logBox{background:#000;color:#0f0;padding:10px;margin:10px auto;width:95%;height:180px;overflow-y:auto;
      border:1px solid #333;border-radius:8px;text-align:left;font-family:monospace}
    table{margin:10px auto;width:90%;border-collapse:collapse;background:#131a24}
    th,td{padding:6px 8px;border-bottom:1px solid #333;text-align:left}
    th{color:#6bf3ff}
    #mapForecast,#mapAlerts{height:240px;width:95%;margin:10px auto;border-radius:10px}
    .status-ok{color:#00ff7f}.status-fail{color:#ff4f4f}
    /* === POPUP FINAL === */
    #summaryPopup{
      position:fixed;top:50%;left:50%;transform:translate(-50%,-50%) scale(0.8);
      background:#fff;color:#000;border-radius:12px;box-shadow:0 0 25px rgba(0,0,0,0.6);
      width:360px;max-width:90%;padding:20px;text-align:left;display:none;z-index:9999;
      animation:fadeInZoom .3s forwards;
    }
    @keyframes fadeInZoom{to{opacity:1;transform:translate(-50%,-50%) scale(1)}}
    #summaryPopup h2{margin-top:0;text-align:center;color:#007bff}
    #summaryPopup p{margin:8px 0;font-size:15px}
    #summaryPopup button{background:#007bff;color:#fff;border:none;border-radius:6px;padding:8px 12px;
      display:block;margin:15px auto 0;cursor:pointer;font-weight:600}
  </style>
</head>

<body>
  <header>üõ∞ Centrale de Contr√¥le ‚Äì TINSFLASH</header>

  <nav>
    <a href="/admin-pp.html">Console</a>
    <a href="/admin-alerts.html">Alertes</a>
    <a href="/admin-chat.html">Chat IA</a>
    <a href="/admin-radar.html">Radar</a>
    <a href="/admin-users.html">Utilisateurs</a>
    <a href="/admin-index.html">Index</a>
  </nav>

  <div style="margin-top:10px;">
    <button id="runBtn">‚ö° RUN Complet</button>
    <button id="aiBtn">üß† Analyse IA J.E.A.N</button>
    <button id="refreshBtn">üîÑ Rafra√Æchir</button>
  </div>

  <h3>üìä √âtat du moteur</h3>
  <p>Statut : <span id="status">‚Äî</span></p>
  <p>Dernier run : <span id="lastRun">Jamais</span></p>

  <h3>üåç Carte Pr√©visions</h3>
  <div id="mapForecast"></div>

  <h3>üö® Carte Alertes</h3>
  <div id="mapAlerts"></div>

  <h3>üìú Logs moteur (temps r√©el)</h3>
  <div id="logBox">Connexion aux logs‚Ä¶</div>

  <!-- === POPUP FINAL === -->
  <div id="summaryPopup">
    <h2>‚úÖ R√©sum√© du RUN</h2>
    <div id="summaryContent">Chargement‚Ä¶</div>
    <button onclick="closeSummary()">Fermer</button>
  </div>

  <script>
    const API = "https://tinsflash-backend.onrender.com";
    const logBox=document.getElementById("logBox");

    // === Carte Pr√©visions ===
    const mapForecast=L.map("mapForecast").setView([20,0],2);
    const mapAlerts=L.map("mapAlerts").setView([20,0],2);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:"¬© OpenStreetMap"}).addTo(mapForecast);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:"¬© OpenStreetMap"}).addTo(mapAlerts);
    let forecastMarkers=[],alertMarkers=[];

    async function updateStatus(){
      try{
        const r=await fetch(`${API}/api/status`);
        const d=await r.json();
        document.getElementById("status").textContent=d.status||"‚Äî";
        document.getElementById("lastRun").textContent=d.lastRun?new Date(d.lastRun).toLocaleString():"Jamais";
        updateMaps(d);
      }catch(e){console.error(e);}
    }

    function updateMaps(d){
      forecastMarkers.forEach(m=>mapForecast.removeLayer(m));
      alertMarkers.forEach(m=>mapAlerts.removeLayer(m));
      forecastMarkers=[];alertMarkers=[];

      // Forecasts : zones couvertes = vert
      if(d.coveredZones&&Array.isArray(d.coveredZones)){
        d.coveredZones.forEach(z=>{
          const m=L.circleMarker([z.lat,z.lon],{color:"lime",radius:4}).addTo(mapForecast)
            .bindPopup(`Pr√©visions OK<br>${z.name||"Zone"}`);
          forecastMarkers.push(m);
        });
      }

      // Alertes : rouges ou oranges selon gravit√©
      if(d.alertsWorld){
        for(const [region,alerts] of Object.entries(d.alertsWorld)){
          for(const [k,v] of Object.entries(alerts)){
            const lat=v?.geo?.lat||0,lon=v?.geo?.lon||0;
            const col=v.certainty>=90?"red":v.certainty>=70?"orange":"yellow";
            const mark=L.circleMarker([lat,lon],{color:col,radius:5}).addTo(mapAlerts)
              .bindPopup(`${region}<br>${v.title||"Alerte"} (${v.certainty||"?"}%)`);
            alertMarkers.push(mark);
          }
        }
      }
    }

    // === Logs SSE ===
    const evtSrc=new EventSource(`${API}/api/logs/stream`);
    evtSrc.onmessage=(e)=>{
      const data=JSON.parse(e.data);
      logBox.innerHTML+=`[${new Date(data.timestamp).toLocaleTimeString()}] ${data.message}<br>`;
      logBox.scrollTop=logBox.scrollHeight;
    };

    // === Boutons ===
    document.getElementById("refreshBtn").onclick=updateStatus;

    document.getElementById("runBtn").onclick=async()=>{
      try{
        const r=await fetch(`${API}/api/run-global`,{method:"POST",headers:{"Content-Type":"application/json"}});
        const d=await r.json();
        if(!d.success)throw new Error(d.error||"√âchec du RUN");
        await showSummary();
      }catch(e){alert("‚ùå "+e.message);}
    };

    document.getElementById("aiBtn").onclick=async()=>{
      try{
        const r=await fetch(`${API}/api/ai-analyse`,{method:"POST"});
        const d=await r.json();
        alert(d.success?"üß† IA J.E.A.N termin√©e":"‚ùå Erreur IA");
      }catch(e){alert("‚ùå "+e.message);}
    };

    async function showSummary(){
      const r=await fetch(`${API}/api/status`);
      const d=await r.json();
      const s=document.getElementById("summaryPopup");
      const c=document.getElementById("summaryContent");
      const a=d.alertsWorldSummary||{};
      const total=d.coveredZones?.length||0;
      c.innerHTML=`
        <p>‚úÖ <b>${d.alertsWorldSummary?.europeAlerts + d.alertsWorldSummary?.usaAlerts || 0}</b> pr√©visions OK sur <b>${total}</b> zones couvertes</p>
        <p style="color:#e60000">üö® ${a.premium||0} alertes Premium (‚â•90%) √† examiner</p>
        <p style="color:#ff8c00">‚ö†Ô∏è ${a.validated||0} alertes √† valider (70‚Äì89%)</p>
        <p style="color:#ffaa00">üü† ${a.watch||0} alertes en surveillance (<70%)</p>
        <p style="font-size:13px;margin-top:10px;color:#444;">üïí Dernier run : ${d.lastRun?new Date(d.lastRun).toLocaleString():"Jamais"}</p>
      `;
      s.style.display="block";
    }

    function closeSummary(){
      document.getElementById("summaryPopup").style.display="none";
      updateStatus();
    }

    updateStatus();
  </script>
</body>
</html>
