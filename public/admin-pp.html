<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="robots" content="noindex,nofollow" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>‚ö° TINSFLASH PRO+++ ‚Äì Console IA J.E.A.N</title>
  <style>
    body{margin:0;background:#0a111d;color:#e6f6ff;font-family:Inter,system-ui}
    header{padding:14px;text-align:center;background:#08121d;color:#6bf3ff;font-weight:700;font-size:1.1rem}
    nav{display:flex;justify-content:center;gap:12px;padding:10px;background:#0d1624}
    nav a{color:#6bf3ff;text-decoration:none;font-weight:600}
    nav a:hover{text-decoration:underline}
    main{max-width:1200px;margin:0 auto;padding:12px}
    .status-panel{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:10px}
    .status{flex:1 1 160px;padding:8px;border-radius:8px;text-align:center;font-weight:600}
    .ok{background:#003f2d;color:#76ff7a}
    .warn{background:#4f2a00;color:#ffc978}
    .fail{background:#3b0000;color:#ff6b6b}
    .controls{display:flex;flex-wrap:wrap;gap:8px;margin:10px 0}
    .controls button{flex:1 1 180px;padding:10px;border:none;border-radius:8px;font-weight:700;cursor:pointer;color:#001}
    .controls button:hover{opacity:0.9}
    .btn-run-eu{background:#6bf3ff}
    .btn-run-world{background:#49c7f5}
    .btn-ai{background:#93ff93}
    .btn-fusion{background:#b3ff6b}
    .btn-stop{background:#ff6b6b}
    .btn-reset{background:#ffa86b}
    .btn-refresh{background:#6bb1ff}
    .stats{display:flex;flex-wrap:wrap;gap:10px;margin:12px 0}
    .stat{flex:1 1 220px;background:#0d1624;padding:10px;border-radius:8px;text-align:center}
    .stat span{display:block;font-size:1.4rem;margin-top:4px}
    iframe{width:100%;height:480px;border:0;border-radius:10px;margin-bottom:12px}
    .logs{background:#0d1624;padding:10px;border-radius:10px;height:300px;overflow:auto;font-family:monospace;font-size:0.9rem}
    /* chat bubble */
    #chatBubble{position:fixed;bottom:22px;right:22px;background:#4fc3f7;border-radius:50%;width:58px;height:58px;display:flex;justify-content:center;align-items:center;color:#001;font-weight:700;cursor:pointer;box-shadow:0 0 12px #4fc3f7}
    #chatBox{position:fixed;bottom:90px;right:22px;width:340px;height:430px;background:#0e1725;border-radius:12px;display:none;flex-direction:column;overflow:hidden;box-shadow:0 0 15px #4fc3f7}
    #chatMessages{flex:1;overflow:auto;padding:10px}
    #chatControls{display:flex}
    #chatControls input{flex:1;padding:8px;border:none;background:#07121a;color:#e6f6ff}
    #chatControls button{background:#4fc3f7;border:none;color:#001;font-weight:700;padding:8px 10px}
    .msg-bot{background:#123045;padding:6px;border-radius:8px;margin:5px 0}
    .msg-user{background:#4fc3f7;color:#001;padding:6px;border-radius:8px;margin:5px 0;text-align:right}
  </style>
</head>
<body>

<script>
const pin=sessionStorage.getItem("tinsflashPIN");
if(!pin){const p=prompt("Code d‚Äôacc√®s admin ?");if(p!=="202679"){alert("Acc√®s refus√©");location.href="/";}else sessionStorage.setItem("tinsflashPIN","ok");}
</script>

<header>‚ö° TINSFLASH PRO+++ ‚Äì Console IA J.E.A.N (GPT-5 moteur / GPT-4o-mini console)</header>
<nav>
  <a href="/admin-pp.html">Console</a>
  <a href="/admin-alerts.html">Alertes</a>
  <a href="/admin-chat.html">Chat</a>
  <a href="/admin-radar.html">Radar</a>
  <a href="/index.html">Index public</a>
</nav>

<main>
  <div class="status-panel" id="statusPanel">
    <div class="status ok" id="stModels">Mod√®les : OK</div>
    <div class="status ok" id="stEngine">Moteur : OK</div>
    <div class="status ok" id="stAI">IA J.E.A.N : OK</div>
    <div class="status ok" id="stMongo">MongoDB : OK</div>
    <div class="status ok" id="stRender">Render : Connect√©</div>
  </div>

  <div class="controls">
    <button class="btn-run-eu" onclick="runZone('Europe')">üåç Run Europe / USA / Canada</button>
    <button class="btn-run-world" onclick="runZone('World')">üåç Run reste du monde</button>
    <button class="btn-ai" onclick="runIA()">üß† Lancer IA J.E.A.N</button>
    <button class="btn-fusion" onclick="fusionIA()">‚öôÔ∏è Fusion IA</button>
    <button class="btn-stop" onclick="stopExtraction()">üõë Stop</button>
    <button class="btn-reset" onclick="resetStop()">‚ôªÔ∏è Reset</button>
    <button class="btn-refresh" onclick="refreshStatus()">üîÑ Rafra√Æchir</button>
  </div>

  <div class="stats" id="stats">
    <div class="stat" style="border:2px solid #b36bff;">Primeur üåê<span id="nPrimeur">0</span></div>
    <div class="stat" style="border:2px solid #00ff99;">> 90 % ‚úÖ<span id="n90">0</span></div>
    <div class="stat" style="border:2px solid #ffd966;">70‚Äì89 % ‚ö†Ô∏è<span id="n70">0</span></div>
    <div class="stat" style="border:2px solid #ff6b6b;">< 70 % üîç<span id="nSub70">0</span></div>
  </div>

  <h3>üåé Carte Pr√©visions</h3>
  <iframe src="/admin-radar.html#forecast" id="forecastMap"></iframe>

  <h3>üö® Carte Alertes</h3>
  <iframe src="/admin-radar.html#alerts" id="alertsMap"></iframe>

  <h3>üìú Logs moteur</h3>
  <div class="logs" id="logs"></div>
</main>

<!-- Chat bubble -->
<div id="chatBubble">üí¨</div>
<div id="chatBox">
  <div id="chatMessages">
    <div class="msg-bot">ü§ñ J.E.A.N : Connect√© √† la console technique (mode GPT-4o-mini)</div>
  </div>
  <div id="chatControls">
    <input id="chatInput" placeholder="Discuter avec J.E.A.N‚Ä¶" onkeypress="if(event.key==='Enter')sendChat()">
    <button onclick="sendChat()">‚Üí</button>
  </div>
</div>

<script>
const API="/api";
async function runZone(zone){
  const url=zone==="World"?`${API}/runGlobal?zone=World`:`${API}/runGlobal?zone=Europe`;
  addLog("üöÄ Lancement extraction "+zone);
  await fetch(url,{method:"POST"}).then(r=>r.json()).then(j=>addLog(JSON.stringify(j))).catch(e=>addLog("Erreur run "+e));
}
async function runIA(){addLog("üß† Lancement IA J.E.A.N");await fetch(`${API}/ai-analyse`,{method:"POST"}).then(r=>r.json()).then(j=>addLog(JSON.stringify(j))).catch(e=>addLog("Erreur IA "+e));}
async function fusionIA(){addLog("‚öôÔ∏è Fusion IA");await fetch(`${API}/runWorldAlerts`,{method:"POST"}).then(r=>r.json()).then(j=>addLog(JSON.stringify(j))).catch(e=>addLog("Erreur fusion "+e));}
async function stopExtraction(){await fetch(`${API}/stop-extraction`,{method:"POST"});}
async function resetStop(){await fetch(`${API}/reset-stop-extraction`,{method:"POST"});}
async function refreshStatus(){
  const res=await fetch(`${API}/status`);const j=await res.json();
  addLog("üîÑ Statut moteur actualis√©");
  if(j.errors?.length)addLog("‚ö†Ô∏è "+j.errors.length+" erreurs");
  if(j.coveredZones)document.getElementById("stModels").innerText="Mod√®les : "+j.coveredZones.length+" zones";
}
function addLog(msg){const l=document.getElementById("logs");l.innerHTML+="<div>"+msg+"</div>";l.scrollTop=l.scrollHeight;}
setInterval(async()=>{const r=await fetch(`${API}/logs-live`);const j=await r.json();document.getElementById("logs").innerText=j.logs.map(x=>x.message).join("\n");},60000);

/* chat */
const chatBubble=document.getElementById("chatBubble");
const chatBox=document.getElementById("chatBox");
chatBubble.onclick=()=>chatBox.style.display=chatBox.style.display==="flex"?"none":"flex";
async function sendChat(){
  const txt=document.getElementById("chatInput").value.trim();
  if(!txt)return;
  const msgs=document.getElementById("chatMessages");
  msgs.innerHTML+=`<div class='msg-user'>${txt}</div>`;
  document.getElementById("chatInput").value="";
  try{
    const res=await fetch("/api/ai-admin",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({message:txt,mode:"moteur"})});
    const j=await res.json();
    msgs.innerHTML+=`<div class='msg-bot'>${j.reply||j}</div>`;
    msgs.scrollTop=msgs.scrollHeight;
  }catch(e){msgs.innerHTML+=`<div class='msg-bot'>‚ùå Erreur : ${e.message}</div>`;}
}
</script>
</body>
</html>
