<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>‚ö° Centrale Nucl√©aire M√©t√©o ‚Äì Console Admin</title>
  <meta name="robots" content="noindex,nofollow">
  <style>
    body { font-family: Arial, sans-serif; background:#111; color:#eee; margin:0; }
    header { background:#222; padding:10px; display:flex; justify-content:space-between; align-items:center; }
    header h1 { margin:0; font-size:18px; color:#fdd835; }
    nav a { color:#0af; margin:0 10px; text-decoration:none; font-weight:bold; }
    nav a:hover { text-decoration:underline; }
    .container { padding:20px; }
    button { padding:10px 15px; border:none; border-radius:5px; cursor:pointer; }
    .runBtn { background:#2196f3; color:white; font-size:16px; }
    .runBtn.running { background:#f44336; }
    .runBtn.done { background:#4caf50; }
    .statusBox { margin:10px 0; padding:10px; border-radius:5px; }
    .status-ok { background:#2e7d32; }
    .status-fail { background:#c62828; }
    .status-pending { background:#ef6c00; }
    ul { list-style:none; padding:0; }
    li { padding:5px; margin:3px 0; border-radius:3px; }
    .ok { background:#2e7d32; }
    .fail { background:#c62828; }
    .pending { background:#ef6c00; }
    .logs { background:#000; padding:10px; height:250px; overflow-y:scroll; font-family:monospace; font-size:13px; border:1px solid #333; }
  </style>
</head>
<body>
  <script>
    // Protection par mot de passe
    const pass = prompt("Mot de passe ?");
    if (pass !== "202679") {
      document.body.innerHTML = "<h1 style='color:red;text-align:center;'>‚õî Acc√®s refus√©</h1>";
      throw new Error("Acc√®s refus√©");
    }
  </script>

  <header>
    <h1>‚ö° Centrale Nucl√©aire M√©t√©o ‚Äì Console Admin</h1>
    <nav>
      <a href="admin-pp.html">Console</a>
      <a href="admin-alerts.html">Alertes</a>
      <a href="admin-index.html">Vue Utilisateur</a>
      <a href="admin-chat.html">Chat IA</a>
      <a href="admin-radar.html">Radar</a>
    </nav>
  </header>

  <div class="container">
    <!-- Bouton RUN -->
    <h2>üöÄ Lancer RUN</h2>
    <button id="runBtn" class="runBtn">‚ñ∂Ô∏è Lancer RUN</button>
    <div id="runStatus"></div>

    <!-- Checklist moteur -->
    <h2>üìã Checklist Moteur</h2>
    <ul id="checklist">
      <li id="step1" class="pending">1. Extraction mod√®les</li>
      <li id="step2" class="pending">2. RUNGLOBAL Europe</li>
      <li id="step3" class="pending">3. RUNGLOBAL USA</li>
      <li id="step4" class="pending">4. RUN Continentales</li>
      <li id="step5" class="pending">5. Mise sous fichier des extractions</li>
      <li id="step6" class="pending">6. Analyse IA (relief, climat, environnement)</li>
      <li id="step7" class="pending">7. Pr√©visions locales zones couvertes</li>
      <li id="step8" class="pending">8. Pr√©visions nationales zones couvertes</li>
      <li id="step9" class="pending">9. Alertes locales zones couvertes</li>
      <li id="step10" class="pending">10. Alertes nationales zones couvertes</li>
      <li id="step11" class="pending">11. Alertes continentales (zones non couvertes)</li>
      <li id="step12" class="pending">12. Assemblage alertes mondiales</li>
      <li id="step13" class="pending">13. Open Data pr√©visions zones non couvertes</li>
    </ul>

    <div id="engineStatus" class="statusBox status-pending">Moteur op√©rationnel : EN ATTENTE</div>

    <!-- Logs -->
    <h2>üìú Logs en direct</h2>
    <div id="logs" class="logs"></div>
  </div>

  <script>
    const runBtn = document.getElementById("runBtn");
    const runStatus = document.getElementById("runStatus");
    const checklist = document.getElementById("checklist");
    const engineStatus = document.getElementById("engineStatus");
    const logsDiv = document.getElementById("logs");

    function addLog(msg) {
      const now = new Date();
      const time = now.toLocaleTimeString();
      const entry = `[${time}] ${msg}`;
      const p = document.createElement("div");
      p.textContent = entry;
      logsDiv.prepend(p);
      // Garde max 50 logs
      while (logsDiv.childNodes.length > 50) {
        logsDiv.removeChild(logsDiv.lastChild);
      }
    }

    async function runGlobal() {
      runBtn.classList.add("running");
      runBtn.textContent = "‚è≥ RUNNING‚Ä¶";
      runStatus.innerHTML = "";

      try {
        const res = await fetch("/api/run-global?zone=All");
        const data = await res.json();
        addLog("‚ñ∂Ô∏è RUN GLOBAL lanc√©");
        if (data.error) throw new Error(data.error);

        const res2 = await fetch("/api/run-continental");
        const data2 = await res2.json();
        addLog("‚ñ∂Ô∏è RUN CONTINENTAL lanc√©");
        if (data2.error) throw new Error(data2.error);

        runBtn.classList.remove("running");
        runBtn.classList.add("done");
        runBtn.textContent = "‚úÖ RUN termin√©";
        runStatus.innerHTML = "<div class='statusBox status-ok'>RUN termin√© avec succ√®s</div>";

        engineStatus.className = "statusBox status-ok";
        engineStatus.textContent = "Moteur op√©rationnel : OK ‚úÖ";
      } catch (err) {
        runBtn.classList.remove("running");
        runBtn.classList.add("fail");
        runBtn.textContent = "‚ùå RUN √©chec";
        runStatus.innerHTML = "<div class='statusBox status-fail'>Erreur RUN: " + err.message + "</div>";
        engineStatus.className = "statusBox status-fail";
        engineStatus.textContent = "Moteur op√©rationnel : FAIL ‚ùå";
        addLog("Erreur RUN: " + err.message);
      }
    }

    runBtn.addEventListener("click", runGlobal);

    // Logs SSE
    const evtSource = new EventSource("/api/logs/stream");
    evtSource.onmessage = function(e) {
      if (!e.data) return;
      try {
        const obj = JSON.parse(e.data);
        if (obj.message) {
          addLog(obj.message);
        }
      } catch {
        addLog(e.data);
      }
    };
  </script>
</body>
</html>
