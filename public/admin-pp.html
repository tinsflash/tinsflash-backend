<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>‚ö° Console Administrateur ‚Äî Centrale Nucl√©aire M√©t√©o</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body { font-family: Arial, sans-serif; background:#111; color:#eee; margin:0; padding:0; }
    header { background:#222; padding:15px; text-align:center; font-size:20px; }
    nav { background:#333; padding:10px; display:flex; flex-wrap:wrap; justify-content:space-around; }
    nav a { color:#fff; text-decoration:none; padding:8px; }
    nav a:hover { background:#555; border-radius:5px; }
    section { padding:20px; display:none; }
    section.active { display:block; }
    button { padding:8px 15px; margin:5px; cursor:pointer; }
    #logs { background:#000; color:#0f0; padding:10px; height:200px; overflow:auto; font-family:monospace; }
    .status-grid { display:grid; grid-template-columns: repeat(auto-fit,minmax(200px,1fr)); gap:10px; }
    .status { padding:10px; text-align:center; border-radius:5px; font-size:14px; }
    .green { background:#0a0; }
    .red { background:#a00; }
    .orange { background:#fa0; }
    pre { background:#000; color:#0f0; padding:10px; overflow:auto; max-height:400px; }
    details { margin:5px 0; }
    iframe { width:100%; height:500px; border:none; }
  </style>
</head>
<body>
  <header>‚ö° Cockpit Administrateur ‚Äî Centrale Nucl√©aire M√©t√©o</header>

  <nav>
    <a href="#cockpit" onclick="showPage('cockpit')">Cockpit</a>
    <a href="#alerts" onclick="showPage('alerts')">Alertes</a>
    <a href="#chat" onclick="showPage('chat')">Chat IA</a>
    <a href="#radar" onclick="showPage('radar')">Radar</a>
    <a href="#preview" onclick="showPage('preview')">Pr√©visualisation Index</a>
    <a href="#news" onclick="showPage('news')">Infos M√©t√©o Mondiales</a>
    <a href="#users" onclick="showPage('users')">Utilisateurs</a>
  </nav>

  <!-- Cockpit -->
  <section id="cockpit" class="active">
    <h2>üåç Cockpit</h2>
    <button onclick="launchRun()">üöÄ Lancer Run Global</button>

    <h3>‚úÖ Checklist moteur</h3>
    <div class="status-grid" id="checkup-grid"></div>

    <h3>üìú Logs</h3>
    <div id="logs">En attente‚Ä¶</div>

    <h3>üì° √âtat du moteur</h3>
    <button onclick="exportEngineState()">üì• Export JSON</button>
    <button onclick="copyEngineState()">üìã Copier JSON</button>
    <div id="engineAccordion">Chargement‚Ä¶</div>
  </section>

  <!-- Alertes -->
  <section id="alerts">
    <h2>‚ö†Ô∏è Alertes</h2>
    <pre id="alertsBox">Chargement‚Ä¶</pre>
  </section>

  <!-- Chat IA -->
  <section id="chat">
    <h2>ü§ñ Chat IA (GPT-5)</h2>
    <textarea id="prompt" style="width:100%;height:100px;"></textarea>
    <button onclick="askIA()">Envoyer</button>
    <pre id="iaReply">R√©ponse ici‚Ä¶</pre>
  </section>

  <!-- Radar -->
  <section id="radar">
    <h2>üåê Radar Global</h2>
    <iframe src="https://embed.windy.com/embed2.html?lat=50&lon=5&zoom=4&level=surface&overlay=rain&menu=&message=&marker=&calendar=&pressure=&type=map&location=coordinates&detail=&detailLat=50&detailLon=5&metricWind=default&metricTemp=default&radarRange=-1"></iframe>
  </section>

  <!-- Pr√©visualisation Index -->
  <section id="preview">
    <h2>üëÅÔ∏è Pr√©visualisation Index</h2>
    <input type="text" id="previewLocation" placeholder="Ville, pays‚Ä¶" />
    <button onclick="previewIndex()">Voir Index</button>
    <pre id="previewBox">R√©sultat ici‚Ä¶</pre>
  </section>

  <!-- Infos m√©t√©o mondiales -->
  <section id="news">
    <h2>üì∞ Infos M√©t√©o Mondiales</h2>
    <pre id="newsBox">Chargement‚Ä¶</pre>
  </section>

  <!-- Utilisateurs -->
  <section id="users">
    <h2>üë• Suivi Utilisateurs</h2>
    <pre id="usersBox">Chargement‚Ä¶</pre>
  </section>

  <script>
    function showPage(id) {
      document.querySelectorAll("section").forEach(sec => sec.classList.remove("active"));
      document.getElementById(id).classList.add("active");
    }

    function log(msg) {
      const logsDiv = document.getElementById("logs");
      logsDiv.innerText += "\\n" + msg;
      logsDiv.scrollTop = logsDiv.scrollHeight;
    }

    async function launchRun() {
      log("‚ñ∂Ô∏è Lancement Run Global‚Ä¶");
      const res = await fetch("/api/run-global", { method: "POST" });
      const data = await res.json();
      log("‚úÖ Run termin√©");
      updateCheckup();
      loadEngineState();
      loadAlerts();
    }

    async function updateCheckup() {
      const res = await fetch("/api/checkup");
      const checkup = await res.json();
      const grid = document.getElementById("checkup-grid");
      grid.innerHTML = "";
      for (const [k,v] of Object.entries(checkup)) {
        const div = document.createElement("div");
        div.className = "status " + (v==="OK"?"green": v==="PENDING"?"orange":"red");
        div.innerText = k + ": " + v;
        grid.appendChild(div);
      }
    }

    async function loadEngineState() {
      const res = await fetch("/api/engine-state");
      const state = await res.json();
      renderAccordion(state);
    }

    function renderAccordion(data) {
      const container = document.getElementById("engineAccordion");
      container.innerHTML = "";
      if (!data || !data.zonesCovered) {
        container.innerText = "Pas de donn√©es";
        return;
      }
      for (const [country, cdata] of Object.entries(data.zonesCovered)) {
        const details = document.createElement("details");
        const summary = document.createElement("summary");
        summary.innerText = "üåç " + country;
        details.appendChild(summary);

        for (const region of cdata.regions || []) {
          const sub = document.createElement("details");
          const sum = document.createElement("summary");
          sum.innerText = "üìç " + region.region;
          sub.appendChild(sum);
          sub.innerHTML += "<pre>"+JSON.stringify(region,null,2)+"</pre>";
          details.appendChild(sub);
        }
        container.appendChild(details);
      }
    }

    async function exportEngineState() {
      const res = await fetch("/api/engine-state");
      const data = await res.json();
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "engine-state.json";
      a.click();
      URL.revokeObjectURL(url);
    }

    async function copyEngineState() {
      const res = await fetch("/api/engine-state");
      const data = await res.json();
      await navigator.clipboard.writeText(JSON.stringify(data, null, 2));
      alert("üìã Copi√© dans le presse-papier !");
    }

    async function loadAlerts() {
      const res = await fetch("/api/alerts");
      const data = await res.json();
      document.getElementById("alertsBox").innerText = JSON.stringify(data.alerts,null,2);
    }

    async function askIA() {
      const prompt = document.getElementById("prompt").value;
      const res = await fetch("/api/chat", {
        method:"POST", headers:{"Content-Type":"application/json"},
        body:JSON.stringify({ message: prompt })
      });
      const data = await res.json();
      document.getElementById("iaReply").innerText = data.reply || "‚ùå Pas de r√©ponse";
    }

    async function previewIndex() {
      const loc = document.getElementById("previewLocation").value;
      const res = await fetch("/api/forecast/" + encodeURIComponent(loc));
      const data = await res.json();
      document.getElementById("previewBox").innerText = JSON.stringify(data,null,2);
    }

    async function loadNews() {
      const res = await fetch("/api/news");
      const data = await res.json();
      document.getElementById("newsBox").innerText = JSON.stringify(data.news,null,2);
    }

    async function loadUsers() {
      const res = await fetch("/api/users");
      const data = await res.json();
      document.getElementById("usersBox").innerText = JSON.stringify(data.users,null,2);
    }

    // Auto-refresh
    setInterval(updateCheckup, 15000);
    setInterval(loadAlerts, 30000);
    setInterval(loadEngineState, 60000);
    setInterval(loadNews, 60000);
    setInterval(loadUsers, 60000);
  </script>
</body>
</html>
