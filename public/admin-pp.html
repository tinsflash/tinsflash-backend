<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="robots" content="noindex,nofollow" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>üõ∞ Console IA J.E.A.N ‚Äì TINSFLASH</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    body {
      font-family: "Segoe UI", sans-serif;
      background-color: #0c111a;
      color: #cde4ff;
      margin: 0;
      padding: 0;
      text-align: center;
    }
    h1 { font-size: 1.3rem; margin: 10px 0; color: #66ccff; }
    button {
      border: none; border-radius: 8px; padding: 10px 16px;
      margin: 5px; cursor: pointer; font-weight: 600;
    }
    #runBtn { background: #007bff; color: white; }
    #aiBtn { background: #28a745; color: white; }
    #refreshBtn { background: #17a2b8; color: white; }
    #logBox {
      background: #000; color: #0f0; padding: 10px; margin: 10px auto;
      width: 95%; height: 200px; overflow-y: auto;
      border: 1px solid #333; border-radius: 8px;
      text-align: left; font-family: monospace;
    }
    table {
      margin: 10px auto; width: 90%;
      border-collapse: collapse; background: #131a24;
    }
    th, td {
      padding: 6px 8px;
      border-bottom: 1px solid #333;
    }
    th { color: #66ccff; }
    #map { height: 250px; width: 95%; margin: 10px auto; border-radius: 10px; }
    #chat {
      width: 95%; margin: 10px auto; background: #111820; border-radius: 8px;
      padding: 10px; text-align: left;
    }
    #chatInput {
      width: 80%; padding: 10px; border-radius: 5px; border: none;
      background: #222; color: #fff;
    }
    #sendChat {
      padding: 10px 16px; background: #007bff; color: white; border: none; border-radius: 5px;
    }
    .msg { margin: 6px 0; }
    .user { color: #0af; }
    .ai { color: #0f0; }
  </style>
</head>

<body>
  <h1>üß† Console IA J.E.A.N ‚Äì TINSFLASH</h1>

  <div>
    <button id="runBtn">‚ö° Lancer Extraction (sans IA)</button>
    <button id="aiBtn">üß† Lancer Analyse IA J.E.A.N</button>
    <button id="refreshBtn">üîÑ Tout rafra√Æchir</button>
  </div>

  <h2>‚öôÔ∏è √âtat du moteur</h2>
  <p>Statut : <span id="status">‚Äî</span></p>
  <p>Dernier run : <span id="lastRun">Jamais</span></p>
  <p>Mod√®les actifs : <span id="models">‚Äî</span></p>

  <h2>üìä R√©sum√©s</h2>
  <table>
    <thead><tr><th>Type</th><th>Nombre</th></tr></thead>
    <tbody id="summary"><tr><td>‚Äî</td><td>‚Äî</td></tr></tbody>
  </table>

  <h2>üìò D√©tail par mod√®le</h2>
  <table>
    <thead><tr><th>Mod√®le</th><th>OK</th><th>Fail</th></tr></thead>
    <tbody id="modelTable"><tr><td colspan="3">Chargement‚Ä¶</td></tr></tbody>
  </table>

  <h2>üåç Carte alertes</h2>
  <div id="map"></div>

  <h2>üìú Logs moteur (temps r√©el)</h2>
  <div id="logBox">Connexion aux logs‚Ä¶</div>

  <h2>üí¨ Chat IA J.E.A.N</h2>
  <div id="chat"></div>
  <input id="chatInput" placeholder="Parle √† J.E.A.N (moteur GPT-4o-mini)" />
  <button id="sendChat">Envoyer</button>

  <script>
    const API = "https://tinsflash-backend.onrender.com";
    const logBox = document.getElementById("logBox");
    const modelTable = document.getElementById("modelTable");
    const summary = document.getElementById("summary");

    async function updateStatus() {
      try {
        const r = await fetch(`${API}/api/status`);
        const d = await r.json();
        document.getElementById("status").innerText = d.status;
        document.getElementById("lastRun").innerText = d.lastRun ? new Date(d.lastRun).toLocaleString() : "Jamais";
        document.getElementById("models").innerText = Object.keys(d.models || {}).join(", ");

        // mod√®les
        modelTable.innerHTML = "";
        for (const [k,v] of Object.entries(d.models || {})) {
          const ok = v === "ok" ? "‚úÖ" : "";
          const fail = v === "fail" ? "‚ùå" : "";
          modelTable.innerHTML += `<tr><td>${k}</td><td>${ok}</td><td>${fail}</td></tr>`;
        }
        summary.innerHTML = `<tr><td>Alertes locales</td><td>${d.alertsCount}</td></tr>`;
      } catch(e) {
        console.error("Erreur statut:", e);
      }
    }

    // Boutons
    document.getElementById("runBtn").onclick = async () => {
      const res = await fetch(`${API}/api/run-global`, { method: "POST", headers: {"Content-Type": "application/json"} });
      const data = await res.json();
      alert(data.success ? "‚úÖ Extraction compl√®te !" : "‚ùå √âchec extraction");
      updateStatus();
    };

    document.getElementById("aiBtn").onclick = async () => {
      const res = await fetch(`${API}/api/ai-analyse`, { method: "POST" });
      const data = await res.json();
      alert(data.success ? "üß† IA J.E.A.N termin√©e" : "‚ùå Erreur IA");
      updateStatus();
    };

    document.getElementById("refreshBtn").onclick = updateStatus;

    // Logs temps r√©el SSE
    const evtSrc = new EventSource(`${API}/api/logs/stream`);
    evtSrc.onmessage = (e) => {
      const data = JSON.parse(e.data);
      logBox.innerHTML += `[${new Date(data.timestamp).toLocaleTimeString()}] ${data.message}<br>`;
      logBox.scrollTop = logBox.scrollHeight;
    };

    // Carte Leaflet
    const map = L.map('map').setView([20,0], 2);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
      attribution: '¬© OpenStreetMap'
    }).addTo(map);

    // Chat IA
    const chat = document.getElementById("chat");
    document.getElementById("sendChat").onclick = async () => {
      const txt = document.getElementById("chatInput").value.trim();
      if (!txt) return;
      chat.innerHTML += `<div class='msg user'>üë®‚ÄçüöÄ Toi : ${txt}</div>`;
      document.getElementById("chatInput").value = "";
      const res = await fetch(`${API}/api/cohere`, {
        method:"POST", headers:{"Content-Type":"application/json"},
        body: JSON.stringify({ question: txt })
      });
      const data = await res.json();
      chat.innerHTML += `<div class='msg ai'>ü§ñ J.E.A.N : ${data.reply}</div>`;
      chat.scrollTop = chat.scrollHeight;
    };

    updateStatus();
  </script>
</body>
</html>
