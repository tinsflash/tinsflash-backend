<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>üåå TINSFLASH - Console Admin NASA</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    /* ======== Style NASA ======== */
    body {
      margin: 0;
      font-family: "Segoe UI", Roboto, sans-serif;
      background-color: #0b0f1a;
      color: #e0e0e0;
      display: flex;
    }
    a { color: #00c9ff; text-decoration: none; }
    h1, h2, h3 { color: #00eaff; margin: 0.5em 0; }

    /* Sidebar */
    .sidebar {
      width: 230px;
      background: #111726;
      height: 100vh;
      padding: 20px;
      box-shadow: 2px 0 10px rgba(0,0,0,0.8);
      position: fixed;
      top: 0; left: 0;
      display: flex;
      flex-direction: column;
    }
    .sidebar h1 {
      font-size: 1.2em;
      text-align: center;
      margin-bottom: 1em;
      color: #00eaff;
    }
    .sidebar a {
      padding: 12px;
      margin: 6px 0;
      border-radius: 6px;
      display: block;
      background: #1a2235;
      transition: background 0.3s;
    }
    .sidebar a:hover { background: #00c9ff33; }

    /* Content */
    .content {
      margin-left: 250px;
      padding: 20px;
      flex: 1;
      overflow-y: auto;
      height: 100vh;
    }

    /* Panels */
    .panel {
      background: #161d2e;
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 20px;
      box-shadow: 0 0 10px #00c9ff55;
    }
    .panel h2 { border-bottom: 1px solid #00eaff33; padding-bottom: 5px; }

    /* Logs */
    .logs {
      background: #0f141f;
      padding: 10px;
      border-radius: 6px;
      max-height: 200px;
      overflow-y: auto;
      font-family: monospace;
      font-size: 0.9em;
    }

    /* Check-up */
    .checkup-list {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 6px;
    }
    .checkup-item {
      padding: 6px;
      border-radius: 4px;
      background: #1a2235;
    }
    .ok { color: #00ff9d; font-weight: bold; }
    .fail { color: #ff5555; font-weight: bold; }

    /* Tables */
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    th, td {
      border: 1px solid #00c9ff33;
      padding: 8px;
      text-align: left;
    }
    th { background: #1a2235; }

    /* Inputs */
    input, select, textarea, button {
      padding: 8px;
      margin: 5px 0;
      border: none;
      border-radius: 6px;
      background: #1a2235;
      color: #e0e0e0;
      width: 100%;
    }
    button {
      background: #00c9ff;
      color: #0b0f1a;
      font-weight: bold;
      cursor: pointer;
    }
    button:hover { background: #00eaff; }
  </style>
  <script>
    function showSection(id) {
      document.querySelectorAll(".section").forEach(s => s.style.display = "none");
      document.getElementById(id).style.display = "block";
    }
    window.onload = () => {
      showSection("console");
      refreshLogs();
      refreshCheckup();
      setInterval(refreshLogs, 5000);
      setInterval(refreshCheckup, 5000);
    };

    async function refreshLogs() {
      try {
        const res = await fetch("/api/logs");
        const data = await res.json();
        const logsEl = document.getElementById("logs");
        logsEl.innerHTML = "";
        (data || []).slice(-50).forEach(l => {
          const div = document.createElement("div");
          div.textContent = `[${l.ts}] ${l.msg}`;
          logsEl.appendChild(div);
        });
      } catch(e) {
        document.getElementById("logs").innerText = "Erreur chargement logs";
      }
    }

    async function refreshCheckup() {
      try {
        const res = await fetch("/api/checkup");
        const data = await res.json();
        const cEl = document.getElementById("checkup");
        cEl.innerHTML = "";

        const labels = {
          modelsOk: "1: Mod√®les OK",
          modelsNok: "2: Mod√®les NON OK",
          sourcesOk: "3: Sources OK",
          sourcesNok: "4: Sources NON OK",
          aiForecastOk: "5: Analyse IA pr√©visions",
          aiAlertsOk: "6: Analyse IA alertes",
          forecastsLocalOk: "7: Pr√©visions locales zones couvertes",
          forecastsNationalOk: "8: Pr√©visions nationales zones couvertes",
          alertsLocalOk: "9: Alertes locales zones couvertes",
          alertsNationalOk: "10: Alertes nationales zones couvertes",
          alertsContinentalOk: "11: Alertes continentales zones non couvertes",
          alertsGlobalOk: "12: Assemblage alertes mondiales",
          openDataOk: "13: OpenData zones non couvertes"
        };

        Object.keys(labels).forEach(key => {
          const div = document.createElement("div");
          div.className = "checkup-item";
          const val = data[key];
          div.innerHTML = `${labels[key]} : <span class="${val ? "ok" : "fail"}">${val ? "OK" : "NOK"}</span>`;
          cEl.appendChild(div);
        });

        // R√©sum√© moteur
        document.getElementById("engine-status").innerText = data.engineOperational ? "OK" : "NOK";
        document.getElementById("engine-status").className = data.engineOperational ? "ok" : "fail";

        document.getElementById("users").innerText = JSON.stringify(data.usersByZone || {});
      } catch(e) {
        document.getElementById("checkup").innerText = "Erreur chargement check-up";
      }
    }

    // IA Chat
    async function askAI(type){
      const msg = document.getElementById("msg"+(type==="console"?"Console":"Engine")).value;
      const res = await fetch("/api/chat/"+(type==="console"?"":"engine"),{
        method:"POST",headers:{"Content-Type":"application/json"},
        body:JSON.stringify({message:msg})
      });
      const data = await res.json();
      document.getElementById("reply"+(type==="console"?"Console":"Engine")).innerText = data.reply||"Erreur IA";
    }
  </script>
</head>
<body>
  <div class="sidebar">
    <h1>‚ö° TINSFLASH</h1>
    <a href="#" onclick="showSection('console')">Console</a>
    <a href="#" onclick="showSection('alerts')">Alertes</a>
    <a href="#" onclick="showSection('user')">Vue Utilisateur</a>
    <a href="#" onclick="showSection('chat')">Chat IA</a>
    <a href="#" onclick="showSection('radar')">Outils & Radar</a>
  </div>

  <div class="content">
    <!-- Console -->
    <div id="console" class="section">
      <div class="panel">
        <h2>Lancer un run</h2>
        <button onclick="fetch('/api/run-global',{method:'POST'})">üöÄ Run Global</button>
        <button onclick="fetch('/api/run-continental',{method:'POST'})">üåç Run Continental</button>
      </div>
      <div class="panel">
        <h2>Logs moteur</h2>
        <div class="logs" id="logs">Chargement...</div>
      </div>
      <div class="panel">
        <h2>Check-up Moteur</h2>
        <div class="checkup-list" id="checkup"></div>
      </div>
      <div class="panel">
        <h2>R√©sum√© moteur</h2>
        <p>Moteur op√©rationnel : <span id="engine-status" class="ok">...</span></p>
        <p>D√©tails utilisateurs par zone : <span id="users">Chargement...</span></p>
      </div>
    </div>

    <!-- Alertes -->
    <div id="alerts" class="section" style="display:none">
      <div class="panel">
        <h2>Alertes auto-valid√©es (>90%)</h2>
        <table><thead><tr><th>Pays</th><th>Type</th><th>Indice</th></tr></thead><tbody id="alerts-validated"></tbody></table>
      </div>
      <div class="panel">
        <h2>Alertes √† examiner (70‚Äì90%)</h2>
        <table><thead><tr><th>Pays</th><th>Type</th><th>Indice</th><th>Action</th></tr></thead><tbody id="alerts-pending"></tbody></table>
      </div>
      <div class="panel">
        <h2>Comparaison avec autres sources</h2>
        <h3>A. Premiers d√©tecteurs</h3>
        <div id="alerts-first"></div>
        <h3>B. D√©j√† vues ailleurs</h3>
        <div id="alerts-others"></div>
      </div>
    </div>

    <!-- Vue utilisateur -->
    <div id="user" class="section" style="display:none">
      <div class="panel">
        <h2>Vue utilisateur</h2>
        <label>Ville :</label>
        <input type="text" id="city">
        <label>Pays :</label>
        <select id="country">
          <option value="Belgium">Belgium</option>
          <option value="France">France</option>
          <option value="USA">USA</option>
          <option value="United Kingdom">United Kingdom</option>
        </select>
        <button>Voir la page utilisateur</button>
      </div>
      <div class="panel" id="user-preview">
        <h2>Pr√©visualisation</h2>
        <iframe src="/index.html" width="100%" height="400"></iframe>
      </div>
    </div>

    <!-- Chat IA -->
    <div id="chat" class="section" style="display:none">
      <div class="panel">
        <h2>Chat IA Console</h2>
        <textarea id="msgConsole"></textarea>
        <button onclick="askAI('console')">Envoyer</button>
        <div id="replyConsole"></div>
      </div>
      <div class="panel">
        <h2>Chat IA Moteur</h2>
        <textarea id="msgEngine"></textarea>
        <button onclick="askAI('engine')">Envoyer</button>
        <div id="replyEngine"></div>
      </div>
    </div>

    <!-- Radar -->
    <div id="radar" class="section" style="display:none">
      <div class="panel">
        <h2>Radar Global</h2>
        <iframe src="/api/radar/global" width="100%" height="400"></iframe>
      </div>
      <div class="panel">
        <h2>Outils techniques</h2>
        <p>Benchmark mod√®les, freshness sources (√† brancher).</p>
      </div>
    </div>
  </div>
</body>
</html>
