<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="robots" content="noindex,nofollow" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>üõ∞Ô∏è Console IA J.E.A.N ‚Äì TINSFLASH</title>

  <!-- === STYLES === -->
  <link href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" rel="stylesheet" />
  <style>
    body { font-family: "Inter", sans-serif; background:#0b0f19; color:#eaeaea; margin:0; }
    header { background:#111831; padding:15px; text-align:center; color:#4fc3f7; font-size:22px; font-weight:bold; }
    nav { background:#1a2238; padding:10px; display:flex; justify-content:center; gap:15px; flex-wrap:wrap; }
    nav a { color:#ccc; text-decoration:none; font-weight:600; }
    nav a:hover { color:#4fc3f7; }
    main { padding:15px; }
    h2 { color:#4fc3f7; border-bottom:1px solid #333; padding-bottom:6px; margin-top:25px; }

    /* --- Section moteur --- */
    .status-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(180px,1fr)); gap:10px; margin-top:10px; }
    .status-box { background:#1a2238; padding:10px; border-radius:8px; text-align:center; }
    .status-box span { display:block; margin-top:4px; font-size:13px; color:#aaa; }

    button { background:#4fc3f7; color:#000; border:none; border-radius:6px; padding:8px 15px; cursor:pointer; font-weight:bold; }
    button:hover { background:#0288d1; }

    /* --- Logs --- */
    #logs { background:#111; border-radius:8px; padding:10px; height:250px; overflow-y:auto; font-size:13px; }
    #errors { background:#260000; border-radius:8px; padding:10px; margin-top:10px; color:#ffbaba; font-size:13px; display:none; }

    /* --- Carte --- */
    #mapForecast, #mapAlerts { height:400px; margin-top:15px; border-radius:8px; }
    .leaflet-popup-content { font-size:13px; }

    /* --- Chat --- */
    .chat-float { position:fixed; bottom:15px; right:15px; width:280px; background:#111831; border-radius:10px; box-shadow:0 0 12px #000; overflow:hidden; }
    .chat-header { background:#4fc3f7; color:#000; font-weight:bold; padding:8px; text-align:center; cursor:pointer; }
    .chat-body { display:none; flex-direction:column; height:260px; }
    .chat-messages { flex:1; overflow-y:auto; padding:8px; font-size:13px; }
    .chat-input { display:flex; gap:5px; padding:8px; background:#0b0f19; }
    .chat-input input { flex:1; padding:6px; border-radius:6px; border:1px solid #555; background:#111; color:#eee; }
    .chat-input button { padding:6px 10px; background:#4fc3f7; border:none; border-radius:6px; cursor:pointer; }

    .msg { margin:4px 0; padding:6px 10px; border-radius:6px; max-width:75%; }
    .bot { background:#333; color:#fff; text-align:left; }
    .user { background:#4fc3f7; color:#000; margin-left:auto; text-align:right; }

    @media (max-width:768px){
      .chat-float{width:90%;right:5%;bottom:10px;}
      #mapForecast,#mapAlerts{height:280px;}
    }
  </style>
</head>

<body>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    // === S√©curit√© ===
    const pin = prompt("Code d‚Äôacc√®s admin ?");
    if (pin !== "202679") { alert("‚õî Acc√®s refus√©"); location.href="/"; }

    // === Variables globales ===
    let mapForecast, mapAlerts;

    // === Initialisation cartes ===
    function initMaps(){
      mapForecast = L.map('mapForecast').setView([20,0],2);
      mapAlerts = L.map('mapAlerts').setView([20,0],2);

      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{ attribution:'¬© OpenStreetMap' }).addTo(mapForecast);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{ attribution:'¬© OpenStreetMap' }).addTo(mapAlerts);
    }

    // === Charger √©tat moteur ===
    async function loadStatus(){
      try {
        const res = await fetch("/api/status");
        const data = await res.json();
        document.getElementById("engineStatus").innerText = data.status;
        document.getElementById("lastRun").innerText = data.lastRun ? new Date(data.lastRun).toLocaleString() : "Jamais";
        if (data.status === "ok") document.getElementById("engineStatus").style.color="#4caf50";
        if (data.status === "fail") document.getElementById("engineStatus").style.color="#ff5252";
        updateMapForecast(data.forecasts);
      } catch(e){ console.error(e); }
    }

    // === Logs SSE ===
    const evtSource = new EventSource("/api/logs/stream");
    evtSource.onmessage = e => {
      const log = JSON.parse(e.data);
      const div = document.getElementById("logs");
      const line = document.createElement("div");
      line.textContent = `[${new Date(log.timestamp).toLocaleTimeString()}] ${log.message}`;
      div.appendChild(line);
      div.scrollTop = div.scrollHeight;
    };

    // === Rafra√Æchir logs manuellement ===
    async function refreshLogs(){
      const res = await fetch("/api/logs/stream");
      console.log("üîÑ Logs rafra√Æchis (flux SSE actif)");
    }

    // === Charger erreurs ===
    async function loadErrors(){
      try {
        const res = await fetch("/api/status");
        const data = await res.json();
        if (data.steps?.errors?.length){
          const box = document.getElementById("errors");
          box.innerHTML = "<b>Erreurs r√©centes :</b><br>"+data.steps.errors.map(e=>`‚Ä¢ ${e}`).join("<br>");
          box.style.display="block";
        }
      }catch(e){console.error(e);}
    }

    // === Cartes : mise √† jour pr√©visions ===
    function updateMapForecast(forecasts){
      if (!forecasts) return;
      for(const [country, data] of Object.entries(forecasts)){
        const color = data.status==="ok"?"#4caf50":data.status==="fail"?"#ff5252":"#ff9800";
        const lat = data.lat || 0, lon = data.lon || 0;
        L.circleMarker([lat,lon],{radius:6,color,fillOpacity:0.8}).addTo(mapForecast)
          .bindPopup(`<b>${country}</b><br>${data.summary || "Pr√©vision en cours"}`);
      }
    }

    // === Cartes : alertes ===
    async function updateMapAlerts(){
      const res = await fetch("/api/alerts");
      const alerts = await res.json();
      alerts.forEach(a=>{
        const col = a.severity==="red"?"#ff0000":a.severity==="orange"?"#ff9800":"#4caf50";
        L.circleMarker([a.lat,a.lon],{radius:7,color:col,fillOpacity:0.8}).addTo(mapAlerts)
          .bindPopup(`<b>${a.region || a.country}</b><br>${a.title}<br>Fiabilit√©: ${a.confidence || "?"}%`);
      });
    }

    // === Bouton run ===
    async function runGlobal(){
      const btn=document.getElementById("runBtn");
      btn.disabled=true;btn.innerText="‚è≥ Lancement...";
      const res=await fetch("/api/run-global",{method:"POST",headers:{"Content-Type":"application/json"}});
      const data=await res.json();
      if(data.success){alert("‚úÖ Run lanc√© avec succ√®s");loadStatus();updateMapAlerts();}
      else{alert("‚ùå Erreur run");}
      btn.disabled=false;btn.innerText="‚ö° Lancer Run Global";
    }

    // === Chat moteur (GPT-3.5) ===
    function addMsg(txt,who="bot"){
      const box=document.querySelector(".chat-messages");
      const div=document.createElement("div");
      div.className=`msg ${who}`;div.innerText=txt;
      box.appendChild(div);box.scrollTop=box.scrollHeight;
    }

    async function sendMsg(){
      const input=document.getElementById("chatInput");
      const text=input.value.trim();if(!text)return;
      addMsg(text,"user");input.value="";
      try{
        const res=await fetch("/api/chat-engine",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({message:text})});
        const data=await res.json();
        addMsg(data.reply||"‚ö†Ô∏è Pas de r√©ponse","bot");
      }catch(e){addMsg("Erreur: "+e.message,"bot");}
    }

    function toggleChat(){
      const body=document.querySelector(".chat-body");
      body.style.display=body.style.display==="flex"?"none":"flex";
    }

    // === Initialisation ===
    window.onload=()=>{
      initMaps();
      loadStatus();
      loadErrors();
      updateMapAlerts();
    };
  </script>

  <!-- === Interface === -->
  <header>üõ∞Ô∏è Console IA J.E.A.N ‚Äì TINSFLASH</header>
  <nav>
    <a href="/admin-pp.html">Console</a>
    <a href="/admin-alerts.html">Alertes</a>
    <a href="/admin-chat.html">Chat</a>
    <a href="/admin-index.html">Vue Index</a>
    <a href="/admin-radar.html">Radar & News</a>
    <a href="/admin-users.html">Utilisateurs</a>
  </nav>

  <main>
    <h2>‚öôÔ∏è √âtat du moteur</h2>
    <button id="runBtn" onclick="runGlobal()">‚ö° Lancer Run Global</button>
    <div class="status-grid">
      <div class="status-box"><b>Statut moteur</b><span id="engineStatus">‚Äì</span></div>
      <div class="status-box"><b>Dernier run</b><span id="lastRun">1970</span></div>
      <div class="status-box"><b>Mod√®les actifs</b><span>IA + GFS + ECMWF + ICON</span></div>
      <div class="status-box"><b>Zones couvertes</b><span>Europe + USA + UK + Ukraine + Scandinavie + Suisse</span></div>
    </div>

    <h2>üìú Logs moteur</h2>
    <button onclick="refreshLogs()">üîÑ Rafra√Æchir</button>
    <div id="logs"></div>

    <div id="errors"></div>

    <h2>üåç Carte pr√©visions (zones couvertes)</h2>
    <div id="mapForecast"></div>

    <h2>üö® Carte alertes (monde)</h2>
    <div id="mapAlerts"></div>
  </main>

  <!-- === Chat IA (GPT-3.5) === -->
  <div class="chat-float">
    <div class="chat-header" onclick="toggleChat()">üí¨ Chat IA moteur</div>
    <div class="chat-body">
      <div class="chat-messages"></div>
      <div class="chat-input">
        <input id="chatInput" placeholder="Demande √† l‚ÄôIA moteur..." />
        <button onclick="sendMsg()">‚ñ∂</button>
      </div>
    </div>
  </div>
</body>
</html>
