<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>âš¡ Centrale NuclÃ©aire MÃ©tÃ©o â€“ Console Admin</title>
  <style>
    body { background: #111; color: #eee; font-family: Arial, sans-serif; padding: 20px; }
    h1 { color: gold; }
    .status { padding: 5px; margin: 10px 0; border-radius: 6px; }
    .status.ok { background: #1e4620; color: #8f8; }
    .status.fail { background: #462020; color: #f88; }
    .status.pending { background: #444; color: orange; }
    button { padding: 10px 20px; font-size: 16px; cursor: pointer; }
    .checklist div { padding: 4px; margin: 2px 0; border-radius: 4px; }
    .red { background: #400; }
    .orange { background: #633; }
    .green { background: #040; }
    #logs { background: #000; padding: 10px; max-height: 250px; overflow-y: auto; font-family: monospace; }
    #alerts { background: #111; padding: 10px; margin-top: 10px; border: 1px solid #333; }
  </style>
</head>
<body>
  <h1>âš¡ Centrale NuclÃ©aire MÃ©tÃ©o â€“ Console Admin</h1>

  <!-- ğŸš€ RUN -->
  <section>
    <h2>ğŸš€ Lancer RUN</h2>
    <button id="runBtn">â–¶ï¸ Lancer RUN</button>
    <div id="runStatus"></div>
  </section>

  <!-- ğŸ“‹ Checklist -->
  <section>
    <h2>ğŸ“‹ Checklist Moteur</h2>
    <div id="checklist" class="checklist"></div>
  </section>

  <!-- ğŸ“œ Logs -->
  <section>
    <h2>ğŸ“œ Logs en direct</h2>
    <div id="logs"></div>
  </section>

  <!-- ğŸš¨ Alertes -->
  <section>
    <h2>ğŸš¨ Alertes</h2>
    <div id="alerts"></div>
  </section>

<script>
  const runBtn = document.getElementById("runBtn");
  const runStatus = document.getElementById("runStatus");
  const checklistDiv = document.getElementById("checklist");
  const alertsDiv = document.getElementById("alerts");

  // === Lancer RUN GLOBAL + CONTINENTAL ===
  runBtn.addEventListener("click", async () => {
    runStatus.innerHTML = '<div class="status pending">ğŸŸ  RUN en cours...</div>';
    try {
      const res = await fetch("/api/run-global", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ zone: "All" }) });
      const data = await res.json();

      if (data.success) {
        if (data.result && data.result.error) {
          runStatus.innerHTML = `<div class="status fail">âš ï¸ Erreur RUN: ${data.result.error}</div>`;
        } else {
          runStatus.innerHTML = `<div class="status ok">âœ… RUN terminÃ© avec succÃ¨s</div>`;
          await fetch("/api/run-continental", { method: "POST" }); // dÃ©clenche continental
        }
      } else {
        runStatus.innerHTML = `<div class="status fail">âŒ RUN Ã©chouÃ©: ${data.error}</div>`;
      }
    } catch (err) {
      runStatus.innerHTML = `<div class="status fail">ğŸ’¥ Erreur: ${err.message}</div>`;
    }
  });

  // === Checklist dynamique ===
  async function refreshChecklist() {
    try {
      const res = await fetch("/api/engine-state");
      const data = await res.json();
      const steps = [
        "Extraction modÃ¨les",
        "RUNGLOBAL Europe",
        "RUNGLOBAL USA",
        "RUN Continentales",
        "Mise sous fichier des extractions",
        "Analyse IA (relief, climat, environnement)",
        "PrÃ©visions locales et nationales",
        "Alertes locales et nationales",
        "Alertes continentales (zones non couvertes)",
        "Vue par pays (zones couvertes)"
      ];
      checklistDiv.innerHTML = "";
      steps.forEach((s, i) => {
        const status = data.checkup?.[i] || data.checkup?.engineStatus || "FAIL";
        let cls = "red";
        if (status === "OK") cls = "green";
        else if (status === "PENDING") cls = "orange";
        checklistDiv.innerHTML += `<div class="${cls}">${i+1}. ${s}</div>`;
      });
    } catch {
      checklistDiv.innerHTML = "<div class='red'>âŒ Impossible de charger la checklist</div>";
    }
  }
  setInterval(refreshChecklist, 5000);

  // === Logs en direct (SSE) ===
  const logsDiv = document.getElementById("logs");
  const evtSource = new EventSource("/api/logs/stream");
  evtSource.onmessage = function(event) {
    const logs = JSON.parse(event.data);
    logsDiv.innerHTML = "";
    logs
      .filter(l => l && l.message && !l.message.includes("Cohere") && !l.message.includes("invalid request"))
      .slice(0, 50) // max 50
      .forEach(log => {
        const time = log.timestamp ? new Date(log.timestamp).toLocaleTimeString() : "--:--:--";
        logsDiv.innerHTML += `<div>[${time}] ${log.message}</div>`;
      });
  };

  // === Alertes ===
  async function refreshAlerts() {
    try {
      const res = await fetch("/api/alerts");
      const data = await res.json();
      alertsDiv.innerHTML = "";
      (data.alerts || []).forEach(a => {
        alertsDiv.innerHTML += `
          <div style="margin-bottom:10px; border-bottom:1px solid #333;">
            <b>${a.type || "?"}</b> â€“ Zone: ${a.zone || a.continent || "?"}<br/>
            FiabilitÃ©: ${a.reliability || "?"}% â€“ IntensitÃ©: ${a.intensity || "?"}<br/>
            ConsÃ©quences: ${a.consequences || "?"}<br/>
            Recommandations: ${a.recommendations || "?"}<br/>
            DurÃ©e: ${a.start || "?"} â†’ ${a.end || "?"}
          </div>
        `;
      });
    } catch {
      alertsDiv.innerHTML = "<div class='red'>âŒ Impossible de charger les alertes</div>";
    }
  }
  setInterval(refreshAlerts, 15000);

  // Init
  refreshChecklist();
  refreshAlerts();
</script>
</body>
</html>
