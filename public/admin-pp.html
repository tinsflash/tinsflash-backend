<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Cockpit Administrateur — Centrale Nucléaire Météo</title>
  <style>
    body { background:#111; color:#eee; font-family: monospace; margin:0; padding:0; }
    nav { background:#222; padding:10px; }
    nav a { color:#ccc; margin-right:15px; text-decoration:none; }
    nav a:hover { color:#fff; }
    h2 { margin-top:20px; color:#0f0; }
    .checklist { background:#000; padding:10px; border:1px solid #333; }
    .logbox { background:#000; color:#0f0; padding:10px; height:200px; overflow-y:auto; border:1px solid #333; }
    .badge { padding:2px 6px; border-radius:4px; font-weight:bold; }
    .pending { background:#555; color:#fff; }
    .running { background:orange; color:#000; }
    .ok { background:green; color:#fff; }
    .fail { background:red; color:#fff; }
    details { margin:5px 0; }
    pre { background:#111; padding:10px; border:1px solid #333; overflow-x:auto; }
  </style>
</head>
<body>

  <!-- Navigation -->
  <nav>
    <a href="/admin">Cockpit</a>
    <a href="/admin-alerts">Alertes</a>
    <a href="/admin-chat">Chat IA</a>
    <a href="/admin-radar">Radar</a>
    <a href="/admin-index">Prévisualisation Index</a>
    <a href="/admin-infos">Infos Météo Mondiales</a>
    <a href="/admin-users">Utilisateurs</a>
  </nav>

  <div style="padding:20px;">
    <h1>⚡ Cockpit Administrateur</h1>

    <!-- Bouton RUN -->
    <button onclick="launchRun()" style="padding:10px; background:red; color:#fff; font-size:16px;">
      🚀 Lancer Run Global
    </button>

    <!-- Checklist moteur -->
    <h2>✅ Checklist moteur</h2>
    <div id="checkup" class="checklist">Chargement...</div>

    <!-- Logs moteur -->
    <h2>📜 Logs moteur</h2>
    <div id="logs" class="logbox">Chargement...</div>

    <!-- État complet moteur -->
    <h2>🛰️ État complet du moteur</h2>
    <button onclick="exportJSON()">📂 Export JSON</button>
    <button onclick="copyJSON()">📋 Copier JSON</button>
    <div id="engineState"></div>
  </div>

<script>
async function fetchCheckup() {
  const res = await fetch("/api/checkup");
  const data = await res.json();
  let html = "<table>";
  for (const [step, status] of Object.entries(data)) {
    let cls = "pending", label = "⚪";
    if (status === "RUNNING") { cls = "running"; label = "🟠"; }
    if (status === "OK") { cls = "ok"; label = "🟢"; }
    if (status === "FAIL") { cls = "fail"; label = "🔴"; }
    html += `<tr><td>${label}</td><td>${step}</td><td><span class="badge ${cls}">${status}</span></td></tr>`;
  }
  html += "</table>";
  document.getElementById("checkup").innerHTML = html;
}

async function fetchLogs() {
  const res = await fetch("/api/logs");
  const logs = await res.json();
  const box = document.getElementById("logs");
  box.innerHTML = logs.map(l => l).join("<br>");
  box.scrollTop = box.scrollHeight;
}

async function fetchEngineState() {
  const res = await fetch("/api/engine-state");
  const data = await res.json();
  const container = document.getElementById("engineState");
  container.innerHTML = "";
  for (const [key, val] of Object.entries(data)) {
    const details = document.createElement("details");
    const summary = document.createElement("summary");
    summary.textContent = key;
    details.appendChild(summary);
    const pre = document.createElement("pre");
    pre.textContent = JSON.stringify(val, null, 2);
    details.appendChild(pre);
    container.appendChild(details);
  }
}

function exportJSON() {
  fetch("/api/engine-state").then(r => r.json()).then(data => {
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "engineState.json";
    a.click();
    URL.revokeObjectURL(url);
  });
}

function copyJSON() {
  fetch("/api/engine-state").then(r => r.json()).then(data => {
    navigator.clipboard.writeText(JSON.stringify(data, null, 2));
    alert("JSON copié dans le presse-papier !");
  });
}

async function launchRun() {
  const res = await fetch("/api/run-global", { method:"POST" });
  const data = await res.json();
  alert("Run global lancé !");
  console.log(data);
}

// Refresh auto
setInterval(fetchCheckup, 2000);
setInterval(fetchLogs, 2000);
setInterval(fetchEngineState, 5000);

// Premier load
fetchCheckup();
fetchLogs();
fetchEngineState();
</script>

</body>
</html>
