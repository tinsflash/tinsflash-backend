<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>‚ö° Cockpit Administrateur ‚Äî Centrale Nucl√©aire M√©t√©o</title>
  <meta name="robots" content="noindex,nofollow">
  <style>
    body { font-family: Arial, sans-serif; background:#111; color:#eee; margin:0; }
    header { background:#222; padding:10px; display:flex; justify-content:space-between; align-items:center; }
    header h1 { margin:0; font-size:18px; color:#fdd835; }
    nav a { color:#0af; margin:0 10px; text-decoration:none; font-weight:bold; }
    nav a:hover { text-decoration:underline; }
    .container { padding:20px; }
    .btn { padding:12px 20px; cursor:pointer; border:none; border-radius:6px; font-weight:bold; }
    .btnRun { background:#0af; color:#fff; }
    .statusBox { padding:12px; margin:15px 0; border-radius:6px; font-weight:bold; font-size:16px; text-align:center; }
    .ok { background:#2e7d32; color:#fff; }
    .fail { background:#c62828; color:#fff; }
    .running { background:#f9a825; color:#000; }
    .checklist { margin-top:20px; }
    .checklist div { padding:12px; margin:5px 0; border-radius:6px; font-weight:bold; }
    .logs { background:#000; padding:10px; margin-top:20px; max-height:300px; overflow-y:auto; font-family:monospace; font-size:12px; color:#0f0; }
    .toggleBtn { margin-top:10px; cursor:pointer; background:#333; color:#fff; border:none; padding:5px 10px; border-radius:5px; }
  </style>
</head>
<body>
<script>
  const pass = prompt("Mot de passe ?");
  if (pass !== "202679") {
    document.body.innerHTML = "<h1 style='color:red;text-align:center;'>‚õî Acc√®s refus√©</h1>";
    throw new Error("Acc√®s refus√©");
  }
</script>

<header>
  <h1>‚ö° Cockpit Administrateur ‚Äî Centrale Nucl√©aire M√©t√©o</h1>
  <nav>
    <a href="admin-pp.html">Console</a>
    <a href="admin-alerts.html">Alertes</a>
    <a href="admin-index.html">Vue Utilisateur</a>
    <a href="admin-chat.html">Chat IA</a>
    <a href="admin-radar.html">Radar + News</a>
    <a href="admin-users.html">Utilisateurs</a>
  </nav>
</header>

<div class="container">
  <!-- Bouton RUN -->
  <button class="btn btnRun" onclick="lancerRun()">üöÄ Lancer RUN Global</button>
  <div id="runStatus" class="statusBox">En attente‚Ä¶</div>

  <!-- Checklist moteur -->
  <h2>üìã Checklist moteur</h2>
  <div class="checklist" id="checklist">
    <div id="step1">1. Extraction mod√®les</div>
    <div id="step2">2. RUNGLOBAL Europe</div>
    <div id="step3">3. RUNGLOBAL USA</div>
    <div id="step4">4. RUN Continentales</div>
    <div id="step5">5. Mise sous fichier des extractions</div>
    <div id="step6">6. Analyse IA (relief, climat, environnement)</div>
    <div id="step7">7. Pr√©visions locales zones couvertes</div>
    <div id="step8">8. Pr√©visions nationales zones couvertes</div>
    <div id="step9">9. Alertes locales zones couvertes</div>
    <div id="step10">10. Alertes nationales zones couvertes</div>
    <div id="step11">11. Alertes continentales (zones non couvertes)</div>
    <div id="step12">12. Assemblage alertes mondiales</div>
    <div id="step13">13. Open Data pr√©visions zones non couvertes</div>
  </div>

  <h3 id="moteurStatus" class="statusBox">Moteur op√©rationnel : ‚è≥</h3>

  <!-- Logs -->
  <h2>üìú Logs en direct</h2>
  <div class="logs" id="logs">[Logs en attente‚Ä¶]</div>
  <button class="toggleBtn" onclick="toggleLogs()">Voir plus/moins</button>
</div>

<script>
  function setStep(id, status) {
    const el = document.getElementById(id);
    el.className = status;
  }

  async function lancerRun() {
    const statusBox = document.getElementById("runStatus");
    statusBox.innerHTML = "‚è≥ RUN en cours...";
    statusBox.className = "statusBox running";

    try {
      const res = await fetch("/api/run-global", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ zone: "All" })
      });

      const text = await res.text();
      let data;
      try {
        data = JSON.parse(text);
      } catch (e) {
        throw new Error("R√©ponse invalide du backend: " + text.slice(0,100));
      }

      if (data.success) {
        statusBox.innerHTML = "‚úÖ RUN termin√© avec succ√®s";
        statusBox.className = "statusBox ok";
        document.getElementById("moteurStatus").innerHTML = "Moteur op√©rationnel : OK ‚úÖ";
        document.getElementById("moteurStatus").className = "statusBox ok";
      } else {
        statusBox.innerHTML = "‚ùå RUN √©chec: " + (data.error || "Erreur inconnue");
        statusBox.className = "statusBox fail";
        document.getElementById("moteurStatus").innerHTML = "Moteur op√©rationnel : FAIL ‚ùå";
        document.getElementById("moteurStatus").className = "statusBox fail";
      }
    } catch (err) {
      statusBox.innerHTML = "‚ùå Erreur RUN: " + err.message;
      statusBox.className = "statusBox fail";
      document.getElementById("moteurStatus").innerHTML = "Moteur op√©rationnel : FAIL ‚ùå";
      document.getElementById("moteurStatus").className = "statusBox fail";
    }
  }

  // Logs SSE
  let showAll = false;
  function toggleLogs() { showAll = !showAll; }

  const logsBox = document.getElementById("logs");
  const evtSource = new EventSource("/api/logs/stream");
  evtSource.onmessage = function(event) {
    try {
      const logs = JSON.parse(event.data);
      const recent = showAll ? logs : logs.slice(-20); // garder 20 derni√®res par d√©faut
      logsBox.innerHTML = recent
        .map(l => `[${new Date(l.timestamp).toLocaleTimeString()}] ${l.message}`)
        .join("<br>");
      logsBox.scrollTop = logsBox.scrollHeight;
    } catch (err) {
      logsBox.innerHTML += "<br>‚ö†Ô∏è Erreur parsing logs: " + err.message;
    }
  };
</script>
</body>
</html>
