<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="robots" content="noindex,nofollow" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Console Admin ‚Äì Centrale Nucl√©aire M√©t√©o</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #0b0f1a;
      color: #e6e6e6;
      margin: 0;
      padding: 0;
    }
    header {
      background: #111827;
      padding: 15px;
      text-align: center;
      font-size: 20px;
      font-weight: bold;
      color: #00d4ff;
    }
    main { padding: 20px; }
    section { margin-bottom: 25px; }
    h2 {
      border-bottom: 2px solid #00d4ff;
      padding-bottom: 5px;
      margin-bottom: 10px;
    }
    button {
      background: #00d4ff;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      font-size: 16px;
      cursor: pointer;
    }
    button:hover { background: #00aacc; }
    ul { list-style: none; padding: 0; }
    li { margin: 6px 0; }
    .status { font-weight: bold; padding: 2px 8px; border-radius: 4px; }
    .ok { background: #065f46; color: #10b981; }
    .fail { background: #7f1d1d; color: #ef4444; }
    .pending { background: #78350f; color: #f59e0b; }
    #logs {
      background: #1f2937;
      padding: 10px;
      border-radius: 6px;
      height: 250px;
      overflow-y: auto;
      font-family: monospace;
      font-size: 13px;
    }
    .alert {
      border: 1px solid #374151;
      border-radius: 6px;
      padding: 10px;
      margin-bottom: 10px;
    }
    .alert strong { display: block; margin-bottom: 5px; }
  </style>
</head>
<body>
  <header>‚ö° Console Admin ‚Äì TINSFLASH</header>
  <main>
    <!-- Section 1 : Run -->
    <section>
      <h2>üöÄ Lancer la Centrale</h2>
      <button onclick="launchRun()">Lancer RUN Global + Continental</button>
      <p id="runStatus"></p>
    </section>

    <!-- Section 2 : Checklist moteur -->
    <section>
      <h2>üìã Checklist moteur</h2>
      <ul id="checklist">
        <li>1A. Extraction des mod√®les ‚Üí <span class="status pending">‚è≥ Pending</span></li>
        <li>1B. Run Global Europe ‚Üí <span class="status pending">‚è≥ Pending</span></li>
        <li>1C. Run Global USA ‚Üí <span class="status pending">‚è≥ Pending</span></li>
        <li>1D. Runs Continentaux ‚Üí <span class="status pending">‚è≥ Pending</span></li>
        <li>2. Mise sous fichier des extractions ‚Üí <span class="status pending">‚è≥ Pending</span></li>
        <li>3. Analyse IA (relief, climat, env., satellites) ‚Üí <span class="status pending">‚è≥ Pending</span></li>
        <li>4. Pr√©visions locales & nationales (zones couvertes) ‚Üí <span class="status pending">‚è≥ Pending</span></li>
        <li>5. Alertes locales & nationales (zones couvertes) ‚Üí <span class="status pending">‚è≥ Pending</span></li>
        <li>6. Alertes continentales (zones non couvertes) ‚Üí <span class="status pending">‚è≥ Pending</span></li>
        <li>7. Vue par pays (zones couvertes : pr√©visions + alertes) ‚Üí <span class="status pending">‚è≥ Pending</span></li>
      </ul>
    </section>

    <!-- Section 3 : Logs -->
    <section>
      <h2>üìú Logs en direct</h2>
      <div id="logs">‚è≥ En attente de nouveaux logs...</div>
    </section>

    <!-- Section 4 : Alertes -->
    <section>
      <h2>üö® Alertes Primeur / √Ä valider / √Ä surveiller</h2>
      <div id="alerts"></div>
    </section>
  </main>

  <script>
    // Lancer RUN Global + Continental
    async function launchRun() {
      document.getElementById("runStatus").textContent = "‚è≥ Lancement en cours...";
      try {
        const globalRes = await fetch("/api/run-global", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({}) });
        const contRes = await fetch("/api/run-continental", { method: "POST" });
        document.getElementById("runStatus").textContent = "‚úÖ Runs lanc√©s avec succ√®s";
      } catch (err) {
        document.getElementById("runStatus").textContent = "‚ùå Erreur lors du lancement : " + err.message;
      }
    }

    // Checklist moteur ‚Üí refresh auto
    async function refreshChecklist() {
      try {
        const res = await fetch("/api/checkup");
        const data = await res.json();
        const items = document.querySelectorAll("#checklist li span");

        const keys = [
          "models", "runEurope", "runUSA", "runContinental",
          "saveFiles", "analysisAI", "forecastCovered",
          "alertsCovered", "alertsContinental", "perCountryView"
        ];

        keys.forEach((key, i) => {
          if (data[key] === "OK") {
            items[i].textContent = "üü¢ OK";
            items[i].className = "status ok";
          } else if (data[key] === "FAIL") {
            items[i].textContent = "‚ùå FAIL";
            items[i].className = "status fail";
          } else {
            items[i].textContent = "‚è≥ Pending";
            items[i].className = "status pending";
          }
        });
      } catch (err) {
        console.error("Checklist error:", err);
      }
    }
    setInterval(refreshChecklist, 10000);
    refreshChecklist();

    // Logs SSE
    function connectLogs() {
      const logDiv = document.getElementById("logs");
      logDiv.textContent = "";
      const evtSource = new EventSource("/api/logs/stream");
      evtSource.onmessage = (event) => {
        const logs = JSON.parse(event.data);
        logDiv.textContent = "";
        logs.forEach(log => {
          const p = document.createElement("p");
          p.textContent = `[${log.timestamp}] ${log.message}`;
          logDiv.appendChild(p);
        });
        logDiv.scrollTop = logDiv.scrollHeight;
      };
    }
    connectLogs();

    // Alertes
    async function refreshAlerts() {
      try {
        const res = await fetch("/api/alerts");
        const data = await res.json();
        const container = document.getElementById("alerts");
        container.innerHTML = "";
        (data.alerts || []).forEach(alert => {
          const div = document.createElement("div");
          div.className = "alert";
          div.innerHTML = `
            <strong>${alert.type} (${alert.reliability}%)</strong>
            ${alert.description || ""}<br/>
            ${alert.firstDetector ? "üåç Primeur (nous les 1ers)" : ""}
          `;
          container.appendChild(div);
        });
      } catch (err) {
        console.error("Alerts error:", err);
      }
    }
    setInterval(refreshAlerts, 15000);
    refreshAlerts();
  </script>
</body>
</html>
