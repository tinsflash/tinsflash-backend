<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>⚡ Centrale Nucléaire Météo – Console Admin</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <header>
    <h1>⚡ Centrale Nucléaire Météo – Console Admin</h1>
  </header>

  <!-- SuperForecast -->
  <section>
    <h3>🚀 SuperForecast</h3>
    <button onclick="runSuperForecast()">Lancer Run</button>
    <p id="sf-status">⏳ En attente…</p>
  </section>

  <!-- Prévisions -->
  <section>
    <h3>📡 Prévisions nationales (BE / FR multi-zones / USA)</h3>
    <div id="forecast-list">⏳ Chargement…</div>
    <button onclick="publishToIndex()">Publier vers index</button>
  </section>

  <!-- Alertes -->
  <section>
    <h3>⚠️ Alertes</h3>
    <div id="alerts">Aucune alerte</div>
  </section>

  <!-- Chat J.E.A.N. -->
  <section>
    <h3>🤖 Chat J.E.A.N.</h3>
    <input type="text" id="chat-input" placeholder="Pose ta question..." />
    <button id="chat-send">Envoyer</button>
    <p id="chat-response">⏳ En attente...</p>
  </section>

  <!-- Debug IA -->
  <section id="debug-ia" style="display:none;">
    <h3>🛠️ Debug Cohere</h3>
    <pre id="debug-content" style="background:#111; color:#0f0; padding:10px; border-radius:8px; max-height:200px; overflow:auto;"></pre>
  </section>
  <button id="toggle-debug">Afficher debug IA</button>

  <!-- Logs -->
  <section>
    <h3>📜 Logs</h3>
    <div id="logs">⏳ Chargement…</div>
  </section>

  <script>
    async function runSuperForecast() {
      document.getElementById("sf-status").textContent = "⏳ Run en cours…";
      const res = await fetch("/api/superforecast/run", { method: "POST" });
      const data = await res.json();
      document.getElementById("sf-status").textContent = "✅ Run terminé";
      loadLogs();
    }

    async function publishToIndex() {
      alert("📤 Prévisions publiées vers l’index (front).");
    }

    async function loadForecasts() {
      const res = await fetch("/api/forecasts");
      const data = await res.json();
      const container = document.getElementById("forecast-list");
      if (!data || data.length === 0) {
        container.textContent = "⚠️ Aucune prévision disponible.";
        return;
      }
      container.innerHTML = data.map(f =>
        `<div><strong>${f.zone || "N/A"}</strong> – ${f.minTemp ?? "?"}° / ${f.maxTemp ?? "?"}° – 🌧️ ${f.precip ?? "?"}% – 💨 ${f.wind ?? "?"} km/h</div>`
      ).join("");
    }

    async function loadAlerts() {
      const res = await fetch("/api/alerts");
      const data = await res.json();
      const container = document.getElementById("alerts");
      if (!data || data.length === 0) {
        container.textContent = "⚠️ Aucune alerte.";
        return;
      }
      container.innerHTML = data.map(a =>
        `<div>🚨 ${a.type} – ${a.zone} (${a.level})</div>`
      ).join("");
    }

    async function loadLogs() {
      const res = await fetch("/api/logs");
      const data = await res.json();
      const container = document.getElementById("logs");
      if (!data || data.length === 0) {
        container.textContent = "⚠️ Aucun log.";
        return;
      }
      container.innerHTML = data.map(l =>
        `<div>[${l.date || "?"}] ${l.message}</div>`
      ).join("");
    }

    // Chat JEAN
    const chatInput = document.getElementById("chat-input");
    const chatSend = document.getElementById("chat-send");
    const chatResponse = document.getElementById("chat-response");
    const debugSection = document.getElementById("debug-ia");
    const debugContent = document.getElementById("debug-content");
    const toggleDebug = document.getElementById("toggle-debug");

    toggleDebug.addEventListener("click", () => {
      debugSection.style.display = debugSection.style.display === "none" ? "block" : "none";
    });

    chatSend.addEventListener("click", async () => {
      const message = chatInput.value.trim();
      if (!message) {
        chatResponse.textContent = "⚠️ Entrez une question.";
        return;
      }

      chatResponse.textContent = "⏳ J.E.A.N. réfléchit...";

      try {
        const res = await fetch("/api/chat", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ message }),
        });

        const data = await res.json();
        chatResponse.textContent = data.reply || "⚠️ Réponse indisponible";

        if (data.debug) {
          debugContent.textContent = JSON.stringify(data.debug, null, 2);
        }
      } catch (err) {
        chatResponse.textContent = "⚠️ Erreur réseau.";
      }
    });

    // Auto-load
    loadForecasts();
    loadAlerts();
    loadLogs();
  </script>
</body>
</html>
