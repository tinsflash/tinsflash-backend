<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="robots" content="noindex,nofollow">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‚ö° Console Admin ‚Äî Centrale M√©t√©o Mondiale</title>
  <style>
    body { font-family: Arial, sans-serif; background:#0d1117; color:#e6edf3; margin:0; }
    header { background:#111; padding:12px; text-align:center; font-size:22px; font-weight:bold; color:#0af; }
    nav { background:#1c1f26; padding:10px; text-align:center; }
    nav a { color:#0af; margin:0 12px; text-decoration:none; }
    h2, h3 { margin:15px 0 10px; color:#0af; }
    .grid { display:grid; grid-template-columns: repeat(auto-fill,minmax(200px,1fr)); gap:10px; margin:10px 0; }
    .zone { background:#161b22; border-radius:6px; padding:10px; }
    .zone button { margin-top:6px; padding:6px 10px; border:none; border-radius:4px; cursor:pointer; background:#0af; color:#000; font-weight:bold; }
    .status-ball { width:14px; height:14px; border-radius:50%; display:inline-block; margin-right:6px; }
    .status-ball.pending { background:#cc0; }
    .status-ball.ok { background:#2a2; }
    .status-ball.fail { background:#a22; }
    #logs { background:#000; color:#eee; font-family:monospace; padding:10px; height:250px; overflow-y:auto; border-radius:8px; margin-top:10px; white-space:pre-wrap; }
    .info { color:#0af; }
    .warn { color:#cc0; }
    .error { color:#f55; }
    #chatButton { position:fixed; bottom:20px; right:20px; width:60px; height:60px; border-radius:50%; background:#0af; color:#fff; font-size:22px; font-weight:bold; border:none; cursor:pointer; }
    #chatBubble { position:fixed; bottom:90px; right:20px; width:320px; height:420px; background:#161b22; border:2px solid #0af; border-radius:10px; display:none; flex-direction:column; }
    #chatBubble header { padding:8px; font-weight:bold; text-align:center; color:#0af; }
    #chatLog { flex:1; overflow-y:auto; padding:8px; background:#0d1117; border-radius:6px; }
    #chatInput { display:flex; }
    #chatInput input { flex:1; padding:6px; border:none; border-radius:6px; }
    #chatInput button { padding:6px 10px; background:#0af; border:none; border-radius:6px; cursor:pointer; }
  </style>
</head>
<body>
<script>
  const pass = prompt("Code d'acc√®s ?");
  if (pass !== "202679") {
    document.body.innerHTML = "<h1 style='color:red;text-align:center;'>‚õî Acc√®s refus√©</h1>";
    throw new Error("Acc√®s refus√©");
  }
</script>

<header>‚ö° Centrale Nucl√©aire M√©t√©o ‚Äî Console Admin</header>
<nav>
  <a href="/admin">Console</a>
  <a href="/admin-alerts">Alertes</a>
  <a href="/admin-chat">Chat IA</a>
  <a href="/admin-index">Vue Index</a>
  <a href="/admin-radar">Radar & News</a>
  <a href="/admin-users">Utilisateurs</a>
</nav>

<main style="padding:20px;">
  <h2>üõ∞Ô∏è √âtapes du moteur</h2>
  <div id="engine-steps" class="grid"></div>

  <h2>üìä Pr√©visions ‚Äî Zones couvertes</h2>
  <div id="forecast-zones" class="grid"></div>

  <h2>üö® Alertes ‚Äî Zones couvertes</h2>
  <div id="alert-zones" class="grid"></div>

  <h2>üåç Alertes continentales</h2>
  <div id="continental-zones" class="grid"></div>

  <h2>ü§ñ Fusion & Orchestration IA</h2>
  <div id="fusion-ia" class="zone">
    <span class="status-ball pending"></span> Fusion & Orchestration globale
    <button onclick="runZone('fusion','/api/run-orchestrator')">Relancer</button>
  </div>

  <h2>üìú Logs moteur (live)</h2>
  <div id="logs">Connexion en cours‚Ä¶</div>
</main>

<!-- Chat bulle -->
<button id="chatButton" onclick="toggleChat()">üí¨</button>
<div id="chatBubble">
  <header>ü§ñ Chat IA Moteur</header>
  <div id="chatLog"></div>
  <div id="chatInput">
    <input type="text" id="chatMsg" placeholder="Demander au moteur..." onkeypress="if(event.key==='Enter') sendChat()">
    <button onclick="sendChat()">Envoyer</button>
  </div>
</div>

<script>
  // √âtapes moteur fixes
  const engineSteps = [
    { id:"geo", name:"Import donn√©es g√©ographiques" },
    { id:"models", name:"Pompage mod√®les physiques & IA" },
    { id:"forecast", name:"Pr√©visions zones couvertes" },
    { id:"alerts", name:"Alertes zones couvertes" },
    { id:"continental", name:"Alertes continentales" },
    { id:"fusion-step", name:"Fusion IA finale" }
  ];

  function renderSteps() {
    const c = document.getElementById("engine-steps");
    c.innerHTML = "";
    engineSteps.forEach(s=>{
      const div = document.createElement("div");
      div.className="zone";
      div.id=s.id;
      div.innerHTML=`<span class="status-ball pending"></span>${s.name}`;
      c.appendChild(div);
    });
  }
  renderSteps();

  // Zones continentales
  const continentalZones = [
    { id:"africa", name:"Afrique", endpoint:"/api/run-alerts-continental?continent=Africa" },
    { id:"asia", name:"Asie", endpoint:"/api/run-alerts-continental?continent=Asia" },
    { id:"oceania", name:"Oc√©anie", endpoint:"/api/run-alerts-continental?continent=Oceania" },
    { id:"south-america", name:"Am√©rique du Sud", endpoint:"/api/run-alerts-continental?continent=SouthAmerica" }
  ];
  function renderContinental() {
    const c=document.getElementById("continental-zones");
    c.innerHTML="";
    continentalZones.forEach(z=>{
      const div=document.createElement("div");
      div.className="zone"; div.id=z.id;
      div.innerHTML=`<span class="status-ball pending"></span>${z.name}
      <button onclick="runZone('${z.id}','${z.endpoint}')">Relancer</button>`;
      c.appendChild(div);
    });
  }
  renderContinental();

  // G√©n√©ration zones couvertes depuis /api/engine-state
  async function buildCoveredZones() {
    const res=await fetch("/api/engine-state");
    const state=await res.json();
    const f=document.getElementById("forecast-zones");
    const a=document.getElementById("alert-zones");
    f.innerHTML=""; a.innerHTML="";
    if(state && state.checkup){
      Object.keys(state.checkup).forEach(zone=>{
        const divF=document.createElement("div");
        divF.className="zone"; divF.id="forecast-"+zone;
        divF.innerHTML=`<span class="status-ball pending"></span>${zone}
        <button onclick="runZone('forecast-${zone}','/api/run-global?zone=${zone}')">Relancer</button>`;
        f.appendChild(divF);

        const divA=document.createElement("div");
        divA.className="zone"; divA.id="alert-"+zone;
        divA.innerHTML=`<span class="status-ball pending"></span>${zone}
        <button onclick="runZone('alert-${zone}','/api/run-alerts?zone=${zone}')">Relancer</button>`;
        a.appendChild(divA);
      });
    }
  }
  buildCoveredZones();

  // Statuts
  function setStatus(zone,state){
    const el=document.querySelector(`#${zone} .status-ball`);
    if(el) el.className="status-ball "+state;
  }

  async function runZone(zoneId,endpoint){
    setStatus(zoneId,"pending");
    try{
      const res=await fetch(endpoint,{method:"POST"});
      const data=await res.json();
      setStatus(zoneId,data.success?"ok":"fail");
    }catch{ setStatus(zoneId,"fail"); }
  }

  // Refresh auto
  async function refreshStatus(){
    const res=await fetch("/api/engine-state");
    const state=await res.json();
    if(state && state.checkup){
      Object.entries(state.checkup).forEach(([zone,status])=>{
        const f="forecast-"+zone, a="alert-"+zone;
        if(status==="ok"){ setStatus(f,"ok"); setStatus(a,"ok"); }
        else if(status==="fail"){ setStatus(f,"fail"); setStatus(a,"fail"); }
        else { setStatus(f,"pending"); setStatus(a,"pending"); }
      });
    }
  }
  setInterval(refreshStatus,10000);

  // Logs live
  const logDiv=document.getElementById("logs");
  const evt=new EventSource("/api/logs/stream");
  evt.onmessage=(e)=>{
    const log=JSON.parse(e.data);
    let cls="info";
    if(log.message.includes("ERROR")) cls="error";
    if(log.message.includes("WARN")) cls="warn";
    logDiv.innerHTML+=`<div class="${cls}">[${new Date(log.ts).toLocaleTimeString()}] ${log.message}</div>`;
    logDiv.scrollTop=logDiv.scrollHeight;
  };

  // Chat moteur
  function toggleChat(){
    const c=document.getElementById("chatBubble");
    c.style.display=c.style.display==="flex"?"none":"flex";
  }
  async function sendChat(){
    const input=document.getElementById("chatMsg");
    const msg=input.value.trim();
    if(!msg) return;
    const log=document.getElementById("chatLog");
    log.innerHTML+=`<div><b>Moi:</b> ${msg}</div>`;
    input.value="";
    const res=await fetch("/api/chat/engine",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({message:msg})});
    const data=await res.json();
    log.innerHTML+=`<div><b>Moteur:</b> ${data.reply}</div>`;
    log.scrollTop=log.scrollHeight;
  }
</script>
</body>
</html>
