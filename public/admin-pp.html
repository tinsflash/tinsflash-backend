<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="robots" content="noindex,nofollow" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>üõ∞Ô∏è Console IA J.E.A.N ‚Äì TINSFLASH</title>

  <link href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" rel="stylesheet" />

  <style>
    body { font-family:"Inter",sans-serif;background:#0b0f19;color:#eaeaea;margin:0;overflow-x:hidden; }
    header { background:#111831;padding:15px;text-align:center;color:#4fc3f7;font-size:22px;font-weight:bold; }
    nav { background:#1a2238;padding:10px;display:flex;justify-content:center;gap:15px;flex-wrap:wrap; }
    nav a { color:#ccc;text-decoration:none;font-weight:600; }
    nav a:hover { color:#4fc3f7; }
    main { padding:15px; }
    h2 { color:#4fc3f7;border-bottom:1px solid #333;padding-bottom:6px;margin-top:25px; }

    .status-grid { display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:10px;margin-top:10px; }
    .status-box { background:#1a2238;padding:10px;border-radius:8px;text-align:center; }
    .status-box span { display:block;margin-top:4px;font-size:13px;color:#aaa; }

    button { background:#4fc3f7;color:#000;border:none;border-radius:6px;padding:8px 15px;cursor:pointer;font-weight:bold; }
    button:hover { background:#0288d1; }

    #summaryTable { width:100%;margin-top:10px;border-collapse:collapse;font-size:14px; }
    #summaryTable th,#summaryTable td { border:1px solid #333;padding:6px;text-align:center; }
    #summaryTable th { background:#1a2238;color:#4fc3f7; }

    #logs { background:#111;border-radius:8px;padding:10px;height:220px;overflow-y:auto;font-size:13px;margin-top:10px; }
    #errors { background:#260000;border-radius:8px;padding:10px;margin-top:10px;color:#ffbaba;font-size:13px;display:none; }

    #mapForecast,#mapAlerts { height:380px;margin-top:10px;border-radius:8px; }

    /* Voyants */
    .led { display:inline-block;width:14px;height:14px;border-radius:50%;margin-right:5px; }
    .led.green { background:#00ff80;box-shadow:0 0 8px #00ff80; }
    .led.red { background:#ff5252;box-shadow:0 0 8px #ff5252; }
    .led.orange { background:#ffaa00;animation:blink 1s infinite; }
    @keyframes blink {50%{opacity:0.2;}}

    /* Chat */
    .chat-float { position:fixed;bottom:15px;right:15px;width:280px;background:#111831;border-radius:10px;box-shadow:0 0 12px #000;overflow:hidden; }
    .chat-header { background:#4fc3f7;color:#000;font-weight:bold;padding:8px;text-align:center;cursor:pointer; }
    .chat-body { display:none;flex-direction:column;height:260px; }
    .chat-messages { flex:1;overflow-y:auto;padding:8px;font-size:13px; }
    .chat-input { display:flex;gap:5px;padding:8px;background:#0b0f19; }
    .chat-input input { flex:1;padding:6px;border-radius:6px;border:1px solid #555;background:#111;color:#eee; }
    .chat-input button { padding:6px 10px;background:#4fc3f7;border:none;border-radius:6px;cursor:pointer; }

    .msg { margin:4px 0;padding:6px 10px;border-radius:6px;max-width:75%; }
    .bot { background:#333;color:#fff;text-align:left; }
    .user { background:#4fc3f7;color:#000;margin-left:auto;text-align:right; }

    @media(max-width:768px){.chat-float{width:90%;right:5%;bottom:10px;}#mapForecast,#mapAlerts{height:280px;}}
  </style>
</head>
<body>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
/* === S√©curit√© === */
const storedPin=sessionStorage.getItem("tinsflashPIN");
if(!storedPin){
  const pin=prompt("Code d‚Äôacc√®s admin ?");
  if(pin!=="202679"){alert("‚õî Acc√®s refus√©");location.href="/";}else{sessionStorage.setItem("tinsflashPIN","ok");}
}

/* === Variables === */
let mapForecast,mapAlerts;

/* === Init cartes === */
function initMaps(){
  mapForecast=L.map("mapForecast").setView([20,0],2);
  mapAlerts=L.map("mapAlerts").setView([20,0],2);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:"¬© OpenStreetMap"}).addTo(mapForecast);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:"¬© OpenStreetMap"}).addTo(mapAlerts);
}

/* === Rafra√Æchir statut moteur === */
async function loadStatus(){
  try{
    const res=await fetch("/api/status");
    const data=await res.json();
    const statusEl=document.getElementById("engineStatus");
    const led=document.getElementById("engineLed");
    const s=data.status?.toLowerCase()||"idle";
    statusEl.innerText=data.status||"‚Äì";
    if(s==="ok"){led.className="led green";}
    else if(s==="running"){led.className="led orange";}
    else if(s==="fail"){led.className="led red";}
    else{led.className="led red";}
    document.getElementById("lastRun").innerText=data.lastRun?new Date(data.lastRun).toLocaleString():"Jamais";
  }catch(e){console.error(e);}
}

/* === Lancement Run Global === */
async function runGlobal(){
  const btn=document.getElementById("runBtn");
  btn.disabled=true;
  btn.innerText="‚è≥ Lancement...";
  const res=await fetch("/api/run-global",{method:"POST"});
  const data=await res.json();
  if(data.success){
    alert("‚úÖ Moteur lanc√© avec succ√®s !");
    await addLogLine("‚úÖ Run global confirm√© par le moteur.");
  }else{
    alert("‚ùå √âchec du lancement : "+(data.error||"Erreur inconnue"));
    await addLogLine("‚ùå Erreur lancement : "+(data.error||""));
  }
  btn.disabled=false;
  btn.innerText="‚ö° Lancer Run Global";
  loadStatus();updateMapForecast();updateMapAlerts();
}

/* === Logs SSE === */
const evtSource=new EventSource("/api/logs/stream");
evtSource.onmessage=e=>{
  const log=JSON.parse(e.data);
  addLogLine(`[${new Date(log.timestamp).toLocaleTimeString()}] ${log.message}`);
};
function addLogLine(msg){
  const div=document.getElementById("logs");
  const line=document.createElement("div");
  line.textContent=msg;
  div.appendChild(line);
  div.scrollTop=div.scrollHeight;
}

/* === Maps Pr√©visions === */
async function updateMapForecast(){
  mapForecast.eachLayer(l=>{if(l instanceof L.CircleMarker)mapForecast.removeLayer(l);});
  try{
    const res=await fetch("/api/status");
    const data=await res.json();
    const forecasts=data.forecasts||{};
    for(const [country,info] of Object.entries(forecasts)){
      const color=info.status==="ok"?"#00ff80":info.status==="fail"?"#ff5252":"#ffaa00";
      const lat=info.lat||0,lon=info.lon||0;
      L.circleMarker([lat,lon],{radius:6,color,fillOpacity:0.8})
        .addTo(mapForecast)
        .bindPopup(`<b>${country}</b><br>${info.summary||"Pr√©vision en cours"}`);
    }
  }catch(e){console.error(e);}
}

/* === Maps Alertes === */
async function updateMapAlerts(){
  mapAlerts.eachLayer(l=>{if(l instanceof L.CircleMarker)mapAlerts.removeLayer(l);});
  const res=await fetch("/api/alerts");
  const alerts=await res.json();
  alerts.forEach(a=>{
    const col=a.severity==="extreme"?"#ff0000":a.severity==="high"?"#ff9800":a.severity==="medium"?"#ffff00":"#4caf50";
    if(a.lat && a.lon){
      L.circleMarker([a.lat,a.lon],{radius:7,color:col,fillOpacity:0.8})
      .addTo(mapAlerts)
      .bindPopup(`<b>${a.country}</b><br>${a.title}<br>${a.description}<br>Fiabilit√©: ${a.certainty}%`);
    }
  });
}

/* === Tableau alertes === */
async function loadSummary(){
  const res=await fetch("/api/alerts/summary");
  const s=await res.json();
  document.getElementById("summaryBody").innerHTML=`
    <tr><td>Total</td><td>${s.total||0}</td></tr>
    <tr><td>Publi√©es ‚â•90%</td><td>${s.byStatus?.published||0}</td></tr>
    <tr><td>√Ä valider</td><td>${s.byStatus?.toValidate||0}</td></tr>
    <tr><td>Sous surveillance</td><td>${s.byStatus?.["under-surveillance"]||0}</td></tr>
    <tr><td>Archiv√©es</td><td>${s.byStatus?.archived||0}</td></tr>
    <tr><td>Exclusives</td><td>${s.exclusives||0}</td></tr>`;
}

/* === Chat IA moteur (GPT-3.5) === */
function addMsg(txt,who="bot"){
  const box=document.querySelector(".chat-messages");
  const div=document.createElement("div");
  div.className=`msg ${who}`;div.innerText=txt;
  box.appendChild(div);box.scrollTop=box.scrollHeight;
}
async function sendMsg(){
  const input=document.getElementById("chatInput");
  const text=input.value.trim();if(!text)return;
  addMsg(text,"user");input.value="";
  try{
    const res=await fetch("/api/chat-engine",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({message:text})});
    const data=await res.json();
    addMsg(data.reply||"‚ö†Ô∏è Pas de r√©ponse","bot");
  }catch(e){addMsg("Erreur: "+e.message,"bot");}
}
function toggleChat(){
  const body=document.querySelector(".chat-body");
  body.style.display=body.style.display==="flex"?"none":"flex";
}

/* === Init === */
window.onload=()=>{
  initMaps();loadStatus();loadSummary();updateMapForecast();updateMapAlerts();
  setInterval(()=>{loadStatus();loadSummary();updateMapForecast();updateMapAlerts();},10000);
};
</script>

<header>üõ∞Ô∏è Console IA J.E.A.N ‚Äì TINSFLASH</header>
<nav>
  <a href="/admin-pp.html">Console</a>
  <a href="/admin-alerts.html">Alertes</a>
  <a href="/admin-index.html">Index</a>
  <a href="/admin-radar.html">Radar</a>
  <a href="/admin-users.html">Utilisateurs</a>
</nav>

<main>
  <h2>‚öôÔ∏è √âtat du moteur</h2>
  <button id="runBtn" onclick="runGlobal()">‚ö° Lancer Run Global</button>

  <div class="status-grid">
    <div class="status-box"><b><span id="engineLed" class="led red"></span>Statut moteur</b><span id="engineStatus">‚Äì</span></div>
    <div class="status-box"><b>Dernier run</b><span id="lastRun">Jamais</span></div>
    <div class="status-box"><b>Mod√®les actifs</b><span>IA + GFS + ECMWF + ICON</span></div>
    <div class="status-box"><b>Zones couvertes</b><span>Europe + USA + UK + Ukraine + Scandinavie + Suisse</span></div>
  </div>

  <h2>üìä Synth√®se des alertes</h2>
  <table id="summaryTable">
    <thead><tr><th>Type</th><th>Nombre</th></tr></thead>
    <tbody id="summaryBody"><tr><td colspan="2">Chargement...</td></tr></tbody>
  </table>

  <h2>üåç Carte pr√©visions (zones couvertes)</h2>
  <div id="mapForecast"></div>

  <h2>üö® Carte alertes (monde)</h2>
  <div id="mapAlerts"></div>

  <h2>üìú Logs moteur</h2>
  <div id="logs"></div>
  <div id="errors"></div>
</main>

<!-- Chat IA -->
<div class="chat-float">
  <div class="chat-header" onclick="toggleChat()">üí¨ Chat IA moteur</div>
  <div class="chat-body">
    <div class="chat-messages"></div>
    <div class="chat-input">
      <input id="chatInput" placeholder="Demande √† l‚ÄôIA moteur..." />
      <button onclick="sendMsg()">‚ñ∂</button>
    </div>
  </div>
</div>

</body>
</html>
