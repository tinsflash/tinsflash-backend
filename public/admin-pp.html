<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="robots" content="noindex,nofollow">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‚ö° Console Admin ‚Äì Centrale Nucl√©aire M√©t√©o</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial, sans-serif; background:#111; color:#eee; margin:0; }
    header { background:#222; padding:10px; text-align:center; }
    nav a { color:#0af; margin:0 10px; text-decoration:none; }
    h2, h3 { margin-top:20px; }

    /* R√©sum√© */
    #alertsSummary { background:#222; padding:12px; margin:12px; border-radius:8px; font-size:0.95em; }

    /* Boutons runs */
    .button { margin:6px; padding:10px 14px; border:none; border-radius:6px; cursor:pointer; font-weight:bold; min-width:190px; }
    .orange { background:#cc0; color:#000; }
    .green { background:#2a2; color:#fff; }
    .red { background:#a22; color:#fff; }
    .loading { background:#09f; color:#fff; animation: blink 1s infinite; }
    @keyframes blink { 50% { opacity:0.5; } }

    /* Logs */
    #logs { display:none; background:#000; color:#0f0; padding:12px; border-radius:8px; margin:12px; height:280px; overflow-y:auto; font-family: monospace; font-size:0.9em; }

    /* Colonnes */
    .columns { display:flex; gap:20px; margin:20px; }
    .zone { flex:1; background:#222; padding:10px; border-radius:8px; }
    .zone h3 { margin:0 0 8px 0; }
    .row { display:flex; justify-content:space-between; margin:4px 0; }
    .ball { width:14px; height:14px; border-radius:50%; display:inline-block; margin-left:6px; }
    .ball.orange { background:#cc0; }
    .ball.green { background:#2a2; }
    .ball.red { background:#a22; }
    .ball.purple { background:#639; }

    /* Historique */
    #runsHistory { width:95%; margin:12px; border-collapse: collapse; font-size:0.9em; }
    #runsHistory th, #runsHistory td { border: 1px solid #444; padding: 6px; text-align: center; }
    #runsHistory th { background:#222; }
    #runsHistory tr.ok { background:#132; color:#0f0; }
    #runsHistory tr.fail { background:#311; color:#f55; }

    /* Chat bulle */
    #chatButton {
      position: fixed; bottom:20px; right:20px;
      width:60px; height:60px; border-radius:50%;
      background:#0af; color:#fff; font-size:24px; font-weight:bold;
      border:none; cursor:pointer; z-index:9999;
    }
    #chatBubble {
      position: fixed; bottom:90px; right:20px;
      background:#222; border:2px solid #0af; border-radius:12px;
      padding:10px; width:320px; height:420px;
      display:none; flex-direction:column; z-index:9999;
    }
    #chatBubble header { font-weight:bold; text-align:center; margin-bottom:6px; }
    #chatLog { flex:1; overflow-y:auto; background:#000; padding:6px; border-radius:6px; font-family: monospace; }
    #chatInput { margin-top:6px; display:flex; }
    #chatInput input { flex:1; padding:4px; }
    #chatInput button { padding:4px 8px; }
  </style>
</head>
<body>
<script>
  const pwd = prompt("Mot de passe ?");
  if (pwd !== "202679") {
    document.write("‚õî Acc√®s refus√©");
    throw new Error("Acc√®s refus√©");
  }
</script>

<header>
  <h1>‚ö° Centrale nucl√©aire m√©t√©o ‚Äì Console Admin</h1>
  <nav>
    <a href="/admin">Console</a>
    <a href="/admin-alerts">Alertes</a>
    <a href="/admin-chat">Chat</a>
    <a href="/admin-index">Vue Index</a>
    <a href="/admin-radar">Radar & News</a>
    <a href="/admin-users">Utilisateurs</a>
  </nav>
</header>

<div id="alertsSummary">Chargement du r√©sum√©‚Ä¶</div>
<canvas id="alertsChart"></canvas>

<div class="columns">
  <div class="zone">
    <h3>üåç Pr√©visions Europe</h3>
    <div id="europeForecast"></div>
  </div>
  <div class="zone">
    <h3>üá∫üá∏ Pr√©visions USA</h3>
    <div id="usaForecast"></div>
  </div>
</div>

<div class="columns">
  <div class="zone">
    <h3>üö® Alertes Europe</h3>
    <div id="europeAlerts"></div>
  </div>
  <div class="zone">
    <h3>üö® Alertes USA</h3>
    <div id="usaAlerts"></div>
  </div>
</div>

<section id="engineControls">
  <h2>üõ† Contr√¥le moteur</h2>
  <div class="buttons">
    <button id="btnEurope" data-label="Run Pr√©visions Europe" class="button orange" onclick="runProcess('/api/run-europe','btnEurope')">Run Pr√©visions Europe</button>
    <button id="btnUSA" data-label="Run Pr√©visions USA" class="button orange" onclick="runProcess('/api/run-usa','btnUSA')">Run Pr√©visions USA</button>
    <button id="btnAlertsEurope" data-label="Run Alertes Europe" class="button orange" onclick="runProcess('/api/run-alerts','btnAlertsEurope')">Run Alertes Europe</button>
    <button id="btnAlertsContinental" data-label="Run Alertes Continentales" class="button orange" onclick="runProcess('/api/run-alerts-continental','btnAlertsContinental')">Run Alertes Continentales</button>
    <button id="btnAlertsWorld" data-label="Run Alertes Mondiales" class="button orange" onclick="runProcess('/api/run-alerts-world','btnAlertsWorld')">Run Alertes Mondiales</button>
    <button id="btnOrchestrator" data-label="Run Orchestrateur IA" class="button orange" onclick="runProcess('/api/run-orchestrator','btnOrchestrator')">Run Orchestrateur IA</button>
  </div>
  <button onclick="toggleLogs()">üìú Voir logs</button>
  <pre id="logs"></pre>

  <h3>üìñ Historique des runs</h3>
  <table id="runsHistory">
    <thead>
      <tr>
        <th>Date</th>
        <th>Run</th>
        <th>Dur√©e</th>
        <th>Statut</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</section>

<button id="chatButton" onclick="toggleChat()">üí¨</button>
<div id="chatBubble">
  <header>ü§ñ Chat Moteur IA</header>
  <div id="chatLog"></div>
  <div id="chatInput">
    <input type="text" id="chatMsg" placeholder="Demander au moteur..." onkeypress="if(event.key==='Enter') sendChat()">
    <button onclick="sendChat()">Envoyer</button>
  </div>
</div>

<script>
let lastExclusiveCount = 0;
let chart;
let eventSource;

// === R√©sum√© des alertes ===
async function fetchAlertsSummary() {
  try {
    const res = await fetch("/api/alerts/summary");
    if (!res.ok) return;
    const s = await res.json();
    const exclusiveCount = s.exclusives || 0;

    let exclusiveBadge = `<span>${exclusiveCount}</span>`;
    if (exclusiveCount > lastExclusiveCount) {
      exclusiveBadge = `<span style="color:red;font-weight:bold">${exclusiveCount}</span>`;
    }
    lastExclusiveCount = exclusiveCount;

    document.getElementById("alertsSummary").innerHTML = `
      üìä <strong>Total alertes actives :</strong> ${s.total || 0}<br>
      üü¢ Publi√©es : ${s.byStatus?.["published"] || 0}<br>
      üü° √Ä valider : ${s.byStatus?.["toValidate"] || 0}<br>
      üîµ Sous surveillance : ${s.byStatus?.["under-surveillance"] || 0}<br>
      üî¥ Exclusives : ${exclusiveBadge}<br>
      üü¢ Confirm√©es ailleurs : ${s.confirmedElsewhere || 0}
    `;
    updateChart(s);
  } catch(e) { console.error("R√©sum√© alertes error", e); }
}

function updateChart(s) {
  const ctx = document.getElementById("alertsChart").getContext("2d");
  const data = {
    labels: ["Publi√©es", "√Ä valider", "Surveillance", "Ignor√©es", "Exclusives", "Confirm√©es"],
    datasets: [{
      data: [
        s.byStatus?.["published"] || 0,
        s.byStatus?.["toValidate"] || 0,
        s.byStatus?.["under-surveillance"] || 0,
        s.byStatus?.["ignored"] || 0,
        s.exclusives || 0,
        s.confirmedElsewhere || 0
      ],
      backgroundColor: ["#2a2", "#cc0", "#335", "#633", "#a22", "#0af"]
    }]
  };
  if (chart) { chart.data = data; chart.update(); }
  else {
    chart = new Chart(ctx, { type:"doughnut", data, options:{ plugins:{ legend:{ labels:{ color:"#eee" } } } } });
  }
}

// === Checkup zones ===
async function fetchCountries() {
  try {
    const res = await fetch("/api/checkup");
    const state = await res.json();
    fillZone("europeForecast", Object.keys(state.zonesCoveredEurope || {}), state.checkupForecast);
    fillZone("usaForecast", Object.keys(state.zonesCoveredUSA || {}), state.checkupForecast);
    fillZone("europeAlerts", Object.keys(state.zonesCoveredEurope || {}), state.checkupAlerts);
    fillZone("usaAlerts", Object.keys(state.zonesCoveredUSA || {}), state.checkupAlerts);
  } catch(e) { console.error("Checkup error", e); }
}

function fillZone(id, list, checkup) {
  const div = document.getElementById(id);
  div.innerHTML = "";
  list.forEach(c => {
    const st = checkup?.[c] || "PENDING";
    let ballClass = "orange";
    if (st === "OK") ballClass = "green";
    else if (st === "FAIL") ballClass = "red";
    else if (st === "PARTIAL") ballClass = "purple";
    div.innerHTML += `<div class="row"><span>${c}</span><span class="ball ${ballClass}"></span></div>`;
  });
}

// === Lancer process (runs) + historique ===
async function runProcess(endpoint, btnId) {
  const btn = document.getElementById(btnId);
  btn.className = "button loading"; 
  btn.textContent = "‚è≥ En cours...";
  const start = Date.now();

  try {
    const res = await fetch(endpoint, { method:"POST" });
    const data = await res.json();
    const duration = ((Date.now() - start) / 1000).toFixed(1) + "s";

    if (res.ok && data.success) {
      btn.className = "button green"; btn.textContent = "‚úÖ OK";
      addLog(`‚úî Run termin√© (${endpoint})`);
      addRunHistory(endpoint, duration, true);
    } else {
      btn.className = "button red"; btn.textContent = "‚ùå Erreur";
      addLog(`‚ùå Erreur run (${endpoint}): ${data.error || "inconnu"}`);
      addRunHistory(endpoint, duration, false);
    }
  } catch (err) {
    const duration = ((Date.now() - start) / 1000).toFixed(1) + "s";
    btn.className = "button red"; btn.textContent = "‚ùå √âchec";
    addLog(`‚ö†Ô∏è Exception: ${err.message}`);
    addRunHistory(endpoint, duration, false);
  }

  setTimeout(() => { btn.className = "button orange"; btn.textContent = btn.getAttribute("data-label"); }, 5000);
}

function addRunHistory(endpoint, duration, ok) {
  const tbody = document.querySelector("#runsHistory tbody");
  const tr = document.createElement("tr");
  tr.className = ok ? "ok" : "fail";
  tr.innerHTML = `
    <td>${new Date().toLocaleTimeString()}</td>
    <td>${endpoint.replace("/api/","")}</td>
    <td>${duration}</td>
    <td>${ok ? "‚úÖ OK" : "‚ùå FAIL"}</td>
  `;
  tbody.prepend(tr);
}

// === Logs ===
function toggleLogs() {
  const logs = document.getElementById("logs");
  if (logs.style.display === "none") {
    logs.style.display = "block"; logs.innerText = "üì° Connexion logs en direct‚Ä¶\n";
    eventSource = new EventSource("/api/logs/stream");
    eventSource.onmessage = (e) => {
      try { const obj = JSON.parse(e.data); addLog(`[${obj.time}] ${obj.message}`); }
      catch { addLog(e.data); }
    };
  } else { logs.style.display = "none"; if (eventSource) eventSource.close(); }
}

function addLog(msg) {
  const logs = document.getElementById("logs");
  logs.innerText += msg + "\n"; logs.scrollTop = logs.scrollHeight;
}

// === Chat moteur ===
function toggleChat() {
  const chat = document.getElementById("chatBubble");
  chat.style.display = chat.style.display === "none" ? "flex" : "none";
}

async function sendChat() {
  const input = document.getElementById("chatMsg");
  const msg = input.value.trim(); if (!msg) return;
  const logEl = document.getElementById("chatLog");
  logEl.innerHTML += `<div><b>Moi:</b> ${msg}</div>`;
  input.value = "";
  try {
    const res = await fetch("/api/chat/engine", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ message: msg }) });
    const data = await res.json();
    logEl.innerHTML += `<div><b>Jean:</b> ${data.reply}</div>`;
  } catch(err) { logEl.innerHTML += `<div><b>Erreur:</b> ${err.message}</div>`; }
  logEl.scrollTop = logEl.scrollHeight;
}

setInterval(fetchAlertsSummary, 7000);
setInterval(fetchCountries, 10000);
window.onload = () => { fetchAlertsSummary(); fetchCountries(); };
</script>
</body>
</html>
