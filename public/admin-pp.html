<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>‚ö° Centrale Nucl√©aire M√©t√©o ‚Äì Console Admin</title>
  <meta name="robots" content="noindex,nofollow">
  <style>
    body { font-family: Arial, sans-serif; background:#111; color:#eee; margin:0; }
    header { background:#222; padding:10px; display:flex; justify-content:space-between; align-items:center; }
    header h1 { margin:0; font-size:18px; color:#fdd835; }
    nav a { color:#0af; margin:0 10px; text-decoration:none; font-weight:bold; }
    nav a:hover { text-decoration:underline; }
    .container { padding:20px; }
    .btn { padding:10px 20px; cursor:pointer; border:none; border-radius:5px; font-weight:bold; }
    .btnRun { background:#0af; color:#fff; }
    .statusBox { padding:10px; margin:10px 0; border-radius:5px; font-weight:bold; }
    .ok { background:green; color:#fff; }
    .fail { background:red; color:#fff; }
    .running { background:orange; color:#000; }
    .checklist { margin-top:20px; }
    .checklist div { padding:8px; margin:3px 0; border-radius:4px; }
    .checklist .ok { background:#2e7d32; }
    .checklist .fail { background:#c62828; }
    .checklist .running { background:#f9a825; color:#000; }
    .logs { background:#000; padding:10px; margin-top:20px; max-height:300px; overflow-y:auto; font-family:monospace; font-size:12px; }
  </style>
</head>
<body>
<script>
  const pass = prompt("Mot de passe ?");
  if (pass !== "202679") {
    document.body.innerHTML = "<h1 style='color:red;text-align:center;'>‚õî Acc√®s refus√©</h1>";
    throw new Error("Acc√®s refus√©");
  }
</script>

<header>
  <h1>‚ö° Centrale Nucl√©aire M√©t√©o ‚Äì Console Admin</h1>
  <nav>
    <a href="admin-pp.html">Console</a>
    <a href="admin-alerts.html">Alertes</a>
    <a href="admin-index.html">Vue Utilisateur</a>
    <a href="admin-chat.html">Chat IA</a>
    <a href="admin-radar.html">Radar + News</a>
  </nav>
</header>

<div class="container">
  <!-- Bouton RUN -->
  <button class="btn btnRun" onclick="lancerRun()">üöÄ Lancer RUN</button>
  <div id="runStatus" class="statusBox">En attente‚Ä¶</div>

  <!-- Checklist moteur -->
  <h2>üìã Checklist Moteur</h2>
  <div class="checklist" id="checklist">
    <div>1. Extraction mod√®les</div>
    <div>2. RUNGLOBAL Europe</div>
    <div>3. RUNGLOBAL USA</div>
    <div>4. RUN Continentales</div>
    <div>5. Mise sous fichier des extractions</div>
    <div>6. Analyse IA (relief, climat, environnement)</div>
    <div>7. Pr√©visions locales zones couvertes</div>
    <div>8. Pr√©visions nationales zones couvertes</div>
    <div>9. Alertes locales zones couvertes</div>
    <div>10. Alertes nationales zones couvertes</div>
    <div>11. Alertes continentales (zones non couvertes)</div>
    <div>12. Assemblage alertes mondiales</div>
    <div>13. Open Data pr√©visions zones non couvertes</div>
  </div>

  <h3 id="moteurStatus">Moteur op√©rationnel : ‚è≥</h3>

  <!-- Logs -->
  <h2>üìú Logs en direct</h2>
  <div class="logs" id="logs">[Logs en attente‚Ä¶]</div>
</div>

<script>
  async function lancerRun() {
    const statusBox = document.getElementById("runStatus");
    statusBox.innerHTML = "‚è≥ RUN en cours...";
    statusBox.className = "statusBox running";

    try {
      const res = await fetch("/api/run-global", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ zone: "All" })
      });

      const text = await res.text();
      let data;
      try {
        data = JSON.parse(text);
      } catch (e) {
        throw new Error("R√©ponse invalide du backend: " + text.slice(0,100));
      }

      if (data.success) {
        statusBox.innerHTML = "‚úÖ RUN termin√© avec succ√®s";
        statusBox.className = "statusBox ok";
        document.getElementById("moteurStatus").innerHTML = "Moteur op√©rationnel : OK ‚úÖ";
      } else {
        statusBox.innerHTML = "‚ùå RUN √©chec: " + (data.error || "Erreur inconnue");
        statusBox.className = "statusBox fail";
        document.getElementById("moteurStatus").innerHTML = "Moteur op√©rationnel : FAIL ‚ùå";
      }
    } catch (err) {
      statusBox.innerHTML = "‚ùå Erreur RUN: " + err.message;
      statusBox.className = "statusBox fail";
      document.getElementById("moteurStatus").innerHTML = "Moteur op√©rationnel : FAIL ‚ùå";
    }
  }

  // Logs SSE
  const logsBox = document.getElementById("logs");
  const evtSource = new EventSource("/api/logs/stream");
  evtSource.onmessage = function(event) {
    try {
      const logs = JSON.parse(event.data);
      logsBox.innerHTML = logs
        .slice(-50) // garder 50 derniers
        .map(l => `[${new Date(l.timestamp).toLocaleTimeString()}] ${l.message}`)
        .join("<br>");
      logsBox.scrollTop = logsBox.scrollHeight;
    } catch (err) {
      logsBox.innerHTML += "<br>‚ö†Ô∏è Erreur parsing logs: " + err.message;
    }
  };
</script>
</body>
</html>
