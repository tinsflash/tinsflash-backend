<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <!-- Emp√™cher indexation par les moteurs -->
  <meta name="robots" content="noindex,nofollow" />
  <meta name="googlebot" content="noindex,nofollow" />
  <meta name="bingbot" content="noindex,nofollow" />

  <title>‚ö° Centrale Nucl√©aire M√©t√©o ‚Äì Console Admin</title>
  <link rel="stylesheet" href="styles.css" />
  <style>
    /* styles minimaux pour le gate et la console */
    body { font-family: Inter, Arial, sans-serif; background:#071024; color:#e6eef8; margin:0; }
    header { padding:18px; background:linear-gradient(90deg,#081022,#0b1630); }
    main { padding:18px; }
    .hidden { display:none !important; }
    .gate { max-width:440px; margin:40px auto; background:#071428; border:1px solid #123; padding:20px; border-radius:8px; text-align:center; }
    input[type="password"]{ width:100%; padding:10px; margin-top:10px; border-radius:6px; border:1px solid #234; background:#071428; color:#e6eef8; }
    button { margin-top:12px; padding:10px 14px; border-radius:6px; border:0; cursor:pointer; background:#1f8feb; color:white; }
    .note { color:#9fb2d6; font-size:0.9rem; margin-top:8px; }
    .danger { background:#e64949 !important; }
    .card{ background:#07182a; padding:12px; border-radius:8px; margin-bottom:12px; border:1px solid #123; }
    .small{ font-size:0.9rem; color:#9fb2d6; }
  </style>
</head>
<body>
  <!-- Gate : s'affiche tant que pas de mot de passe -->
  <div id="gate" class="gate" aria-live="polite">
    <h2>üîí Acc√®s Admin</h2>
    <p class="small">Page prot√©g√©e ‚Äî acc√®s r√©serv√© aux administrateurs Tinsflash.</p>
    <input id="admin-pass" type="password" placeholder="Mot de passe admin" aria-label="mot de passe admin" />
    <button id="btn-unlock">D√©verrouiller</button>
    <p class="note">Astuce : ce contr√¥le c√¥t√© client est pratique pour UX. Pour s√©curit√© r√©elle active le middleware serveur (voir instructions serveur).</p>
  </div>

  <!-- Main console : cach√©e tant que gate non valid√©e -->
  <main id="console" class="hidden" aria-hidden="true">
    <header>
      <h1>‚ö° Centrale Nucl√©aire M√©t√©o ‚Äì Console Admin</h1>
      <p class="small">Mode 100% r√©el ‚Äî zones couvertes : UE27 + UK + Ukraine + USA</p>
    </header>

    <!-- SuperForecast -->
    <section class="card">
      <h3>üöÄ SuperForecast</h3>
      <button id="btn-run">Lancer Run</button>
      <div id="sf-result" class="small">En attente...</div>
    </section>

    <!-- Pr√©visions (BE, FR multi-zones, USA...) -->
    <section class="card">
      <h3>üõ∞Ô∏è Pr√©visions nationales (BE / FR multi-zones / USA)</h3>
      <div id="forecasts">Chargement‚Ä¶</div>
      <div style="margin-top:8px;">
        <button id="btn-publish" title="Publier les pr√©visions sur l'index public">Publier vers index</button>
      </div>
    </section>

    <!-- Alertes -->
    <section class="card">
      <h3>‚ö†Ô∏è Alertes</h3>
      <div id="alerts">Chargement‚Ä¶</div>
    </section>

    <!-- Chat JEAN -->
    <section class="card">
      <h3>ü§ñ Chat J.E.A.N.</h3>
      <input id="chat-input" placeholder="Question √† J.E.A.N." style="width:75%;padding:8px;border-radius:6px;border:1px solid #123;background:#071428;color:#e6eef8"/>
      <button id="btn-chat">Envoyer</button>
      <div id="chat-reply" class="small" style="margin-top:8px"></div>
    </section>

    <!-- Logs -->
    <section class="card">
      <h3>üìú Logs</h3>
      <div id="logs" class="small">Chargement‚Ä¶</div>
    </section>
  </main>

<script>
/*
  Gate logic (client-side)
  - Password required: 202679
  - Stores ephemeral flag in sessionStorage only (not persistent)
  - Warning: client-only protection is not fully secure (see server-side snippet below)
*/
const ADMIN_PW = "202679";
const gateEl = document.getElementById("gate");
const consoleEl = document.getElementById("console");
const passInput = document.getElementById("admin-pass");
const btnUnlock = document.getElementById("btn-unlock");

function unlockUI() {
  gateEl.classList.add("hidden");
  consoleEl.classList.remove("hidden");
  consoleEl.removeAttribute("aria-hidden");
  sessionStorage.setItem("tinsflash_admin_unlocked", "1");
  initConsole(); // charge data
}

btnUnlock.addEventListener("click", () => {
  if (passInput.value === ADMIN_PW) {
    unlockUI();
  } else {
    passInput.value = "";
    passInput.placeholder = "Mot de passe incorrect";
    passInput.focus();
  }
});

// Auto-unlock if session present
if (sessionStorage.getItem("tinsflash_admin_unlocked") === "1") {
  unlockUI();
}

/* =========================
   Console JS: appels API
   =========================
   - API base assumed same origin: "/api/..."
   - Si tu utilises un sous-domaine/host, modifie API_BASE.
*/
const API_BASE = ""; // "" => m√™me origine

async function initConsole() {
  // add button listeners
  document.getElementById("btn-run").addEventListener("click", runSuperForecast);
  document.getElementById("btn-publish").addEventListener("click", publishForecasts);
  document.getElementById("btn-chat").addEventListener("click", sendChat);

  // initial load
  await Promise.all([loadForecasts(), loadAlerts(), loadLogs()]);
  // refresh logs every 10s to see live run steps
  setInterval(loadLogs, 10000);
}

async function runSuperForecast() {
  const r = document.getElementById("sf-result");
  r.textContent = "‚è≥ Lancement SuperForecast‚Ä¶";
  try {
    const res = await fetch(API_BASE + "/api/superforecast/run", { method: "POST" });
    const json = await res.json();
    r.textContent = json.analysis || "‚úÖ Run termin√©";
    // refresh data
    await loadForecasts();
    await loadAlerts();
    await loadLogs();
  } catch (e) {
    r.textContent = "‚ùå Erreur run: " + (e.message || e);
  }
}

async function loadForecasts() {
  const el = document.getElementById("forecasts");
  el.textContent = "Chargement‚Ä¶";
  try {
    const res = await fetch(API_BASE + "/api/forecasts");
    const arr = await res.json();
    if (!Array.isArray(arr) || arr.length === 0) { el.innerHTML = "<i>Aucune pr√©vision</i>"; return; }
    // group by country for readability (BE/FR/USA)
    const grouped = {};
    arr.forEach(f => { grouped[f.country] = grouped[f.country] || []; grouped[f.country].push(f); });
    let html = "";
    for (const country of Object.keys(grouped)) {
      html += `<div style="margin-bottom:8px;"><strong>${country}</strong>`;
      grouped[country].forEach(item => {
        html += `<div class="small" style="margin-left:8px;">${item.date} ‚Äî ${item.minTemp ?? "-"}¬∞ / ${item.maxTemp ?? "-"}¬∞ ‚Ä¢ ‚òî ${item.rainProbability ?? 0}% ‚Ä¢ üí® ${item.windSpeed ?? 0} km/h</div>`;
      });
      html += `</div>`;
    }
    el.innerHTML = html;
  } catch (err) {
    el.innerHTML = `<span style="color:#ff7b7b">Erreur pr√©visions: ${err.message || err}</span>`;
  }
}

async function publishForecasts() {
  // action rapide: envoi un signal au backend pour publier
  // backend attendu: POST /api/forecasts/publish  (√† ajouter si pas pr√©sent)
  if (!confirm("Publier les pr√©visions sur l'index public ?")) return;
  try {
    const res = await fetch(API_BASE + "/api/forecasts/publish", { method: "POST" });
    if (!res.ok) throw new Error("Erreur publication");
    alert("‚úÖ Publication demand√©e (backend doit g√©rer l'actualisation index)");
  } catch (e) {
    alert("‚ùå Impossible de publier: " + (e.message || e));
  }
}

async function loadAlerts() {
  const el = document.getElementById("alerts");
  el.textContent = "Chargement‚Ä¶";
  try {
    const res = await fetch(API_BASE + "/api/alerts");
    const arr = await res.json();
    if (!Array.isArray(arr) || arr.length === 0) { el.innerHTML = "<i>Aucune alerte</i>"; return; }
    let html = "";
    arr.forEach(a => {
      const status = a.status || "‚ö†Ô∏è";
      html += `<div style="margin-bottom:8px;"><strong>${a.title ?? "Alerte"}</strong> <span class="small">(${a.certainty ?? "?"}%)</span><div class="small">${a.description ?? a.message ?? ""}</div>`;
      // action buttons (valider/rejeter) -> backend endpoints support√©s: PUT /api/alerts/:id or POST /api/alerts/publish...
      html += `<div style="margin-top:6px;"><button onclick="validateAlert('${a._id}')">‚úÖ Valider</button> <button onclick="rejectAlert('${a._id}')" class="danger">‚ùå Rejeter</button></div></div>`;
    });
    el.innerHTML = html;
  } catch (err) {
    el.innerHTML = `<span style="color:#ff7b7b">Erreur alertes: ${err.message || err}</span>`;
  }
}

async function validateAlert(id) {
  try {
    // appel PUT pour mettre √† jour le statut
    const res = await fetch(API_BASE + `/api/alerts/${id}`, { method:"PUT", headers:{"Content-Type":"application/json"}, body: JSON.stringify({ status: "‚úÖ Premier d√©tecteur", published: true }) });
    if (!res.ok) throw new Error("√âchec validation");
    await loadAlerts();
  } catch (e) {
    alert("Erreur validation: " + (e.message||e));
  }
}
async function rejectAlert(id) {
  try {
    const res = await fetch(API_BASE + `/api/alerts/${id}`, { method:"PUT", headers:{"Content-Type":"application/json"}, body: JSON.stringify({ status: "‚ùå Doublon", published: false }) });
    if (!res.ok) throw new Error("√âchec rejet");
    await loadAlerts();
  } catch (e) { alert("Erreur rejet: " + (e.message||e)); }
}

async function sendChat() {
  const q = document.getElementById("chat-input").value;
  const out = document.getElementById("chat-reply");
  out.textContent = "‚è≥ J.E.A.N. en cours‚Ä¶";
  try {
    const res = await fetch(API_BASE + "/api/chat", { method:"POST", headers:{"Content-Type":"application/json"}, body: JSON.stringify({ message: q }) });
    const json = await res.json();
    out.textContent = json.reply || json || "Pas de r√©ponse";
  } catch (e) {
    out.textContent = "‚ùå Erreur chat: " + (e.message||e);
  }
}

async function loadLogs() {
  const el = document.getElementById("logs");
  try {
    const res = await fetch(API_BASE + "/api/logs");
    const logs = await res.json();
    if (!Array.isArray(logs) || logs.length === 0) { el.textContent = "Aucun log"; return; }
    el.innerHTML = logs.map(l => `<div class="small">[${new Date(l.timestamp).toLocaleString()}] ${l.message}</div>`).join("");
  } catch (e) {
    el.textContent = "Erreur logs: " + (e.message||e);
  }
}
</script>
</body>
</html>
