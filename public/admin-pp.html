<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>üõ∞Ô∏è TINSFLASH ‚Äì Console Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <style>
    body { margin:0; font-family:"Segoe UI",sans-serif; background:#0d1117; color:#e6edf3; }
    header { background:#161b22; padding:10px; text-align:center; }
    header h1 { margin:0; color:#58a6ff; }

    .container { display:grid; gap:12px; padding:12px; max-width:1200px; margin:auto; }

    .card {
      background:#161b22;
      padding:12px;
      border-radius:8px;
      box-shadow:0 2px 6px rgba(0,0,0,0.4);
    }
    h2 { margin:0 0 6px; color:#79c0ff; font-size:1.1rem; }

    button {
      background:#238636;
      color:white; border:none; padding:8px 12px;
      border-radius:6px; cursor:pointer; font-weight:bold;
    }
    button:hover { background:#2ea043; }

    #status { font-size:0.9rem; }

    #logs { background:#0d1117; border:1px solid #30363d; padding:8px; height:250px; overflow-y:auto; font-size:0.85rem; }
    #map { width:100%; height:300px; border-radius:8px; }

    /* Avatar / Chat moteur */
    #avatar-engine {
      position:fixed;
      bottom:80px;
      right:15px;
      width:70px;
      height:70px;
      border-radius:50%;
      background:#fff url('/avatars/jean-default.png') center/cover no-repeat;
      box-shadow:0 0 8px rgba(0,0,0,0.5);
      cursor:pointer;
      z-index:9999;
    }
    #chat-engine {
      position:fixed;
      bottom:160px;
      right:12px;
      width:280px;
      height:320px;
      background:#fff;
      color:#000;
      border-radius:10px;
      display:none;
      flex-direction:column;
      box-shadow:0 2px 8px rgba(0,0,0,0.4);
      z-index:10000;
    }
    #chat-header { background:#238636; color:#fff; padding:4px; font-size:0.85rem; border-radius:10px 10px 0 0; }
    #chat-messages { flex:1; padding:6px; overflow-y:auto; font-size:0.8rem; }
    #chat-input { display:flex; }
    #chat-input input { flex:1; border:none; padding:5px; font-size:0.8rem; }
    #chat-input button { background:#238636; color:#fff; border:none; padding:5px 7px; cursor:pointer; font-size:0.8rem; }
  </style>
</head>
<body>
  <header>
    <h1>üõ∞Ô∏è Console Admin TINSFLASH</h1>
    <p>üöÄ Cockpit de commande m√©t√©o nucl√©aire</p>
  </header>

  <main class="container">
    <!-- Bouton RUN -->
    <div class="card">
      <h2>‚ö° Lancement moteur</h2>
      <button onclick="launchRun()">‚ñ∂Ô∏è Lancer RUN GLOBAL</button>
      <div id="status">‚è≥ En attente‚Ä¶</div>
    </div>

    <!-- Carte zones -->
    <div class="card">
      <h2>üåç Zones & Alertes</h2>
      <div id="map"></div>
    </div>

    <!-- Logs -->
    <div class="card">
      <h2>üì° Logs en direct</h2>
      <div id="logs">‚è≥ En attente logs...</div>
    </div>
  </main>

  <!-- Avatar moteur -->
  <div id="avatar-engine" onclick="toggleChat()"></div>

  <!-- Chat moteur -->
  <div id="chat-engine">
    <div id="chat-header">üí¨ Chat moteur</div>
    <div id="chat-messages"></div>
    <div id="chat-input">
      <input type="text" id="engine-input" placeholder="Demandez √† J.E.A.N. moteur...">
      <button id="engine-send">Envoyer</button>
    </div>
  </div>

  <script>
    // === RUN GLOBAL ===
    async function launchRun(){
      document.getElementById("status").innerText="üöÄ RUN GLOBAL en cours...";
      try{
        const res=await fetch("/api/run-global",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({zone:"All"})});
        const data=await res.json();
        if(data.success){
          document.getElementById("status").innerText="‚úÖ RUN GLOBAL lanc√© avec succ√®s.";
        }else{
          document.getElementById("status").innerText="‚ùå Erreur RUN GLOBAL: "+(data.error||"inconnue");
        }
      }catch(e){
        document.getElementById("status").innerText="‚ùå Exception: "+e.message;
      }
    }

    // === Logs SSE ===
    const logBox=document.getElementById("logs");
    const evtSource=new EventSource("/api/logs/stream");
    evtSource.onmessage=function(e){
      const log=JSON.parse(e.data);
      logBox.innerHTML+=`<div>[${new Date(log.ts).toLocaleTimeString()}] ${log.type} ‚Üí ${log.message}</div>`;
      logBox.scrollTop=logBox.scrollHeight;
    };

    // === Carte Leaflet ===
    let map=L.map("map").setView([20,0],2);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{ attribution:'¬© OpenStreetMap'}).addTo(map);
    let markersLayer=L.layerGroup().addTo(map);

    async function refreshMap(){
      try{
        const res=await fetch("/api/alerts");
        const alerts=await res.json();
        markersLayer.clearLayers();
        alerts.forEach(a=>{
          if(!a.lat||!a.lon) return;
          const c=a.data?.confidence||0;
          let color="green"; if(c>=70&&c<90) color="orange"; if(c>=90) color="red";
          const circle=L.circle([a.lat,a.lon],{radius:120000,color,fillOpacity:0.5});
          circle.bindPopup(`<b>${a.country} ${a.region||""}</b><br>Fiabilit√©: ${c}%`);
          markersLayer.addLayer(circle);
        });
      }catch(e){ console.warn("Erreur map:",e.message); }
    }
    refreshMap();
    setInterval(refreshMap,60000);

    // === Chat moteur ===
    function toggleChat(){
      const chat=document.getElementById("chat-engine");
      chat.style.display=chat.style.display==="flex"?"none":"flex";
    }

    document.getElementById("engine-send").addEventListener("click",sendEngineMsg);
    document.getElementById("engine-input").addEventListener("keyup",e=>{
      if(e.key==="Enter") sendEngineMsg();
    });

    async function sendEngineMsg(){
      const msg=document.getElementById("engine-input").value;
      if(!msg) return;
      const res=await fetch("/api/chat-engine",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({message:msg})});
      const data=await res.json();
      const chat=document.getElementById("chat-messages");
      chat.innerHTML+=`<div><b>Moi:</b> ${msg}</div>`;
      chat.innerHTML+=`<div><b>Moteur:</b> ${data.reply}</div>`;
      chat.scrollTop=chat.scrollHeight;
      document.getElementById("engine-input").value="";
    }
  </script>
</body>
</html>
