<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="robots" content="noindex,nofollow">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‚ö° Centrale Nucl√©aire M√©t√©o ‚Äì Console Admin</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial, sans-serif; background:#0b0f19; color:#eee; margin:0; }
    header { background:#111831; padding:15px; text-align:center; font-size:22px; font-weight:bold; color:#4fc3f7; }
    nav { background:#1a2238; padding:10px; display:flex; justify-content:center; gap:15px; }
    nav a { color:#ccc; text-decoration:none; font-weight:bold; }
    nav a:hover { color:#4fc3f7; }
    h2 { margin:20px 0 10px; }
    .columns { display:flex; gap:20px; margin:20px; }
    .zone { flex:1; background:#161b22; padding:15px; border-radius:8px; }
    .zone h3 { margin-top:0; color:#4fc3f7; }
    .row { display:flex; justify-content:space-between; margin:4px 0; }
    .ball { width:14px; height:14px; border-radius:50%; display:inline-block; margin-left:6px; }
    .ball.orange { background:#cc0; }
    .ball.green { background:#2a2; }
    .ball.red { background:#a22; }
    .ball.purple { background:#639; }
    #alertsSummary { background:#1f2937; padding:12px; margin:12px; border-radius:8px; font-size:0.95em; }
    .button { margin:5px; padding:8px 12px; border:none; border-radius:6px; cursor:pointer; font-weight:bold; }
    .orange { background:#cc0; color:#000; }
    .green { background:#2a2; color:#fff; }
    .red { background:#a22; color:#fff; }
    .purple { background:#639; color:#fff; }
    #logs { display:none; background:#000; padding:10px; border-radius:6px; margin:10px; max-height:250px; overflow:auto; font-size:0.85em; }
    #chatButton { position: fixed; bottom:20px; right:20px; width:60px; height:60px; border-radius:50%; background:#0af; color:#fff; font-size:24px; font-weight:bold; border:none; cursor:pointer; z-index:9999; }
    #chatBubble { position: fixed; bottom:90px; right:20px; background:#222; border:2px solid #0af; border-radius:12px; padding:10px; width:320px; height:420px; display:none; flex-direction:column; z-index:9999; }
    #chatBubble header { font-weight:bold; text-align:center; margin-bottom:6px; }
    #chatLog { flex:1; overflow-y:auto; background:#000; padding:6px; border-radius:6px; }
    #chatInput { margin-top:6px; display:flex; }
    #chatInput input { flex:1; padding:4px; }
    #chatInput button { padding:4px 8px; }
  </style>
</head>
<body>
  <script>
    const pwd = prompt("Mot de passe ?");
    if (pwd !== "202679") {
      document.write("‚õî Acc√®s refus√©");
      throw new Error("Acc√®s refus√©");
    }
  </script>

  <header>‚ö° Centrale Nucl√©aire M√©t√©o ‚Äì Console Admin</header>
  <nav>
    <a href="/admin-pp.html">Console</a>
    <a href="/admin-alerts.html">Alertes</a>
    <a href="/admin-chat.html">Chat</a>
    <a href="/admin-index.html">Vue Index</a>
    <a href="/admin-radar.html">Radar & News</a>
    <a href="/admin-users.html">Utilisateurs</a>
  </nav>

  <div id="alertsSummary">Chargement du r√©sum√©‚Ä¶</div>
  <canvas id="alertsChart"></canvas>

  <div class="columns">
    <div class="zone">
      <h3>üåç Pr√©visions</h3>
      <h4>Europe</h4>
      <div id="europeForecast"></div>
      <h4>USA</h4>
      <div id="usaForecast"></div>
    </div>
    <div class="zone">
      <h3>üö® Alertes</h3>
      <h4>Europe</h4>
      <div id="europeAlerts"></div>
      <h4>USA</h4>
      <div id="usaAlerts"></div>
    </div>
  </div>

  <section id="engineControls">
    <h2>üõ† Contr√¥le moteur</h2>
    <button class="button green" onclick="runProcess('/api/run-europe')">Run Pr√©visions Europe</button>
    <button class="button green" onclick="runProcess('/api/run-usa')">Run Pr√©visions USA</button>
    <button class="button orange" onclick="runProcess('/api/run-alerts')">Run Alertes Europe+USA</button>
    <button class="button purple" onclick="runProcess('/api/run-alerts-continental')">Run Alertes Continentales</button>
    <button class="button red" onclick="runProcess('/api/run-alerts-world')">Run Alertes Mondiales</button>
    <button onclick="toggleLogs()">üìú Voir logs</button>
    <div id="logs"></div>
  </section>

  <button id="chatButton" onclick="toggleChat()">üí¨</button>
  <div id="chatBubble">
    <header>ü§ñ ChatGPT5 ‚Äì Moteur</header>
    <div id="chatLog"></div>
    <div id="chatInput">
      <input type="text" id="chatMsg" placeholder="Demander au moteur..." onkeypress="if(event.key==='Enter') sendChat()">
      <button onclick="sendChat()">Envoyer</button>
    </div>
  </div>

  <script>
    let chart, lastExclusiveCount = 0;

    async function fetchAlertsSummary() {
      const res = await fetch("/api/alerts/summary");
      if (!res.ok) return;
      const s = await res.json();
      const exclusiveCount = s.exclusives || 0;
      document.getElementById("alertsSummary").innerHTML = `
        <div>üìä Total alertes actives : ${s.total || 0}</div>
        <div>‚úÖ Publi√©es : ${s.byStatus?.published || 0} | ‚è≥ √Ä valider : ${s.byStatus?.toValidate || 0}</div>
        <div>üîµ Surveillance : ${s.byStatus?.["under-surveillance"] || 0}</div>
        <div>üî¥ Exclusives : ${exclusiveCount} | üü¢ Confirm√©es ailleurs : ${s.confirmedElsewhere || 0}</div>
      `;
      updateChart(s);
    }

    function updateChart(s) {
      const ctx = document.getElementById("alertsChart").getContext("2d");
      const data = {
        labels: ["Publi√©es", "√Ä valider", "Surveillance", "Exclusives", "Confirm√©es"],
        datasets: [{
          data: [
            s.byStatus?.published || 0,
            s.byStatus?.toValidate || 0,
            s.byStatus?.["under-surveillance"] || 0,
            s.exclusives || 0,
            s.confirmedElsewhere || 0
          ],
          backgroundColor: ["#2a2", "#cc0", "#335", "#a22", "#0af"]
        }]
      };
      if (chart) { chart.data = data; chart.update(); }
      else { chart = new Chart(ctx, { type:"doughnut", data, options:{plugins:{legend:{labels:{color:"#eee"}}}}}); }
    }

    async function fetchCountries() {
      const res = await fetch("/api/checkup");
      const state = await res.json();
      fillZone("europeForecast", Object.keys(state.zonesCoveredEurope || {}), state.checkupForecast);
      fillZone("usaForecast", Object.keys(state.zonesCoveredUSA || {}), state.checkupForecast);
      fillZone("europeAlerts", Object.keys(state.zonesCoveredEurope || {}), state.checkupAlerts);
      fillZone("usaAlerts", Object.keys(state.zonesCoveredUSA || {}), state.checkupAlerts);
    }

    function fillZone(id, list, checkup) {
      const div = document.getElementById(id);
      div.innerHTML = "";
      list.forEach(c => {
        const st = checkup?.[c] || "PENDING";
        let ballClass = "orange";
        if (st === "OK") ballClass = "green";
        else if (st === "FAIL") ballClass = "red";
        else if (st === "PARTIAL") ballClass = "purple";
        div.innerHTML += `<div class="row"><span>${c}</span><span class="ball ${ballClass}"></span></div>`;
      });
    }

    let eventSource;
    function toggleLogs() {
      const logs = document.getElementById("logs");
      if (logs.style.display === "none") {
        logs.style.display = "block";
        logs.innerText = "Connexion logs en direct‚Ä¶\n";
        eventSource = new EventSource("/api/logs/stream");
        eventSource.onmessage = (e) => {
          const obj = JSON.parse(e.data);
          logs.innerText += `[${obj.time}] ${obj.message}\n`;
          logs.scrollTop = logs.scrollHeight;
        };
      } else {
        logs.style.display = "none";
        if (eventSource) eventSource.close();
      }
    }

    function toggleChat() {
      const chat = document.getElementById("chatBubble");
      chat.style.display = chat.style.display === "none" ? "flex" : "none";
    }

    async function sendChat() {
      const input = document.getElementById("chatMsg");
      const msg = input.value.trim();
      if (!msg) return;
      const logEl = document.getElementById("chatLog");
      logEl.innerHTML += `<div><b>Moi:</b> ${msg}</div>`;
      input.value = "";
      const res = await fetch("/api/chat/engine", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ message: msg })
      });
      const data = await res.json();
      logEl.innerHTML += `<div><b>GPT:</b> ${data.reply}</div>`;
      logEl.scrollTop = logEl.scrollHeight;
    }

    setInterval(fetchAlertsSummary, 7000);
    setInterval(fetchCountries, 10000);
    window.onload = () => { fetchAlertsSummary(); fetchCountries(); };
  </script>
</body>
</html>
