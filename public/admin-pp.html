<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="robots" content="noindex,nofollow">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‚ö° Console Admin ‚Äî TINSFLASH</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <style>
    body { font-family: Arial, sans-serif; background:#0d1117; color:#e6edf3; margin:0; }
    header { background:#111; padding:12px; text-align:center; font-size:22px; font-weight:bold; color:#0af; }
    nav { background:#1c1f26; padding:10px; text-align:center; }
    nav a { color:#0af; margin:0 12px; text-decoration:none; }
    h2 { margin:15px 0 10px; color:#0af; }
    .grid { display:grid; grid-template-columns:1fr 2fr; gap:20px; padding:10px; }
    .zone { background:#161b22; border-radius:6px; padding:10px; margin-bottom:10px; }
    button { margin:6px 0; padding:10px 14px; border:none; border-radius:6px; cursor:pointer; background:#0af; color:#000; font-weight:bold; }
    .status-ball { width:14px; height:14px; border-radius:50%; display:inline-block; margin-right:6px; }
    .pending { background:#cc0; }
    .ok { background:#2a2; }
    .fail { background:#a22; }
    #logs { background:#000; color:#eee; font-family:monospace; padding:10px; height:250px; overflow-y:auto; border-radius:8px; margin-top:10px; white-space:pre-wrap; }
    .info { color:#0af; }
    .warn { color:#cc0; }
    .error { color:#f55; }

    /* Carte */
    #map { width:100%; height:400px; border-radius:8px; margin-top:10px; }

    /* Chat */
    #chatButton { position:fixed; bottom:20px; right:20px; width:60px; height:60px; border-radius:50%; background:#0af; color:#fff; font-size:22px; font-weight:bold; border:none; cursor:pointer; }
    #chatBubble { position:fixed; bottom:90px; right:20px; width:320px; height:420px; background:#161b22; border:2px solid #0af; border-radius:10px; display:none; flex-direction:column; }
    #chatBubble header { padding:8px; font-weight:bold; text-align:center; color:#0af; }
    #chatLog { flex:1; overflow-y:auto; padding:8px; background:#0d1117; border-radius:6px; }
    #chatInput { display:flex; }
    #chatInput input { flex:1; padding:6px; border:none; border-radius:6px; }
    #chatInput button { padding:6px 10px; background:#0af; border:none; border-radius:6px; cursor:pointer; }
  </style>
</head>
<body>
<script>
  const pass = prompt("Code d'acc√®s ?");
  if (pass !== "202679") {
    document.body.innerHTML = "<h1 style='color:red;text-align:center;'>‚õî Acc√®s refus√©</h1>";
    throw new Error("Acc√®s refus√©");
  }
</script>

<header>‚ö° TINSFLASH ‚Äî Console Admin</header>
<nav>
  <a href="/admin">Console</a>
  <a href="/admin-alerts">Alertes</a>
  <a href="/admin-chat">Chat IA</a>
  <a href="/admin-index">Vue Index</a>
  <a href="/admin-radar">Radar & News</a>
  <a href="/admin-users">Utilisateurs</a>
</nav>

<div class="grid">
  <!-- Colonne gauche -->
  <div>
    <h2>üõ∞Ô∏è Orchestration</h2>
    <button onclick="runGlobal()">‚ñ∂Ô∏è Run Global (Orchestre)</button>

    <h2>‚ö° Phases du moteur</h2>
    <div id="engine-status">
      <div><span class="status-ball pending"></span> Mod√®les</div>
      <div><span class="status-ball pending"></span> Pr√©visions locales/nationales</div>
      <div><span class="status-ball pending"></span> Pr√©visions continentales</div>
      <div><span class="status-ball pending"></span> Alertes locales/nationales</div>
      <div><span class="status-ball pending"></span> Alertes continentales</div>
      <div><span class="status-ball pending"></span> Alertes mondiales</div>
      <div><span class="status-ball pending"></span> Fusion IA globale</div>
    </div>
  </div>

  <!-- Colonne droite -->
  <div>
    <h2>üåç Carte des pr√©visions & alertes</h2>
    <div id="map"></div>
  </div>
</div>

<h2>üìú Logs moteur (live)</h2>
<div id="logs">Connexion en cours‚Ä¶</div>

<!-- Chat bulle -->
<button id="chatButton" onclick="toggleChat()">üí¨</button>
<div id="chatBubble">
  <header>ü§ñ Chat IA Moteur</header>
  <div id="chatLog"></div>
  <div id="chatInput">
    <input type="text" id="chatMsg" placeholder="Demander au moteur..." onkeypress="if(event.key==='Enter') sendChat()">
    <button onclick="sendChat()">Envoyer</button>
  </div>
</div>

<script>
  // === Carte Leaflet ===
  const map = L.map('map').setView([20, 0], 2);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '¬© OpenStreetMap'
  }).addTo(map);

  let countryLayers = {};

  async function updateMap() {
    try {
      const alerts = await fetch('/api/alerts').then(r => r.json());
      const status = await fetch('/api/status').then(r => r.json());

      // Nettoyage
      Object.values(countryLayers).forEach(l => map.removeLayer(l));
      countryLayers = {};

      // Couleur selon √©tat
      const getColor = (country) => {
        const alert = alerts.find(a => a.country === country);
        if (alert) {
          const c = alert.data?.confidence || 0;
          if (c >= 90) return "red";
          if (c >= 70) return "orange";
        }
        return "green";
      };

      // Boucles sur les alertes (zones)
      alerts.forEach(a => {
        if (!a.lat || !a.lon) return;
        const circle = L.circle([a.lat, a.lon], {
          radius: 150000,
          color: getColor(a.country),
          fillOpacity: 0.5
        }).addTo(map);
        circle.bindPopup(`<b>${a.country} ${a.region||""}</b><br>Type: ${a.type}<br>Fiabilit√©: ${a.data?.confidence||0}%`);
        countryLayers[a.id] = circle;
      });

    } catch (e) {
      console.error("Erreur updateMap:", e);
    }
  }
  setInterval(updateMap, 15000);
  updateMap();

  // === Logs live ===
  const logDiv=document.getElementById("logs");
  const evt=new EventSource("/api/logs/stream");
  evt.onmessage=(e)=>{
    const log=JSON.parse(e.data);
    let cls="info"; if(log.message.includes("ERROR")) cls="error"; if(log.message.includes("WARN")) cls="warn";
    logDiv.innerHTML+=`<div class="${cls}">[${new Date(log.ts).toLocaleTimeString()}] ${log.message}</div>`;
    logDiv.scrollTop=logDiv.scrollHeight;
  };

  // === Run Global ===
  async function runGlobal(){
    const res = await fetch("/api/run-global",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({zone:"All"})});
    const data = await res.json();
    alert("‚ñ∂Ô∏è Run Global lanc√©");
  }

  // === Chat IA moteur ===
  function toggleChat(){ const c=document.getElementById("chatBubble"); c.style.display=c.style.display==="flex"?"none":"flex"; }
  async function sendChat(){
    const input=document.getElementById("chatMsg"); const msg=input.value.trim(); if(!msg) return;
    const log=document.getElementById("chatLog"); log.innerHTML+=`<div><b>Moi:</b> ${msg}</div>`; input.value="";
    const res=await fetch("/api/chat/engine",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({message:msg})});
    const data=await res.json(); log.innerHTML+=`<div style="color:#0af;"><b>Moteur:</b> ${data.reply}</div>`; log.scrollTop=log.scrollHeight;
  }

  // === Phases moteur ===
  async function refreshStatus(){
    try {
      const res = await fetch("/api/status"); const data = await res.json();
      const statuses = {
        models:data.models,
        local:data.steps.localForecasts,
        continental:data.steps.forecastsContinental,
        aiAlerts:data.steps.aiAlerts,
        contAlerts:data.steps.alertsContinental,
        worldAlerts:data.steps.alertsWorld,
        fusion:data.steps.engineStatus
      };
      const div=document.getElementById("engine-status").children;
      let i=0;
      for(const st of Object.values(statuses)){
        if(!div[i]) continue;
        div[i].children[0].className="status-ball "+(st==="OK"?"ok":st==="FAIL"?"fail":"pending");
        i++;
      }
    } catch(e){ console.error("refreshStatus error:",e); }
  }
  setInterval(refreshStatus,10000);
  refreshStatus();
</script>
</body>
</html>
