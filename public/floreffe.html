<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="robots" content="noindex,nofollow" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<title>TINSFLASH • Dôme Floreffe (IA J.E.A.N. – Version complète)</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<style>
body{margin:0;font-family:"Segoe UI",sans-serif;background:#0f172a;color:#f5faff;}
header{display:flex;justify-content:space-between;align-items:center;padding:15px;background:linear-gradient(90deg,#08101f,#15294d);color:#4fc3f7;font-size:1.6em;font-weight:bold;text-shadow:0 0 12px #4fc3f7;}
header button{background:#11263f;color:#7dd3fc;border:1px solid #4fc3f7;border-radius:6px;padding:6px 12px;font-size:.9em;cursor:pointer;transition:.3s;}
header button:hover{background:#4fc3f7;color:#000;}
#statusBar{background:#0d1528;color:#7dd3fc;padding:6px 12px;font-size:.9em;display:flex;justify-content:space-between;align-items:center;}
#statusBar span{margin-right:10px;}
#statusIA{font-weight:bold;color:#00ff99;}
.subheader{text-align:center;background:#0d1528;color:#7dd3fc;padding:6px;font-size:.9em;}
.video-container{position:relative;overflow:hidden;}
video{width:100%;max-height:180px;object-fit:cover;display:block;filter:brightness(.95);}
.video-overlay{position:absolute;bottom:0;width:100%;height:60px;background:linear-gradient(to bottom,rgba(15,23,42,0)0%,#0f172a100%);pointer-events:none;}
.sound-btn{position:absolute;right:15px;bottom:15px;background:rgba(0,0,0,.5);border:none;border-radius:50%;color:#4fc3f7;font-size:18px;padding:6px;cursor:pointer;}
main{max-width:1300px;margin:auto;padding:20px;}
h2{color:#4fc3f7;border-left:4px solid #4fc3f7;padding-left:10px;margin-top:35px;}
p{color:#e0e8f9;line-height:1.5;text-align:justify;}
.intro-title{text-align:center;color:#4fc3f7;font-size:1.6em;margin-top:25px;text-shadow:0 0 10px #4fc3f7;}
.intro-block{display:flex;align-items:center;gap:18px;flex-wrap:wrap;}
.intro-block img{border-radius:10px;width:140px;max-height:220px;object-fit:contain;box-shadow:0 0 18px rgba(0,0,0,.4);}
.intro-text{flex:1;max-height:200px;overflow-y:auto;background:#131a2b;padding:12px;border-radius:10px;color:#e0e8f9;line-height:1.5;}
.map-container{height:420px;margin:25px 0;border-radius:10px;overflow:hidden;box-shadow:0 0 12px rgba(0,0,0,.4);}
#summary-box{background:#16233a;border-radius:10px;padding:12px;margin-top:15px;text-align:center;box-shadow:0 0 10px rgba(0,0,0,.3);}
.forecast-grid{display:flex;flex-wrap:wrap;gap:10px;margin-top:10px;justify-content:center;}
.forecast-card{background:#131a2b;border-radius:10px;padding:10px;min-width:120px;text-align:center;cursor:pointer;box-shadow:0 0 10px rgba(0,0,0,.3);transition:.2s;}
.forecast-card:hover{transform:scale(1.05);background:#1a2942;}
table{width:100%;border-collapse:collapse;margin-top:10px;font-size:.9em;}
th,td{border-bottom:1px solid #22304e;padding:6px;text-align:center;}
th{background:#16233a;color:#7dd3fc;}
tr:hover{background:#1a2845;}
.alert-box{background:#1b2439;border-left:4px solid #4fc3f7;padding:8px;margin-bottom:8px;border-radius:8px;}
.banner{background:#16233a;color:#4fc3f7;padding:12px;text-align:center;font-weight:bold;margin-top:20px;border-radius:8px;}
footer{text-align:center;background:#111827;color:#ccc;padding:15px;font-size:.9em;}
footer a{color:#4fc3f7;text-decoration:none;}
footer a:hover{text-decoration:underline;}
.voice-log{position:fixed;bottom:20px;left:20px;background:rgba(0,0,0,0.6);color:#00ff99;padding:10px 15px;border-radius:6px;font-size:.9em;max-width:400px;z-index:50;}
</style>
</head>

<body>
<header>
  <span>TINSFLASH • Dôme Floreffe (IA J.E.A.N.)</span>
  <div>
    <button id="refreshBtn">🔄 Rafraîchir</button>
    <button id="muteBtn">🔇 Muet</button>
  </div>
</header>
<div id="statusBar">
  <span id="statusIA">🟢 IA Connectée</span>
  <span id="statusMongo">📡 Mongo OK</span>
  <span id="statusTime"></span>
</div>
<div class="subheader">🛰 Données satellites • IA locale multi-sources • Corrélation topographique</div>

<div class="video-container">
  <video autoplay muted loop playsinline id="introVideo">
    <source src="intro-jean.mp4" type="video/mp4"/>
  </video>
  <div class="video-overlay"></div>
  <button class="sound-btn" id="soundToggle">🔇</button>
</div>

<main>
<h2 class="intro-title">Présentation du système TINSFLASH IA J.E.A.N.</h2>
<div class="intro-block">
<img src="avatars/jean-default.png" alt="Avatar J.E.A.N"/>
<div class="intro-text">
<p><strong>TINSFLASH IA J.E.A.N.</strong> analyse en continu la commune de <b>Floreffe</b> via 60 points de mesure (topographie, vent, humidité, hydrologie).</p>
<p>Objectif : <b>anticiper verglas, ruissellement et inondations</b> avant les services officiels avec une fiabilité > 90 %.</p>
</div></div>

<h2>📡 Synthèse IA J.E.A.N.</h2>
<div id="summary-box">Chargement…</div>

<h2>🗓 Prévisions à 5 jours</h2>
<div id="weekForecasts" class="forecast-grid">Chargement…</div>

<h2>🗺 Carte communale (60 points)</h2>
<div id="map" class="map-container"></div>

<h2>📊 Détail complet</h2>
<div style="overflow-x:auto">
<table id="zonesTable">
<thead><tr><th>Point</th><th>Temp (°C)</th><th>Pluie</th><th>Vent</th><th>Humidité</th><th>Altitude</th></tr></thead>
<tbody><tr><td colspan="6">Chargement…</td></tr></tbody>
</table></div>

<h2>⚠️ Alertes locales et nationales</h2>
<div id="alertsBox">Chargement…</div>

<h2>🌌 Dôme holographique Floreffe</h2>
<iframe src="hologram-floreffe.html" style="width:100%;height:420px;border:none;border-radius:10px;"></iframe>
</main>

<footer>© 2025 TINSFLASH – Tous droits réservés</footer>

<div class="voice-log" id="voiceLog">🧠 J.E.A.N. prêt – Surveillance en cours</div>

<script>
// === Son intro ===
const video=document.getElementById("introVideo");
document.getElementById("soundToggle").onclick=()=>{video.muted=!video.muted;document.getElementById("soundToggle").innerText=video.muted?"🔇":"🔊";};

// === Voix ===
let mute=false;
document.getElementById("muteBtn").onclick=()=>{mute=!mute;document.getElementById("muteBtn").innerText=mute?"🔈 Son":"🔇 Muet";};
function speak(txt){if(mute)return;try{const u=new SpeechSynthesisUtterance(txt);u.lang="fr-FR";u.voice=speechSynthesis.getVoices().find(v=>v.lang==="fr-FR"&&v.name.includes("Thomas"))||null; speechSynthesis.speak(u);}catch{}}
function logVoice(t){document.getElementById("voiceLog").innerText="🧠 "+t; speak(t);}

// === WebSocket ===
function connectWS(){const ws=new WebSocket(`wss://${location.host}/ws/hologram`);
ws.onopen=()=>{document.getElementById("statusIA").innerText="🟢 IA Connectée";};
ws.onclose=()=>{document.getElementById("statusIA").innerText="🔴 IA Perdue";setTimeout(connectWS,4000);};
ws.onmessage=(e)=>{try{const d=JSON.parse(e.data);if(d.type==="alert"){logVoice(d.message||"Nouvelle alerte");renderAlerts([{type:"IA",description:d.message,zone:"Floreffe"}]);}}catch{}};}
connectWS();

// === Run manuel ===
document.getElementById("refreshBtn").onclick=async()=>{await fetch("/api/run-floreffe",{method:"POST"}); logVoice("Mise à jour du Dôme Floreffe lancée");initFloreffe();};

// === Données ===
async function initFloreffe(){try{
let f=await fetch("/api/forecast/floreffe").then(r=>r.json());
let a=await fetch("/api/alerts/floreffe").then(r=>r.json());
renderSummary(f);renderWeek(f);renderMap(f);renderTable(f);renderAlerts(a);
}catch(e){console.error(e);}}
function renderSummary(f){const z=f?.data?.data||f?.zones||[];if(!z.length)return;const avg=k=>z.reduce((x,y)=>x+(y[k]||0),0)/z.length;
document.getElementById("summary-box").innerHTML=`🌡 ${avg("temperature").toFixed(1)}°C | 💧 ${avg("precipitation").toFixed(1)} mm/h | 💨 ${avg("wind").toFixed(1)} km/h | 💦 ${avg("humidity").toFixed(0)}%<br>Points actifs : ${z.length}`;}
function renderWeek(f){const w=f?.general?.week;if(!w)return;const box=document.getElementById("weekForecasts");box.innerHTML=w.map(d=>`<div class='forecast-card'><b>${d.day}</b><br>🌡 ${d.temp_min}°/${d.temp_max}°<br>${d.condition}</div>`).join("");}
function renderMap(f){const z=f?.data?.data||f?.zones||[];const map=L.map("map").setView([50.44,4.76],12);L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19}).addTo(map);
z.forEach(p=>{L.circleMarker([p.lat,p.lon],{radius:6,color:p.precipitation>10?"#00ffff":"#4fc3f7"}).addTo(map).bindPopup(`<b>${p.name}</b><br>🌡${p.temperature}°C<br>💧${p.precipitation}mm/h`);});}
function renderTable(f){const z=f?.data?.data||f?.zones||[];const tb=document.querySelector("#zonesTable tbody");tb.innerHTML=z.map(p=>`<tr><td>${p.name}</td><td>${fmt(p.temperature)}</td><td>${fmt(p.precipitation)}</td><td>${fmt(p.wind)}</td><td>${fmt(p.humidity)}</td><td>${p.alt}</td></tr>`).join("");}
function renderAlerts(a){const b=document.getElementById("alertsBox");if(!a?.length){b.innerHTML="<div class='alert-box'>🚫 Aucune alerte</div>";return;}b.innerHTML=a.map(x=>`<div class='alert-box'><b>${x.type}</b> – ${x.zone}<br>${x.description||""}</div>`).join("");}
function fmt(v){return(v==null||isNaN(v))?"—":Number(v).toFixed(1);}
async function checkStatus(){try{const r=await fetch("/api/alerts").then(r=>r.json());document.getElementById("statusMongo").innerText="📡 Mongo OK ("+r.length+" alertes)";}catch{document.getElementById("statusMongo").innerText="⚠️ Mongo hors ligne";}}
function clock(){document.getElementById("statusTime").innerText=new Date().toLocaleTimeString("fr-FR",{hour:"2-digit",minute:"2-digit"});}
setInterval(clock,1000);clock();setInterval(initFloreffe,300000);setInterval(checkStatus,120000);initFloreffe();checkStatus();
</script>
</body>
</html>
