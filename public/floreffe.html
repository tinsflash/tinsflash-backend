<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="robots" content="noindex,nofollow" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<title>TINSFLASH • Dôme Floreffe (IA J.E.A.N. – Version complète)</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<style>
body{margin:0;font-family:"Segoe UI",sans-serif;background:#0f172a;color:#f5faff;}
header{display:flex;justify-content:space-between;align-items:center;padding:15px;background:linear-gradient(90deg,#08101f,#15294d);color:#4fc3f7;font-size:1.6em;font-weight:bold;text-shadow:0 0 12px #4fc3f7;}
header button{background:#11263f;color:#7dd3fc;border:1px solid #4fc3f7;border-radius:6px;padding:6px 12px;font-size:.9em;cursor:pointer;transition:.3s;}
header button:hover{background:#4fc3f7;color:#000;}
.subheader{text-align:center;background:#0d1528;color:#7dd3fc;padding:6px;font-size:.9em;}
.video-container{position:relative;overflow:hidden;}
video{width:100%;max-height:180px;object-fit:cover;display:block;filter:brightness(.95);}
.video-overlay{position:absolute;bottom:0;width:100%;height:60px;background:linear-gradient(to bottom,rgba(15,23,42,0)0%,#0f172a100%);pointer-events:none;}
.sound-btn{position:absolute;right:15px;bottom:15px;background:rgba(0,0,0,.5);border:none;border-radius:50%;color:#4fc3f7;font-size:18px;padding:6px;cursor:pointer;}
main{max-width:1300px;margin:auto;padding:20px;}
h2{color:#4fc3f7;border-left:4px solid #4fc3f7;padding-left:10px;margin-top:35px;}
p{color:#e0e8f9;line-height:1.5;text-align:justify;}
.intro-title{text-align:center;color:#4fc3f7;font-size:1.6em;margin-top:25px;text-shadow:0 0 10px #4fc3f7;}
.intro-block{display:flex;align-items:center;gap:18px;flex-wrap:wrap;}
.intro-block img{border-radius:10px;width:140px;max-height:220px;object-fit:contain;box-shadow:0 0 18px rgba(0,0,0,.4);}
.intro-text{flex:1;max-height:200px;overflow-y:auto;background:#131a2b;padding:12px;border-radius:10px;color:#e0e8f9;line-height:1.5;}
.map-container{height:420px;margin:25px 0;border-radius:10px;overflow:hidden;box-shadow:0 0 12px rgba(0,0,0,.4);}
#summary-box{background:#16233a;border-radius:10px;padding:12px;margin-top:15px;text-align:center;box-shadow:0 0 10px rgba(0,0,0,.3);}
.forecast-grid{display:flex;flex-wrap:wrap;gap:10px;margin-top:10px;justify-content:center;}
.forecast-card{background:#131a2b;border-radius:10px;padding:10px;min-width:120px;text-align:center;cursor:pointer;box-shadow:0 0 10px rgba(0,0,0,.3);transition:0.2s;}
.forecast-card:hover{transform:scale(1.05);background:#1a2942;}
table{width:100%;border-collapse:collapse;margin-top:10px;font-size:.9em;}
th,td{border-bottom:1px solid #22304e;padding:6px;text-align:center;}
th{background:#16233a;color:#7dd3fc;}
tr:hover{background:#1a2845;}
.alert-box{background:#1b2439;border-left:4px solid #4fc3f7;padding:8px;margin-bottom:8px;border-radius:8px;}
.banner{background:#16233a;color:#4fc3f7;padding:12px;text-align:center;font-weight:bold;margin-top:20px;border-radius:8px;}
footer{text-align:center;background:#111827;color:#ccc;padding:15px;font-size:.9em;}
footer a{color:#4fc3f7;text-decoration:none;}
footer a:hover{text-decoration:underline;}
</style>
</head>

<body>
<header>
  <span>TINSFLASH • Dôme Floreffe (IA J.E.A.N.)</span>
  <button id="refreshBtn">🔄 Rafraîchir données IA</button>
</header>
<div class="subheader">🛰 Données satellites • IA locale multi-sources • Corrélation topographique</div>

<div class="video-container">
  <video autoplay muted loop playsinline id="introVideo">
    <source src="intro-jean.mp4" type="video/mp4"/>
  </video>
  <div class="video-overlay"></div>
  <button class="sound-btn" id="soundToggle">🔇</button>
</div>

<main>
<h2 class="intro-title">Présentation du système TINSFLASH IA J.E.A.N.</h2>
<div class="intro-block">
<img src="avatars/jean-default.png" alt="Avatar J.E.A.N"/>
<div class="intro-text">
<p><strong>TINSFLASH IA J.E.A.N.</strong> analyse en continu la commune de <b>Floreffe</b> via 60 points de mesure intégrant topographie, vent, humidité et données hydrologiques.</p>
<p>Objectif : <b>anticiper verglas, ruissellement et inondations</b> avant les services officiels, avec une fiabilité IA supérieure à 90 %.</p>
</div></div>

<h2>📡 Synthèse IA J.E.A.N. – Commune de Floreffe</h2>
<div id="summary-box">Chargement des données...</div>

<h2>🗓 Prévisions à 5 jours – Synthèse IA J.E.A.N.</h2>
<div id="weekForecasts" class="forecast-grid">Chargement des prévisions…</div>

<h2>🗺 Carte communale – 60 points de prévision</h2>
<div id="map" class="map-container"></div>

<h2>📊 Détail complet des 60 points</h2>
<div style="overflow-x:auto">
<table id="zonesTable">
<thead><tr><th>Point</th><th>Temp (°C)</th><th>Pluie (mm/h)</th><th>Vent (km/h)</th><th>Humidité (%)</th><th>Altitude (m)</th></tr></thead>
<tbody><tr><td colspan="6">Chargement…</td></tr></tbody>
</table></div>

<h2>⚠️ Alertes locales et nationales</h2>
<div id="alertsBox">Chargement…</div>

<h2>🌌 Dôme holographique Floreffe</h2>
<iframe src="hologram-floreffe.html" style="width:100%;height:420px;border:none;border-radius:10px;"></iframe>
</main>

<footer>© 2025 TINSFLASH – Tous droits réservés</footer>

<script>
// === Rafraîchir manuellement ===
document.getElementById("refreshBtn").onclick = async ()=>{
  try{
    await fetch("/api/run-floreffe",{method:"POST"});
    alert("✅ Données IA rafraîchies (run Floreffe complet lancé)");
    initFloreffe();
  }catch(e){alert("⚠️ Erreur de rafraîchissement : "+e.message);}
};

// === Lecture audio intro ===
document.getElementById("soundToggle").onclick=()=>{
  const v=document.getElementById("introVideo");
  if(v.muted){v.muted=false;document.getElementById("soundToggle").innerText="🔊";}
  else{v.muted=true;document.getElementById("soundToggle").innerText="🔇";}
};

// === Initialisation générale ===
async function initFloreffe(){
 try{
  // 1️⃣ – lecture locale (fallback)
  let forecasts=null, alerts=null;
  try{forecasts=await fetch("floreffe_forecasts.json?"+Date.now()).then(r=>r.json());}catch{}
  try{alerts=await fetch("floreffe_alerts.json?"+Date.now()).then(r=>r.json());}catch{}

  // 2️⃣ – si vide → lecture Mongo via API
  if(!forecasts || Object.keys(forecasts).length===0)
    forecasts=await fetch("/api/forecast/floreffe").then(r=>r.json());
  if(!alerts || !Array.isArray(alerts))
    alerts=await fetch("/api/alerts/floreffe").then(r=>r.json());

  let zones=[];
  if(Array.isArray(forecasts?.zones)) zones=forecasts.zones;
  else if(Array.isArray(forecasts?.data)) zones=forecasts.data;
  else if(Array.isArray(forecasts?.data?.zones)) zones=forecasts.data.zones;
  else if(Array.isArray(forecasts)) zones=forecasts;

  // --- 5 jours ---
  const weekBox=document.getElementById("weekForecasts");
  if(forecasts?.general?.week){
    weekBox.innerHTML="";
    forecasts.general.week.forEach((d,i)=>{
      const card=document.createElement("div");
      card.className="forecast-card";
      card.innerHTML=`<b>${d.day}</b><br>🌡 ${d.temp_min}°/${d.temp_max}°<br>🌦 ${d.condition}`;
      weekBox.appendChild(card);
    });
  }

  // --- moyenne actuelle ---
  const avg=(a,k1,k2)=>a.length?a.reduce((x,y)=>x+(y[k1]??y[k2]??0),0)/a.length:0;
  document.getElementById("summary-box").innerHTML=
  `<b>🌍 Commune de Floreffe</b><br>
  🌡 ${(avg(zones,"temp_max","temperature")||0).toFixed(1)}°C |
  💧 ${(avg(zones,"precipitation","rain_mm")||0).toFixed(1)} mm/h |
  🌬 ${(avg(zones,"wind","wind_speed")||0).toFixed(1)} km/h |
  💦 ${(avg(zones,"humidity","humidite")||0).toFixed(0)}%<br>
  Points actifs : ${zones.length}`;

  renderMap(zones);
  renderTable(zones);
  renderAlerts(alerts);
 }catch(e){console.error(e);}
}

// === Carte ===
function renderMap(zones){
 const map=L.map("map").setView([50.44,4.76],12);
 L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19}).addTo(map);
 zones.forEach(z=>{
  const t=z.temp_max??z.temperature??0;
  const p=z.precipitation??z.rain_mm??0;
  const m=L.circleMarker([z.lat||50.44,z.lon||4.76],{radius:6,color:"#4fc3f7"}).addTo(map);
  m.bindPopup(`<b>${z.name||z.id||"Point"}</b><br>🌡 ${t}°C<br>💧 ${p} mm/h`);
 });
}

// === Tableau ===
function renderTable(zones){
 const tb=document.querySelector("#zonesTable tbody");tb.innerHTML="";
 zones.forEach(z=>{
  const name=z.name||z.id||"?";
  const temp=z.temp_max??z.temperature??0;
  const rain=z.precipitation??z.rain_mm??0;
  const wind=z.wind??z.wind_speed??0;
  const hum=z.humidity??z.humidite??0;
  const alt=z.alt??z.altitude??"?";
  tb.innerHTML+=`
    <tr>
      <td>${name}</td>
      <td>${fmt(temp,"°")}</td>
      <td>${fmt(rain,"")}</td>
      <td>${fmt(wind,"")}</td>
      <td>${fmt(hum,"")}</td>
      <td>${alt}</td>
    </tr>`;
 });
}

// === Alertes ===
function renderAlerts(list){
 const c=document.getElementById("alertsBox");
 if(!list?.length){c.innerHTML="<div class='alert-box'>🚫 Aucune alerte active</div>";return;}
 let html="";
 list.forEach(a=>{
  const r=(a.reliability??a.confidence??0.8)*100;
  html+=`<div class='alert-box'><b>${a.type||"Alerte"}</b> – ${a.zone||""}<br>${a.description||""}<br>Confiance ${r.toFixed(0)}%</div>`;
 });
 c.innerHTML=html;
}
function fmt(v,u){return(v==null||isNaN(v))?"—":`${Number(v).toFixed(1)}${u||""}`;}
window.onload=initFloreffe;
</script>
</body>
</html>
