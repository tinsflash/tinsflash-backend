<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üåç TINSFLASH PRO+++ ‚Äî D√¥me Floreffe IA J.E.A.N. (TV)</title>
<style>
  html, body {
    margin: 0;
    padding: 0;
    overflow: hidden;
    background: radial-gradient(circle at 50% 60%, #000a00 0%, #000 80%);
    color: #8fe1ff;
    font-family: 'Segoe UI', sans-serif;
    height: 100%;
  }
  #overlayUI {
    position: absolute;
    top: 10px;
    left: 10px;
    z-index: 15;
    color: #8fe1ff;
  }
  #overlayUI h2 {
    margin: 0;
    font-size: 1.2em;
    color: #00c3ff;
    text-shadow: 0 0 8px #00c3ff;
  }
  .btn {
    background: rgba(0,255,255,0.08);
    border: 1px solid #00c3ff;
    color: #8fe1ff;
    border-radius: 6px;
    padding: 6px 10px;
    margin-right: 6px;
    cursor: pointer;
  }
  .btn.active {
    background: #00c3ff;
    color: black;
    font-weight: bold;
  }
  #radarContainer {
    position: absolute;
    right: 20px;
    bottom: 20px;
    width: 420px;
    height: 420px;
    border: 2px solid #00ff99;
    border-radius: 10px;
    overflow: hidden;
    box-shadow: 0 0 20px rgba(0,255,128,0.3);
    z-index: 10;
  }
  #statusBar {
    position: absolute;
    bottom: 0;
    left: 0;
    width: 100%;
    background: rgba(0,30,0,0.8);
    color: #8fe1ff;
    font-size: 0.9em;
    padding: 8px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: 0 -2px 10px rgba(0,255,128,0.2);
  }
  #statusIA {
    font-weight: bold;
    color: #00ff99;
  }
  #voiceLog {
    position: absolute;
    bottom: 60px;
    left: 10px;
    width: 450px;
    background: rgba(0,0,0,0.4);
    border-left: 4px solid #00ff99;
    padding: 10px;
    border-radius: 6px;
    font-size: 0.9em;
  }
</style>
</head>
<body>

<div id="overlayUI">
  <h2>üåç D√¥me Floreffe ‚Äî M√©t√©o & Alertes IA J.E.A.N.</h2>
  <button id="btnPause" class="btn">Pause rotation</button>
  <button id="btnReset" class="btn">Reset</button>
  <button id="btnZoom" class="btn">Zoom +</button>
  <button id="btnUnzoom" class="btn">Zoom ‚àí</button>
  <span id="statusIA">üü¢ Statut IA : actif</span>
</div>

<div id="radarContainer">
  <iframe
    src="https://www.rainviewer.com/map.html?loc=50.44,4.74,7&oFa=0&oC=1&oU=1&oCS=1&oF=1&oAP=1&c=1&o=0&lm=1&layer=radar&sm=1"
    width="100%"
    height="100%"
    frameborder="0"
    style="border:0;">
  </iframe>
</div>

<div id="voiceLog">üß† J.E.A.N. pr√™t. Surveillance m√©t√©o active sur Floreffe.</div>
<div id="statusBar">
  <span>üå¶ Temp√©rature : <span id="tempNow">-- ¬∞C</span> | üí® Vent : <span id="windNow">-- km/h</span> | üíß Humidit√© : <span id="humNow">-- %</span></span>
  <span id="timeNow"></span>
</div>

<script type="module">
import * as THREE from "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js";
import { OrbitControls } from "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/controls/OrbitControls.js";

const scene = new THREE.Scene();
scene.fog = new THREE.Fog(0x001a00, 200, 1200);

const camera = new THREE.PerspectiveCamera(45, window.innerWidth/window.innerHeight, 0.1, 5000);
camera.position.set(0, 150, 500);

const renderer = new THREE.WebGLRenderer({antialias:true});
renderer.setSize(window.innerWidth, window.innerHeight);
document.body.appendChild(renderer.domElement);

const controls = new OrbitControls(camera, renderer.domElement);
controls.enableDamping = true;
controls.dampingFactor = 0.1;
controls.rotateSpeed = 0.6;

const light = new THREE.DirectionalLight(0x99ffcc,1.2);
light.position.set(1,1,1);
scene.add(light);
scene.add(new THREE.AmbientLight(0x102020));

const ground = new THREE.Mesh(
  new THREE.PlaneGeometry(2000,2000),
  new THREE.MeshPhongMaterial({color:0x001a00,opacity:0.5,transparent:true})
);
ground.rotation.x = -Math.PI/2;
scene.add(ground);

const reliefGroup = new THREE.Group();
const overlayGroup = new THREE.Group();
scene.add(reliefGroup);
scene.add(overlayGroup);

// === Boussole et noms villages ===
const compass = new THREE.Group();
const loader = new THREE.FontLoader();
loader.load("https://threejs.org/examples/fonts/helvetiker_regular.typeface.json", (font) => {
  const dirs = [["N",0,0,-400],["S",0,0,400],["E",400,0,0],["O",-400,0,0]];
  dirs.forEach(([txt,x,y,z])=>{
    const geo = new THREE.TextGeometry(txt,{font,size:20,height:1});
    const mat = new THREE.MeshBasicMaterial({color:0x00ff99});
    const mesh = new THREE.Mesh(geo,mat);
    mesh.position.set(x,y,z);
    compass.add(mesh);
  });
  const villages=[["Floreffe",0,0,0],["Floriffoux",-150,0,80],["Soye",100,0,120],["Frani√®re",0,0,180]];
  villages.forEach(([txt,x,y,z])=>{
    const geo = new THREE.TextGeometry(txt,{font,size:12,height:0.5});
    const mat = new THREE.MeshBasicMaterial({color:0x8fe1ff});
    const mesh = new THREE.Mesh(geo,mat);
    mesh.position.set(x,y,z);
    compass.add(mesh);
  });
});
scene.add(compass);

// === Chargement relief & pr√©visions ===
async function loadData(){
  try{
    const altitudes = await (await fetch("./floreffe_altitudes_hr.json")).json();
    const forecasts = await (await fetch("./floreffe_forecasts.json")).json();
    buildRelief(altitudes,forecasts);
  }catch(err){ console.error(err); }
}

function buildRelief(altitudes,forecasts){
  const geom=new THREE.BufferGeometry();
  const vertices=[],colors=[];
  const cLow=new THREE.Color(0x0020aa), cHigh=new THREE.Color(0xffffff);
  altitudes.forEach(p=>{
    const x=p.lon*600-2800,y=p.alt*1.5,z=-p.lat*600+30500;
    vertices.push(x,y,z);
    const c=cLow.clone().lerp(cHigh,Math.min(1,p.alt/250));
    colors.push(c.r,c.g,c.b);
  });
  geom.setAttribute("position",new THREE.Float32BufferAttribute(vertices,3));
  geom.setAttribute("color",new THREE.Float32BufferAttribute(colors,3));
  const mat=new THREE.PointsMaterial({size:2.1,vertexColors:true});
  reliefGroup.add(new THREE.Points(geom,mat));

  if(forecasts?.zones?.length){
    forecasts.zones.forEach(z=>{
      const col=z.precipitation>10?0x00ffff:0x0099ff;
      const s=new THREE.Mesh(
        new THREE.SphereGeometry(2,8,8),
        new THREE.MeshBasicMaterial({color:col})
      );
      s.position.set(z.lon*600-2800,z.alt??120,-z.lat*600+30500);
      overlayGroup.add(s);
    });
  }
}

// === Animation radar et rotation ===
let rotating=true;
function animate(){
  requestAnimationFrame(animate);
  if(rotating){
    reliefGroup.rotation.y+=0.0006;
    overlayGroup.rotation.y+=0.0006;
    compass.rotation.y+=0.0006;
  }
  controls.update();
  renderer.render(scene,camera);
}
animate();

// === Contr√¥les ===
document.getElementById("btnPause").onclick=()=>{rotating=!rotating};
document.getElementById("btnReset").onclick=()=>{camera.position.set(0,150,500)};
document.getElementById("btnZoom").onclick=()=>{camera.position.z-=50};
document.getElementById("btnUnzoom").onclick=()=>{camera.position.z+=50};

// === Donn√©es m√©t√©o et voix ===
async function updateMeteo(){
  try{
    const res=await fetch("/api/forecast/floreffe");
    const js=await res.json();
    if(js?.data?.data?.length){
      const p=js.data.data[0];
      document.getElementById("tempNow").innerText=`${p.temperature??"--"} ¬∞C`;
      document.getElementById("windNow").innerText=`${p.wind??"--"} km/h`;
      document.getElementById("humNow").innerText=`${p.humidity??"--"} %`;
    }
  }catch{}
}
setInterval(updateMeteo,600000);
updateMeteo();

// === Voix masculine fran√ßaise IA ===
function speak(txt){
  try{
    const s=new SpeechSynthesisUtterance(txt);
    s.lang="fr-FR";
    s.voice=speechSynthesis.getVoices().find(v=>v.lang==="fr-FR"&&v.name.includes("Thomas"))||null;
    speechSynthesis.speak(s);
  }catch{}
}
function logVoice(txt){
  const v=document.getElementById("voiceLog");
  const lines=v.innerHTML.split("<br>").slice(-4);
  lines.push("üß† "+txt);
  v.innerHTML=lines.join("<br>");
  speak(txt);
}

// === IA monitoring via WebSocket ===
const ws=new WebSocket(`wss://${location.host}/ws/hologram`);
ws.onmessage=(m)=>{
  try{
    const data=JSON.parse(m.data);
    if(data.type==="alert"&&data.message){
      logVoice(data.message);
      document.getElementById("statusIA").innerText="üü† Alerte IA d√©tect√©e";
    }
  }catch{}
};

// === Horloge ===
function updateClock(){
  const d=new Date();
  document.getElementById("timeNow").innerText=d.toLocaleTimeString("fr-FR",{hour:"2-digit",minute:"2-digit"});
}
setInterval(updateClock,1000);
updateClock();

loadData();
</script>
</body>
</html>
