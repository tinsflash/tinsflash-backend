<!-- PATH: public/admin-radar.html -->
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="robots" content="noindex,nofollow" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>🛰️ Radar & News Météo – TINSFLASH Everest v1.2</title>
  <link href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" rel="stylesheet" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    body{background:#0b0f19;color:#eaeaea;font-family:Inter,system-ui,Arial;margin:0;}
    header{background:#111831;padding:15px;text-align:center;color:#4fc3f7;font-size:22px;font-weight:bold;}
    nav{background:#1a2238;padding:10px;display:flex;justify-content:center;gap:15px;flex-wrap:wrap;}
    nav a{color:#ccc;text-decoration:none;font-weight:600;} nav a:hover{color:#4fc3f7;}
    main{padding:15px;}
    #map{height:420px;border-radius:10px;margin-bottom:15px;}
    #newsBox{background:#1a2238;border-radius:10px;padding:10px;}
    h2{color:#4fc3f7;border-bottom:1px solid #333;padding-bottom:4px;margin-top:10px;}
    button{background:#4fc3f7;color:#000;font-weight:bold;border:none;border-radius:6px;padding:8px 14px;cursor:pointer;}
    button:hover{background:#03a9f4;}
    .controls{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:10px;}
    input{border:none;border-radius:6px;padding:8px;background:#111;color:#fff;min-width:200px;}
    .news-item{border-bottom:1px solid #222;padding:6px 0;}
    .news-item:last-child{border:none;}
    .news-item a{color:#4fc3f7;text-decoration:none;}
    .news-item a:hover{text-decoration:underline;}
  </style>
</head>
<body>
<script>
// === Sécurité PIN ===
const pin=sessionStorage.getItem("tinsflashPIN")||prompt("Code d’accès admin ?");
if(pin!=="202679"){alert("⛔ Accès refusé");location.href="/";}else sessionStorage.setItem("tinsflashPIN","ok");

let map,windyLayer,alertMarkers=[];

// === Initialisation carte Windy + Leaflet ===
function initMap(){
  map=L.map("map").setView([20,0],2);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:"© OpenStreetMap"}).addTo(map);
  loadWindyLayer();
  loadAlerts();
  loadNews();
}

// === Windy radar intégré (iframe officiel) ===
function loadWindyLayer(){
  const windy=document.createElement("iframe");
  windy.src="https://embed.windy.com/embed2.html?lat=20&lon=0&zoom=3&level=surface&overlay=rain&menu=&message=true&marker=true&calendar=now&pressure=true&type=map&location=coordinates&detail=&detailLat=46.5&detailLon=2.5&metricWind=default&metricTemp=default";
  windy.style.width="100%";windy.style.height="420px";windy.style.border="none";windy.style.borderRadius="10px";
  const box=document.getElementById("map");
  box.innerHTML="";
  box.appendChild(windy);
}

// === Charger alertes réelles depuis backend ===
async function loadAlerts(){
  try{
    const res=await fetch("/api/alerts");
    const alerts=await res.json();
    alertMarkers.forEach(m=>map.removeLayer(m));
    alertMarkers=[];

    alerts.forEach(a=>{
      const color=a.certainty>=90?"#00ffb7":a.certainty>=70?"#ffe66b":"#ff7043";
      if(a.geo?.lat&&a.geo?.lon){
        const m=L.circleMarker([a.geo.lat,a.geo.lon],{color,fillColor:color,radius:6,fillOpacity:0.8})
          .addTo(map)
          .bindPopup(`<b>${a.zone||a.country||"?"}</b><br>${a.title}<br>Certitude ${a.certainty}%<br>${a.status}`);
        alertMarkers.push(m);
      }
    });
  }catch(e){console.error("Erreur chargement alertes:",e);}
}

// === Charger flux de news météo ===
async function loadNews(){
  try{
    const box=document.getElementById("newsBox");
    box.innerHTML="⏳ Chargement des dernières actualités météo...";
    const res=await fetch("/api/news");
    if(!res.ok){box.innerHTML="⚠️ Flux news indisponible.";return;}
    const news=await res.json();
    box.innerHTML="";
    news.slice(0,15).forEach(n=>{
      const div=document.createElement("div");
      div.className="news-item";
      div.innerHTML=`<a href="${n.link}" target="_blank">📰 ${n.title}</a><br><span style="font-size:12px;color:#aaa;">${new Date(n.date).toLocaleString()}</span>`;
      box.appendChild(div);
    });
  }catch(e){
    console.error("Erreur news:",e);
    document.getElementById("newsBox").innerHTML="⚠️ Impossible de charger les actualités météo.";
  }
}

// === Recherche zone ===
async function searchZone(){
  const txt=document.getElementById("zoneInput").value.trim();
  if(!txt)return;
  try{
    const res=await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(txt)}`);
    const data=await res.json();
    if(data.length){
      const {lat,lon,display_name}=data[0];
      map.setView([parseFloat(lat),parseFloat(lon)],6);
      L.marker([lat,lon]).addTo(map).bindPopup(display_name).openPopup();
    }else alert("Zone non trouvée");
  }catch(e){alert("Erreur recherche zone");}
}

window.onload=()=>initMap();
</script>

<header>🛰️ Radar & News Météo – TINSFLASH Everest v1.2</header>
<nav>
  <a href="/admin-pp.html">Console</a>
  <a href="/admin-alerts.html">Alertes</a>
  <a href="/admin-chat.html">Chat</a>
  <a href="/admin-index.html">Vue Utilisateur</a>
  <a href="/admin-radar.html" style="color:#4fc3f7;">Radar</a>
  <a href="/admin-users.html">Utilisateurs</a>
</nav>

<main>
  <div class="controls">
    <input id="zoneInput" placeholder="🔍 Rechercher une zone (ville, pays, coord...)" />
    <button onclick="searchZone()">Rechercher</button>
    <button onclick="loadWindyLayer()">🌍 Réinitialiser radar</button>
    <button onclick="loadAlerts()">🚨 Rafraîchir alertes</button>
    <button onclick="loadNews()">📰 Rafraîchir news</button>
  </div>

  <div id="map"></div>

  <h2>📰 Dernières actualités météo</h2>
  <div id="newsBox">–</div>
</main>
</body>
</html>
