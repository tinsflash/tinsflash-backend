<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ğŸŒ DÃ´me Floreffe â€” Radar IA J.E.A.N.</title>
  <style>
    body {
      margin: 0;
      overflow: hidden;
      background: radial-gradient(circle at 50% 60%, #000a00 0%, #000 80%);
      font-family: 'Segoe UI', sans-serif;
      color: #8fe1ff;
    }
    #menu {
      position: absolute;
      top: 10px; left: 10px;
      z-index: 10;
    }
    button {
      background: rgba(0,255,255,0.1);
      color: #8fe1ff;
      border: 1px solid #00c3ff;
      border-radius: 6px;
      padding: 5px 10px;
      margin-right: 6px;
      cursor: pointer;
    }
    button.active { background:#00c3ff; color:black; font-weight:bold; }
    #loader {
      position: absolute;
      top: 50%; left: 50%;
      transform: translate(-50%,-50%);
      color: #00c3ff;
      font-size: 1.2em;
      text-shadow: 0 0 10px #00c3ff;
    }
    canvas.radarCanvas {
      position: fixed;
      top:0; left:0;
      width:100%; height:100%;
      z-index:0;
      pointer-events:none;
      opacity:0.25;
    }
    // ==========================================================
// ğŸ§  RÃ©ception IA J.E.A.N. â€“ prÃ©-alerte locale
// ==========================================================
let banner;
function showJeanMessage(text){
  if(!banner){
    banner=document.createElement("div");
    banner.style.position="absolute";
    banner.style.top="10px";
    banner.style.right="10px";
    banner.style.padding="10px 15px";
    banner.style.background="rgba(0,255,180,0.1)";
    banner.style.border="1px solid #00ff99";
    banner.style.borderRadius="8px";
    banner.style.color="#8fe1ff";
    banner.style.fontSize="1em";
    banner.style.fontFamily="Segoe UI";
    banner.style.zIndex="50";
    document.body.appendChild(banner);
  }
  banner.textContent="ğŸ§  IA J.E.A.N. : "+text;
  banner.style.opacity="1";
  if(window.speechSynthesis){
    const utter=new SpeechSynthesisUtterance(text);
    utter.lang="fr-FR";
    speechSynthesis.cancel();
    speechSynthesis.speak(utter);
  }
  setTimeout(()=>{banner.style.transition="opacity 2s";banner.style.opacity="0";},12000);
}

// Branche sur le WebSocket existant
if(ws){
  const oldHandler=ws.onmessage;
  ws.onmessage=(msg)=>{
    try{
      const obj=JSON.parse(msg.data);
      if(obj.type==="jean_message") showJeanMessage(obj.text);
      else if(oldHandler) oldHandler(msg);
    }catch(e){console.warn(e.message);}
  };
}
  
  </style>
</head>
<body>
  <div id="menu">
    ğŸŒ <b>DÃ´me Floreffe â€” Radar + Hologramme IA J.E.A.N.</b><br />
    <button id="btnRelief" class="active">Relief HR</button>
    <button id="btnRadar" class="active">Radar</button>
    <button id="btnIA">IA J.E.A.N.</button>
  </div>
  <div id="loader">Chargement du dÃ´me holographique...</div>
  <canvas id="radarCanvas" class="radarCanvas"></canvas>

  <script type="module">
    import * as THREE from "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js";
    import { OrbitControls } from "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/controls/OrbitControls.js";

    // === Initialisation Three.js ===
    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(45, innerWidth/innerHeight, 0.1, 5000);
    camera.position.set(0,150,400);

    const renderer = new THREE.WebGLRenderer({antialias:true});
    renderer.setSize(innerWidth,innerHeight);
    document.body.appendChild(renderer.domElement);

    const controls = new OrbitControls(camera,renderer.domElement);
    controls.enableDamping=true; controls.dampingFactor=0.1;

    // LumiÃ¨res
    const light=new THREE.DirectionalLight(0x99ffcc,1.2); light.position.set(1,1,1);
    scene.add(light); scene.add(new THREE.AmbientLight(0x102020));

    // Groupes
    const reliefGroup=new THREE.Group();
    const overlayGroup=new THREE.Group();
    scene.add(reliefGroup, overlayGroup);

    // Loader UI
    const loaderText=document.getElementById("loader");

    // === Chargement des donnÃ©es ===
    async function loadData(){
      try{
        const alt=await (await fetch("./floreffe_altitudes_hr.json")).json();
        const forecasts=await (await fetch("./floreffe_forecasts.json")).json();
        const radar=await (await fetch("./floreffe_radar.json")).json();
        loaderText.innerText="Relief + radar + prÃ©visions chargÃ©s...";
        buildRelief(alt,forecasts,radar);
      }catch(err){
        loaderText.innerText="âŒ Erreur : "+err.message;
        console.error(err);
      }
    }

    // === Construction relief + radar ===
    function buildRelief(altitudes, forecasts, radar){
      loaderText.remove();
      // Relief
      const geom=new THREE.BufferGeometry();
      const verts=[], cols=[];
      const cLow=new THREE.Color(0x0020aa), cHigh=new THREE.Color(0xffffff);
      altitudes.forEach(p=>{
        const x=p.lon*600-2800, y=p.alt*1.5, z=-p.lat*600+30500;
        verts.push(x,y,z);
        const c=cLow.clone().lerp(cHigh,Math.min(1,p.alt/250));
        cols.push(c.r,c.g,c.b);
      });
      geom.setAttribute("position",new THREE.Float32BufferAttribute(verts,3));
      geom.setAttribute("color",new THREE.Float32BufferAttribute(cols,3));
      const ptsMat=new THREE.PointsMaterial({size:2.2,vertexColors:true});
      reliefGroup.add(new THREE.Points(geom,ptsMat));

      // Overlay radar = halos dâ€™impact
      if(radar?.fronts){
        radar.fronts.forEach(f=>{
          const c=f.speed>35?0xff3333:0x00ff99;
          const s=new THREE.Mesh(new THREE.SphereGeometry(4,12,12),
            new THREE.MeshBasicMaterial({color:c,transparent:true,opacity:0.4}));
          s.position.set(f.lon*600-2800,120,-f.lat*600+30500);
          overlayGroup.add(s);
        });
      }

      animate();
    }

    function animate(){
      requestAnimationFrame(animate);
      reliefGroup.rotation.y+=0.0008;
      overlayGroup.rotation.y+=0.0008;
      controls.update();
      renderer.render(scene,camera);
    }

    // Radar 2D en fond
    const radarCanvas=document.getElementById("radarCanvas");
    const ctx=radarCanvas.getContext("2d");
    radarCanvas.width=innerWidth; radarCanvas.height=innerHeight;

    async function drawRadar(){
      try{
        const data=await (await fetch("./floreffe_radar.json?"+Date.now())).json();
        ctx.clearRect(0,0,radarCanvas.width,radarCanvas.height);
        for(const f of data.fronts){
          const x=(f.lon+5)*80, y=(52-f.lat)*80;
          ctx.fillStyle=`rgba(0,255,180,${0.3+Math.random()*0.3})`;
          ctx.beginPath(); ctx.arc(x,y,15,0,Math.PI*2); ctx.fill();
        }
      }catch(e){console.warn("Radar update fail",e.message);}
      setTimeout(drawRadar,600000); // 10 min
    }
    drawRadar();

    window.addEventListener("resize",()=>{
      camera.aspect=innerWidth/innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(innerWidth,innerHeight);
      radarCanvas.width=innerWidth; radarCanvas.height=innerHeight;
    });

    loadData();
  </script>
</body>
</html>
