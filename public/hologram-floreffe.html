<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>TINSFLASH ‚Äì D√¥me holographique Floreffe</title>
<script src="https://unpkg.com/three@0.160.0/build/three.min.js"></script>
<script src="https://unpkg.com/three@0.160.0/examples/js/controls/OrbitControls.js"></script>
<style>
html,body{margin:0;padding:0;overflow:hidden;background:#000;color:#7de0ff;font-family:Segoe UI,Arial}
#info{position:fixed;top:10px;left:10px;background:rgba(0,0,0,.4);padding:8px 12px;border-radius:6px;font-size:14px;}
#angleBtn,#resBtn{position:fixed;top:10px;background:#111;color:#7de0ff;border:1px solid #7de0ff;
padding:6px 10px;border-radius:5px;cursor:pointer;transition:.3s}
#angleBtn:hover,#resBtn:hover{background:#7de0ff;color:#000;}
#angleBtn{right:10px;}
#resBtn{right:120px;}
#loader{
  position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);
  width:80px;height:80px;border:4px solid rgba(0,183,255,0.3);
  border-top:4px solid #00c8ff;border-radius:50%;animation:spin 1s linear infinite;
  display:none;z-index:10;
}
@keyframes spin{0%{transform:translate(-50%,-50%) rotate(0deg)}100%{transform:translate(-50%,-50%) rotate(360deg)}}
</style>
</head>
<body>
<div id="info">üåç D√¥me Floreffe ‚Äì Donn√©es locales (relief + alertes m√©t√©o)</div>
<button id="resBtn">Relief HR</button>
<button id="angleBtn">Vue 45¬∞</button>
<div id="loader"></div>
<canvas id="scene"></canvas>

<script>
let scene,camera,renderer,controls,terrainMesh,alertGroup,angleMode=false;
let currentRes="std";
let loader=document.getElementById("loader");

init();
animate();

async function init(){
  const canvas=document.getElementById("scene");
  renderer=new THREE.WebGLRenderer({canvas,antialias:true});
  renderer.setSize(window.innerWidth,window.innerHeight);
  scene=new THREE.Scene();
  camera=new THREE.PerspectiveCamera(45,window.innerWidth/window.innerHeight,1,2000);
  camera.position.set(0,150,250);
  controls=new THREE.OrbitControls(camera,renderer.domElement);
  controls.autoRotate=true;
  controls.autoRotateSpeed=0.6;
  controls.enableDamping=true;

  // Halo
  const haloGeom=new THREE.RingGeometry(120,130,64);
  const haloMat=new THREE.MeshBasicMaterial({color:0x33ccff,side:THREE.DoubleSide,transparent:true,opacity:0.2});
  const halo=new THREE.Mesh(haloGeom,haloMat);
  halo.rotation.x=Math.PI/2;
  scene.add(halo);

  // Lumi√®res
  const light=new THREE.PointLight(0x66ccff,1.5,600);
  light.position.set(0,200,0);
  scene.add(light);
  scene.add(new THREE.AmbientLight(0x447799,0.4));

  // Relief standard
  const altStd=await fetch("floreffe_altitudes.json").then(r=>r.json());
  createTerrain(altStd);

  // Alertes m√©t√©o
  const alerts=await fetch("floreffe_alertes.json").then(r=>r.json());
  renderAlerts(alerts);

  document.getElementById("angleBtn").onclick=()=>switchAngle();
  document.getElementById("resBtn").onclick=()=>switchResolution();
  window.addEventListener("resize",onResize);
}

function createTerrain(points){
  if(terrainMesh) scene.remove(terrainMesh);
  const geometry=new THREE.PlaneGeometry(240,240,30,30);
  geometry.rotateX(-Math.PI/2);
  const pos=geometry.attributes.position;
  for(let i=0;i<pos.count;i++){
    const vx=pos.getX(i)/2+50.44;
    const vz=pos.getZ(i)/2+4.76;
    const closest=points.reduce((a,b)=>{
      const da=(vx-b.lat)**2+(vz-b.lon)**2;
      const db=(vx-a.lat)**2+(vz-a.lon)**2;
      return da<db?b:a;
    });
    const h=(closest.alt-80)/2;
    pos.setY(i,h);
  }
  pos.needsUpdate=true;
  const mat=new THREE.MeshBasicMaterial({
    color:0x33ccff,wireframe:true,transparent:true,opacity:0.6
  });
  terrainMesh=new THREE.Mesh(geometry,mat);
  scene.add(terrainMesh);
}

function renderAlerts(list){
  alertGroup=new THREE.Group();
  list.forEach(a=>{
    const geom=new THREE.SphereGeometry(2.5,12,12);
    const col=a.type.includes("Verglas")?0x66ccff:
              a.type.includes("Pluie")?0x33aaff:
              a.type.includes("Vent")?0xff9900:0xff0000;
    const mat=new THREE.MeshBasicMaterial({color:col,transparent:true,opacity:0.9});
    const s=new THREE.Mesh(geom,mat);
    s.position.set((a.lat-50.44)*200,(a.reliability*100)/2,(a.lon-4.76)*200);
    s.userData={zone:a.zone,type:a.type,desc:a.description};
    alertGroup.add(s);
  });
  scene.add(alertGroup);
}

async function switchResolution(){
  const btn=document.getElementById("resBtn");
  loader.style.display="block"; // affiche le halo pendant le chargement
  await sleep(300);

  try{
    if(currentRes==="std"){
      btn.textContent="Relief STD";
      currentRes="hr";
      const altHR=await fetch("floreffe_altitudes_hr.json").then(r=>r.json());
      createTerrain(altHR);
      console.log("üîÅ Relief haute r√©solution charg√© !");
    }else{
      btn.textContent="Relief HR";
      currentRes="std";
      const altStd=await fetch("floreffe_altitudes.json").then(r=>r.json());
      createTerrain(altStd);
      console.log("üîÅ Relief standard recharg√© !");
    }
  }catch(err){
    console.error("Erreur chargement relief :",err);
  }finally{
    loader.style.display="none"; // cache le halo
  }
}

function animate(){
  requestAnimationFrame(animate);
  controls.update();
  if(alertGroup){
    const t=Date.now()*0.003;
    alertGroup.children.forEach((s,i)=>{
      s.scale.setScalar(1+0.25*Math.sin(t+i));
      s.material.opacity=0.5+0.4*Math.abs(Math.sin(t+i));
    });
  }
  renderer.render(scene,camera);
}

function switchAngle(){
  angleMode=!angleMode;
  if(angleMode){camera.position.set(200,200,200);}
  else{camera.position.set(0,150,250);}
}

function onResize(){
  camera.aspect=window.innerWidth/window.innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(window.innerWidth,window.innerHeight);
}

function sleep(ms){return new Promise(r=>setTimeout(r,ms));}
</script>
</body>
</html>
