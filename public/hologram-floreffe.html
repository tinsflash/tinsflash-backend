<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>TINSFLASH ‚Äì D√¥me holographique Floreffe</title>
<script src="https://unpkg.com/three@0.160.0/build/three.min.js"></script>
<script src="https://unpkg.com/three@0.160.0/examples/js/controls/OrbitControls.js"></script>
<style>
html,body{margin:0;padding:0;overflow:hidden;background:#000;color:#7de0ff;font-family:Segoe UI,Arial;}
#hud{position:fixed;top:10px;left:10px;background:rgba(0,0,0,.5);padding:8px 12px;border-radius:6px;font-size:14px;}
button{position:fixed;top:10px;background:rgba(10,30,40,.8);color:#7de0ff;border:1px solid #00c8ff;
padding:6px 10px;border-radius:5px;cursor:pointer;transition:.3s;z-index:5;text-shadow:0 0 4px #00c8ff;}
button:hover{background:#00c8ff;color:#000;}
#resBtn{right:280px;}
#angleBtn{right:180px;}
#satBtn{right:80px;}
#refreshBtn{right:10px;}
#jeanBtn{position:fixed;bottom:20px;right:20px;width:60px;height:60px;border-radius:50%;background:#00c8ff;color:#000;font-size:22px;font-weight:bold;box-shadow:0 0 20px rgba(0,200,255,.8);}
#jeanPanel{display:none;position:fixed;bottom:100px;right:20px;width:320px;height:260px;background:rgba(10,20,40,.9);border:1px solid #00c8ff;border-radius:10px;padding:10px;overflow:auto;color:#9eefff;font-size:14px;}
#timeline{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);width:60%;height:8px;background:rgba(255,255,255,.1);border-radius:6px;cursor:pointer;}
#timeline::after{content:"";position:absolute;top:0;left:0;width:0;height:100%;background:#00c8ff;border-radius:6px;transition:width .3s;}
#loader{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);width:80px;height:80px;border:4px solid rgba(0,183,255,0.3);border-top:4px solid #00c8ff;border-radius:50%;animation:spin 1s linear infinite;display:none;z-index:10;}
@keyframes spin{0%{transform:translate(-50%,-50%) rotate(0deg)}100%{transform:translate(-50%,-50%) rotate(360deg)}}
@keyframes scanPulse {0%,100%{opacity:.3;}50%{opacity:1;}}
.scanline{position:fixed;left:0;top:0;width:100%;height:100%;
background:repeating-linear-gradient(to bottom,rgba(0,255,100,0.05)0,rgba(0,255,100,0.1)2px,transparent4px);
mix-blend-mode:overlay;pointer-events:none;animation:scanPulse 3s infinite;}
</style>
</head>
<body>
<div id="hud">üåç D√¥me Floreffe ‚Äì Relief holographique + satellites 4D + overlay m√©t√©o</div>
<button id="resBtn">Relief HR</button>
<button id="angleBtn">Vue 45¬∞</button>
<button id="satBtn">üõ∞ Sat ON</button>
<button id="refreshBtn">üîÑ VisionIA</button>
<div id="loader"></div>
<div class="scanline"></div>
<canvas id="scene"></canvas>
<div id="timeline"></div>
<button id="jeanBtn">ü§ñ</button>
<div id="jeanPanel">J.E.A.N. en attente‚Ä¶</div>

<script>
let scene,camera,renderer,controls,terrainMesh,satGroup=new THREE.Group();
let angleMode=false,satVisible=true,currentRes="std";
const loader=document.getElementById("loader"),jeanPanel=document.getElementById("jeanPanel");

init();animate();

// === INITIALISATION ===
async function init(){
 const canvas=document.getElementById("scene");
 renderer=new THREE.WebGLRenderer({canvas,antialias:true});
 renderer.setSize(window.innerWidth,window.innerHeight);
 scene=new THREE.Scene();
 scene.fog=new THREE.FogExp2(0x000010,0.0012);
 camera=new THREE.PerspectiveCamera(45,window.innerWidth/window.innerHeight,1,2000);
 camera.position.set(0,150,250);
 controls=new THREE.OrbitControls(camera,renderer.domElement);
 controls.autoRotate=true;controls.autoRotateSpeed=0.3;controls.enableDamping=true;

 scene.add(new THREE.AmbientLight(0x447799,0.5));
 const light=new THREE.PointLight(0x66ccff,1.2,800);light.position.set(0,200,0);scene.add(light);

 const haloGeom=new THREE.RingGeometry(120,130,64);
 const haloMat=new THREE.MeshBasicMaterial({color:0x33ccff,side:THREE.DoubleSide,transparent:true,opacity:0.25});
 const halo=new THREE.Mesh(haloGeom,haloMat);halo.rotation.x=Math.PI/2;halo.rotation.z=Math.PI/6;scene.add(halo);

 // Relief STD
 const altStd=await fetch("/floreffe_altitudes.json").then(r=>r.json());
 createTerrain(altStd);
 await applyWeatherOverlay(); // üå¶ superposition m√©t√©o

 // Couches satellites
 await loadSatLayers();

 // Timeline
 const timeline=document.getElementById("timeline");
 timeline.addEventListener("click",e=>{
   const pct=e.offsetX/timeline.offsetWidth;
   timeline.style.setProperty("width",`${pct*100}%`);
   updateSatOpacity(pct);
 });

 document.getElementById("angleBtn").onclick=()=>switchAngle();
 document.getElementById("resBtn").onclick=()=>switchResolution();
 document.getElementById("refreshBtn").onclick=()=>refreshVision();
 document.getElementById("satBtn").onclick=()=>toggleSat();
 document.getElementById("jeanBtn").onclick=()=>toggleJean();
 window.addEventListener("resize",onResize);

 // mise √† jour m√©t√©o automatique
 setInterval(applyWeatherOverlay,300000);
}

// === RELIEF ===
function createTerrain(points){
 if(terrainMesh)scene.remove(terrainMesh);
 const geometry=new THREE.PlaneGeometry(240,240,60,60);
 geometry.rotateX(-Math.PI/2);
 const pos=geometry.attributes.position;
 for(let i=0;i<pos.count;i++){
   const vx=pos.getX(i)/2+50.44, vz=pos.getZ(i)/2+4.76;
   const closest=points.reduce((a,b)=>{
     const da=(vx-b.lat)**2+(vz-b.lon)**2;
     const db=(vx-a.lat)**2+(vz-a.lon)**2;
     return da<db?b:a;
   });
   const h=closest?.alt ? (closest.alt-80)/2 : 0;
   pos.setY(i,h);
 }
 pos.needsUpdate=true;
 const mat=new THREE.MeshBasicMaterial({
   color:0x00ff77,wireframe:true,transparent:true,opacity:0.35
 });
 terrainMesh=new THREE.Mesh(geometry,mat);
 scene.add(terrainMesh);
}

// === OVERLAY M√âT√âO ===
async function applyWeatherOverlay(){
 try{
   const data=await fetch("/floreffe_forecasts.json").then(r=>r.json()).catch(()=>null);
   if(!data?.zones)return;
   const zones=data.zones;
   const colors={pluie:new THREE.Color(0x0077ff),vent:new THREE.Color(0xcccccc),
                 chaleur:new THREE.Color(0xff6600),froid:new THREE.Color(0x00ffff)};
   const geom=terrainMesh.geometry;
   const pos=geom.attributes.position;
   const col=new Float32Array(pos.count*3);

   for(let i=0;i<pos.count;i++){
     const vx=pos.getX(i)/2+50.44, vz=pos.getZ(i)/2+4.76;
     const closest=zones.reduce((a,b)=>{
       const da=(vx-b.lat)**2+(vz-b.lon)**2;
       const db=(vx-a.lat)**2+(vz-a.lon)**2;
       return da<db?b:a;
     });

     let c=new THREE.Color(0x00ff77);
     if(closest.precipitation>1) c=colors.pluie;
     else if(closest.wind>40) c=colors.vent;
     else if(closest.temperature>27) c=colors.chaleur;
     else if(closest.temperature<2) c=colors.froid;

     col[i*3]=c.r;col[i*3+1]=c.g;col[i*3+2]=c.b;
   }
   geom.setAttribute("color",new THREE.BufferAttribute(col,3));
   terrainMesh.material.vertexColors=true;
   terrainMesh.material.needsUpdate=true;
   console.log("üå¶ Overlay m√©t√©o appliqu√©");
 }catch(e){console.warn("Overlay m√©t√©o √©chou√©",e);}
}

// === SATELLITES ===
async function loadSatLayers(){
 const texClouds=new THREE.TextureLoader().load("/sat_clouds_real.jpg");
 const texRain=new THREE.TextureLoader().load("/sat_rain_real.png");
 const texWind=new THREE.TextureLoader().load("/sat_wind.png");
 [ {t:texClouds,y:65,o:0.45}, {t:texRain,y:70,o:0.4}, {t:texWind,y:75,o:0.3} ].forEach(d=>{
   const geo=new THREE.PlaneGeometry(240,240);
   const mat=new THREE.MeshBasicMaterial({map:d.t,transparent:true,opacity:d.o});
   const m=new THREE.Mesh(geo,mat);
   m.rotation.x=-Math.PI/2;m.position.y=d.y;
   satGroup.add(m);
 });
 scene.add(satGroup);
}

function toggleSat(){
 satVisible=!satVisible;
 satGroup.visible=satVisible;
 document.getElementById("satBtn").innerText=satVisible?"üõ∞ Sat ON":"üõ∞ Sat OFF";
}

function updateSatOpacity(pct){
 satGroup.children.forEach((m,i)=>{
   m.material.opacity=0.2+0.4*Math.abs(Math.sin(pct*Math.PI*(i+1)));
 });
}

// === RAFRA√éCHIR ===
async function refreshVision(){
 loader.style.display="block";
 try{
   const res=await fetch("/api/vision/run");
   const txt=await res.text();
   alert("‚úÖ VisionIA rafra√Æchie : "+txt.slice(0,80)+"...");
 }catch(e){alert("‚ö†Ô∏è Erreur VisionIA : "+e.message);}
 loader.style.display="none";
}

// === IA J.E.A.N. ===
async function toggleJean(){
 if(jeanPanel.style.display==="none"){jeanPanel.style.display="block";jeanPanel.innerHTML="Analyse en cours...";await askJean();}
 else jeanPanel.style.display="none";
}
async function askJean(){
 try{
   const q=prompt("Pose ta question √† J.E.A.N. :", "Quel est le risque actuel ?");
   if(!q)return;
   const res=await fetch(`/api/jean/analyse?prompt=${encodeURIComponent(q)}`);
   const data=await res.text();
   jeanPanel.innerHTML=`<b>üß† R√©ponse J.E.A.N. :</b><br>${data}`;
 }catch(e){jeanPanel.innerHTML="‚ö†Ô∏è Erreur connexion IA : "+e.message;}
}

// === VUES ===
function switchAngle(){
 angleMode=!angleMode;
 if(angleMode){camera.position.set(200,200,200);}else{camera.position.set(0,150,250);}
}
async function switchResolution(){
 loader.style.display="block";
 try{
   if(currentRes==="std"){
     currentRes="hr";
     const altHR=await fetch("/floreffe_altitudes_hr.json").then(r=>r.json());
     createTerrain(altHR);
     await applyWeatherOverlay();
   }else{
     currentRes="std";
     const altStd=await fetch("/floreffe_altitudes.json").then(r=>r.json());
     createTerrain(altStd);
     await applyWeatherOverlay();
   }
 }catch(e){console.error(e);}finally{loader.style.display="none";}
}
function onResize(){camera.aspect=window.innerWidth/window.innerHeight;camera.updateProjectionMatrix();renderer.setSize(window.innerWidth,window.innerHeight);}
function animate(){requestAnimationFrame(animate);controls.update();renderer.render(scene,camera);}
</script>
</body>
</html>
