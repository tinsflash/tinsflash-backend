<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>üåç D√¥me Floreffe ‚Äî Carte holographique 4D IA J.E.A.N.</title>
  <style>
    body {
      margin: 0;
      overflow: hidden;
      background: radial-gradient(circle at 50% 60%, #000a00 0%, #000 80%);
      font-family: 'Segoe UI', sans-serif;
      color: #8fe1ff;
    }
    #menu {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 10;
      text-shadow: 0 0 6px #00ffff;
    }
    button {
      background: rgba(0, 255, 255, 0.1);
      color: #8fe1ff;
      border: 1px solid #00c3ff;
      border-radius: 6px;
      padding: 5px 10px;
      margin-right: 6px;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    button.active {
      background: #00c3ff;
      color: black;
      font-weight: bold;
      box-shadow: 0 0 10px #00ffff;
    }
    #loader {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: #00c3ff;
      font-size: 1.2em;
      text-shadow: 0 0 10px #00c3ff;
      text-align: center;
    }
  </style>
</head>
<body>
  <div id="menu">
    üåç <b>D√¥me Floreffe ‚Äî Carte holographique IA J.E.A.N.</b><br />
    <button id="btnRelief" class="active">Relief HR</button>
    <button id="btn45">Vue 45¬∞</button>
    <button id="btnSat">Sat On/Off</button>
    <button id="btnIA">IA J.E.A.N.</button>
  </div>
  <div id="loader">Chargement du d√¥me holographique...</div>

  <script type="module">
    import * as THREE from "https://cdn.jsdelivr.net/npm/three@0.161/build/three.module.js";
    import { OrbitControls } from "https://cdn.jsdelivr.net/npm/three@0.161/examples/jsm/controls/OrbitControls.js";

    // === Liens Render directs ===
    const baseURL = "https://tinsflash-backend.onrender.com";
    const altitudesURL = `${baseURL}/floreffe_altitudes.json`;
    const forecastsURL = `${baseURL}/floreffe_forecasts.json`;

    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(45, innerWidth / innerHeight, 0.1, 5000);
    camera.position.set(0, 180, 400);

    const renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(innerWidth, innerHeight);
    renderer.setPixelRatio(window.devicePixelRatio);
    document.body.appendChild(renderer.domElement);

    const controls = new OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;
    controls.dampingFactor = 0.1;
    controls.rotateSpeed = 0.6;

    // === Lumi√®res ===
    const light = new THREE.DirectionalLight(0x99ffcc, 1.3);
    light.position.set(1, 1, 1);
    scene.add(light);
    scene.add(new THREE.AmbientLight(0x102020));

    // === Sol holographique ===
    const ground = new THREE.Mesh(
      new THREE.PlaneGeometry(2000, 2000),
      new THREE.MeshPhongMaterial({ color: 0x001a00, opacity: 0.5, transparent: true })
    );
    ground.rotation.x = -Math.PI / 2;
    scene.add(ground);

    // === Groupes principaux ===
    const reliefGroup = new THREE.Group();
    const overlayGroup = new THREE.Group();
    const radarGroup = new THREE.Group();
    scene.add(reliefGroup, overlayGroup, radarGroup);

    const loaderText = document.getElementById("loader");
    const btnRelief = document.getElementById("btnRelief");
    const btn45 = document.getElementById("btn45");
    const btnSat = document.getElementById("btnSat");
    const btnIA = document.getElementById("btnIA");

    // === Chargement des donn√©es r√©elles ===
    async function loadData() {
      try {
        loaderText.innerText = "Chargement du relief haute r√©solution...";
        const [altitudes, forecasts] = await Promise.all([
          fetch(altitudesURL).then(r => r.json()),
          fetch(forecastsURL).then(r => r.json())
        ]);
        loaderText.innerText = "Donn√©es charg√©es. Construction du d√¥me...";
        buildRelief(altitudes, forecasts);
      } catch (err) {
        loaderText.innerText = "‚ùå Erreur de chargement : " + err.message;
        console.error(err);
      }
    }

    function buildRelief(altitudes, forecasts) {
      loaderText.remove();

      // === Relief par points color√©s ===
      const geometry = new THREE.BufferGeometry();
      const vertices = [];
      const colors = [];
      const colorLow = new THREE.Color(0x0033cc);
      const colorHigh = new THREE.Color(0xffffff);

      altitudes.forEach((p) => {
        const x = (p.lon - 4.7) * 1000;
        const y = p.alt * 1.5;
        const z = (50.4 - p.lat) * 1000;
        vertices.push(x, y, z);
        const color = colorLow.clone().lerp(colorHigh, Math.min(1, p.alt / 250));
        colors.push(color.r, color.g, color.b);
      });

      geometry.setAttribute("position", new THREE.Float32BufferAttribute(vertices, 3));
      geometry.setAttribute("color", new THREE.Float32BufferAttribute(colors, 3));
      const points = new THREE.Points(
        geometry,
        new THREE.PointsMaterial({ size: 2.2, vertexColors: true })
      );
      reliefGroup.add(points);

      // === Grille holographique ===
      const lineMaterial = new THREE.LineBasicMaterial({
        color: 0x00ff66, transparent: true, opacity: 0.4,
      });
      const lineGeometry = new THREE.BufferGeometry();
      const lineVertices = [];
      for (let i = 0; i < vertices.length; i += 9) {
        const x1 = vertices[i], y1 = vertices[i + 1], z1 = vertices[i + 2];
        const x2 = vertices[i + 3], y2 = vertices[i + 4], z2 = vertices[i + 5];
        lineVertices.push(x1, y1, z1, x2, y2, z2);
      }
      lineGeometry.setAttribute("position", new THREE.Float32BufferAttribute(lineVertices, 3));
      reliefGroup.add(new THREE.LineSegments(lineGeometry, lineMaterial));

      // === Points m√©t√©o ===
      if (forecasts?.zones?.length) {
        forecasts.zones.forEach((z) => {
          const color = z.precipitation > 10 ? 0x00ffff : 0x0099ff;
          const sphere = new THREE.Mesh(
            new THREE.SphereGeometry(3, 8, 8),
            new THREE.MeshBasicMaterial({ color })
          );
          const x = (z.lon - 4.7) * 1000;
          const y = (z.alt ?? 100) + 40;
          const zPos = (50.4 - z.lat) * 1000;
          sphere.position.set(x, y, zPos);
          overlayGroup.add(sphere);
        });
      }

      // === Halo radar tournant ===
      const radarGeom = new THREE.CircleGeometry(600, 64);
      const radarMat = new THREE.MeshBasicMaterial({
        color: 0x00ff66, transparent: true, opacity: 0.08, side: THREE.DoubleSide,
      });
      const radar = new THREE.Mesh(radarGeom, radarMat);
      radar.rotation.x = -Math.PI / 2;
      radarGroup.add(radar);

      function animateRadar() {
        radar.rotation.z += 0.002;
        radar.material.opacity = 0.05 + 0.03 * Math.sin(Date.now() * 0.002);
        requestAnimationFrame(animateRadar);
      }
      animateRadar();

      animate();
    }

    // === Animation principale ===
    function animate() {
      requestAnimationFrame(animate);
      reliefGroup.rotation.y += 0.0006;
      overlayGroup.rotation.y += 0.0008;
      controls.update();
      renderer.render(scene, camera);
    }

    // === Boutons ===
    btnRelief.onclick = () => {
      reliefGroup.visible = !reliefGroup.visible;
      btnRelief.classList.toggle("active");
    };
    btn45.onclick = () => {
      camera.position.set(250, 200, 250);
      camera.lookAt(0, 0, 0);
    };
    btnSat.onclick = () => {
      scene.background = scene.background ? null : new THREE.Color(0x000000);
      btnSat.classList.toggle("active");
    };
    btnIA.onclick = () => {
      alert("üß† IA J.E.A.N. : Analyse tactique du relief et des risques hydrologiques en cours...");
    };

    window.addEventListener("resize", () => {
      camera.aspect = innerWidth / innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(innerWidth, innerHeight);
    });

    // === Brouillard atmosph√©rique doux ===
    scene.fog = new THREE.Fog(0x001a00, 200, 900);

    loadData();
  </script>
</body>
</html>
