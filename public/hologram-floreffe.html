<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>üåç D√¥me Floreffe ‚Äî Carte holographique 4D IA J.E.A.N.</title>
  <style>
    body {
      margin: 0;
      overflow: hidden;
      background: radial-gradient(circle at 50% 60%, #000a00 0%, #000 80%);
      font-family: 'Segoe UI', sans-serif;
      color: #8fe1ff;
    }
    #menu {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 10;
    }
    button {
      background: rgba(0, 255, 255, 0.1);
      color: #8fe1ff;
      border: 1px solid #00c3ff;
      border-radius: 6px;
      padding: 5px 10px;
      margin-right: 6px;
      cursor: pointer;
    }
    button.active {
      background: #00c3ff;
      color: black;
      font-weight: bold;
    }
    #loader {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: #00c3ff;
      font-size: 1.2em;
      text-shadow: 0 0 10px #00c3ff;
    }
  </style>
</head>
<body>
  <div id="menu">
    üåç <b>D√¥me Floreffe ‚Äî Carte holographique + radar IA J.E.A.N.</b><br />
    <button id="btnRelief" class="active">Relief HR</button>
    <button id="btnContours" class="active">Courbes</button>
    <button id="btn45">Vue 45¬∞</button>
    <button id="btnSat">Sat On/Off</button>
    <button id="btnIA">IA J.E.A.N.</button>
  </div>
  <div id="loader">Chargement du d√¥me holographique...</div>

  <script type="module">
    import * as THREE from "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js";
    import { OrbitControls } from "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/controls/OrbitControls.js";
    import { addContourLines } from "./js/addContourLines.js";

    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 5000);
    camera.position.set(0, 150, 400);

    const renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.body.appendChild(renderer.domElement);

    const controls = new OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;
    controls.dampingFactor = 0.1;
    controls.rotateSpeed = 0.6;

    // === Lumi√®res ===
    const light = new THREE.DirectionalLight(0x99ffcc, 1.2);
    light.position.set(1, 1, 1);
    scene.add(light);
    scene.add(new THREE.AmbientLight(0x102020));

    // === Sol lumineux ===
    const ground = new THREE.Mesh(
      new THREE.PlaneGeometry(2000, 2000),
      new THREE.MeshPhongMaterial({ color: 0x001a00, opacity: 0.5, transparent: true })
    );
    ground.rotation.x = -Math.PI / 2;
    scene.add(ground);

    // === Groupes principaux ===
    const reliefGroup = new THREE.Group();
    const overlayGroup = new THREE.Group();
    const radarGroup = new THREE.Group();
    scene.add(reliefGroup);
    scene.add(overlayGroup);
    scene.add(radarGroup);

    const loaderText = document.getElementById("loader");
    const btnRelief = document.getElementById("btnRelief");
    const btnContours = document.getElementById("btnContours");
    const btn45 = document.getElementById("btn45");
    const btnSat = document.getElementById("btnSat");
    const btnIA = document.getElementById("btnIA");

    // === Chargement JSON ===
    async function loadData() {
      try {
        const altitudes = await (await fetch("./floreffe_altitudes_hr.json")).json();
        const forecasts = await (await fetch("./floreffe_forecasts.json")).json();
        loaderText.innerText = "Relief & m√©t√©o charg√©s...";
        buildRelief(altitudes, forecasts);
      } catch (err) {
        loaderText.innerText = "‚ùå Erreur de chargement : " + err.message;
        console.error(err);
      }
    }

    function buildRelief(altitudes, forecasts) {
      loaderText.remove();

      const geometry = new THREE.BufferGeometry();
      const vertices = [];
      const colors = [];
      const colorLow = new THREE.Color(0x0020aa);
      const colorHigh = new THREE.Color(0xffffff);

      altitudes.forEach((p) => {
        const x = p.lon * 600 - 2800;
        const y = p.alt * 1.5;
        const z = -p.lat * 600 + 30500;
        vertices.push(x, y, z);
        const color = colorLow.clone().lerp(colorHigh, Math.min(1, p.alt / 250));
        colors.push(color.r, color.g, color.b);
      });

      geometry.setAttribute("position", new THREE.Float32BufferAttribute(vertices, 3));
      geometry.setAttribute("color", new THREE.Float32BufferAttribute(colors, 3));

      const pointsMat = new THREE.PointsMaterial({ size: 2.0, vertexColors: true });
      const points = new THREE.Points(geometry, pointsMat);
      reliefGroup.add(points);

      // === Grille Hunger Games ===
      const lineMat = new THREE.LineBasicMaterial({ color: 0x00ff66, transparent: true, opacity: 0.4 });
      const lineGeom = new THREE.BufferGeometry();
      const lineVerts = [];
      for (let i = 0; i < vertices.length; i += 9) {
        const x1 = vertices[i], y1 = vertices[i + 1], z1 = vertices[i + 2];
        const x2 = vertices[i + 3], y2 = vertices[i + 4], z2 = vertices[i + 5];
        const x3 = vertices[i + 6], y3 = vertices[i + 7], z3 = vertices[i + 8];
        lineVerts.push(x1, y1, z1, x2, y2, z2, x2, y2, z2, x3, y3, z3);
      }
      lineGeom.setAttribute("position", new THREE.Float32BufferAttribute(lineVerts, 3));
      const gridLines = new THREE.LineSegments(lineGeom, lineMat);
      reliefGroup.add(gridLines);

      function pulseLines() {
        const t = Date.now() * 0.002;
        lineMat.opacity = 0.25 + 0.15 * Math.sin(t);
        requestAnimationFrame(pulseLines);
      }
      pulseLines();

      // === Halo radar ===
      const radarGeom = new THREE.CircleGeometry(450, 64);
      const radarMat = new THREE.MeshBasicMaterial({ color: 0x00ff66, transparent: true, opacity: 0.08, side: THREE.DoubleSide });
      const radar = new THREE.Mesh(radarGeom, radarMat);
      radar.rotation.x = -Math.PI / 2;
      radarGroup.add(radar);

      function animateRadar() {
        radar.rotation.z += 0.002;
        radar.material.opacity = 0.05 + 0.03 * Math.sin(Date.now() * 0.002);
        requestAnimationFrame(animateRadar);
      }
      animateRadar();

      // === Ajout des courbes de niveau ===
      addContourLines(scene, reliefGroup);

      animate();
    }

    // === Animation principale ===
    function animate() {
      requestAnimationFrame(animate);
      reliefGroup.rotation.y += 0.0008;
      overlayGroup.rotation.y += 0.0008;
      controls.update();
      renderer.render(scene, camera);
    }

    // === Boutons ===
    btnRelief.onclick = () => {
      reliefGroup.visible = !reliefGroup.visible;
      btnRelief.classList.toggle("active");
    };
    btnContours.onclick = () => {
      scene.children.forEach(o => { if (o.type === "Group") o.visible = !o.visible; });
      btnContours.classList.toggle("active");
    };
    btn45.onclick = () => { camera.position.set(200, 200, 200); camera.lookAt(0, 0, 0); };
    btnSat.onclick = () => { scene.background = scene.background ? null : new THREE.Color(0x000000); btnSat.classList.toggle("active"); };
    btnIA.onclick = () => { alert("üß† IA J.E.A.N. : Analyse du relief tactique Floreffe en cours..."); };

    window.addEventListener("resize", () => {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    });

    scene.fog = new THREE.Fog(0x001a00, 200, 900);
    loadData();
  </script>
</body>
</html>
